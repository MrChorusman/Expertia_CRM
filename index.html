<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expertia CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/recharts.min.js"></script>
    <link rel="icon" href="https://storage.googleapis.com/gemini-generative-ai-api/f55a1dda-6560-4321-aidb-53f36780a82f" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        @media print {
            body * { visibility: hidden; }
            #invoice-printable, #invoice-printable * { visibility: visible; }
            #invoice-printable { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="display:flex; justify-content:center; align-items:center; height:100vh; font-family: Inter, sans-serif; color: #4A5568;">
            Cargando Expertia CRM...
        </div>
    </div>

    <script src="./firebase-config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, runTransaction, setDoc } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";
        
        window.firebase = {
            initializeApp, getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken,
            getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, runTransaction, setDoc
        };
    </script>

    <script type="text/babel" data-presets="react">
        function startApp() {
            console.log('Intentando iniciar aplicación...');
            console.log('React disponible:', typeof window.React !== 'undefined');
            console.log('ReactDOM disponible:', typeof window.ReactDOM !== 'undefined');
            console.log('Recharts disponible:', typeof window.Recharts !== 'undefined');
            console.log('Firebase disponible:', typeof window.firebase !== 'undefined');
            
            if (typeof window.React === 'undefined' || typeof window.ReactDOM === 'undefined') {
                console.log('Esperando React...');
                setTimeout(startApp, 100);
                return;
            }

            const { useState, useEffect, useMemo } = React;
            
            // Hacer Recharts opcional para evitar bloqueos
            let BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line;
            if (typeof window.Recharts !== 'undefined') {
                ({ BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line } = window.Recharts);
            }
            
            // Hacer Firebase opcional para el arranque inicial
            let initializeApp, getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken, getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, runTransaction, setDoc;
            if (typeof window.firebase !== 'undefined') {
                ({ initializeApp, getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken, getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, runTransaction, setDoc } = window.firebase);
            }

            // --- Íconos (SVG) ---
            const PlusIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
            const UserIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
            const EditIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>;
            const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
            const BuildingIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>;
            const MailIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>;
            const PhoneIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>;
            const CheckSquareIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>;
            const MapPinIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>;
            const TrendingUpIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>;
            const DollarSignIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>;
            const BellIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>;
            const MessageSquareIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>;
            const XIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
            const SendIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>;
            const FileTextIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>;

            // --- Constantes de la aplicación ---
            const FUNNEL_TAGS = { 'Lead': 'bg-gray-200 text-gray-800', 'Primer Contacto': 'bg-blue-200 text-blue-800', 'Interesado': 'bg-cyan-200 text-cyan-800', 'Demo Realizada': 'bg-indigo-200 text-indigo-800', 'Negociación': 'bg-purple-200 text-purple-800', 'En Cierre': 'bg-orange-200 text-orange-800', 'Ganado': 'bg-green-200 text-green-800', 'Perdido': 'bg-red-200 text-red-800' };
            const CONTACT_PREFERENCES = { 'Email': <MailIcon />, 'Teléfono': <PhoneIcon />, 'WhatsApp': <MessageSquareIcon />, 'Visita Comercial': <BuildingIcon /> };
            const INVOICE_STATUSES = { 'Borrador': 'bg-gray-200 text-gray-800', 'Finalizada': 'bg-blue-200 text-blue-800', 'Pagada': 'bg-green-200 text-green-800', 'Anulada': 'bg-red-300 text-red-900' };
            const VAT_RATE = 0.21;

            // --- Configuración de Firebase ---
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                // Configuración demo para desarrollo
                apiKey: "demo-api-key",
                authDomain: "expertia-crm-demo.firebaseapp.com",
                projectId: "expertia-crm-demo",
                storageBucket: "expertia-crm-demo.appspot.com",
                messagingSenderId: "123456789",
                appId: "1:123456789:web:demo-app-id"
            };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'expertia-crm-demo';

            // --- Componente Principal: App ---
            function App() {
                const [db, setDb] = useState(null);
                const [auth, setAuth] = useState(null);
                const [user, setUser] = useState(null);
                const [userProfile, setUserProfile] = useState(null);
                const [isAuthReady, setIsAuthReady] = useState(false);

                const [clients, setClients] = useState([]);
                const [invoices, setInvoices] = useState([]);
                const [products, setProducts] = useState([]);
                const [offers, setOffers] = useState([]);
                const [activeView, setActiveView] = useState('dashboard');
                const [selectedItem, setSelectedItem] = useState(null);
                const [isLoading, setIsLoading] = useState(true);
                const [searchTerm, setSearchTerm] = useState('');
                const [filterTag, setFilterTag] = useState('all');

                // Función para verificar permisos
                const isAdmin = () => userProfile?.role === 'admin';
                const isCommercialOrAdmin = () => userProfile?.role === 'admin' || userProfile?.role === 'comercial';

                useEffect(() => {
                    console.log("Iniciando inicialización de Firebase...");
                    
                    if (typeof initializeApp === 'undefined') {
                        console.log("Firebase no disponible, ejecutando en modo demo");
                        // Modo demo con datos de ejemplo
                        setUser({ uid: "demo-user-123", email: "demo@expertia.com" });
                        setUserProfile({ 
                            id: "demo-user-123", 
                            email: "demo@expertia.com", 
                            name: "Usuario Demo", 
                            role: "admin" 
                        });
                        setIsAuthReady(true);
                        setIsLoading(false);
                        
                        // Cargar datos demo
                        loadDemoData();
                        return;
                    }

                    try {
                        // Inicializar Firebase
                        const app = initializeApp(firebaseConfig);
                        const firestoreDb = getFirestore(app);
                        const firebaseAuth = getAuth(app);
                        setDb(firestoreDb);
                        setAuth(firebaseAuth);

                        // Listener de autenticación
                        const unsubscribe = onAuthStateChanged(firebaseAuth, async (firebaseUser) => {
                            if (firebaseUser) {
                                setUser(firebaseUser);
                                // Cargar perfil del usuario desde Firestore
                                const userDoc = await doc(firestoreDb, 'users', firebaseUser.uid);
                                onSnapshot(userDoc, (snapshot) => {
                                    if (snapshot.exists()) {
                                        setUserProfile({ id: firebaseUser.uid, ...snapshot.data() });
                                    } else {
                                        // Usuario nuevo, crear perfil básico
                                        const newProfile = {
                                            email: firebaseUser.email,
                                            name: firebaseUser.displayName || 'Usuario',
                                            role: 'comercial', // Por defecto comercial
                                            createdAt: new Date().toISOString()
                                        };
                                        setDoc(userDoc, newProfile);
                                        setUserProfile({ id: firebaseUser.uid, ...newProfile });
                                    }
                                });
                            } else {
                                // Sin autenticación, modo demo
                                setUser({ uid: "demo-user-123", email: "demo@expertia.com" });
                                setUserProfile({ 
                                    id: "demo-user-123", 
                                    email: "demo@expertia.com", 
                                    name: "Usuario Demo", 
                                    role: "admin" 
                                });
                                loadDemoData();
                            }
                            setIsAuthReady(true);
                            setIsLoading(false);
                        });

                        return () => unsubscribe();
                    } catch (error) {
                        console.error("Error al inicializar Firebase:", error);
                        // Fallback a modo demo
                        setUser({ uid: "demo-user-123", email: "demo@expertia.com" });
                        setUserProfile({ 
                            id: "demo-user-123", 
                            email: "demo@expertia.com", 
                            name: "Usuario Demo", 
                            role: "admin" 
                        });
                        setIsAuthReady(true);
                        setIsLoading(false);
                        loadDemoData();
                    }
                }, []);

                // Función para cargar datos demo
                const loadDemoData = () => {
                    setClients([
                        { 
                            id: '1', 
                            name: 'Hospital San Juan', 
                            email: 'contacto@hospitalsanjuan.com', 
                            phone: '+34 91 123 4567', 
                            company: 'Hospital San Juan', 
                            funnelStage: 'Ganado', 
                            lastContact: '2025-07-08',
                            address: 'Calle Mayor 123, Madrid',
                            notes: 'Cliente prioritario',
                            consentGiven: true,
                            acceptsMarketing: true
                        },
                        { 
                            id: '2', 
                            name: 'Clínica Dental López', 
                            email: 'info@clinicalopez.com', 
                            phone: '+34 93 234 5678', 
                            company: 'Clínica Dental López', 
                            funnelStage: 'En Cierre', 
                            lastContact: '2025-07-07',
                            address: 'Av. Diagonal 456, Barcelona',
                            notes: 'Interesado en equipos dentales',
                            consentGiven: true,
                            acceptsMarketing: false
                        },
                        { 
                            id: '3', 
                            name: 'Centro Médico Valle', 
                            email: 'admin@centrovalle.com', 
                            phone: '+34 95 345 6789', 
                            company: 'Centro Médico Valle', 
                            funnelStage: 'Interesado', 
                            lastContact: '2025-07-06',
                            address: 'Plaza Central 789, Sevilla',
                            notes: 'Contacto inicial realizado',
                            consentGiven: true,
                            acceptsMarketing: true
                        }
                    ]);
                    
                    setProducts([
                        { 
                            id: '1', 
                            name: 'Equipo de Rayos X Digital', 
                            price: 15000, 
                            description: 'Sistema completo de radiografía digital con panel detector',
                            category: 'Diagnóstico',
                            supplier: 'Storz Medical'
                        },
                        { 
                            id: '2', 
                            name: 'Monitor de Signos Vitales', 
                            price: 3500, 
                            description: 'Monitor multiparamétrico para UCI',
                            category: 'Monitorización',
                            supplier: 'Zamar Medical'
                        },
                        { 
                            id: '3', 
                            name: 'Desfibrilador Automático', 
                            price: 8500, 
                            description: 'DEA con pantalla LCD y guía de voz',
                            category: 'Emergencias',
                            supplier: 'Storz Medical'
                        }
                    ]);
                    
                    setInvoices([
                        { 
                            id: '1', 
                            number: 'EXP-001', 
                            clientId: '1',
                            clientName: 'Hospital San Juan', 
                            amount: 15000,
                            total: 18150, // Con IVA
                            status: 'Pagada', 
                            date: '2025-07-01',
                            series: 'EXP',
                            items: [
                                { productId: '1', quantity: 1, price: 15000 }
                            ]
                        },
                        { 
                            id: '2', 
                            number: 'EXP-002', 
                            clientId: '2',
                            clientName: 'Clínica Dental López', 
                            amount: 3500,
                            total: 4235, // Con IVA
                            status: 'Finalizada', 
                            date: '2025-07-05',
                            series: 'EXP',
                            items: [
                                { productId: '2', quantity: 1, price: 3500 }
                            ]
                        }
                    ]);
                    
                    console.log("Datos demo cargados exitosamente");
                };

                // Listeners de Firestore con nueva estructura
                useEffect(() => {
                    if (!isAuthReady || !db || !user || !userProfile) return;
                    
                    console.log("Configurando listeners de Firestore...");
                    
                    if (!isCommercialOrAdmin()) {
                        console.log("Usuario sin permisos suficientes");
                        return;
                    }

                    const unsubscribers = [];

                    // Listener para clientes
                    const clientsCollection = collection(db, 'clientes');
                    unsubscribers.push(
                        onSnapshot(clientsCollection, (snapshot) => {
                            const clientsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setClients(clientsData);
                        }, (error) => {
                            console.error("Error loading clients:", error);
                        })
                    );

                    // Listener para productos
                    const productsCollection = collection(db, 'productos');
                    unsubscribers.push(
                        onSnapshot(productsCollection, (snapshot) => {
                            const productsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setProducts(productsData);
                        }, (error) => {
                            console.error("Error loading products:", error);
                        })
                    );

                    // Listener para facturas
                    const invoicesCollection = collection(db, 'facturas');
                    unsubscribers.push(
                        onSnapshot(invoicesCollection, (snapshot) => {
                            const invoicesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setInvoices(invoicesData);
                        }, (error) => {
                            console.error("Error loading invoices:", error);
                        })
                    );

                    // Listener para ofertas
                    const offersCollection = collection(db, 'ofertas');
                    unsubscribers.push(
                        onSnapshot(offersCollection, (snapshot) => {
                            const offersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setOffers(offersData);
                        }, (error) => {
                            console.error("Error loading offers:", error);
                        })
                    );

                    setIsLoading(false);

                    return () => {
                        unsubscribers.forEach(unsubscribe => unsubscribe());
                    };
                }, [isAuthReady, db, user, userProfile]);
                
                // --- Funciones CRUD con nueva estructura ---
                const handleSave = async (collectionName, data, docId) => {
                    if (!db || !user) {
                        console.log("Guardando en modo demo...");
                        return;
                    }
                    
                    const finalDocId = docId || data.id;
                    const { id, ...dataToSave } = data;
                    
                    // Agregar metadatos
                    dataToSave.updatedAt = new Date().toISOString();
                    dataToSave.updatedBy = user.uid;
                    
                    if (!finalDocId) {
                        dataToSave.createdAt = new Date().toISOString();
                        dataToSave.createdBy = user.uid;
                    }
                    
                    try {
                        if (finalDocId) {
                            await setDoc(doc(db, collectionName, finalDocId), dataToSave, { merge: true });
                        } else {
                            await addDoc(collection(db, collectionName), dataToSave);
                        }
                        console.log(`Guardado exitoso en ${collectionName}`);
                    } catch (error) { 
                        console.error(`Error guardando en ${collectionName}:`, error); 
                    }
                };

                const handleDelete = async (collectionName, docId) => {
                    if (!db || !user) {
                        console.log("Eliminando en modo demo...");
                        return;
                    }
                    
                    if (window.confirm('¿Estás seguro de que quieres eliminar este elemento? Esta acción no se puede deshacer.')) {
                        try {
                            await deleteDoc(doc(db, collectionName, docId));
                            console.log(`Eliminado exitoso de ${collectionName}`);
                        } catch (error) { 
                            console.error(`Error eliminando de ${collectionName}:`, error); 
                        }
                    }
                };
                
                const handleSaveClient = async (clientData) => {
                    await handleSave('clientes', clientData, clientData.id);
                    setActiveView('dashboard');
                    setSelectedItem(null);
                };
                
                const handleSaveProfile = async (profileData) => {
                    await handleSave('users', profileData, user.uid);
                    setActiveView('dashboard');
                };
                
                const handleSaveOffer = async (offerData) => {
                    await handleSave('ofertas', offerData, offerData.id);
                    setActiveView('offers');
                };

                const handleSaveProduct = async (productData) => {
                    if (!isAdmin()) {
                        alert('Solo los administradores pueden gestionar productos');
                        return;
                    }
                    await handleSave('productos', productData, productData.id);
                };

                const getNextInvoiceNumber = async (type) => {
                    if (!db) {
                        // Modo demo - generar número temporal
                        const timestamp = Date.now();
                        const prefix = type === 'EXP' ? 'EXP' : 'ALQ';
                        return `${prefix}-DEMO-${timestamp}`;
                    }

                    const counterRef = doc(db, 'counters', type);
                    let nextNumber;
                    
                    try {
                        await runTransaction(db, async (transaction) => {
                            const counterDoc = await transaction.get(counterRef);
                            if (!counterDoc.exists()) {
                                const startValue = type === 'EXP' ? 1 : 1;
                                transaction.set(counterRef, { current: startValue });
                                nextNumber = startValue;
                            } else {
                                const newCurrent = counterDoc.data().current + 1;
                                transaction.update(counterRef, { current: newCurrent });
                                nextNumber = newCurrent;
                            }
                        });
                        
                        const prefix = type === 'EXP' ? 'EXP' : 'ALQ';
                        return `${prefix}${String(nextNumber).padStart(3, '0')}`;
                    } catch (error) {
                        console.error("Error obteniendo número de factura:", error);
                        const prefix = type === 'EXP' ? 'EXP' : 'ALQ';
                        return `${prefix}-ERROR-${Date.now()}`;
                    }
                };

                const handleSaveInvoice = async (invoiceData, convertFromProforma = false) => {
                    let dataToSave = { ...invoiceData };
                    
                    if (convertFromProforma || !dataToSave.id) {
                        if (dataToSave.type !== 'Factura Proforma') {
                            dataToSave.number = await getNextInvoiceNumber(dataToSave.series || 'EXP');
                        } else {
                            dataToSave.number = `PROFORMA-${Date.now()}`;
                        }
                    }
                    
                    await handleSave('facturas', dataToSave, dataToSave.id);
                    setActiveView('accounting');
                };

                const handleConvertToInvoice = async (proformaInvoice) => {
                    const invoiceData = {
                        ...proformaInvoice,
                        type: 'Factura',
                        status: 'Finalizada',
                    };
                    await handleSaveInvoice(invoiceData, true);
                };

                const handleRegisterPayment = async (invoice, paymentAmount) => {
                    if (!db || !invoice || !paymentAmount) return;
                    
                    const newTotalPaid = (invoice.totalPaid || 0) + paymentAmount;
                    const updatedInvoice = {
                        ...invoice,
                        totalPaid: newTotalPaid,
                        status: newTotalPaid >= invoice.total ? 'Pagada' : 'Finalizada',
                    };
                    
                    await handleSave('facturas', updatedInvoice, updatedInvoice.id);
                    
                    // Registrar el pago en subcolección
                    if (db && user) {
                        const paymentData = { 
                            amount: paymentAmount, 
                            date: new Date().toISOString(), 
                            method: 'Transferencia',
                            registeredBy: user.uid
                        };
                        await addDoc(collection(db, `facturas/${invoice.id}/payments`), paymentData);
                    }
                    
                    setSelectedItem(updatedInvoice);
                };

                const filteredClients = useMemo(() => clients.filter(client =>
                    (searchTerm === '' || client.name.toLowerCase().includes(searchTerm.toLowerCase()) || client.clinic.toLowerCase().includes(searchTerm.toLowerCase())) &&
                    (filterTag === 'all' || client.tag === filterTag)
                ), [clients, searchTerm, filterTag]);

                const renderView = () => {
                    if (!isCommercialOrAdmin() && activeView !== 'profile') {
                        return (
                            <div className="p-6 text-center">
                                <h2 className="text-xl font-semibold text-gray-800 mb-4">Acceso Restringido</h2>
                                <p className="text-gray-600">No tienes permisos para acceder a esta funcionalidad.</p>
                                <p className="text-sm text-gray-500 mt-2">Contacta con un administrador para obtener acceso.</p>
                            </div>
                        );
                    }

                    switch (activeView) {
                        case 'profile': 
                            return <ProfileForm userProfile={userProfile} onSave={handleSaveProfile} onBack={() => setActiveView('dashboard')} />;
                        case 'bulkCommunication': 
                            return <BulkCommunication clients={clients} onBack={() => setActiveView('dashboard')} />;
                        case 'addClient': 
                            return <ClientForm onSave={handleSaveClient} onCancel={() => setActiveView('dashboard')} />;
                        case 'editClient': 
                            return <ClientForm client={selectedItem} onSave={handleSaveClient} onCancel={() => setActiveView('dashboard')} />;
                        case 'detailClient': 
                            return <ClientDetail 
                                client={selectedItem} 
                                db={db} 
                                user={user} 
                                onEdit={() => { setSelectedItem(selectedItem); setActiveView('editClient'); }} 
                                onDelete={() => handleDelete('clientes', selectedItem.id)} 
                                onBack={() => setActiveView('dashboard')} 
                                onCreateInvoice={() => { setSelectedItem({ client: selectedItem }); setActiveView('createInvoice'); }} 
                                onGenerateConsent={() => { setSelectedItem(selectedItem); setActiveView('consentForm'); }} 
                            />;
                        case 'consentForm': 
                            return <ConsentForm client={selectedItem} onBack={() => { setSelectedItem(selectedItem); setActiveView('detailClient'); }} />;
                        case 'offers': 
                            return <OffersDashboard 
                                offers={offers} 
                                clients={clients} 
                                onCreateOffer={() => { setSelectedItem(null); setActiveView('createOffer'); }} 
                                onViewOffer={(offer) => { setSelectedItem(offer); setActiveView('viewOffer'); }} 
                                onDeleteOffer={(id) => handleDelete('ofertas', id)} 
                            />;
                        case 'createOffer': 
                            return <OfferForm 
                                clients={clients} 
                                products={products} 
                                onSave={handleSaveOffer} 
                                onCancel={() => setActiveView('offers')} 
                            />;
                        case 'viewOffer': 
                            return <OfferDetail offer={selectedItem} clients={clients} onBack={() => setActiveView('offers')} />;
                        case 'accounting': 
                            return <AccountingDashboard 
                                invoices={invoices} 
                                clients={clients} 
                                products={products} 
                                isAdmin={isAdmin()}
                                onSaveProduct={handleSaveProduct} 
                                onDeleteProduct={(id) => handleDelete('productos', id)} 
                                onCreateInvoice={() => { setSelectedItem(null); setActiveView('createInvoice'); }} 
                                onViewInvoice={(invoice) => { setSelectedItem(invoice); setActiveView('viewInvoice'); }} 
                                onDeleteInvoice={(id) => handleDelete('facturas', id)} 
                            />;
                        case 'createInvoice': 
                            return <InvoiceForm 
                                clients={clients} 
                                products={products} 
                                onSave={handleSaveInvoice} 
                                onCancel={() => setActiveView('accounting')} 
                                invoiceData={selectedItem} 
                            />;
                        case 'viewInvoice': 
                            return <InvoiceDetail 
                                invoice={selectedItem} 
                                clients={clients} 
                                onBack={() => setActiveView('accounting')} 
                                onRegisterPayment={handleRegisterPayment} 
                                db={db} 
                                user={user} 
                                onConvertToInvoice={handleConvertToInvoice} 
                            />;
                        case 'reports': 
                            return <ReportsDashboard allInvoices={invoices} />;
                        case 'admin':
                            if (!isAdmin()) {
                                return (
                                    <div className="p-6 text-center">
                                        <h2 className="text-xl font-semibold text-red-600 mb-4">Acceso Denegado</h2>
                                        <p className="text-gray-600">Solo los administradores pueden acceder al panel de administración.</p>
                                    </div>
                                );
                            }
                            return <AdminPanel 
                                users={[]} 
                                products={products}
                                onSaveProduct={handleSaveProduct}
                                onDeleteProduct={(id) => handleDelete('productos', id)}
                            />;
                        default: 
                            return <Dashboard 
                                clients={filteredClients} 
                                allClients={clients} 
                                onAddClient={() => setActiveView('addClient')} 
                                onBulkComm={() => setActiveView('bulkCommunication')} 
                                onViewClient={(client) => { setSelectedItem(client); setActiveView('detailClient'); }} 
                                onEditClient={(client) => { setSelectedItem(client); setActiveView('editClient'); }} 
                                onDeleteClient={(id) => handleDelete('clientes', id)} 
                                searchTerm={searchTerm} 
                                setSearchTerm={setSearchTerm} 
                                filterTag={filterTag} 
                                setFilterTag={setFilterTag} 
                            />;
                    }
                };

                return (
                    <div className="bg-gray-50 min-h-screen font-sans">
                        <Header userProfile={userProfile} activeView={activeView} setActiveView={setActiveView} />
                        <main className="p-4 sm:p-6 md:p-8">{renderView()}</main>
                    </div>
                );
            }

            // --- Componentes ---
            function Header({ userProfile, activeView, setActiveView }) {
                const navItemClass = (viewName) => `cursor-pointer py-2 px-3 rounded-md text-sm font-medium flex items-center gap-2 ${activeView.startsWith(viewName) ? 'bg-[#006666] text-white' : 'text-gray-600 hover:bg-gray-200'}`;
                const isAdmin = userProfile?.role === 'admin';
                
                return (
                    <header className="bg-white shadow-md sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-20">
                                <div className="flex items-center">
                                    <img src="./data/LOGO EXPERTIA MEDICAL SOLUTIONS.jpg" alt="Expertia Medical Solutions Logo" className="h-12 w-auto" />
                                </div>
                                <nav className="flex items-center gap-4">
                                    <span onClick={() => setActiveView('dashboard')} className={navItemClass('dashboard')}>
                                        <UserIcon width={16} height={16} /> Clientes
                                    </span>
                                    <span onClick={() => setActiveView('offers')} className={navItemClass('offers')}>
                                        <FileTextIcon width={16} height={16}/> Ofertas
                                    </span>
                                    <span onClick={() => setActiveView('accounting')} className={navItemClass('accounting')}>
                                        <DollarSignIcon /> Contabilidad
                                    </span>
                                    <span onClick={() => setActiveView('reports')} className={navItemClass('reports')}>
                                        <TrendingUpIcon width={16} height={16} /> Informes
                                    </span>
                                    {isAdmin && (
                                        <span onClick={() => setActiveView('admin')} className={navItemClass('admin')}>
                                            <CheckSquareIcon /> Admin
                                        </span>
                                    )}
                                </nav>
                                <div className="flex items-center gap-3 cursor-pointer" onClick={() => setActiveView('profile')}>
                                    <div className="flex flex-col text-right">
                                        <div className="text-sm text-gray-600">{userProfile?.name || 'Usuario'}</div>
                                        <div className="text-xs text-gray-500 capitalize">{userProfile?.role || 'comercial'}</div>
                                    </div>
                                    <img src={userProfile?.photoURL || 'https://placehold.co/40x40/008080/FFFFFF?text=U'} alt="Perfil" className="h-10 w-10 rounded-full object-cover" />
                                </div>
                            </div>
                        </div>
                    </header>
                );
            }

            // ... (El resto de los componentes se definen aquí, igual que en la versión anterior) ...
            
            // Componente Dashboard simplificado para demo
            function Dashboard({ clients, onAddClient, onViewClient, searchTerm, setSearchTerm }) {
                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h1 className="text-3xl font-bold text-gray-900">Dashboard de Clientes</h1>
                            <button onClick={onAddClient} className="bg-[#006666] text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-[#005555]">
                                <PlusIcon width={20} height={20} />
                                Añadir Cliente
                            </button>
                        </div>
                        
                        <div className="bg-white rounded-lg shadow p-6">
                            <div className="mb-4">
                                <input 
                                    type="text" 
                                    placeholder="Buscar clientes..." 
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg"
                                />
                            </div>
                            
                            <div className="grid gap-4">
                                {clients.map(client => (
                                    <div key={client.id} className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" onClick={() => onViewClient(client)}>
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <h3 className="font-semibold text-lg">{client.name}</h3>
                                                <p className="text-gray-600">{client.company}</p>
                                                <p className="text-sm text-gray-500">{client.email}</p>
                                                <p className="text-sm text-gray-500">{client.phone}</p>
                                            </div>
                                            <span className={`px-3 py-1 rounded-full text-xs font-medium ${FUNNEL_TAGS[client.funnelStage] || 'bg-gray-200 text-gray-800'}`}>
                                                {client.funnelStage}
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }
            
            // Placeholder para otros componentes
            function ClientForm() { return <div className="p-6"><h2>Formulario de Cliente - En desarrollo</h2></div>; }
            function ClientDetail() { return <div className="p-6"><h2>Detalle de Cliente - En desarrollo</h2></div>; }
            function OffersDashboard() { return <div className="p-6"><h2>Dashboard de Ofertas - En desarrollo</h2></div>; }
            function AccountingDashboard() { return <div className="p-6"><h2>Dashboard de Contabilidad - En desarrollo</h2></div>; }
            function ReportsDashboard() { return <div className="p-6"><h2>Dashboard de Informes - En desarrollo</h2></div>; }
            function ProfileForm() { return <div className="p-6"><h2>Formulario de Perfil - En desarrollo</h2></div>; }
            function BulkCommunication() { return <div className="p-6"><h2>Comunicaciones Masivas - En desarrollo</h2></div>; }
            
            // Formulario de Productos
            function ProductForm({ product, onSave, onCancel }) {
                const [formData, setFormData] = useState({
                    name: product?.name || '',
                    description: product?.description || '',
                    category: product?.category || '',
                    supplier: product?.supplier || '',
                    price: product?.price || '',
                    code: product?.code || '',
                    stock: product?.stock || 0,
                    minStock: product?.minStock || 0
                });

                const handleSubmit = (e) => {
                    e.preventDefault();
                    const productData = {
                        ...formData,
                        price: parseFloat(formData.price),
                        stock: parseInt(formData.stock),
                        minStock: parseInt(formData.minStock),
                        id: product?.id || Date.now().toString()
                    };
                    onSave(productData);
                };

                const handleChange = (field, value) => {
                    setFormData(prev => ({ ...prev, [field]: value }));
                };

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h1 className="text-3xl font-bold text-gray-900">
                                {product ? 'Editar Producto' : 'Nuevo Producto'}
                            </h1>
                            <button
                                onClick={onCancel}
                                className="text-gray-500 hover:text-gray-700"
                            >
                                <XIcon width={24} height={24} />
                            </button>
                        </div>

                        <div className="bg-white rounded-lg shadow p-6">
                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Nombre del Producto *
                                        </label>
                                        <input
                                            type="text"
                                            value={formData.name}
                                            onChange={(e) => handleChange('name', e.target.value)}
                                            required
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                            placeholder="Nombre del producto"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Código del Producto
                                        </label>
                                        <input
                                            type="text"
                                            value={formData.code}
                                            onChange={(e) => handleChange('code', e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                            placeholder="Código SKU"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Categoría *
                                        </label>
                                        <select
                                            value={formData.category}
                                            onChange={(e) => handleChange('category', e.target.value)}
                                            required
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                        >
                                            <option value="">Seleccionar categoría</option>
                                            <option value="Equipos Médicos">Equipos Médicos</option>
                                            <option value="Instrumentos">Instrumentos</option>
                                            <option value="Consumibles">Consumibles</option>
                                            <option value="Software">Software</option>
                                            <option value="Servicios">Servicios</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Proveedor
                                        </label>
                                        <input
                                            type="text"
                                            value={formData.supplier}
                                            onChange={(e) => handleChange('supplier', e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                            placeholder="Nombre del proveedor"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Precio (€) *
                                        </label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            value={formData.price}
                                            onChange={(e) => handleChange('price', e.target.value)}
                                            required
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                            placeholder="0.00"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Stock Actual
                                        </label>
                                        <input
                                            type="number"
                                            value={formData.stock}
                                            onChange={(e) => handleChange('stock', e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                            placeholder="0"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Stock Mínimo
                                        </label>
                                        <input
                                            type="number"
                                            value={formData.minStock}
                                            onChange={(e) => handleChange('minStock', e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                            placeholder="0"
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Descripción
                                    </label>
                                    <textarea
                                        value={formData.description}
                                        onChange={(e) => handleChange('description', e.target.value)}
                                        rows={4}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                        placeholder="Descripción detallada del producto"
                                    />
                                </div>

                                <div className="flex justify-end gap-3 pt-6">
                                    <button
                                        type="button"
                                        onClick={onCancel}
                                        className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        type="submit"
                                        className="px-6 py-3 bg-[#006666] text-white rounded-lg hover:bg-[#005555]"
                                    >
                                        {product ? 'Actualizar' : 'Crear'} Producto
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }
            
            // Panel de Administración
            function AdminPanel({ products, onSaveProduct, onDeleteProduct }) {
                const [activeTab, setActiveTab] = useState('products');
                const [showProductForm, setShowProductForm] = useState(false);
                const [editingProduct, setEditingProduct] = useState(null);
                
                const handleAddProduct = () => {
                    setEditingProduct(null);
                    setShowProductForm(true);
                };
                
                const handleEditProduct = (product) => {
                    setEditingProduct(product);
                    setShowProductForm(true);
                };
                
                const handleSaveProduct = (productData) => {
                    onSaveProduct(productData);
                    setShowProductForm(false);
                    setEditingProduct(null);
                };
                
                if (showProductForm) {
                    return (
                        <ProductForm 
                            product={editingProduct}
                            onSave={handleSaveProduct}
                            onCancel={() => {
                                setShowProductForm(false);
                                setEditingProduct(null);
                            }}
                        />
                    );
                }
                
                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h1 className="text-3xl font-bold text-gray-900">Panel de Administración</h1>
                        </div>
                        
                        <div className="bg-white rounded-lg shadow">
                            <div className="border-b border-gray-200">
                                <nav className="flex space-x-8 px-6">
                                    <button 
                                        onClick={() => setActiveTab('products')}
                                        className={`py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'products' ? 'border-[#006666] text-[#006666]' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                                    >
                                        Gestión de Productos
                                    </button>
                                    <button 
                                        onClick={() => setActiveTab('users')}
                                        className={`py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'users' ? 'border-[#006666] text-[#006666]' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                                    >
                                        Gestión de Usuarios
                                    </button>
                                </nav>
                            </div>
                            
                            <div className="p-6">
                                {activeTab === 'products' && (
                                    <div>
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="text-xl font-semibold">Productos del Catálogo</h2>
                                            <button 
                                                onClick={handleAddProduct}
                                                className="bg-[#006666] text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-[#005555]"
                                            >
                                                <PlusIcon width={20} height={20} />
                                                Añadir Producto
                                            </button>
                                        </div>
                                        
                                        <div className="grid gap-4">
                                            {products.map(product => (
                                                <div key={product.id} className="border border-gray-200 rounded-lg p-4">
                                                    <div className="flex justify-between items-start">
                                                        <div>
                                                            <h3 className="font-semibold text-lg">{product.name}</h3>
                                                            <p className="text-gray-600">{product.description}</p>
                                                            <p className="text-sm text-gray-500">Categoría: {product.category}</p>
                                                            <p className="text-sm text-gray-500">Proveedor: {product.supplier}</p>
                                                            <p className="text-lg font-medium text-[#006666]">{product.price?.toLocaleString('es-ES')}€</p>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button 
                                                                onClick={() => handleEditProduct(product)}
                                                                className="p-2 text-blue-600 hover:bg-blue-50 rounded"
                                                            >
                                                                <EditIcon />
                                                            </button>
                                                            <button 
                                                                onClick={() => onDeleteProduct(product.id)}
                                                                className="p-2 text-red-600 hover:bg-red-50 rounded"
                                                            >
                                                                <TrashIcon />
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                {activeTab === 'users' && (
                                    <div>
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="text-xl font-semibold">Gestión de Usuarios</h2>
                                            <button className="bg-[#006666] text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-[#005555]">
                                                <PlusIcon width={20} height={20} />
                                                Invitar Usuario
                                            </button>
                                        </div>
                                        
                                        <div className="text-center py-8 text-gray-500">
                                            <p>Gestión de usuarios en desarrollo</p>
                                            <p className="text-sm">Próximamente: invitar usuarios, asignar roles, gestionar permisos</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }
            
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        }
        
        // Se llama a la función de arranque después de que la ventana completa se haya cargado.
        window.onload = startApp;
    </script>
</body>
</html>
