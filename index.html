<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expertia CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/recharts.min.js"></script>
    <link rel="icon" href="https://storage.googleapis.com/gemini-generative-ai-api/f55a1dda-6560-4321-aidb-53f36780a82f" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        @media print {
            body * { visibility: hidden; }
            #invoice-printable, #invoice-printable * { visibility: visible; }
            #invoice-printable { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="display:flex; justify-content:center; align-items:center; height:100vh; font-family: Inter, sans-serif; color: #4A5568;">
            Cargando Expertia CRM...
        </div>
    </div>

    <script src="./firebase-config.js"></script>
    <script src="./auth-simple.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, runTransaction, setDoc } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";
        
        window.firebase = {
            initializeApp, getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken,
            getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, runTransaction, setDoc
        };
    </script>

    <script type="text/babel" data-presets="react">
        function startApp() {
            console.log('Intentando iniciar aplicación...');
            console.log('React disponible:', typeof window.React !== 'undefined');
            console.log('ReactDOM disponible:', typeof window.ReactDOM !== 'undefined');
            console.log('Recharts disponible:', typeof window.Recharts !== 'undefined');
            console.log('Firebase disponible:', typeof window.firebase !== 'undefined');
            
            if (typeof window.React === 'undefined' || typeof window.ReactDOM === 'undefined') {
                console.log('Esperando React...');
                setTimeout(startApp, 100);
                return;
            }

            const { useState, useEffect, useMemo } = React;
            
            // Hacer Recharts opcional para evitar bloqueos
            let BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line;
            if (typeof window.Recharts !== 'undefined') {
                ({ BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line } = window.Recharts);
            }
            
            // Hacer Firebase opcional para el arranque inicial
            let initializeApp, getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken, getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, runTransaction, setDoc;
            if (typeof window.firebase !== 'undefined') {
                ({ initializeApp, getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken, getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, runTransaction, setDoc } = window.firebase);
            }

            // --- Íconos (SVG) ---
            const PlusIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
            const UserIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
            const EditIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>;
            const DollarSignIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>;
            const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
            const BuildingIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>;
            const MailIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>;
            const PhoneIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>;
            const CheckSquareIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>;
            const MapPinIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>;
            const TrendingUpIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>;
            const TrophyIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line><path d="m5 7 1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-12"></path><path d="M2 7h20"></path><path d="M4 19c0-2.2 1.8-4 4-4s4 1.8 4 4v0"></path><path d="M16 19c0-2.2 1.8-4 4-4s4 1.8 4 4v0"></path></svg>;
            const EmailIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22 6 12 13 2 6"></polyline></svg>;
            const DownloadIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
            const CopyIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>;
            const BellIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>;
            const MessageSquareIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>;
            const XIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
            const ChevronUpIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>;
            const ChevronDownIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>;
            const SearchIcon = ({ width = 20, height = 20 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>;
            const FilterIcon = ({ width = 20, height = 20 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>;

            // --- Funciones Utilitarias ---
            const formatAddress = (address) => {
                if (!address) return 'No especificada';
                if (typeof address === 'string') return address;
                if (typeof address === 'object') {
                    const { street = '', city = '', postalCode = '', country = '' } = address;
                    return [street, city, postalCode, country].filter(Boolean).join(', ');
                }
                return 'No especificada';
            };

            // --- Componente de Confirmación Personalizado ---
            function CustomConfirm({ isOpen, title, message, onConfirm, onCancel, type = 'warning' }) {
                if (!isOpen) return null;

                const typeConfig = {
                    warning: {
                        icon: <AlertTriangleIcon width={24} height={24} />,
                        iconColor: 'text-orange-600',
                        bgColor: 'bg-orange-50',
                        borderColor: 'border-orange-200'
                    },
                    danger: {
                        icon: <XCircleIcon width={24} height={24} />,
                        iconColor: 'text-red-600', 
                        bgColor: 'bg-red-50',
                        borderColor: 'border-red-200'
                    },
                    info: {
                        icon: <CheckIcon width={24} height={24} />,
                        iconColor: 'text-blue-600',
                        bgColor: 'bg-blue-50', 
                        borderColor: 'border-blue-200'
                    }
                };

                const config = typeConfig[type] || typeConfig.warning;

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                            <div className={`flex items-center gap-3 p-6 ${config.bgColor} ${config.borderColor} border-b rounded-t-lg`}>
                                <div className={config.iconColor}>
                                    {config.icon}
                                </div>
                                <h3 className="text-lg font-semibold text-gray-900">{title}</h3>
                            </div>
                            <div className="p-6">
                                <p className="text-gray-600 mb-6">{message}</p>
                                <div className="flex gap-3 justify-end">
                                    <button
                                        onClick={onCancel}
                                        className="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        onClick={onConfirm}
                                        className={`px-4 py-2 text-white rounded-md transition-colors ${
                                            type === 'danger' 
                                                ? 'bg-red-600 hover:bg-red-700' 
                                                : 'bg-[#006666] hover:bg-[#005555]'
                                        }`}
                                    >
                                        Confirmar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- Componente de Notificación Personalizado ---
            function CustomNotification({ isOpen, title, message, onClose, type = 'success', autoClose = true, duration = 3000 }) {
                const [isVisible, setIsVisible] = useState(false);

                useEffect(() => {
                    if (isOpen) {
                        setIsVisible(true);
                        if (autoClose) {
                            const timer = setTimeout(() => {
                                setIsVisible(false);
                                setTimeout(onClose, 300); // Esperar a que termine la animación
                            }, duration);
                            return () => clearTimeout(timer);
                        }
                    }
                }, [isOpen, autoClose, duration, onClose]);

                const typeConfig = {
                    success: {
                        icon: <CheckIcon width={24} height={24} />,
                        iconColor: 'text-green-600',
                        bgColor: 'bg-green-50',
                        borderColor: 'border-green-200',
                        progressColor: 'bg-green-500'
                    },
                    info: {
                        icon: <InfoIcon width={24} height={24} />,
                        iconColor: 'text-blue-600',
                        bgColor: 'bg-blue-50',
                        borderColor: 'border-blue-200',
                        progressColor: 'bg-blue-500'
                    },
                    warning: {
                        icon: <AlertTriangleIcon width={24} height={24} />,
                        iconColor: 'text-orange-600',
                        bgColor: 'bg-orange-50',
                        borderColor: 'border-orange-200',
                        progressColor: 'bg-orange-500'
                    }
                };

                const config = typeConfig[type] || typeConfig.success;

                if (!isOpen) return null;

                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                        <div className={`bg-white rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all duration-300 ${
                            isVisible ? 'scale-100 opacity-100' : 'scale-95 opacity-0'
                        }`}>
                            <div className={`flex items-center gap-3 p-6 ${config.bgColor} ${config.borderColor} border-b rounded-t-lg relative overflow-hidden`}>
                                <div className={config.iconColor}>
                                    {config.icon}
                                </div>
                                <div className="flex-1">
                                    <h3 className="text-lg font-semibold text-gray-900">{title}</h3>
                                    {message && <p className="text-sm text-gray-600 mt-1">{message}</p>}
                                </div>
                                <button
                                    onClick={() => {
                                        setIsVisible(false);
                                        setTimeout(onClose, 300);
                                    }}
                                    className="text-gray-400 hover:text-gray-600 transition-colors"
                                >
                                    <XIcon width={20} height={20} />
                                </button>
                                {autoClose && (
                                    <div className="absolute bottom-0 left-0 h-1 bg-gray-200 w-full">
                                        <div 
                                            className={`h-full ${config.progressColor} transition-all ease-linear`}
                                            style={{
                                                width: isVisible ? '0%' : '100%',
                                                transitionDuration: `${duration}ms`
                                            }}
                                        />
                                    </div>
                                )}
                            </div>
                            <div className="p-6">
                                <div className="flex items-center gap-3">
                                    <DownloadIcon width={20} height={20} className="text-gray-500" />
                                    <span className="text-sm text-gray-600">El archivo se ha descargado correctamente</span>
                                </div>
                                {!autoClose && (
                                    <div className="flex justify-end mt-4">
                                        <button
                                            onClick={() => {
                                                setIsVisible(false);
                                                setTimeout(onClose, 300);
                                            }}
                                            className="px-4 py-2 bg-[#006666] hover:bg-[#005555] text-white rounded-md transition-colors"
                                        >
                                            Cerrar
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            const SendIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>;
            const PrinterIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>;
            const FileTextIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>;
            const BriefcaseIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>;
            const BarChartIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>;
            const AwardIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg>;
            const CheckIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>;
            const AlertTriangleIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>;
            const XCircleIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>;
            const ClockIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
            const SmartphoneIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>;
            const MegaphoneIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 11l18 0a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2z"></path><path d="M11 11V5a3 3 0 0 0-6 0v6"></path><path d="M15 11v6a3 3 0 0 0 6 0v-6"></path></svg>;
            const StopCircleIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><rect x="9" y="9" width="6" height="6"></rect></svg>;
            const PackageIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>;
            const TagIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>;
            const SettingsIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V6a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>;
            const InfoIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>;
            const ArrowRightIcon = ({ width = 20, height = 20 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>;

            // --- Constantes de la aplicación ---
            const FUNNEL_TAGS = { 'Lead': 'bg-gray-200 text-gray-800', 'Primer Contacto': 'bg-blue-200 text-blue-800', 'Interesado': 'bg-cyan-200 text-cyan-800', 'Demo Realizada': 'bg-indigo-200 text-indigo-800', 'Negociación': 'bg-purple-200 text-purple-800', 'En Cierre': 'bg-orange-200 text-orange-800', 'Ganado': 'bg-green-200 text-green-800', 'Perdido': 'bg-red-200 text-red-800' };
            const CONTACT_PREFERENCES = { 'Email': <MailIcon />, 'Teléfono': <PhoneIcon />, 'WhatsApp': <MessageSquareIcon />, 'Visita Comercial': <BuildingIcon /> };
            const INVOICE_STATUSES = { 'Borrador': 'bg-gray-200 text-gray-800', 'Finalizada': 'bg-blue-200 text-blue-800', 'Pagada': 'bg-green-200 text-green-800', 'Anulada': 'bg-red-300 text-red-900' };
            const OFFER_STATUSES = { 'Borrador': 'bg-gray-200 text-gray-800', 'Enviada': 'bg-blue-200 text-blue-800', 'Aceptada': 'bg-green-200 text-green-800', 'Rechazada': 'bg-red-200 text-red-800', 'Expirada': 'bg-orange-200 text-orange-800' };
            const VAT_RATE = 0.21;

            // --- Función de Exportación a Excel ---
            function exportInvoicesToExcel(invoices, clients, showNotification) {
                const getClientName = (clientId) => clients.find(c => c.id === clientId)?.name || 'N/A';
                const getClientClinic = (clientId) => clients.find(c => c.id === clientId)?.clinic || 'N/A';
                
                // Preparar datos para Excel
                const excelData = invoices.map(invoice => ({
                    'Nº Factura': invoice.invoiceNumber || '',
                    'Serie': invoice.invoiceSeries || '',
                    'Tipo': invoice.type || '',
                    'Cliente': getClientName(invoice.clientId),
                    'Clínica': getClientClinic(invoice.clientId),
                    'Fecha Factura': invoice.invoiceDate || '',
                    'Fecha Vencimiento': invoice.dueDate || '',
                    'Subtotal': invoice.subtotal?.toFixed(2) || '0.00',
                    'IVA': invoice.vat?.toFixed(2) || '0.00',
                    'Total': invoice.total?.toFixed(2) || '0.00',
                    'Estado': invoice.status || '',
                    'Total Pagado': invoice.totalPaid?.toFixed(2) || '0.00',
                    'Pendiente': ((invoice.total || 0) - (invoice.totalPaid || 0)).toFixed(2)
                }));

                // Crear CSV
                const headers = Object.keys(excelData[0] || {});
                const csvContent = [
                    headers.join(','),
                    ...excelData.map(row => 
                        headers.map(header => {
                            const value = row[header];
                            // Escapar comillas y comas en los valores
                            return `"${String(value).replace(/"/g, '""')}"`;
                        }).join(',')
                    )
                ].join('\n');

                // Crear y descargar archivo
                const blob = new Blob(['\uFEFF' + csvContent], { 
                    type: 'text/csv;charset=utf-8;' 
                });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `facturas_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Mostrar notificación de éxito personalizada
                showNotification('Exportación Completada', `Se han exportado ${invoices.length} facturas correctamente`, 'success');
            }

            // --- Configuración de Firebase ---
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                // Configuración demo para desarrollo
                apiKey: "demo-api-key",
                authDomain: "expertia-crm-demo.firebaseapp.com",
                projectId: "expertia-crm-demo",
                storageBucket: "expertia-crm-demo.appspot.com",
                messagingSenderId: "123456789",
                appId: "1:123456789:web:demo-app-id"
            };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'expertia-crm-demo';

            // --- Componente Principal: App ---
            function App() {
                const [db, setDb] = useState(null);
                const [auth, setAuth] = useState(null);
                const [user, setUser] = useState(null);
                const [userProfile, setUserProfile] = useState(null);
                const [isAuthReady, setIsAuthReady] = useState(false);

                const [clients, setClients] = useState([]);
                const [invoices, setInvoices] = useState([]);
                const [products, setProducts] = useState([]);
                const [offers, setOffers] = useState([]);
                const [activeView, setActiveView] = useState('welcome');
                const [selectedItem, setSelectedItem] = useState(null);
                const [isLoading, setIsLoading] = useState(true);
                const [searchTerm, setSearchTerm] = useState('');
                const [filterTag, setFilterTag] = useState('all');

                // Estado para modal de confirmación personalizado
                const [confirmModal, setConfirmModal] = useState({
                    isOpen: false,
                    title: '',
                    message: '',
                    type: 'warning',
                    onConfirm: () => {},
                    onCancel: () => {}
                });

                // Estado para modal de notificación personalizado
                const [notificationModal, setNotificationModal] = useState({
                    isOpen: false,
                    title: '',
                    message: '',
                    type: 'success'
                });

                // Función para mostrar confirmación personalizada
                const showConfirm = (title, message, onConfirm, type = 'warning') => {
                    return new Promise((resolve) => {
                        setConfirmModal({
                            isOpen: true,
                            title,
                            message,
                            type,
                            onConfirm: () => {
                                setConfirmModal({ ...confirmModal, isOpen: false });
                                onConfirm();
                                resolve(true);
                            },
                            onCancel: () => {
                                setConfirmModal({ ...confirmModal, isOpen: false });
                                resolve(false);
                            }
                        });
                    });
                };

                // Función para mostrar notificación personalizada
                const showNotification = (title, message = '', type = 'success') => {
                    setNotificationModal({
                        isOpen: true,
                        title,
                        message,
                        type
                    });
                };

                // Función para verificar permisos
                const isAdmin = () => userProfile?.role === 'admin';
                const isCommercialOrAdmin = () => userProfile?.role === 'admin' || userProfile?.role === 'comercial';

                useEffect(() => {
                    console.log("Iniciando inicialización de Firebase...");
                    
                    if (typeof initializeApp === 'undefined') {
                        console.log("Firebase no disponible, ejecutando en modo demo");
                        // Modo demo con datos de ejemplo
                        setUser({ uid: "demo-user-123", email: "demo@expertia.com" });
                        setUserProfile({ 
                            id: "demo-user-123", 
                            email: "demo@expertia.com", 
                            name: "Usuario Demo", 
                            role: "admin" 
                        });
                        setIsAuthReady(true);
                        setIsLoading(false);
                        
                        // Cargar datos demo
                        loadDemoData();
                        return;
                    }

                    try {
                        // Inicializar Firebase
                        const app = initializeApp(firebaseConfig);
                        const firestoreDb = getFirestore(app);
                        const firebaseAuth = getAuth(app);
                        setDb(firestoreDb);
                        setAuth(firebaseAuth);

                        // Listener de autenticación
                        const unsubscribe = onAuthStateChanged(firebaseAuth, async (firebaseUser) => {
                            if (firebaseUser) {
                                setUser(firebaseUser);
                                // Cargar perfil del usuario desde Firestore
                                const userDoc = await doc(firestoreDb, 'users', firebaseUser.uid);
                                onSnapshot(userDoc, (snapshot) => {
                                    if (snapshot.exists()) {
                                        setUserProfile({ id: firebaseUser.uid, ...snapshot.data() });
                                    } else {
                                        // Usuario nuevo, crear perfil básico
                                        const newProfile = {
                                            email: firebaseUser.email,
                                            name: firebaseUser.displayName || 'Usuario',
                                            role: 'comercial', // Por defecto comercial
                                            createdAt: new Date().toISOString()
                                        };
                                        setDoc(userDoc, newProfile);
                                        setUserProfile({ id: firebaseUser.uid, ...newProfile });
                                    }
                                });
                            } else {
                                // Sin autenticación, modo demo
                                setUser({ uid: "demo-user-123", email: "demo@expertia.com" });
                                setUserProfile({ 
                                    id: "demo-user-123", 
                                    email: "demo@expertia.com", 
                                    name: "Usuario Demo", 
                                    role: "admin" 
                                });
                                loadDemoData();
                            }
                            setIsAuthReady(true);
                            setIsLoading(false);
                        });

                        return () => unsubscribe();
                    } catch (error) {
                        console.error("Error al inicializar Firebase:", error);
                        // Fallback a modo demo
                        setUser({ uid: "demo-user-123", email: "demo@expertia.com" });
                        setUserProfile({ 
                            id: "demo-user-123", 
                            email: "demo@expertia.com", 
                            name: "Usuario Demo", 
                            role: "admin" 
                        });
                        setIsAuthReady(true);
                        setIsLoading(false);
                        loadDemoData();
                    }
                }, []);

                // Función para cargar datos demo
                const loadDemoData = () => {
                    setClients([
                        { 
                            id: '1', 
                            name: 'Hospital San Juan', 
                            email: 'contacto@hospitalsanjuan.com', 
                            phone: '+34 91 123 4567', 
                            company: 'Hospital San Juan', 
                            funnelStage: 'Ganado', 
                            lastContact: '2025-07-08',
                            address: 'Calle Mayor 123, Madrid',
                            notes: 'Cliente prioritario',
                            consentGiven: true,
                            acceptsMarketing: true
                        },
                        { 
                            id: '2', 
                            name: 'Clínica Dental López', 
                            email: 'info@clinicalopez.com', 
                            phone: '+34 93 234 5678', 
                            company: 'Clínica Dental López', 
                            funnelStage: 'En Cierre', 
                            lastContact: '2025-07-07',
                            address: 'Av. Diagonal 456, Barcelona',
                            notes: 'Interesado en equipos dentales',
                            consentGiven: true,
                            acceptsMarketing: false
                        },
                        { 
                            id: '3', 
                            name: 'Centro Médico Valle', 
                            email: 'admin@centrovalle.com', 
                            phone: '+34 95 345 6789', 
                            company: 'Centro Médico Valle', 
                            funnelStage: 'Interesado', 
                            lastContact: '2025-07-06',
                            address: 'Plaza Central 789, Sevilla',
                            notes: 'Contacto inicial realizado',
                            consentGiven: true,
                            acceptsMarketing: true
                        }
                    ]);
                    
                    setProducts([
                        { 
                            id: '1', 
                            name: 'Equipo de Rayos X Digital', 
                            price: 15000, 
                            description: 'Sistema completo de radiografía digital con panel detector',
                            category: 'Diagnóstico',
                            supplier: 'Storz Medical'
                        },
                        { 
                            id: '2', 
                            name: 'Monitor de Signos Vitales', 
                            price: 3500, 
                            description: 'Monitor multiparamétrico para UCI',
                            category: 'Monitorización',
                            supplier: 'Zamar Medical'
                        },
                        { 
                            id: '3', 
                            name: 'Desfibrilador Automático', 
                            price: 8500, 
                            description: 'DEA con pantalla LCD y guía de voz',
                            category: 'Emergencias',
                            supplier: 'Storz Medical'
                        }
                    ]);
                    
                    setInvoices([
                        { 
                            id: '1', 
                            number: 'EXP-001', 
                            clientId: '1',
                            clientName: 'Hospital San Juan', 
                            amount: 15000,
                            total: 18150, // Con IVA
                            status: 'Pagada', 
                            date: '2025-07-01',
                            series: 'EXP',
                            items: [
                                { productId: '1', quantity: 1, price: 15000 }
                            ]
                        },
                        { 
                            id: '2', 
                            number: 'EXP-002', 
                            clientId: '2',
                            clientName: 'Clínica Dental López', 
                            amount: 3500,
                            total: 4235, // Con IVA
                            status: 'Finalizada', 
                            date: '2025-07-05',
                            series: 'EXP',
                            items: [
                                { productId: '2', quantity: 1, price: 3500 }
                            ]
                        }
                    ]);
                    
                    setOffers([
                        { 
                            id: 'OF-001', 
                            offerNumber: 'OF-2025-001',
                            offerSeries: 'OF',
                            clientId: '3',
                            offerDate: '2025-07-15',
                            validUntil: '2025-08-15',
                            status: 'Enviada',
                            description: 'Propuesta de equipamiento completo para Centro Médico Valle',
                            items: [
                                { 
                                    productId: '1', 
                                    description: 'Equipo de Rayos X Digital', 
                                    quantity: 1, 
                                    price: 15000 
                                },
                                { 
                                    productId: '2', 
                                    description: 'Monitor de Signos Vitales', 
                                    quantity: 2, 
                                    price: 3500 
                                }
                            ],
                            subtotal: 22000,
                            vat: 4620,
                            total: 26620,
                            terms: 'Esta oferta es válida hasta la fecha indicada. Los precios incluyen IVA. Forma de pago: 50% a la firma del contrato, 50% a la entrega. Garantía de 2 años.'
                        },
                        { 
                            id: 'OF-002', 
                            offerNumber: 'OF-2025-002',
                            offerSeries: 'OF',
                            clientId: '2',
                            offerDate: '2025-07-10',
                            validUntil: '2025-08-10',
                            status: 'Aceptada',
                            description: 'Equipos especializados para clínica dental',
                            items: [
                                { 
                                    productId: '3', 
                                    description: 'Desfibrilador Automático', 
                                    quantity: 1, 
                                    price: 8500 
                                }
                            ],
                            subtotal: 8500,
                            vat: 1785,
                            total: 10285,
                            terms: 'Oferta especial con descuento del 10%. Instalación y formación incluidas.'
                        },
                        { 
                            id: 'OF-003', 
                            offerNumber: 'OF-2025-003',
                            offerSeries: 'OF',
                            clientId: '1',
                            offerDate: '2025-06-15',
                            validUntil: '2025-07-15',
                            status: 'Expirada',
                            description: 'Renovación de equipamiento existente',
                            items: [
                                { 
                                    productId: '2', 
                                    description: 'Monitor de Signos Vitales', 
                                    quantity: 3, 
                                    price: 3500 
                                }
                            ],
                            subtotal: 10500,
                            vat: 2205,
                            total: 12705,
                            terms: 'Oferta válida hasta la fecha indicada. Sin compromiso de compra.'
                        }
                    ]);
                    
                    console.log("Datos demo cargados exitosamente");
                };

                // Listeners de Firestore con nueva estructura
                useEffect(() => {
                    if (!isAuthReady || !db || !user || !userProfile) return;
                    
                    console.log("Configurando listeners de Firestore...");
                    
                    if (!isCommercialOrAdmin()) {
                        console.log("Usuario sin permisos suficientes");
                        return;
                    }

                    const unsubscribers = [];

                    // Listener para clientes
                    const clientsCollection = collection(db, 'clientes');
                    unsubscribers.push(
                        onSnapshot(clientsCollection, (snapshot) => {
                            const clientsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setClients(clientsData);
                        }, (error) => {
                            console.error("Error loading clients:", error);
                        })
                    );

                    // Listener para productos
                    const productsCollection = collection(db, 'productos');
                    unsubscribers.push(
                        onSnapshot(productsCollection, (snapshot) => {
                            const productsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setProducts(productsData);
                        }, (error) => {
                            console.error("Error loading products:", error);
                        })
                    );

                    // Listener para facturas
                    const invoicesCollection = collection(db, 'facturas');
                    unsubscribers.push(
                        onSnapshot(invoicesCollection, (snapshot) => {
                            const invoicesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setInvoices(invoicesData);
                        }, (error) => {
                            console.error("Error loading invoices:", error);
                        })
                    );

                    // Listener para ofertas
                    const offersCollection = collection(db, 'ofertas');
                    unsubscribers.push(
                        onSnapshot(offersCollection, (snapshot) => {
                            const offersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setOffers(offersData);
                        }, (error) => {
                            console.error("Error loading offers:", error);
                        })
                    );

                    setIsLoading(false);

                    return () => {
                        unsubscribers.forEach(unsubscribe => unsubscribe());
                    };
                }, [isAuthReady, db, user, userProfile]);
                
                // --- Funciones CRUD con nueva estructura ---
                const handleSave = async (collectionName, data, docId) => {
                    if (!db || !user) {
                        console.log("Guardando en modo demo...");
                        return;
                    }
                    
                    const finalDocId = docId || data.id;
                    const { id, ...dataToSave } = data;
                    
                    // Agregar metadatos
                    dataToSave.updatedAt = new Date().toISOString();
                    dataToSave.updatedBy = user.uid;
                    
                    if (!finalDocId) {
                        dataToSave.createdAt = new Date().toISOString();
                        dataToSave.createdBy = user.uid;
                    }
                    
                    try {
                        if (finalDocId) {
                            await setDoc(doc(db, collectionName, finalDocId), dataToSave, { merge: true });
                        } else {
                            await addDoc(collection(db, collectionName), dataToSave);
                        }
                        console.log(`Guardado exitoso en ${collectionName}`);
                    } catch (error) { 
                        console.error(`Error guardando en ${collectionName}:`, error); 
                    }
                };

                const handleDelete = async (collectionName, docId) => {
                    if (!db || !user) {
                        console.log("Eliminando en modo demo...");
                        return;
                    }
                    
                    showConfirm(
                        'Confirmar eliminación',
                        '¿Estás seguro de que quieres eliminar este elemento? Esta acción no se puede deshacer.',
                        async () => {
                            try {
                                await deleteDoc(doc(db, collectionName, docId));
                                console.log(`Eliminado exitoso de ${collectionName}`);
                            } catch (error) { 
                                console.error(`Error eliminando de ${collectionName}:`, error); 
                            }
                        },
                        'danger'
                    );
                };

                // Función de eliminación sin confirmación para uso con confirmaciones personalizadas
                const handleDeleteDirect = async (collectionName, docId) => {
                    if (!db || !user) {
                        console.log("Eliminando en modo demo...");
                        return;
                    }
                    
                    try {
                        await deleteDoc(doc(db, collectionName, docId));
                        console.log(`Eliminado exitoso de ${collectionName}`);
                    } catch (error) { 
                        console.error(`Error eliminando de ${collectionName}:`, error); 
                    }
                };
                
                const handleSaveClient = async (clientData) => {
                    await handleSave('clientes', clientData, clientData.id);
                    setActiveView('dashboard');
                    setSelectedItem(null);
                };
                
                const handleSaveProfile = async (profileData) => {
                    await handleSave('users', profileData, user.uid);
                    setActiveView('dashboard');
                };

                const handleSaveProduct = async (productData) => {
                    if (!isAdmin()) {
                        showNotification('Acceso denegado', 'Solo los administradores pueden gestionar productos', 'error');
                        return;
                    }
                    await handleSave('productos', productData, productData.id);
                    setActiveView('products');
                };

                const getNextInvoiceNumber = async (type) => {
                    if (!db) {
                        // Modo demo - generar número temporal
                        const timestamp = Date.now();
                        const prefix = type === 'EXP' ? 'EXP' : 'ALQ';
                        return `${prefix}-DEMO-${timestamp}`;
                    }

                    const counterRef = doc(db, 'counters', type);
                    let nextNumber;
                    
                    try {
                        await runTransaction(db, async (transaction) => {
                            const counterDoc = await transaction.get(counterRef);
                            if (!counterDoc.exists()) {
                                const startValue = type === 'EXP' ? 1 : 1;
                                transaction.set(counterRef, { current: startValue });
                                nextNumber = startValue;
                            } else {
                                const newCurrent = counterDoc.data().current + 1;
                                transaction.update(counterRef, { current: newCurrent });
                                nextNumber = newCurrent;
                            }
                        });
                        
                        const prefix = type === 'EXP' ? 'EXP' : 'ALQ';
                        return `${prefix}${String(nextNumber).padStart(3, '0')}`;
                    } catch (error) {
                        console.error("Error obteniendo número de factura:", error);
                        const prefix = type === 'EXP' ? 'EXP' : 'ALQ';
                        return `${prefix}-ERROR-${Date.now()}`;
                    }
                };

                const handleSaveInvoice = async (invoiceData, convertFromProforma = false) => {
                    let dataToSave = { ...invoiceData };
                    
                    if (convertFromProforma || !dataToSave.id) {
                        if (dataToSave.type !== 'Factura Proforma') {
                            dataToSave.invoiceNumber = await getNextInvoiceNumber(dataToSave.invoiceSeries || 'EXP');
                        } else {
                            dataToSave.invoiceNumber = `PROFORMA-${Date.now()}`;
                        }
                    }
                    
                    await handleSave('facturas', dataToSave, dataToSave.id);
                    setActiveView('accounting');
                };

                const handleConvertToInvoice = async (proformaInvoice) => {
                    const invoiceData = {
                        ...proformaInvoice,
                        type: 'Factura',
                        status: 'Enviada',
                    };
                    await handleSaveInvoice(invoiceData, true);
                };

                const handleCreateRectificativa = async (originalInvoice) => {
                    try {
                        // Crear una nueva factura rectificativa
                        const rectificativaData = {
                            ...originalInvoice,
                            id: null, // Se generará un nuevo ID
                            type: 'Factura Rectificativa',
                            number: `${originalInvoice.number}-RECT`,
                            originalInvoiceId: originalInvoice.id,
                            originalInvoiceNumber: originalInvoice.number,
                            date: new Date().toISOString().split('T')[0],
                            status: 'Borrador',
                            total: -originalInvoice.total, // Valor negativo para rectificar
                            subtotal: -originalInvoice.subtotal,
                            totalTax: -originalInvoice.totalTax,
                            totalPaid: 0,
                            // Invertir cantidades y precios de los productos/items
                            items: (originalInvoice.items || []).map(item => ({
                                ...item,
                                quantity: -item.quantity,
                                price: item.price, // El precio se mantiene positivo
                                total: -item.total
                            }))
                        };

                        // Cambiar a vista de creación con los datos de la rectificativa
                        setSelectedItem(rectificativaData);
                        setActiveView('createInvoice');
                    } catch (error) {
                        console.error('Error creating rectificativa:', error);
                        alert('Error al crear la factura rectificativa');
                    }
                };

                const handleRegisterPayment = async (invoice, paymentAmount) => {
                    if (!db || !invoice || !paymentAmount) return;
                    
                    const newTotalPaid = (invoice.totalPaid || 0) + paymentAmount;
                    const updatedInvoice = {
                        ...invoice,
                        totalPaid: newTotalPaid,
                        status: newTotalPaid >= invoice.total ? 'Pagada' : 'Enviada',
                    };
                    
                    await handleSave('facturas', updatedInvoice, updatedInvoice.id);
                    
                    // Registrar el pago en subcolección
                    if (db && user) {
                        const paymentData = { 
                            amount: paymentAmount, 
                            date: new Date().toISOString().split('T')[0], 
                            method: 'Transferencia',
                            registeredBy: user.uid
                        };
                        await addDoc(collection(db, `facturas/${invoice.id}/payments`), paymentData);
                    }
                    
                    setSelectedItem(updatedInvoice);
                };

                // === FUNCIONES ESPECÍFICAS PARA OFERTAS ===
                const getNextOfferNumber = async (series = 'OF') => {
                    if (!db) {
                        // Modo demo - generar número temporal
                        const timestamp = Date.now();
                        return `${series}-DEMO-${timestamp}`;
                    }

                    const counterRef = doc(db, 'counters', 'offers');
                    let nextNumber;
                    
                    try {
                        await runTransaction(db, async (transaction) => {
                            const counterDoc = await transaction.get(counterRef);
                            if (!counterDoc.exists()) {
                                nextNumber = 1;
                                transaction.set(counterRef, { count: 1 });
                            } else {
                                nextNumber = counterDoc.data().count + 1;
                                transaction.update(counterRef, { count: nextNumber });
                            }
                        });
                        
                        const year = new Date().getFullYear();
                        return `${series}-${year}-${String(nextNumber).padStart(3, '0')}`;
                    } catch (error) {
                        console.error("Error getting next offer number:", error);
                        return `${series}-${Date.now()}`;
                    }
                };

                const handleSaveOffer = async (offerData) => {
                    let dataToSave = { ...offerData };
                    
                    if (!dataToSave.id) {
                        dataToSave.offerNumber = await getNextOfferNumber(dataToSave.offerSeries || 'OF');
                    }
                    
                    await handleSave('ofertas', dataToSave, dataToSave.id);
                    setActiveView('offers');
                };

                const handleAcceptOffer = async (offerId) => {
                    const offer = offers.find(o => o.id === offerId);
                    if (offer) {
                        const updatedOffer = { ...offer, status: 'Aceptada' };
                        await handleSave('ofertas', updatedOffer, offerId);
                        setSelectedItem(updatedOffer);
                    }
                };

                const handleRejectOffer = async (offerId) => {
                    const offer = offers.find(o => o.id === offerId);
                    if (offer) {
                        const updatedOffer = { ...offer, status: 'Rechazada' };
                        await handleSave('ofertas', updatedOffer, offerId);
                        setSelectedItem(updatedOffer);
                    }
                };

                const handleExpireOffer = async (offerId) => {
                    const offer = offers.find(o => o.id === offerId);
                    if (offer) {
                        const updatedOffer = { ...offer, status: 'Expirada' };
                        await handleSave('ofertas', updatedOffer, offerId);
                        setSelectedItem(updatedOffer);
                    }
                };

                const handleConvertOfferToInvoice = async (offer) => {
                    if (offer.status !== 'Aceptada') {
                        showNotification('Error de conversión', 'Solo se pueden convertir ofertas aceptadas en facturas', 'error');
                        return;
                    }

                    const invoiceData = {
                        clientId: offer.clientId,
                        invoiceDate: new Date().toISOString().split('T')[0],
                        dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'Borrador',
                        type: 'Factura',
                        invoiceSeries: 'EXP',
                        items: offer.items || [],
                        subtotal: offer.subtotal,
                        vat: offer.vat,
                        total: offer.total,
                        originOfferId: offer.id,
                        originOfferNumber: offer.offerNumber
                    };

                    await handleSaveInvoice(invoiceData);
                    
                    // Opcional: actualizar estado de la oferta a "Convertida"
                    // const updatedOffer = { ...offer, status: 'Convertida' };
                    // await handleSave('ofertas', updatedOffer, offer.id);
                    
                    showNotification('Conversión exitosa', 'La oferta ha sido convertida exitosamente en factura', 'success');
                };

                const filteredClients = useMemo(() => clients.filter(client =>
                    (searchTerm === '' || client.name.toLowerCase().includes(searchTerm.toLowerCase()) || client.clinic.toLowerCase().includes(searchTerm.toLowerCase())) &&
                    (filterTag === 'all' || client.tag === filterTag)
                ), [clients, searchTerm, filterTag]);

                const renderView = () => {
                    if (!isCommercialOrAdmin() && activeView !== 'profile' && activeView !== 'welcome') {
                        return (
                            <div className="p-6 text-center">
                                <h2 className="text-xl font-semibold text-gray-800 mb-4">Acceso Restringido</h2>
                                <p className="text-gray-600">No tienes permisos para acceder a esta funcionalidad.</p>
                                <p className="text-sm text-gray-500 mt-2">Contacta con un administrador para obtener acceso.</p>
                            </div>
                        );
                    }

                    switch (activeView) {
                        case 'welcome':
                            return <WelcomeScreen 
                                userProfile={userProfile}
                                clients={clients}
                                invoices={invoices}
                                offers={offers}
                                onNavigate={setActiveView}
                            />;
                        case 'profile': 
                            return <ProfileForm userProfile={userProfile} onSave={handleSaveProfile} onBack={() => setActiveView('dashboard')} />;
                        case 'bulkCommunication': 
                            return <BulkCommunication clients={clients} onBack={() => setActiveView('dashboard')} />;
                        case 'addClient': 
                            return <ClientForm onSave={handleSaveClient} onCancel={() => setActiveView('dashboard')} showNotification={showNotification} />;
                        case 'editClient': 
                            return <ClientForm client={selectedItem} onSave={handleSaveClient} onCancel={() => setActiveView('dashboard')} showNotification={showNotification} />;
                        case 'detailClient': 
                            return <ClientDetail 
                                client={selectedItem} 
                                db={db} 
                                user={user} 
                                onEdit={() => { setSelectedItem(selectedItem); setActiveView('editClient'); }} 
                                onDelete={() => {
                                    showConfirm(
                                        'Eliminar Cliente',
                                        `¿Estás seguro de que quieres eliminar el cliente "${selectedItem.name}"? Esta acción no se puede deshacer.`,
                                        async () => {
                                            await handleDeleteDirect('clientes', selectedItem.id);
                                            setActiveView('dashboard');
                                            setSelectedItem(null);
                                        },
                                        'danger'
                                    );
                                }} 
                                onBack={() => setActiveView('dashboard')} 
                                onCreateInvoice={() => { setSelectedItem({ client: selectedItem }); setActiveView('createInvoice'); }} 
                                onGenerateConsent={() => { setSelectedItem(selectedItem); setActiveView('consentForm'); }} 
                            />;
                        case 'consentForm': 
                            return <ConsentForm client={selectedItem} onBack={() => { setSelectedItem(selectedItem); setActiveView('detailClient'); }} />;
                        case 'offers': 
                            return <OffersDashboard 
                                offers={offers} 
                                clients={clients} 
                                products={products} 
                                onCreateOffer={() => setActiveView('createOffer')} 
                                onViewOffer={(offer) => { setSelectedItem(offer); setActiveView('viewOffer'); }} 
                                onEditOffer={(offer) => { setSelectedItem(offer); setActiveView('editOffer'); }} 
                                onDeleteOffer={(id) => handleDelete('ofertas', id)} 
                                showConfirm={showConfirm}
                            />;
                        case 'createOffer': 
                            return <OfferForm 
                                clients={clients} 
                                products={products} 
                                onSave={handleSaveOffer} 
                                onCancel={() => setActiveView('offers')} 
                                offerData={selectedItem}
                            />;
                        case 'viewOffer': 
                            return <OfferDetail 
                                offer={selectedItem} 
                                clients={clients} 
                                onBack={() => setActiveView('offers')} 
                                onAcceptOffer={handleAcceptOffer}
                                onRejectOffer={handleRejectOffer}
                                onExpireOffer={handleExpireOffer}
                                onConvertToInvoice={handleConvertOfferToInvoice}
                            />;
                        case 'editOffer': 
                            return <OfferForm 
                                clients={clients} 
                                products={products} 
                                onSave={handleSaveOffer} 
                                onCancel={() => setActiveView('offers')} 
                                offerData={selectedItem}
                            />;
                        case 'products': 
                            return <ProductsDashboard 
                                products={products} 
                                onCreateProduct={() => setActiveView('createProduct')} 
                                onEditProduct={(product) => { setSelectedItem(product); setActiveView('editProduct'); }} 
                                onDeleteProduct={(id) => handleDeleteDirect('productos', id)} 
                                showConfirm={showConfirm}
                            />;
                        case 'createProduct': 
                            return <ProductForm 
                                onSave={handleSaveProduct} 
                                onCancel={() => setActiveView('products')} 
                            />;
                        case 'editProduct': 
                            return <ProductForm 
                                product={selectedItem}
                                onSave={handleSaveProduct} 
                                onCancel={() => setActiveView('products')} 
                            />;
                        case 'accounting': 
                            return <AccountingDashboard 
                                invoices={invoices} 
                                clients={clients} 
                                onCreateInvoice={() => { setSelectedItem(null); setActiveView('createInvoice'); }} 
                                onViewInvoice={(invoice) => { setSelectedItem(invoice); setActiveView('viewInvoice'); }} 
                                onDeleteInvoice={(id) => handleDelete('facturas', id)}
                                showConfirm={showConfirm}
                                showNotification={showNotification}
                            />;
                        case 'createInvoice': 
                            return <InvoiceForm 
                                clients={clients} 
                                products={products} 
                                onSave={handleSaveInvoice} 
                                onCancel={() => setActiveView('accounting')} 
                                invoiceData={selectedItem} 
                            />;
                        case 'viewInvoice': 
                            return <InvoiceDetail 
                                invoice={selectedItem} 
                                clients={clients} 
                                onBack={() => setActiveView('accounting')} 
                                onRegisterPayment={handleRegisterPayment} 
                                db={db} 
                                user={user} 
                                onConvertToInvoice={handleConvertToInvoice} 
                                onCreateRectificativa={handleCreateRectificativa}
                                showConfirm={showConfirm}
                                showNotification={showNotification}
                            />;
                        case 'reports': 
                            return <ReportsDashboard allInvoices={invoices} />;
                        case 'admin':
                            if (!isAdmin()) {
                                return (
                                    <div className="p-6 text-center">
                                        <h2 className="text-xl font-semibold text-red-600 mb-4">Acceso Denegado</h2>
                                        <p className="text-gray-600">Solo los administradores pueden acceder al panel de administración.</p>
                                    </div>
                                );
                            }
                            return <AdminPanel 
                                users={[]} 
                                products={products}
                                onSaveProduct={handleSaveProduct}
                                onDeleteProduct={(id) => handleDelete('productos', id)}
                            />;
                        default: 
                            return <Dashboard 
                                clients={filteredClients} 
                                allClients={clients} 
                                onAddClient={() => setActiveView('addClient')} 
                                onBulkComm={() => setActiveView('bulkCommunication')} 
                                onViewClient={(client) => { setSelectedItem(client); setActiveView('detailClient'); }} 
                                onEditClient={(client) => { setSelectedItem(client); setActiveView('editClient'); }} 
                                onDeleteClient={(client) => {
                                    showConfirm(
                                        'Eliminar Cliente',
                                        `¿Estás seguro de que quieres eliminar el cliente "${client.name}"? Esta acción no se puede deshacer.`,
                                        async () => {
                                            await handleDeleteDirect('clientes', client.id);
                                        },
                                        'danger'
                                    );
                                }} 
                                searchTerm={searchTerm} 
                                setSearchTerm={setSearchTerm} 
                                filterTag={filterTag} 
                                setFilterTag={setFilterTag} 
                            />;
                    }
                };

                return (
                    <div className="bg-gray-50 min-h-screen font-sans">
                        <Header userProfile={userProfile} activeView={activeView} setActiveView={setActiveView} />
                        <main className="p-4 sm:p-6 md:p-8">{renderView()}</main>
                        
                        {/* Modal de confirmación personalizado */}
                        <CustomConfirm 
                            isOpen={confirmModal.isOpen}
                            title={confirmModal.title}
                            message={confirmModal.message}
                            type={confirmModal.type}
                            onConfirm={confirmModal.onConfirm}
                            onCancel={confirmModal.onCancel}
                        />
                        
                        {/* Modal de notificación personalizado */}
                        <CustomNotification 
                            isOpen={notificationModal.isOpen}
                            title={notificationModal.title}
                            message={notificationModal.message}
                            type={notificationModal.type}
                            onClose={() => setNotificationModal({ ...notificationModal, isOpen: false })}
                        />
                    </div>
                );
            }

            // --- Componentes ---
            // Componente de Pantalla de Bienvenida
            function WelcomeScreen({ userProfile, clients, invoices, offers, onNavigate }) {
                const totalClients = clients.length;
                const totalInvoices = invoices.length;
                const totalOffers = offers.length;
                
                // Calcular métricas
                const clientsGanados = clients.filter(c => c.funnelStage === 'Ganado').length;
                const invoicesPagadas = invoices.filter(i => i.status === 'Pagada').length;
                const offersAceptadas = offers.filter(o => o.status === 'Aceptada').length;
                
                const totalRevenue = invoices
                    .filter(i => i.status === 'Pagada')
                    .reduce((sum, i) => sum + (i.total || 0), 0);
                
                const currentDate = new Date().toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                return (
                    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-white">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            {/* Saludo de bienvenida */}
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-900 mb-2">¡Bienvenido, {userProfile?.name}!</h1>
                                <p className="text-lg text-gray-600">{currentDate}</p>
                                <p className="text-sm text-gray-500 mt-2">Sistema CRM - Expertia Medical Solutions</p>
                            </div>
                            
                            {/* Métricas principales */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                <StatCard 
                                    title="Total Clientes" 
                                    value={totalClients}
                                    icon={<UserIcon width={32} height={32} />}
                                    className="bg-white border-2 border-green-200 text-gray-900"
                                />
                                <StatCard 
                                    title="Clientes Ganados" 
                                    value={clientsGanados}
                                    icon={<AwardIcon width={32} height={32} />}
                                    className="bg-white border-2 border-green-200 text-gray-900"
                                />
                                <StatCard 
                                    title="Facturas Pagadas" 
                                    value={invoicesPagadas}
                                    icon={<FileTextIcon width={32} height={32} />}
                                    className="bg-white border-2 border-green-200 text-gray-900"
                                />
                                <StatCard 
                                    title="Ingresos Totales" 
                                    value={`€${totalRevenue.toLocaleString('es-ES', { minimumFractionDigits: 2 })}`}
                                    icon={<DollarSignIcon width={32} height={32} />}
                                    className="bg-white border-2 border-green-200 text-gray-900"
                                />
                            </div>
                            
                            {/* Resumen de actividad reciente */}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                                {/* Resumen de ofertas */}
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-lg font-semibold text-gray-900">Estado de Ofertas</h3>
                                        <PackageIcon width={24} height={24} className="text-gray-400" />
                                    </div>
                                    <div className="space-y-3">
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Total ofertas</span>
                                            <span className="font-medium text-gray-900">{totalOffers}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Aceptadas</span>
                                            <span className="font-medium text-green-600">{offersAceptadas}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Pendientes</span>
                                            <span className="font-medium text-orange-600">{offers.filter(o => o.status === 'Enviada').length}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Resumen de facturas */}
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-lg font-semibold text-gray-900">Estado de Facturas</h3>
                                        <FileTextIcon width={24} height={24} className="text-gray-400" />
                                    </div>
                                    <div className="space-y-3">
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Total facturas</span>
                                            <span className="font-medium text-gray-900">{totalInvoices}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Pagadas</span>
                                            <span className="font-medium text-green-600">{invoicesPagadas}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Pendientes</span>
                                            <span className="font-medium text-orange-600">{invoices.filter(i => i.status === 'Finalizada').length}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Pie de la pantalla de bienvenida */}
                            <div className="text-center mt-8 py-6">
                                <p className="text-sm text-gray-500">
                                    Expertia Medical Solutions - Sistema CRM para equipos médicos
                                </p>
                                <button 
                                    onClick={() => onNavigate('dashboard')}
                                    className="mt-4 inline-flex items-center px-6 py-2 bg-[#006666] text-white rounded-md hover:bg-[#005555] transition-colors"
                                >
                                    <BarChartIcon width={20} height={20} className="mr-2" />
                                    Ir al Dashboard Principal
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }
            
            function Header({ userProfile, activeView, setActiveView }) {
                const navItemClass = (viewName) => `cursor-pointer py-2 px-3 rounded-md text-sm font-medium flex items-center gap-2 ${activeView.startsWith(viewName) ? 'bg-[#006666] text-white' : 'text-gray-600 hover:bg-gray-200'}`;
                const isAdmin = userProfile?.role === 'admin';
                
                return (
                    <header className="bg-white shadow-md sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-20">
                                <div className="flex items-center">
                                    {activeView === 'welcome' ? (
                                        <img src="./LOGO_EXPERTIA.jpg" alt="Expertia Medical Solutions Logo" className="h-12 w-auto" />
                                    ) : (
                                        <button 
                                            onClick={() => setActiveView('welcome')}
                                            className="hover:opacity-80 transition-opacity"
                                            title="Volver al inicio"
                                        >
                                            <img src="./LOGO_EXPERTIA.jpg" alt="Expertia Medical Solutions Logo" className="h-12 w-auto" />
                                        </button>
                                    )}
                                </div>
                                <nav className="flex items-center gap-4">
                                    <span onClick={() => setActiveView('dashboard')} className={navItemClass('dashboard')}>
                                        <UserIcon width={16} height={16} /> Clientes
                                    </span>
                                    <span onClick={() => setActiveView('offers')} className={navItemClass('offers')}>
                                        <FileTextIcon width={16} height={16}/> Ofertas
                                    </span>
                                    <span onClick={() => setActiveView('products')} className={navItemClass('products')}>
                                        <BriefcaseIcon width={16} height={16} /> Productos
                                    </span>
                                    <span onClick={() => setActiveView('accounting')} className={navItemClass('accounting')}>
                                        <DollarSignIcon /> Contabilidad
                                    </span>
                                    <span onClick={() => setActiveView('reports')} className={navItemClass('reports')}>
                                        <TrendingUpIcon width={16} height={16} /> Informes
                                    </span>
                                    {isAdmin && (
                                        <span onClick={() => setActiveView('admin')} className={navItemClass('admin')}>
                                            <CheckSquareIcon /> Admin
                                        </span>
                                    )}
                                </nav>
                                <div className="flex items-center gap-3 cursor-pointer" onClick={() => setActiveView('profile')}>
                                    <div className="flex flex-col text-right">
                                        <div className="text-sm text-gray-600">{userProfile?.name || 'Usuario'}</div>
                                        <div className="text-xs text-gray-500 capitalize">{userProfile?.role || 'comercial'}</div>
                                    </div>
                                    <img src={userProfile?.photoURL || 'https://placehold.co/40x40/008080/FFFFFF?text=U'} alt="Perfil" className="h-10 w-10 rounded-full object-cover" />
                                </div>
                            </div>
                        </div>
                    </header>
                );
            }

            // ... (El resto de los componentes se definen aquí, igual que en la versión anterior) ...
            
            // Componente Dashboard simplificado para demo
            function Dashboard({ clients, onAddClient, onViewClient, onEditClient, onDeleteClient, searchTerm, setSearchTerm }) {
                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h1 className="text-3xl font-bold text-gray-900">Dashboard de Clientes</h1>
                            <button onClick={onAddClient} className="bg-[#006666] text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-[#005555]">
                                <PlusIcon width={20} height={20} />
                                Añadir Cliente
                            </button>
                        </div>
                        
                        <div className="bg-white rounded-lg shadow p-6">
                            <div className="mb-4">
                                <input 
                                    type="text" 
                                    placeholder="Buscar clientes..." 
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg"
                                />
                            </div>
                            
                            <div className="grid gap-4">
                                {clients.map(client => (
                                    <div key={client.id} className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                        <div className="flex justify-between items-start">
                                            <div className="cursor-pointer flex-1" onClick={() => onViewClient(client)}>
                                                <h3 className="font-semibold text-lg">{client.name}</h3>
                                                <p className="text-gray-600">{client.company}</p>
                                                <p className="text-sm text-gray-500">{client.email}</p>
                                                <p className="text-sm text-gray-500">{client.phone}</p>
                                            </div>
                                            <div className="flex items-center gap-2 ml-4">
                                                <span className={`px-3 py-1 rounded-full text-xs font-medium ${FUNNEL_TAGS[client.funnelStage] || 'bg-gray-200 text-gray-800'}`}>
                                                    {client.funnelStage}
                                                </span>
                                                <div className="flex gap-1">
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            onEditClient(client);
                                                        }}
                                                        className="p-2 text-blue-600 hover:bg-blue-50 rounded"
                                                        title="Editar cliente"
                                                    >
                                                        <EditIcon width={16} height={16} />
                                                    </button>
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            onDeleteClient(client);
                                                        }}
                                                        className="p-2 text-red-600 hover:bg-red-50 rounded"
                                                        title="Eliminar cliente"
                                                    >
                                                        <TrashIcon />
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }
            
            // Componentes de formulario helper
            function FormField({ label, as = "input", ...props }) {
                const Component = as === "textarea" ? "textarea" : "input";
                return (
                    <div>
                        {label && <label htmlFor={props.name} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
                        <Component id={props.name} {...props} className="block w-full rounded-md border-2 border-gray-400 shadow-sm focus:border-[#006666] focus:ring-[#006666] hover:border-gray-500 sm:text-sm p-3 transition-colors" />
                    </div>
                );
            }

            function FormSelect({ label, options, ...props }) {
                return (
                    <div>
                        <label htmlFor={props.name} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                        <select id={props.name} {...props} className="mt-1 block w-full rounded-md border-2 border-gray-400 shadow-sm focus:border-[#006666] focus:ring-[#006666] hover:border-gray-500 sm:text-sm p-3 transition-colors">
                            {options.map(opt => <option key={opt.value || opt} value={opt.value || opt}>{opt.label || opt}</option>)}
                        </select>
                    </div>
                );
            }
            
            // === COMPONENTE STATCARD PARA MÉTRICAS ===
            function StatCard({ title, value, icon, className = "bg-white" }) {
                return (
                    <div className={`p-6 rounded-lg shadow ${className}`}>
                        <div className="flex items-center justify-between">
                            <div>
                                <h3 className="text-sm font-medium text-gray-600">{title}</h3>
                                <p className="text-2xl font-bold mt-1 text-gray-900">{value}</p>
                            </div>
                            <div className="text-gray-700">
                                {icon}
                            </div>
                        </div>
                    </div>
                );
            }
            
            // Formulario de Cliente
            function ClientForm({ client = {}, onSave, onCancel, showNotification }) {
                const [formData, setFormData] = useState({
                    id: client.id || null, 
                    name: client.name || '', 
                    company: client.company || '',
                    email: client.email || '', 
                    phone: client.phone || '', 
                    address: client.address || '',
                    funnelStage: client.funnelStage || 'Lead', 
                    contactPreference: client.contactPreference || 'Email',
                    productInterest: client.productInterest || [], 
                    notes: client.notes || '', 
                    consentGiven: client.consentGiven || false,
                    acceptsMarketing: client.acceptsMarketing || false,
                    lastContact: client.lastContact || new Date().toISOString().split('T')[0]
                });

                const handleChange = (e) => {
                    const { name, value, type, checked } = e.target;
                    setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
                };

                const handleBrandChange = (e) => {
                    const { value, checked } = e.target;
                    setFormData(prev => {
                        const interests = prev.productInterest;
                        if (checked) return { ...prev, productInterest: [...interests, value] };
                        else return { ...prev, productInterest: interests.filter(b => b !== value) };
                    });
                };

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (!formData.consentGiven) {
                        showNotification('Consentimiento requerido', 'Debe obtener el consentimiento del cliente para guardar sus datos según el RGPD.', 'error');
                        return;
                    }
                    onSave(formData);
                };

                return (
                    <div className="max-w-4xl mx-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-3xl font-bold text-gray-900">
                                {client.id ? 'Editar Cliente' : 'Nuevo Cliente'}
                            </h1>
                            <button onClick={onCancel} className="text-gray-500 hover:text-gray-700">
                                <XIcon width={24} height={24} />
                            </button>
                        </div>

                        <form onSubmit={handleSubmit} className="bg-white p-8 rounded-lg shadow-lg space-y-6">
                            <fieldset className="grid grid-cols-1 md:grid-cols-2 gap-6 border p-4 rounded-md">
                                <legend className="text-lg font-semibold px-2">Información de Contacto</legend>
                                <FormField label="Nombre del Contacto" name="name" value={formData.name} onChange={handleChange} required />
                                <FormField label="Empresa/Clínica" name="company" value={formData.company} onChange={handleChange} required />
                                <FormField label="Email" name="email" type="email" value={formData.email} onChange={handleChange} required />
                                <FormField label="Teléfono" name="phone" value={formData.phone} onChange={handleChange} />
                            </fieldset>

                            <fieldset className="border p-4 rounded-md">
                                <legend className="text-lg font-semibold px-2">Dirección</legend>
                                <div className="mt-4">
                                    <FormField label="Dirección Completa" name="address" value={formData.address} onChange={handleChange} />
                                </div>
                            </fieldset>

                            <fieldset className="grid grid-cols-1 md:grid-cols-2 gap-6 border p-4 rounded-md">
                                <legend className="text-lg font-semibold px-2">Datos Comerciales</legend>
                                <FormSelect 
                                    label="Fase del Embudo" 
                                    name="funnelStage" 
                                    value={formData.funnelStage} 
                                    onChange={handleChange} 
                                    options={Object.keys(FUNNEL_TAGS)} 
                                />
                                <FormSelect 
                                    label="Contacto Preferente" 
                                    name="contactPreference" 
                                    value={formData.contactPreference} 
                                    onChange={handleChange} 
                                    options={Object.keys(CONTACT_PREFERENCES)} 
                                />
                                <FormField 
                                    label="Último Contacto" 
                                    name="lastContact" 
                                    type="date" 
                                    value={formData.lastContact} 
                                    onChange={handleChange} 
                                />
                                <div className="md:col-span-1">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Interesado en</label>
                                    <div className="flex flex-wrap gap-4">
                                        {['STORZ MEDICAL', 'ZAMAR', 'Equipos Diagnóstico', 'Software Médico'].map(interest => (
                                            <label key={interest} className="flex items-center gap-2">
                                                <input 
                                                    type="checkbox" 
                                                    value={interest} 
                                                    checked={formData.productInterest.includes(interest)} 
                                                    onChange={handleBrandChange} 
                                                    className="h-4 w-4 rounded border-gray-300 text-[#006666] focus:ring-[#006666]" 
                                                />
                                                {interest}
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            </fieldset>

                            <div>
                                <label htmlFor="notes" className="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                                <textarea 
                                    id="notes" 
                                    name="notes" 
                                    rows="4" 
                                    value={formData.notes} 
                                    onChange={handleChange} 
                                    className="block w-full rounded-md border-gray-300 shadow-sm focus:border-[#006666] focus:ring-[#006666] sm:text-sm p-3" 
                                    placeholder="Añadir notas sobre el cliente..."
                                />
                            </div>

                            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 space-y-3">
                                <div className="flex items-start">
                                    <input 
                                        id="consentGiven" 
                                        name="consentGiven" 
                                        type="checkbox" 
                                        checked={formData.consentGiven} 
                                        onChange={handleChange} 
                                        className="h-4 w-4 mt-1 rounded border-gray-300 text-[#006666] focus:ring-[#006666]" 
                                    />
                                    <label htmlFor="consentGiven" className="ml-3 text-sm text-yellow-800">
                                        <strong>Confirmo que el cliente ha dado su consentimiento</strong> para el tratamiento de sus datos para la gestión del servicio (RGPD).
                                    </label>
                                </div>
                                <div className="flex items-start">
                                    <input 
                                        id="acceptsMarketing" 
                                        name="acceptsMarketing" 
                                        type="checkbox" 
                                        checked={formData.acceptsMarketing} 
                                        onChange={handleChange} 
                                        className="h-4 w-4 mt-1 rounded border-gray-300 text-[#006666] focus:ring-[#006666]" 
                                    />
                                    <label htmlFor="acceptsMarketing" className="ml-3 text-sm text-yellow-800">
                                        Confirmo que el cliente ha dado su consentimiento explícito para recibir comunicaciones comerciales.
                                    </label>
                                </div>
                            </div>

                            <div className="flex justify-end gap-4 pt-6">
                                <button 
                                    type="button" 
                                    onClick={onCancel} 
                                    className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                >
                                    Cancelar
                                </button>
                                <button 
                                    type="submit" 
                                    className="px-6 py-3 bg-[#006666] text-white rounded-lg hover:bg-[#005555]"
                                >
                                    {client.id ? 'Actualizar' : 'Crear'} Cliente
                                </button>
                            </div>
                        </form>
                    </div>
                );
            }
            
            // Detalle de Cliente
            function ClientDetail({ client, db, user, onEdit, onDelete, onBack, onCreateInvoice, onGenerateConsent }) {
                if (!client) return <div>Cliente no encontrado</div>;

                // Estado para recordatorios
                const [reminders, setReminders] = useState([]);
                const [newReminder, setNewReminder] = useState({ text: '', dueDate: '' });

                // Cargar recordatorios del cliente
                useEffect(() => {
                    if (!db || !user || !client.id) return;
                    
                    const remindersPath = `clientes/${client.id}/recordatorios`;
                    const q = query(collection(db, remindersPath));
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const remindersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setReminders(remindersData);
                    }, (error) => {
                        console.error("Error loading reminders:", error);
                        // En modo demo, usar recordatorios vacíos
                        setReminders([]);
                    });
                    return () => unsubscribe();
                }, [db, user, client.id]);

                // Agregar nuevo recordatorio
                const handleAddReminder = async (e) => {
                    e.preventDefault();
                    if (!newReminder.text || !newReminder.dueDate) return;
                    
                    if (!db || !user) {
                        // Modo demo - simular agregado
                        const demoReminder = {
                            id: Date.now().toString(),
                            text: newReminder.text,
                            dueDate: newReminder.dueDate,
                            createdAt: new Date().toISOString(),
                            createdBy: user.uid
                        };
                        setReminders(prev => [...prev, demoReminder]);
                        setNewReminder({ text: '', dueDate: '' });
                        return;
                    }

                    try {
                        const remindersPath = `clientes/${client.id}/recordatorios`;
                        const reminderData = {
                            text: newReminder.text,
                            dueDate: newReminder.dueDate,
                            createdAt: new Date().toISOString(),
                            createdBy: user.uid
                        };
                        await addDoc(collection(db, remindersPath), reminderData);
                        setNewReminder({ text: '', dueDate: '' });
                    } catch (error) {
                        console.error("Error adding reminder:", error);
                        alert('Error al agregar recordatorio');
                    }
                };

                // Eliminar recordatorio
                const handleDeleteReminder = async (reminderId) => {
                    if (!db || !user) {
                        // Modo demo - simular eliminación
                        setReminders(prev => prev.filter(r => r.id !== reminderId));
                        return;
                    }

                    try {
                        const reminderPath = `clientes/${client.id}/recordatorios/${reminderId}`;
                        await deleteDoc(doc(db, reminderPath));
                    } catch (error) {
                        console.error("Error deleting reminder:", error);
                        alert('Error al eliminar recordatorio');
                    }
                };

                return (
                    <div className="max-w-4xl mx-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-3xl font-bold text-gray-900">{client.name}</h1>
                            <button onClick={onBack} className="text-gray-500 hover:text-gray-700">
                                <XIcon width={24} height={24} />
                            </button>
                        </div>

                        <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                            <div className="p-6">
                                <div className="flex justify-between items-start mb-6">
                                    <div>
                                        <h2 className="text-2xl font-semibold text-gray-800">{client.company}</h2>
                                        <span className={`inline-block px-3 py-1 rounded-full text-sm font-medium mt-2 ${FUNNEL_TAGS[client.funnelStage] || 'bg-gray-200 text-gray-800'}`}>
                                            {client.funnelStage}
                                        </span>
                                    </div>
                                    <div className="flex gap-2">
                                        <button 
                                            onClick={() => onEdit(client)}
                                            className="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200"
                                            title="Editar cliente"
                                        >
                                            <EditIcon />
                                        </button>
                                        <button 
                                            onClick={() => onDelete(client.id)}
                                            className="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200"
                                            title="Eliminar cliente"
                                        >
                                            <TrashIcon />
                                        </button>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-800 mb-4">Información de Contacto</h3>
                                        <div className="space-y-3">
                                            <div className="flex items-center gap-3">
                                                <MailIcon />
                                                <div>
                                                    <span className="text-sm text-gray-500">Email</span>
                                                    <p className="font-medium">{client.email}</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <PhoneIcon />
                                                <div>
                                                    <span className="text-sm text-gray-500">Teléfono</span>
                                                    <p className="font-medium">{client.phone}</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <MapPinIcon />
                                                <div>
                                                    <span className="text-sm text-gray-500">Dirección</span>
                                                    <p className="font-medium">{formatAddress(client.address)}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-800 mb-4">Datos Comerciales</h3>
                                        <div className="space-y-3">
                                            <div>
                                                <span className="text-sm text-gray-500">Último Contacto</span>
                                                <p className="font-medium">{client.lastContact ? new Date(client.lastContact).toLocaleDateString('es-ES') : 'No registrado'}</p>
                                            </div>
                                            <div>
                                                <span className="text-sm text-gray-500">Contacto Preferente</span>
                                                <p className="font-medium">{client.contactPreference || 'No especificado'}</p>
                                            </div>
                                            <div>
                                                <span className="text-sm text-gray-500">Intereses</span>
                                                <div className="flex flex-wrap gap-2 mt-1">
                                                    {client.productInterest?.length > 0 ? 
                                                        client.productInterest.map(interest => (
                                                            <span key={interest} className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                                                {interest}
                                                            </span>
                                                        )) :
                                                        <span className="text-gray-500 text-sm">No especificados</span>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {client.notes && (
                                    <div className="mt-8 pt-6 border-t border-gray-200">
                                        <h3 className="text-lg font-semibold text-gray-800 mb-3">Notas</h3>
                                        <div className="bg-gray-50 p-4 rounded-lg">
                                            <p className="text-gray-700 whitespace-pre-wrap">{client.notes}</p>
                                        </div>
                                    </div>
                                )}

                                <div className="mt-8 pt-6 border-t border-gray-200">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-4">Consentimientos RGPD</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="bg-gray-50 p-4 rounded-lg">
                                            <div className="flex items-center gap-2">
                                                {client.consentGiven ? 
                                                    <CheckIcon width={16} height={16} className="text-green-600" /> : 
                                                    <XCircleIcon width={16} height={16} className="text-red-600" />
                                                }
                                                <span className="font-medium">Consentimiento de Datos</span>
                                            </div>
                                            <p className="text-sm text-gray-600 mt-1">
                                                {client.consentGiven ? 'Consentimiento otorgado' : 'Consentimiento pendiente'}
                                            </p>
                                        </div>
                                        <div className="bg-gray-50 p-4 rounded-lg">
                                            <div className="flex items-center gap-2">
                                                {client.acceptsMarketing ? 
                                                    <CheckIcon width={16} height={16} className="text-green-600" /> : 
                                                    <EmailIcon width={16} height={16} className="text-gray-600" />
                                                }
                                                <span className="font-medium">Marketing</span>
                                            </div>
                                            <p className="text-sm text-gray-600 mt-1">
                                                {client.acceptsMarketing ? 'Acepta comunicaciones' : 'No acepta marketing'}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                {/* Sistema de Recordatorios/Tareas */}
                                <div className="mt-8 pt-6 border-t border-gray-200">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                        <BellIcon />
                                        Tareas y Recordatorios
                                    </h3>
                                    
                                    {/* Lista de recordatorios existentes */}
                                    <div className="space-y-2 mb-4 max-h-60 overflow-y-auto">
                                        {reminders.length > 0 ? (
                                            reminders.map(reminder => (
                                                <div key={reminder.id} className="bg-gray-50 p-3 rounded-lg flex justify-between items-start">
                                                    <div className="flex-1">
                                                        <p className="text-gray-800 font-medium">{reminder.text}</p>
                                                        <div className="flex items-center gap-2 mt-1">
                                                            <span className="text-xs text-gray-500">
                                                                Vence: {new Date(reminder.dueDate).toLocaleDateString('es-ES')}
                                                            </span>
                                                            {new Date(reminder.dueDate) < new Date() && (
                                                                <span className="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full">
                                                                    Vencido
                                                                </span>
                                                            )}
                                                            {new Date(reminder.dueDate).toDateString() === new Date().toDateString() && (
                                                                <span className="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full">
                                                                    Hoy
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <button 
                                                        onClick={() => handleDeleteReminder(reminder.id)}
                                                        className="text-red-500 hover:bg-red-100 p-1 rounded-full ml-2"
                                                        title="Eliminar recordatorio"
                                                    >
                                                        <TrashIcon />
                                                    </button>
                                                </div>
                                            ))
                                        ) : (
                                            <p className="text-sm text-gray-500 italic bg-gray-50 p-3 rounded-lg text-center">
                                                No hay recordatorios pendientes
                                            </p>
                                        )}
                                    </div>

                                    {/* Formulario para agregar nuevo recordatorio */}
                                    <form onSubmit={handleAddReminder} className="bg-blue-50 p-4 rounded-lg">
                                        <h4 className="font-medium text-gray-800 mb-3">Agregar Nueva Tarea</h4>
                                        <div className="flex gap-2">
                                            <input 
                                                type="text" 
                                                value={newReminder.text} 
                                                onChange={e => setNewReminder({...newReminder, text: e.target.value})} 
                                                placeholder="Descripción de la tarea..." 
                                                className="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#006666] focus:border-transparent" 
                                                required
                                            />
                                            <input 
                                                type="date" 
                                                value={newReminder.dueDate} 
                                                onChange={e => setNewReminder({...newReminder, dueDate: e.target.value})} 
                                                className="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#006666] focus:border-transparent" 
                                                required
                                            />
                                            <button 
                                                type="submit" 
                                                className="bg-[#006666] text-white px-4 py-2 rounded-md hover:bg-[#005555] flex items-center gap-2"
                                            >
                                                <PlusIcon width={16} height={16} />
                                                Agregar
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <div className="bg-gray-50 px-6 py-4">
                                <div className="flex justify-between items-center">
                                    <button 
                                        onClick={onBack}
                                        className="px-4 py-2 text-gray-600 hover:text-gray-800"
                                    >
                                        ← Volver al Dashboard
                                    </button>
                                    
                                    <div className="flex gap-3">
                                        <button 
                                            onClick={() => onGenerateConsent(client)}
                                            className="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 flex items-center gap-2"
                                        >
                                            <FileTextIcon /> Generar Consentimiento
                                        </button>
                                        <button 
                                            onClick={() => onCreateInvoice(client)}
                                            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2"
                                        >
                                            <DollarSignIcon /> Crear Factura
                                        </button>
                                        <button 
                                            onClick={() => onEdit(client)}
                                            className="px-4 py-2 bg-[#006666] text-white rounded-lg hover:bg-[#005555] flex items-center gap-2"
                                        >
                                            <EditIcon /> Editar Cliente
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            
            // Formulario de Consentimiento RGPD
            function ConsentForm({ client, onBack }) {
                const consentText = `CONSENTIMIENTO PARA EL TRATAMIENTO DE DATOS PERSONALES

Yo, ${client.name || '[Nombre del Cliente]'}, con DNI/CIF [DNI/CIF del Cliente], en mi propio nombre y representación, o en representación de la entidad ${client.company || '[Nombre de la Empresa/Clínica]'}, por la presente otorgo mi consentimiento explícito a EXPERTIA MEDICAL SOLUTIONS SL para el tratamiento de mis datos personales.

FINALIDADES:
[X] Gestión de la relación comercial y contractual (necesario para el servicio).
[ ] Envío de comunicaciones comerciales sobre productos, servicios y novedades de EXPERTIA MEDICAL SOLUTIONS SL.

DERECHOS:
Puede ejercer sus derechos de acceso, rectificación, supresión, limitación del tratamiento, portabilidad y oposición dirigiéndose a info@expertia.com o a la dirección postal de EXPERTIA MEDICAL SOLUTIONS SL.

Más información en nuestra política de privacidad: www.expertia.com/privacidad

En ${new Date().toLocaleDateString('es-ES', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
})}.

Fdo.: ${client.name || '[Firma del Cliente]'}`;

                const [text, setText] = useState(consentText);

                const handleSendEmail = () => {
                    const subject = 'Consentimiento Informado - Expertia Medical Solutions';
                    const body = encodeURIComponent(text);
                    window.open(`mailto:${client.email}?subject=${subject}&body=${body}`, '_blank');
                };

                const handleCopyToClipboard = () => {
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(text)
                            .then(() => alert('Texto copiado al portapapeles.'))
                            .catch(err => console.error('Error al copiar', err));
                    } else {
                        // Fallback para navegadores más antiguos
                        const textArea = document.createElement("textarea");
                        textArea.value = text;
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            alert('Texto copiado al portapapeles.');
                        } catch (err) {
                            console.error('Fallback: No se pudo copiar', err);
                        }
                        document.body.removeChild(textArea);
                    }
                };

                const handleDownload = () => {
                    const element = document.createElement("a");
                    const file = new Blob([text], { type: 'text/plain' });
                    element.href = URL.createObjectURL(file);
                    element.download = `consentimiento_${client.name?.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
                    document.body.appendChild(element);
                    element.click();
                    document.body.removeChild(element);
                };

                return (
                    <div className="max-w-4xl mx-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-3xl font-bold text-gray-900">Generar Consentimiento Informado</h1>
                            <button onClick={onBack} className="text-gray-500 hover:text-gray-700">
                                <XIcon width={24} height={24} />
                            </button>
                        </div>

                        <div className="bg-white rounded-lg shadow-lg p-8">
                            <div className="mb-6">
                                <h2 className="text-xl font-semibold text-gray-800 mb-4">
                                    Cliente: {client.name} - {client.company}
                                </h2>
                                <div className="bg-blue-50 border-l-4 border-blue-400 p-4">
                                    <div className="flex">
                                        <div className="flex-shrink-0">
                                            <CheckSquareIcon />
                                        </div>
                                        <div className="ml-3">
                                            <p className="text-sm text-blue-700">
                                                <strong>RGPD:</strong> Este formulario genera el consentimiento necesario según el Reglamento General de Protección de Datos.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Texto del Consentimiento (editable)
                                </label>
                                <textarea 
                                    value={text} 
                                    onChange={(e) => setText(e.target.value)} 
                                    rows="20" 
                                    className="w-full p-4 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm"
                                    style={{ fontFamily: 'monospace' }}
                                />
                            </div>

                            <div className="flex justify-between items-center">
                                <button 
                                    onClick={onBack} 
                                    className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                >
                                    ← Volver al Cliente
                                </button>
                                
                                <div className="flex gap-3">
                                    <button 
                                        onClick={handleCopyToClipboard} 
                                        className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"
                                    >
                                        <CopyIcon width={16} height={16} /> Copiar Texto
                                    </button>
                                    <button 
                                        onClick={handleDownload} 
                                        className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2"
                                    >
                                        <DownloadIcon width={16} height={16} /> Descargar
                                    </button>
                                    <button 
                                        onClick={handleSendEmail} 
                                        className="px-6 py-3 bg-[#006666] text-white rounded-lg hover:bg-[#005555] flex items-center gap-2"
                                    >
                                        <EmailIcon width={16} height={16} /> Enviar por Email
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            
            // Placeholder para otros componentes
            function OffersDashboard({ offers, clients, products, onCreateOffer, onViewOffer, onEditOffer, onDeleteOffer, showConfirm }) {
                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h1 className="text-3xl font-bold text-gray-900">Dashboard de Ofertas</h1>
                            <button onClick={onCreateOffer} className="bg-[#006666] text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-[#005555]">
                                <PlusIcon width={20} height={20} />
                                Nueva Oferta
                            </button>
                        </div>
                        
                        <div className="bg-white rounded-lg shadow p-6">
                            <h2 className="text-xl font-semibold mb-4">Ofertas Recientes</h2>
                            
                            <div className="grid gap-4">
                                {offers && offers.length > 0 ? (
                                    offers.map(offer => (
                                        <div key={offer.id} className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                            <div className="flex justify-between items-start">
                                                <div className="cursor-pointer flex-1" onClick={() => onViewOffer(offer)}>
                                                    <h3 className="font-semibold text-lg">Oferta #{offer.offerNumber}</h3>
                                                    <p className="text-gray-600">{offer.clientName}</p>
                                                    <p className="text-sm text-gray-500">Total: €{offer.total}</p>
                                                    <p className="text-sm text-gray-500">Fecha: {offer.offerDate}</p>
                                                </div>
                                                <div className="flex items-center gap-2 ml-4">
                                                    <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                                                        offer.status === 'Aceptada' ? 'bg-green-200 text-green-800' :
                                                        offer.status === 'Rechazada' ? 'bg-red-200 text-red-800' :
                                                        'bg-yellow-200 text-yellow-800'
                                                    }`}>
                                                        {offer.status || 'Pendiente'}
                                                    </span>
                                                    <div className="flex gap-1">
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                onEditOffer(offer);
                                                            }}
                                                            className="p-2 text-blue-600 hover:bg-blue-50 rounded"
                                                            title="Editar oferta"
                                                        >
                                                            <EditIcon width={16} height={16} />
                                                        </button>
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                showConfirm(
                                                                    'Eliminar Oferta',
                                                                    `¿Estás seguro de que quieres eliminar la oferta #${offer.offerNumber}?`,
                                                                    () => onDeleteOffer(offer.id),
                                                                    'danger'
                                                                );
                                                            }}
                                                            className="p-2 text-red-600 hover:bg-red-50 rounded"
                                                            title="Eliminar oferta"
                                                        >
                                                            <TrashIcon />
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="text-center py-8 text-gray-500">
                                        <FileTextIcon width={48} height={48} className="mx-auto mb-4 opacity-50" />
                                        <p>No hay ofertas registradas</p>
                                        <button onClick={onCreateOffer} className="mt-4 text-[#006666] hover:underline">
                                            Crear primera oferta
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }
            
            // === DASHBOARD DE PRODUCTOS ===
            function ProductsDashboard({ products, onCreateProduct, onEditProduct, onDeleteProduct, showConfirm }) {
                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h1 className="text-3xl font-bold text-gray-900">Gestión de Productos</h1>
                            <button onClick={onCreateProduct} className="bg-[#006666] text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-[#005555]">
                                <PlusIcon width={20} height={20} />
                                Nuevo Producto
                            </button>
                        </div>
                        
                        <div className="bg-white rounded-lg shadow p-6">
                            <h2 className="text-xl font-semibold mb-4">Productos Registrados</h2>
                            
                            <div className="grid gap-4">
                                {products && products.length > 0 ? (
                                    products.map(product => (
                                        <div key={product.id} className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1">
                                                    <h3 className="font-semibold text-lg">{product.name}</h3>
                                                    <p className="text-gray-600">{product.description || 'Sin descripción'}</p>
                                                    <p className="text-sm text-gray-500">Categoría: {product.category || 'General'}</p>
                                                    <p className="text-lg font-semibold text-[#006666]">€{Number(product.price || 0).toFixed(2)}</p>
                                                    {product.stock !== undefined && (
                                                        <p className="text-sm text-gray-500">Stock: {product.stock} unidades</p>
                                                    )}
                                                </div>
                                                <div className="flex gap-1 ml-4">
                                                    <button
                                                        onClick={() => onEditProduct(product)}
                                                        className="p-2 text-blue-600 hover:bg-blue-50 rounded"
                                                        title="Editar producto"
                                                    >
                                                        <EditIcon width={16} height={16} />
                                                    </button>
                                                    <button
                                                        onClick={() => {
                                                            showConfirm(
                                                                'Eliminar Producto',
                                                                `¿Estás seguro de que quieres eliminar el producto "${product.name}"?`,
                                                                () => onDeleteProduct(product.id),
                                                                'danger'
                                                            );
                                                        }}
                                                        className="p-2 text-red-600 hover:bg-red-50 rounded"
                                                        title="Eliminar producto"
                                                    >
                                                        <TrashIcon />
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="text-center py-8 text-gray-500">
                                        <BriefcaseIcon width={48} height={48} className="mx-auto mb-4 opacity-50" />
                                        <p>No hay productos registrados</p>
                                        <button onClick={onCreateProduct} className="mt-4 text-[#006666] hover:underline">
                                            Crear primer producto
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }
            
            // === SISTEMA DE CONTABILIDAD COMPLETO ===
            function AccountingDashboard({ invoices, clients, onCreateInvoice, onViewInvoice, onDeleteInvoice, showConfirm, showNotification }) {
                // Estados para filtros y ordenación
                const [searchTerm, setSearchTerm] = useState('');
                const [selectedSeries, setSelectedSeries] = useState('all');
                const [sortField, setSortField] = useState('invoiceDate');
                const [sortDirection, setSortDirection] = useState('desc');
                
                const getClientName = (clientId) => clients.find(c => c.id === clientId)?.name || 'N/A';

                // Obtener series únicas para el filtro
                const uniqueSeries = useMemo(() => {
                    const series = [...new Set(invoices.map(inv => inv.invoiceSeries).filter(Boolean))];
                    return series.sort();
                }, [invoices]);

                // Función de ordenación
                const handleSort = (field) => {
                    if (sortField === field) {
                        setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                    } else {
                        setSortField(field);
                        setSortDirection('asc');
                    }
                };

                // Función para renderizar el icono de ordenación
                const renderSortIcon = (field) => {
                    if (sortField !== field) {
                        return <ChevronUpIcon width={12} height={12} className="text-gray-400" />;
                    }
                    return sortDirection === 'asc' 
                        ? <ChevronUpIcon width={12} height={12} className="text-[#006666]" />
                        : <ChevronDownIcon width={12} height={12} className="text-[#006666]" />;
                };

                // Filtrar y ordenar facturas
                const filteredAndSortedInvoices = useMemo(() => {
                    let filtered = invoices.filter(invoice => {
                        // Filtro por búsqueda
                        const searchLower = searchTerm.toLowerCase();
                        const matchesSearch = !searchTerm || 
                            invoice.invoiceNumber?.toLowerCase().includes(searchLower) ||
                            getClientName(invoice.clientId).toLowerCase().includes(searchLower) ||
                            invoice.status?.toLowerCase().includes(searchLower) ||
                            invoice.invoiceSeries?.toLowerCase().includes(searchLower);

                        // Filtro por serie
                        const matchesSeries = selectedSeries === 'all' || invoice.invoiceSeries === selectedSeries;

                        return matchesSearch && matchesSeries;
                    });

                    // Ordenar
                    filtered.sort((a, b) => {
                        let aValue, bValue;
                        
                        switch (sortField) {
                            case 'invoiceNumber':
                                aValue = a.invoiceNumber || '';
                                bValue = b.invoiceNumber || '';
                                break;
                            case 'invoiceSeries':
                                aValue = a.invoiceSeries || '';
                                bValue = b.invoiceSeries || '';
                                break;
                            case 'clientName':
                                aValue = getClientName(a.clientId);
                                bValue = getClientName(b.clientId);
                                break;
                            case 'invoiceDate':
                                aValue = new Date(a.invoiceDate || '1970-01-01');
                                bValue = new Date(b.invoiceDate || '1970-01-01');
                                break;
                            case 'dueDate':
                                aValue = new Date(a.dueDate || '1970-01-01');
                                bValue = new Date(b.dueDate || '1970-01-01');
                                break;
                            case 'total':
                                aValue = a.total || 0;
                                bValue = b.total || 0;
                                break;
                            case 'status':
                                aValue = a.status || '';
                                bValue = b.status || '';
                                break;
                            default:
                                return 0;
                        }

                        if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
                        if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });

                    return filtered;
                }, [invoices, searchTerm, selectedSeries, sortField, sortDirection, clients]);

                // Estadísticas resumidas
                const stats = useMemo(() => {
                    const total = filteredAndSortedInvoices.reduce((acc, inv) => acc + (inv.total || 0), 0);
                    const paid = filteredAndSortedInvoices.reduce((acc, inv) => acc + (inv.totalPaid || 0), 0);
                    const pending = total - paid;
                    
                    return {
                        count: filteredAndSortedInvoices.length,
                        total: total,
                        paid: paid,
                        pending: pending
                    };
                }, [filteredAndSortedInvoices]);

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h1 className="text-3xl font-bold text-gray-900">Contabilidad</h1>
                        </div>
                        
                        {/* Estadísticas Resumidas */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                                <div className="flex items-center">
                                    <FileTextIcon />
                                    <div className="ml-3">
                                        <p className="text-sm font-medium text-gray-600">Total Facturas</p>
                                        <p className="text-lg font-semibold text-gray-900">{stats.count}</p>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                                <div className="flex items-center">
                                    <CheckIcon width={24} height={24} />
                                    <div className="ml-3">
                                        <p className="text-sm font-medium text-gray-600">Total Facturado</p>
                                        <p className="text-lg font-semibold text-gray-900">{stats.total.toFixed(2)} €</p>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-emerald-500">
                                <div className="flex items-center">
                                    <DollarSignIcon />
                                    <div className="ml-3">
                                        <p className="text-sm font-medium text-gray-600">Total Cobrado</p>
                                        <p className="text-lg font-semibold text-gray-900">{stats.paid.toFixed(2)} €</p>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-orange-500">
                                <div className="flex items-center">
                                    <ClockIcon />
                                    <div className="ml-3">
                                        <p className="text-sm font-medium text-gray-600">Pendiente Cobro</p>
                                        <p className="text-lg font-semibold text-gray-900">{stats.pending.toFixed(2)} €</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div className="bg-white p-6 rounded-lg shadow">
                            {/* Título */}
                            <div className="mb-4">
                                <h3 className="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-4">
                                    <FileTextIcon /> Gestión de Facturas
                                </h3>
                                
                                {/* Barra de herramientas en una sola línea */}
                                <div className="flex justify-between gap-6 mb-4">
                                    {/* Controles de filtrado y búsqueda - cada uno independiente */}
                                    <div className="flex gap-4">
                                        {/* Icono de búsqueda - elemento completamente separado */}
                                        <div className="flex items-center">
                                            <SearchIcon className="text-gray-400" width={16} height={16} />
                                        </div>

                                        {/* Campo de búsqueda - elemento completamente separado */}
                                        <div>
                                            <input
                                                type="text"
                                                placeholder="Buscar facturas..."
                                                value={searchTerm}
                                                onChange={(e) => setSearchTerm(e.target.value)}
                                                className="w-80 px-4 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-[#006666]"
                                            />
                                        </div>

                                        {/* Filtro por Serie - elemento separado */}
                                        <div>
                                            <select
                                                value={selectedSeries}
                                                onChange={(e) => setSelectedSeries(e.target.value)}
                                                className="w-48 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-[#006666]"
                                            >
                                                <option value="all">Todas las series</option>
                                                {uniqueSeries.map(series => (
                                                    <option key={series} value={series}>{series}</option>
                                                ))}
                                            </select>
                                        </div>

                                        {/* Botón Reset - elemento separado */}
                                        {(searchTerm || selectedSeries !== 'all') && (
                                            <div>
                                                <button
                                                    onClick={() => {
                                                        setSearchTerm('');
                                                        setSelectedSeries('all');
                                                    }}
                                                    className="px-3 py-2 text-sm text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors flex items-center gap-1"
                                                >
                                                    <XIcon width={14} height={14} />
                                                    Limpiar
                                                </button>
                                            </div>
                                        )}
                                    </div>

                                    {/* Botones de acción - elementos separados */}
                                    <div className="flex items-center gap-4">
                                        <div>
                                            <button 
                                                onClick={() => exportInvoicesToExcel(filteredAndSortedInvoices, clients, showNotification)}
                                                className="flex items-center gap-2 bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-green-700 transition-colors"
                                            >
                                                <DownloadIcon width={16} height={16} />
                                                Exportar Excel
                                            </button>
                                        </div>
                                        <div>
                                            <button 
                                                onClick={onCreateInvoice} 
                                                className="flex items-center gap-2 bg-[#008080] text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-[#006666] transition-colors"
                                            >
                                                <PlusIcon width={16} height={16} />
                                                Crear Factura
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Información de resultados */}
                            <div className="mb-4 text-sm text-gray-600">
                                Mostrando {filteredAndSortedInvoices.length} de {invoices.length} facturas
                                {(searchTerm || selectedSeries !== 'all') && (
                                    <span className="ml-2 text-[#006666] font-medium">
                                        (filtrado{searchTerm ? ` por "${searchTerm}"` : ''}
                                        {selectedSeries !== 'all' ? ` - serie ${selectedSeries}` : ''})
                                    </span>
                                )}
                            </div>

                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead className="bg-gray-100">
                                        <tr>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('invoiceNumber')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Nº Factura
                                                    {renderSortIcon('invoiceNumber')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('invoiceSeries')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Serie
                                                    {renderSortIcon('invoiceSeries')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('clientName')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Cliente
                                                    {renderSortIcon('clientName')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('invoiceDate')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Fecha
                                                    {renderSortIcon('invoiceDate')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('dueDate')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Vencimiento
                                                    {renderSortIcon('dueDate')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('total')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Total
                                                    {renderSortIcon('total')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('status')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Estado
                                                    {renderSortIcon('status')}
                                                </div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredAndSortedInvoices.length > 0 ? filteredAndSortedInvoices.map(inv => (
                                            <tr key={inv.id} className="border-b hover:bg-gray-50">
                                                <td className="p-3 font-mono text-sm cursor-pointer text-[#006666] hover:text-[#004444] font-medium" onClick={() => onViewInvoice(inv)}>
                                                    {inv.invoiceNumber}
                                                </td>
                                                <td className="p-3">
                                                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ${
                                                        inv.invoiceSeries === 'EXP' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'
                                                    }`}>
                                                        {inv.invoiceSeries}
                                                    </span>
                                                </td>
                                                <td className="p-3">{getClientName(inv.clientId)}</td>
                                                <td className="p-3">{inv.invoiceDate}</td>
                                                <td className="p-3">{inv.dueDate}</td>
                                                <td className="p-3 font-semibold">{inv.total?.toFixed(2) || '0.00'} €</td>
                                                <td className="p-3">
                                                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ${INVOICE_STATUSES[inv.status] || 'bg-gray-200 text-gray-800'}`}>
                                                        {inv.status}
                                                    </span>
                                                </td>
                                            </tr>
                                        )) : (
                                            <tr>
                                                <td colSpan="7" className="text-center p-6 text-gray-500">
                                                    {invoices.length === 0 ? (
                                                        <>
                                                            No hay facturas. 
                                                            <button onClick={onCreateInvoice} className="text-[#008080] ml-2 underline">
                                                                Crear primera factura
                                                            </button>
                                                        </>
                                                    ) : (
                                                        <>
                                                            No se encontraron facturas que coincidan con los filtros aplicados.
                                                            <button 
                                                                onClick={() => {
                                                                    setSearchTerm('');
                                                                    setSelectedSeries('all');
                                                                }}
                                                                className="text-[#008080] ml-2 underline"
                                                            >
                                                                Limpiar filtros
                                                            </button>
                                                        </>
                                                    )}
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            }

            // === FORMULARIO DE FACTURAS ===
            function InvoiceForm({ clients, products, onSave, onCancel, invoiceData }) {
                const [formData, setFormData] = useState({
                    id: invoiceData?.id || null, 
                    clientId: invoiceData?.client?.id || '',
                    invoiceNumber: invoiceData?.invoiceNumber || '',
                    invoiceDate: invoiceData?.invoiceDate || new Date().toISOString().split('T')[0],
                    dueDate: invoiceData?.dueDate || new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    status: invoiceData?.status || 'Borrador',
                    type: invoiceData?.type || 'Factura',
                    invoiceSeries: invoiceData?.invoiceSeries || 'EXP',
                    items: invoiceData?.items || [{ description: '', quantity: 1, price: 0, productId: '' }],
                });

                const subtotal = useMemo(() => formData.items.reduce((acc, item) => acc + (item.quantity * item.price), 0), [formData.items]);
                const vat = useMemo(() => subtotal * VAT_RATE, [subtotal]);
                const total = useMemo(() => subtotal + vat, [subtotal, vat]);

                const handleChange = (e) => { 
                    const { name, value } = e.target; 
                    setFormData(prev => ({ ...prev, [name]: value })); 
                };
               
                const handleItemChange = (index, e) => {
                    const { name, value } = e.target;
                    const items = [...formData.items];
                    if (name === "productId") {
                        const product = products.find(p => p.id === value);
                        items[index].productId = value;
                        items[index].description = product ? product.name : '';
                        items[index].price = product ? product.price : 0;
                    } else {
                        items[index][name] = value;
                    }
                    setFormData(prev => ({ ...prev, items }));
                };

                const addItem = () => { 
                    setFormData(prev => ({ 
                        ...prev, 
                        items: [...prev.items, { description: '', quantity: 1, price: 0, productId: '' }] 
                    })); 
                };
                
                const removeItem = (index) => { 
                    const items = [...formData.items]; 
                    items.splice(index, 1); 
                    setFormData(prev => ({ ...prev, items })); 
                };
                
                const handleSubmit = (e) => { 
                    e.preventDefault(); 
                    onSave({ ...formData, subtotal, vat, total }); 
                };

                return (
                    <form onSubmit={handleSubmit} className="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg space-y-6">
                        <h2 className="text-2xl font-bold text-gray-900">
                            {invoiceData?.id ? 'Editar Factura' : 'Crear Nueva Factura'}
                        </h2>
                        
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-gray-700">Cliente</label>
                                <select 
                                    name="clientId" 
                                    value={formData.clientId} 
                                    onChange={handleChange} 
                                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#008080] focus:ring-[#008080]" 
                                    required
                                >
                                    <option value="">Seleccionar cliente...</option>
                                    {clients.map(c => (
                                        <option key={c.id} value={c.id}>{c.name} - {c.clinic}</option>
                                    ))}
                                </select>
                            </div>
                            
                            <FormField label="Fecha Factura" name="invoiceDate" type="date" value={formData.invoiceDate} onChange={handleChange} />
                            <FormField label="Fecha Vencimiento" name="dueDate" type="date" value={formData.dueDate} onChange={handleChange} />
                            
                            <FormSelect label="Tipo Documento" name="type" value={formData.type} onChange={handleChange} options={['Factura', 'Factura Proforma']} />
                            <FormSelect label="Serie Factura" name="invoiceSeries" value={formData.invoiceSeries} onChange={handleChange} options={['EXP', 'ALQ']} />
                            <FormSelect label="Estado" name="status" value={formData.status} onChange={handleChange} options={Object.keys(INVOICE_STATUSES)} />
                        </div>
                        
                        <div className="border-t pt-4">
                            <h3 className="text-lg font-semibold mb-2">Líneas de la factura</h3>
                            {formData.items.map((item, index) => (
                                <div key={index} className="grid grid-cols-12 gap-2 mb-2 items-center">
                                    <div className="col-span-6">
                                        <select 
                                            name="productId" 
                                            value={item.productId} 
                                            onChange={(e) => handleItemChange(index, e)} 
                                            className="w-full p-2 border rounded-md bg-white shadow-sm"
                                        >
                                            <option value="">Seleccionar producto</option>
                                            {products.map(p => (
                                                <option key={p.id} value={p.id}>{p.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="col-span-2">
                                        <FormField 
                                            placeholder="Cant." 
                                            name="quantity" 
                                            type="number" 
                                            value={item.quantity} 
                                            onChange={(e) => handleItemChange(index, e)} 
                                        />
                                    </div>
                                    <div className="col-span-2">
                                        <FormField 
                                            placeholder="Precio" 
                                            name="price" 
                                            type="number" 
                                            step="0.01"
                                            value={item.price} 
                                            onChange={(e) => handleItemChange(index, e)} 
                                        />
                                    </div>
                                    <div className="col-span-1 font-semibold text-right">
                                        {(item.quantity * item.price).toFixed(2)}€
                                    </div>
                                    <div className="col-span-1">
                                        <button 
                                            type="button" 
                                            onClick={() => removeItem(index)} 
                                            className="text-red-500 p-2 rounded-full hover:bg-red-100"
                                        >
                                            <TrashIcon />
                                        </button>
                                    </div>
                                </div>
                            ))}
                            <button 
                                type="button" 
                                onClick={addItem} 
                                className="text-sm text-[#008080] font-bold"
                            >
                                + Añadir línea
                            </button>
                        </div>
                        
                        <div className="flex justify-end">
                            <div className="w-full md:w-1/3 space-y-2 text-right">
                                <div className="flex justify-between">
                                    <span className="font-semibold">Subtotal:</span>
                                    <span>{subtotal.toFixed(2)} €</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="font-semibold">IVA ({VAT_RATE * 100}%):</span>
                                    <span>{vat.toFixed(2)} €</span>
                                </div>
                                <div className="flex justify-between border-t pt-2 mt-2">
                                    <span className="font-bold text-lg">Total:</span>
                                    <span className="font-bold text-lg">{total.toFixed(2)} €</span>
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex justify-end gap-4 pt-4">
                            <button 
                                type="button" 
                                onClick={onCancel} 
                                className="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300"
                            >
                                Cancelar
                            </button>
                            <button 
                                type="submit" 
                                className="bg-[#008080] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#006666]"
                            >
                                Guardar Factura
                            </button>
                        </div>
                    </form>
                );
            }

            // === FORMULARIO DE OFERTAS ===
            function OfferForm({ clients, products, onSave, onCancel, offerData }) {
                const [formData, setFormData] = useState({
                    id: offerData?.id || null, 
                    clientId: offerData?.client?.id || '',
                    offerNumber: offerData?.offerNumber || '',
                    offerDate: offerData?.offerDate || new Date().toISOString().split('T')[0],
                    validUntil: offerData?.validUntil || new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    status: offerData?.status || 'Borrador',
                    offerSeries: offerData?.offerSeries || 'OF',
                    description: offerData?.description || '',
                    items: offerData?.items || [{ description: '', quantity: 1, price: 0, productId: '' }],
                    terms: offerData?.terms || 'Esta oferta es válida hasta la fecha indicada. Los precios incluyen IVA.',
                });

                const subtotal = useMemo(() => formData.items.reduce((acc, item) => acc + (Number(item.quantity) || 0) * (Number(item.price) || 0), 0), [formData.items]);
                const vat = useMemo(() => subtotal * VAT_RATE, [subtotal]);
                const total = useMemo(() => subtotal + vat, [subtotal, vat]);

                const handleChange = (e) => { 
                    const { name, value } = e.target; 
                    setFormData(prev => ({ ...prev, [name]: value })); 
                };
               
                const handleItemChange = (index, e) => {
                    const { name, value } = e.target;
                    const items = [...formData.items];
                    if (name === "productId") {
                        const product = products.find(p => p.id === value);
                        items[index].productId = value;
                        items[index].description = product ? product.name : '';
                        items[index].price = product ? Number(product.price) || 0 : 0;
                    } else if (name === "quantity" || name === "price") {
                        items[index][name] = Number(value) || 0;
                    } else {
                        items[index][name] = value;
                    }
                    setFormData(prev => ({ ...prev, items }));
                };

                const addItem = () => { 
                    setFormData(prev => ({ 
                        ...prev, 
                        items: [...prev.items, { description: '', quantity: 1, price: 0, productId: '' }] 
                    })); 
                };
                
                const removeItem = (index) => { 
                    const items = [...formData.items]; 
                    items.splice(index, 1); 
                    setFormData(prev => ({ ...prev, items })); 
                };
                
                const handleSubmit = (e) => { 
                    e.preventDefault(); 
                    onSave({ ...formData, subtotal, vat, total }); 
                };

                return (
                    <form onSubmit={handleSubmit} className="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg space-y-6">
                        <div className="flex items-center gap-3 mb-6">
                            <BriefcaseIcon width={32} height={32} className="text-[#008080]" />
                            <h2 className="text-2xl font-bold text-gray-900">
                                {offerData?.id ? 'Editar Oferta' : 'Crear Nueva Oferta'}
                            </h2>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div className="md:col-span-2">
                                <FormSelect 
                                    label="Cliente *" 
                                    name="clientId" 
                                    value={formData.clientId} 
                                    onChange={handleChange} 
                                    options={[
                                        { value: "", label: "Seleccionar cliente" },
                                        ...clients.map(client => ({ value: client.id, label: client.name }))
                                    ]}
                                    required
                                />
                            </div>
                            <FormField label="Nº Oferta" name="offerNumber" value={formData.offerNumber} onChange={handleChange} required />
                            <FormField label="Serie" name="offerSeries" value={formData.offerSeries} onChange={handleChange} required />
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <FormField label="Fecha Oferta" name="offerDate" type="date" value={formData.offerDate} onChange={handleChange} required />
                            <FormField label="Válida hasta" name="validUntil" type="date" value={formData.validUntil} onChange={handleChange} required />
                            <FormSelect label="Estado" name="status" value={formData.status} onChange={handleChange} options={Object.keys(OFFER_STATUSES)} />
                        </div>

                        <div>
                            <FormField 
                                label="Descripción general de la oferta" 
                                as="textarea" 
                                name="description" 
                                value={formData.description} 
                                onChange={handleChange} 
                                rows="3"
                                placeholder="Describe brevemente el contenido de esta oferta..."
                            />
                        </div>

                        <div>
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-lg font-semibold text-gray-800">Items de la Oferta</h3>
                                <button type="button" onClick={addItem} className="bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">
                                    + Agregar Producto
                                </button>
                            </div>
                            
                            <div className="space-y-3">
                                {formData.items.map((item, index) => (
                                    <div key={index} className="grid grid-cols-1 md:grid-cols-6 gap-3 p-4 bg-gray-50 rounded-lg">
                                        <div className="md:col-span-2">
                                            <label className="block text-xs font-medium text-gray-700 mb-1">Producto</label>
                                            <select 
                                                name="productId" 
                                                value={item.productId} 
                                                onChange={(e) => handleItemChange(index, e)} 
                                                className="w-full text-sm border border-gray-300 rounded-md p-2"
                                            >
                                                <option value="">Manual</option>
                                                {products.map(product => (
                                                    <option key={product.id} value={product.id}>{product.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700 mb-1">Descripción</label>
                                            <input 
                                                type="text" 
                                                name="description" 
                                                value={item.description} 
                                                onChange={(e) => handleItemChange(index, e)} 
                                                className="w-full text-sm border border-gray-300 rounded-md p-2" 
                                                placeholder="Descripción"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700 mb-1">Cantidad</label>
                                            <input 
                                                type="number" 
                                                name="quantity" 
                                                value={item.quantity} 
                                                onChange={(e) => handleItemChange(index, e)} 
                                                className="w-full text-sm border border-gray-300 rounded-md p-2" 
                                                min="1"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700 mb-1">Precio €</label>
                                            <input 
                                                type="number" 
                                                step="0.01" 
                                                name="price" 
                                                value={item.price} 
                                                onChange={(e) => handleItemChange(index, e)} 
                                                className="w-full text-sm border border-gray-300 rounded-md p-2" 
                                                min="0"
                                            />
                                        </div>
                                        <div className="flex items-end">
                                            <div className="text-sm font-semibold text-gray-900">
                                                {(item.quantity * item.price).toFixed(2)}€
                                            </div>
                                        </div>
                                        <div className="flex items-end">
                                            <button 
                                                type="button" 
                                                onClick={() => removeItem(index)} 
                                                className="text-red-500 hover:text-red-700 text-sm"
                                                disabled={formData.items.length === 1}
                                            >
                                                Eliminar
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div>
                            <FormField 
                                label="Términos y condiciones" 
                                as="textarea" 
                                name="terms" 
                                value={formData.terms} 
                                onChange={handleChange} 
                                rows="3"
                                placeholder="Condiciones de la oferta, validez, términos de pago, etc..."
                            />
                        </div>

                        <div className="bg-gray-50 p-4 rounded-lg">
                            <div className="grid grid-cols-3 gap-4 text-right">
                                <div>
                                    <div className="text-sm text-gray-600">Subtotal:</div>
                                    <div className="font-semibold">{subtotal.toFixed(2)} €</div>
                                </div>
                                <div>
                                    <div className="text-sm text-gray-600">IVA ({(VAT_RATE * 100).toFixed(0)}%):</div>
                                    <div className="font-semibold">{vat.toFixed(2)} €</div>
                                </div>
                                <div>
                                    <div className="text-sm text-gray-600">Total:</div>
                                    <div className="text-xl font-bold text-[#008080]">{total.toFixed(2)} €</div>
                                </div>
                            </div>
                        </div>

                        <div className="flex justify-between pt-6">
                            <button 
                                type="button" 
                                onClick={onCancel} 
                                className="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300"
                            >
                                Cancelar
                            </button>
                            <button 
                                type="submit" 
                                className="bg-[#008080] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#006666]"
                            >
                                Guardar Oferta
                            </button>
                        </div>
                    </form>
                );
            }

            // === DETALLE DE FACTURA ===
            function InvoiceDetail({ invoice, clients, onBack, onRegisterPayment, db, userId, onConvertToInvoice, onCreateRectificativa, showConfirm, showNotification }) {
                if (!invoice) return null;
                
                const client = clients.find(c => c.id === invoice.clientId);
                const [payments, setPayments] = useState([]);
                const [paymentAmount, setPaymentAmount] = useState(0);
                const amountPaid = invoice.totalPaid || 0;
                const amountDue = invoice.total - amountPaid;
                
                useEffect(() => { 
                    if (!db || !userId || !invoice.id) return; 
                    const paymentsPath = `companies/${invoice.clientId}/invoices/${invoice.id}/payments`; 
                    const q = query(collection(db, paymentsPath)); 
                    const unsubscribe = onSnapshot(q, (snapshot) => { 
                        setPayments(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); 
                    }); 
                    return () => unsubscribe(); 
                }, [db, userId, invoice.id]);
                
                const handlePaymentSubmit = (e) => { 
                    e.preventDefault(); 
                    const amount = parseFloat(paymentAmount); 
                    if (amount > 0 && amount <= amountDue) { 
                        onRegisterPayment(invoice, amount); 
                        setPaymentAmount(0); 
                    } else { 
                        showNotification('Error de pago', 'El importe del pago no es válido. Debe ser mayor que 0 y no superior al importe pendiente.', 'error');
                    } 
                };

                // Función para imprimir la factura
                const handlePrintInvoice = () => {
                    const printContent = generateInvoicePrintHTML(invoice, client);
                    const printWindow = window.open('', '_blank', 'width=800,height=600');
                    printWindow.document.open();
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    printWindow.focus();
                    setTimeout(() => {
                        printWindow.print();
                        printWindow.close();
                    }, 250);
                };

                // Función para generar el HTML de impresión
                const generateInvoicePrintHTML = (invoice, client) => {
                    return `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="utf-8">
                            <title>Factura ${invoice.invoiceNumber}</title>
                            <style>
                                * { margin: 0; padding: 0; box-sizing: border-box; }
                                body { font-family: Arial, sans-serif; font-size: 12px; line-height: 1.4; color: #333; }
                                .invoice-container { max-width: 800px; margin: 0 auto; padding: 20px; }
                                .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; border-bottom: 2px solid #006666; padding-bottom: 20px; }
                                .logo-section h1 { color: #006666; font-size: 24px; margin-bottom: 5px; }
                                .logo-section h2 { color: #333; font-size: 18px; font-weight: normal; }
                                .company-info { text-align: right; }
                                .company-info h3 { color: #006666; font-size: 16px; margin-bottom: 5px; }
                                .invoice-info { display: flex; justify-content: space-between; margin-bottom: 30px; }
                                .invoice-details, .client-details { flex: 1; }
                                .client-details { margin-left: 30px; background: #f8f9fa; padding: 15px; border-radius: 5px; }
                                .invoice-details h4, .client-details h4 { color: #006666; font-size: 14px; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
                                .items-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                                .items-table th { background: #006666; color: white; padding: 10px; text-align: left; font-size: 11px; }
                                .items-table td { padding: 8px 10px; border-bottom: 1px solid #ddd; }
                                .items-table tr:nth-child(even) { background: #f8f9fa; }
                                .totals { float: right; width: 300px; }
                                .totals table { width: 100%; border-collapse: collapse; }
                                .totals td { padding: 5px 10px; }
                                .totals .total-row { background: #006666; color: white; font-weight: bold; }
                                .footer { margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 10px; color: #666; }
                                @media print { 
                                    body { print-color-adjust: exact; } 
                                    .invoice-container { padding: 0; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="invoice-container">
                                <div class="header">
                                    <div class="logo-section">
                                        <img src="./LOGO_EXPERTIA.jpg" alt="Expertia Medical Solutions" style="height: 60px; margin-bottom: 10px;">
                                        <p style="margin-top: 10px; font-weight: bold; font-size: 16px;">${invoice.type.toUpperCase()}</p>
                                        <p style="color: #666;">Nº: ${invoice.invoiceNumber || 'N/A'}</p>
                                    </div>
                                    <div class="company-info">
                                        <h3>Expertia Medical Solutions SL</h3>
                                        <p>Calle Ficticia 123</p>
                                        <p>28080 Madrid, España</p>
                                        <p>CIF: B12345678</p>
                                        <p>Tel: +34 912 345 678</p>
                                        <p>Email: info@expertiamedical.com</p>
                                    </div>
                                </div>

                                <div class="invoice-info">
                                    <div class="invoice-details">
                                        <h4>Detalles de la Factura</h4>
                                        <p><strong>Fecha de Factura:</strong> ${invoice.invoiceDate || 'N/A'}</p>
                                        <p><strong>Fecha de Vencimiento:</strong> ${invoice.dueDate || 'N/A'}</p>
                                        <p><strong>Serie:</strong> ${invoice.invoiceSeries || 'N/A'}</p>
                                        <p><strong>Estado:</strong> ${invoice.status || 'N/A'}</p>
                                    </div>
                                    <div class="client-details">
                                        <h4>Facturar a:</h4>
                                        ${client ? `
                                            <p><strong>${client.clinic || client.name}</strong></p>
                                            <p>${client.address || 'Dirección no especificada'}</p>
                                            <p>${client.postalCode || ''} ${client.city || ''}</p>
                                            <p>Att: ${client.name}</p>
                                            ${client.email ? `<p>Email: ${client.email}</p>` : ''}
                                            ${client.phone ? `<p>Tel: ${client.phone}</p>` : ''}
                                        ` : '<p>Cliente no encontrado</p>'}
                                    </div>
                                </div>

                                <table class="items-table">
                                    <thead>
                                        <tr>
                                            <th>Descripción</th>
                                            <th style="width: 80px;">Cantidad</th>
                                            <th style="width: 100px;">Precio Unit.</th>
                                            <th style="width: 100px;">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${(invoice.items || []).map(item => `
                                            <tr>
                                                <td>${item.description || 'N/A'}</td>
                                                <td style="text-align: center;">${item.quantity || 0}</td>
                                                <td style="text-align: right;">${(item.price || 0).toFixed(2)} €</td>
                                                <td style="text-align: right;">${((item.quantity || 0) * (item.price || 0)).toFixed(2)} €</td>
                                            </tr>
                                        `).join('')}
                                        ${(invoice.items || []).length === 0 ? '<tr><td colspan="4" style="text-align: center; color: #666;">No hay elementos en esta factura</td></tr>' : ''}
                                    </tbody>
                                </table>

                                <div class="totals">
                                    <table>
                                        <tr>
                                            <td style="text-align: right;"><strong>Subtotal:</strong></td>
                                            <td style="text-align: right;">${(invoice.subtotal || 0).toFixed(2)} €</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: right;"><strong>IVA (21%):</strong></td>
                                            <td style="text-align: right;">${(invoice.vat || 0).toFixed(2)} €</td>
                                        </tr>
                                        <tr class="total-row">
                                            <td style="text-align: right;"><strong>TOTAL:</strong></td>
                                            <td style="text-align: right;"><strong>${(invoice.total || 0).toFixed(2)} €</strong></td>
                                        </tr>
                                    </table>
                                </div>

                                <div style="clear: both;"></div>

                                <div class="footer">
                                    <p><strong>Forma de pago:</strong> Transferencia bancaria</p>
                                    <p><strong>Cuenta bancaria:</strong> ES21 1234 5678 9012 3456 7890</p>
                                    <p><strong>Notas:</strong> ${invoice.notes || 'Gracias por confiar en Expertia Medical Solutions.'}</p>
                                    <br>
                                    <p style="text-align: center;">
                                        Expertia Medical Solutions SL | CIF: B12345678 | 
                                        Calle Ficticia 123, 28080 Madrid | 
                                        Tel: +34 912 345 678 | www.expertiamedical.com
                                    </p>
                                </div>
                            </div>
                        </body>
                        </html>
                    `;
                };

                // Función para generar y descargar PDF de la factura
                const handleDownloadPDF = () => {
                    const printContent = generateInvoicePrintHTML(invoice, client);
                    const printWindow = window.open('', '_blank', 'width=800,height=600');
                    printWindow.document.open();
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    printWindow.focus();
                    
                    // Abrir directamente el diálogo de impresión
                    setTimeout(() => {
                        printWindow.print();
                    }, 250);
                };

                // Función para enviar por correo
                const handleSendByEmail = async () => {
                    if (!client || !client.email) {
                        showNotification('Error de email', 'No se encontró el email del cliente. Por favor, verifica que el cliente tenga un email registrado.', 'error');
                        return;
                    }

                    // Preguntar si quiere generar PDF primero usando el modal personalizado
                    const userWantsPDF = await showConfirm(
                        'Generar PDF',
                        '¿Deseas generar primero el PDF de la factura para adjuntarlo al email?',
                        () => {}, // onConfirm vacío porque manejamos la Promise
                        'info'
                    );
                    
                    if (userWantsPDF) {
                        // Usuario confirmó - generar PDF primero
                        handleDownloadPDF();
                        
                        // Esperar un momento y luego mostrar el email
                        setTimeout(() => {
                            openEmailCompose();
                            showNotification('PDF generado', 'No olvides adjuntar el PDF descargado al email antes de enviarlo.', 'info');
                        }, 1000);
                    } else {
                        // Usuario canceló o no quiere PDF - ir directo al email
                        openEmailCompose();
                    }
                };

                const openEmailCompose = () => {
                    const subject = `Factura ${invoice.invoiceNumber} - Expertia Medical Solutions`;
                    const body = `Estimado/a ${client.name},

Adjunto encontrará la factura ${invoice.invoiceNumber} correspondiente a los servicios prestados.

Detalles de la factura:
- Número: ${invoice.invoiceNumber}
- Fecha: ${invoice.invoiceDate}
- Importe: ${(invoice.total || 0).toFixed(2)} €
- Estado: ${invoice.status}

Si tiene alguna pregunta sobre esta factura, no dude en contactarnos.

Atentamente,
Expertia Medical Solutions
Tel: +34 912 345 678
Email: info@expertiamedical.com`;

                    const mailtoLink = `mailto:${client.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    // Abrir en nueva ventana/pestaña
                    window.open(mailtoLink, '_blank');
                };
                
                return (
                    <div className="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
                        <div className="flex justify-between items-start mb-8">
                            <div>
                                <img src="./LOGO_EXPERTIA.jpg" alt="Expertia Medical Solutions" className="h-14 mb-4" />
                                <h2 className="text-2xl font-bold text-gray-900 uppercase">{invoice.type}</h2>
                                <p className="text-gray-500">Nº: {invoice.invoiceNumber}</p>
                            </div>
                            <div className="text-right">
                                <h3 className="text-xl font-bold">Expertia Medical Solutions SL</h3>
                                <p className="text-sm">Calle Ficticia 123, 28080 Madrid</p>
                                <p className="text-sm">B12345678</p>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-8 mb-8">
                            <div className="bg-gray-50 p-4 rounded-lg">
                                <h4 className="font-semibold text-gray-600 mb-2">Facturar a:</h4>
                                {client ? (
                                    <>
                                        <p className="font-bold">{client.clinic}</p>
                                        <p>{formatAddress(client.address)}</p>
                                        <p>{client.postalCode} {client.city}</p>
                                        <p>Att: {client.name}</p>
                                    </>
                                ) : (
                                    <p>Cliente no encontrado</p>
                                )}
                            </div>
                            <div className="bg-gray-50 p-4 rounded-lg text-right">
                                <p><span className="font-semibold">Fecha Factura:</span> {invoice.invoiceDate}</p>
                                <p><span className="font-semibold">Vencimiento:</span> {invoice.dueDate}</p>
                                <p className="mt-2">
                                    <span className="font-semibold">Estado:</span> 
                                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ml-2 ${INVOICE_STATUSES[invoice.status]}`}>
                                        {invoice.status}
                                    </span>
                                </p>
                            </div>
                        </div>
                        
                        <table className="w-full text-left mb-8">
                            <thead className="bg-gray-100">
                                <tr>
                                    <th className="p-3">Descripción</th>
                                    <th className="p-3 text-center">Cantidad</th>
                                    <th className="p-3 text-right">Precio Unitario</th>
                                    <th className="p-3 text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {invoice.items.map((item, index) => (
                                    <tr key={index} className="border-b">
                                        <td className="p-3">{item.description}</td>
                                        <td className="p-3 text-center">{item.quantity}</td>
                                        <td className="p-3 text-right">{parseFloat(item.price).toFixed(2)} €</td>
                                        <td className="p-3 text-right">{(item.quantity * item.price).toFixed(2)} €</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        
                        <div className="flex justify-between items-start">
                            <div className="w-1/2 pr-4">
                                <h4 className="font-semibold text-gray-600 mb-2">Pagos Registrados</h4>
                                {payments.length > 0 ? (
                                    <ul className="text-sm space-y-1">
                                        {payments.map(p => (
                                            <li key={p.id} className="flex justify-between p-1 bg-gray-50 rounded">
                                                <span>{p.date}:</span> 
                                                <span className="font-semibold">{p.amount.toFixed(2)} €</span>
                                            </li>
                                        ))}
                                    </ul>
                                ) : (
                                    <p className="text-sm text-gray-500">No hay pagos registrados.</p>
                                )}
                                
                                {amountDue > 0 && (
                                    <form onSubmit={handlePaymentSubmit} className="mt-4">
                                        <h4 className="font-semibold text-gray-600 mb-2">Registrar Nuevo Pago</h4>
                                        <div className="flex gap-2">
                                            <input 
                                                type="number" 
                                                step="0.01" 
                                                max={amountDue.toFixed(2)} 
                                                value={paymentAmount} 
                                                onChange={(e) => setPaymentAmount(e.target.value)} 
                                                className="w-full rounded-md border-gray-300" 
                                                placeholder="Importe" 
                                            />
                                            <button 
                                                type="submit" 
                                                className="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700"
                                            >
                                                Pagar
                                            </button>
                                        </div>
                                    </form>
                                )}
                            </div>
                            
                            <div className="w-1/2 md:w-1/3 space-y-2 text-right">
                                <div className="flex justify-between">
                                    <span className="font-semibold">Subtotal:</span>
                                    <span>{invoice.subtotal.toFixed(2)} €</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="font-semibold">IVA ({VAT_RATE * 100}%):</span>
                                    <span>{invoice.vat.toFixed(2)} €</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="font-semibold">Total Factura:</span>
                                    <span className="font-semibold">{invoice.total.toFixed(2)} €</span>
                                </div>
                                <div className="flex justify-between text-green-600">
                                    <span className="font-semibold">Total Pagado:</span>
                                    <span className="font-semibold">{amountPaid.toFixed(2)} €</span>
                                </div>
                                <div className="flex justify-between border-t-2 border-gray-800 pt-2 mt-2">
                                    <span className="font-bold text-xl">Pendiente:</span>
                                    <span className="font-bold text-xl text-red-600">{amountDue.toFixed(2)} €</span>
                                </div>
                            </div>
                        </div>
                        
                        <div className="mt-12 flex justify-end gap-4">
                            <button 
                                onClick={onBack} 
                                className="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300"
                            >
                                Volver
                            </button>
                            {invoice.type === 'Factura Proforma' && (
                                <button 
                                    onClick={() => onConvertToInvoice(invoice)} 
                                    className="bg-green-600 text-white font-bold py-2 px-4 rounded-lg"
                                >
                                    Convertir a Factura
                                </button>
                            )}
                            <button 
                                onClick={handlePrintInvoice}
                                className="bg-[#008080] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#006666] flex items-center gap-2"
                            >
                                <PrinterIcon width={16} height={16} />
                                Imprimir
                            </button>
                            <button 
                                onClick={handleDownloadPDF}
                                className="bg-[#006666] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#005555] flex items-center gap-2"
                            >
                                <DownloadIcon width={16} height={16} />
                                Descargar PDF
                            </button>
                            <button 
                                onClick={handleSendByEmail}
                                className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center gap-2"
                            >
                                <SendIcon width={16} height={16} />
                                Enviar por Email
                            </button>
                            {invoice.type !== 'Factura Rectificativa' && (
                                <button 
                                    onClick={() => onCreateRectificativa && onCreateRectificativa(invoice)} 
                                    className="bg-orange-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-700 flex items-center gap-2"
                                >
                                    <FileTextIcon className="w-4 h-4" />
                                    Crear rectificativa
                                </button>
                            )}
                        </div>
                    </div>
                );
            }

            // === DETALLE DE OFERTA ===
            function OfferDetail({ offer, clients, onBack, onAcceptOffer, onRejectOffer, onExpireOffer, onConvertToInvoice }) {
                if (!offer) return null;
                
                const client = clients.find(c => c.id === offer.clientId);
                const isExpired = new Date(offer.validUntil) < new Date();
                const canConvert = offer.status === 'Aceptada';

                const handleStatusUpdate = (newStatus) => {
                    switch(newStatus) {
                        case 'Aceptada':
                            onAcceptOffer(offer.id);
                            break;
                        case 'Rechazada':
                            onRejectOffer(offer.id);
                            break;
                        case 'Expirada':
                            onExpireOffer(offer.id);
                            break;
                    }
                };

                return (
                    <div className="max-w-4xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-[#008080] to-[#006666] text-white p-6">
                            <div className="flex justify-between items-start">
                                <div>
                                    <h1 className="text-2xl font-bold flex items-center gap-2">
                                        <BriefcaseIcon width={24} height={24} /> Oferta {offer.offerNumber}
                                    </h1>
                                    <p className="text-blue-100 mt-1">Serie: {offer.offerSeries}</p>
                                </div>
                                <div className="text-right">
                                    <span className={`px-3 py-1 text-xs font-semibold rounded-full ml-2 ${OFFER_STATUSES[offer.status]}`}>
                                        {offer.status}
                                    </span>
                                    {isExpired && offer.status !== 'Expirada' && (
                                        <div className="text-yellow-200 text-sm mt-2 flex items-center gap-1">
                                            <AlertTriangleIcon width={14} height={14} /> Oferta expirada
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="p-6 space-y-6">
                            {/* Información del cliente y fechas */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        <UserIcon width={20} height={20} /> Información del Cliente
                                    </h3>
                                    <div className="bg-gray-50 p-4 rounded-lg space-y-2">
                                        <div><strong>Nombre:</strong> {client?.name || 'N/A'}</div>
                                        <div><strong>Empresa:</strong> {client?.company || 'N/A'}</div>
                                        <div><strong>Email:</strong> {client?.email || 'N/A'}</div>
                                        <div><strong>Teléfono:</strong> {client?.phone || 'N/A'}</div>
                                    </div>
                                </div>
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        <BriefcaseIcon width={20} height={20} /> Información de la Oferta
                                    </h3>
                                    <div className="bg-gray-50 p-4 rounded-lg space-y-2">
                                        <div><strong>Fecha:</strong> {offer.offerDate}</div>
                                        <div><strong>Válida hasta:</strong> {offer.validUntil}</div>
                                        <div><strong>Descripción:</strong> {offer.description || 'Sin descripción'}</div>
                                    </div>
                                </div>
                            </div>

                            {/* Items */}
                            <div>
                                <h3 className="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                    <PackageIcon width={20} height={20} /> Items de la Oferta
                                </h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full border border-gray-200 rounded-lg">
                                        <thead className="bg-gray-100">
                                            <tr>
                                                <th className="text-left p-3 border-b">Descripción</th>
                                                <th className="text-center p-3 border-b">Cantidad</th>
                                                <th className="text-right p-3 border-b">Precio Unitario</th>
                                                <th className="text-right p-3 border-b">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {offer.items?.map((item, index) => (
                                                <tr key={index} className="border-b">
                                                    <td className="p-3">{item.description}</td>
                                                    <td className="p-3 text-center">{item.quantity}</td>
                                                    <td className="p-3 text-right">{item.price.toFixed(2)} €</td>
                                                    <td className="p-3 text-right font-semibold">{(item.quantity * item.price).toFixed(2)} €</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {/* Términos y condiciones */}
                            {offer.terms && (
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        <FileTextIcon width={20} height={20} /> Términos y Condiciones
                                    </h3>
                                    <div className="bg-gray-50 p-4 rounded-lg">
                                        <p className="text-gray-700 whitespace-pre-line">{offer.terms}</p>
                                    </div>
                                </div>
                            )}

                            {/* Totales */}
                            <div className="bg-gray-50 p-4 rounded-lg">
                                <div className="grid grid-cols-3 gap-4 text-right">
                                    <div>
                                        <div className="text-sm text-gray-600">Subtotal:</div>
                                        <div className="font-semibold text-lg">{offer.subtotal?.toFixed(2)} €</div>
                                    </div>
                                    <div>
                                        <div className="text-sm text-gray-600">IVA:</div>
                                        <div className="font-semibold text-lg">{offer.vat?.toFixed(2)} €</div>
                                    </div>
                                    <div>
                                        <div className="text-sm text-gray-600">Total:</div>
                                        <div className="text-2xl font-bold text-[#008080]">{offer.total?.toFixed(2)} €</div>
                                    </div>
                                </div>
                            </div>

                            {/* Acciones */}
                            <div className="border-t pt-6">
                                <div className="flex flex-col sm:flex-row justify-between gap-4">
                                    <button 
                                        onClick={onBack} 
                                        className="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300"
                                    >
                                        ← Volver
                                    </button>
                                    
                                    <div className="flex flex-col sm:flex-row gap-2">
                                        {/* Acciones de estado */}
                                        {offer.status === 'Borrador' && (
                                            <button 
                                                onClick={() => handleStatusUpdate('Enviada')} 
                                                className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center gap-2"
                                            >
                                                <MailIcon width={16} height={16} /> Marcar como Enviada
                                            </button>
                                        )}
                                        
                                        {offer.status === 'Enviada' && !isExpired && (
                                            <>
                                                <button 
                                                    onClick={() => handleStatusUpdate('Aceptada')} 
                                                    className="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center gap-2"
                                                >
                                                    <CheckIcon width={16} height={16} /> Marcar como Aceptada
                                                </button>
                                                <button 
                                                    onClick={() => handleStatusUpdate('Rechazada')} 
                                                    className="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 flex items-center gap-2"
                                                >
                                                    <XCircleIcon width={16} height={16} /> Marcar como Rechazada
                                                </button>
                                            </>
                                        )}

                                        {isExpired && offer.status !== 'Expirada' && (
                                            <button 
                                                onClick={() => handleStatusUpdate('Expirada')} 
                                                className="bg-orange-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-700 flex items-center gap-2"
                                            >
                                                <ClockIcon width={16} height={16} /> Marcar como Expirada
                                            </button>
                                        )}

                                        {/* Convertir a factura */}
                                        {canConvert && (
                                            <button 
                                                onClick={() => onConvertToInvoice(offer)} 
                                                className="bg-[#008080] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#006666] flex items-center gap-2"
                                            >
                                                <FileTextIcon width={16} height={16} /> Convertir a Factura
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // === DASHBOARD DE INFORMES Y ESTADÍSTICAS ===
            function ReportsDashboard({ allInvoices }) {
                const [productFilter, setProductFilter] = useState('all');
                const [salespersonFilter, setSalespersonFilter] = useState('all');
                const [dateFilter, setDateFilter] = useState('all');
                
                const paidInvoices = allInvoices.filter(inv => inv.status === 'Pagada');

                const productOptions = useMemo(() => {
                    const products = new Set();
                    paidInvoices.forEach(inv => {
                        if (inv.items) {
                            inv.items.forEach(item => { 
                                if(item.description) products.add(item.description);
                            });
                        }
                    });
                    return ['all', ...Array.from(products)];
                }, [paidInvoices]);

                const salespersonOptions = useMemo(() => {
                    const salespersons = new Set();
                    paidInvoices.forEach(inv => { 
                        if(inv.createdBy) salespersons.add(inv.createdBy);
                    });
                    return ['all', ...Array.from(salespersons)];
                }, [paidInvoices]);

                const filteredInvoices = useMemo(() => {
                    return paidInvoices.filter(inv => {
                        const productMatch = productFilter === 'all' || 
                            (inv.items && inv.items.some(item => item.description === productFilter));
                        
                        const salespersonMatch = salespersonFilter === 'all' || inv.createdBy === salespersonFilter;
                        
                        let dateMatch = true;
                        if (dateFilter !== 'all') {
                            const invDate = new Date(inv.invoiceDate);
                            const now = new Date();
                            switch(dateFilter) {
                                case 'thisMonth':
                                    dateMatch = invDate.getMonth() === now.getMonth() && 
                                              invDate.getFullYear() === now.getFullYear();
                                    break;
                                case 'lastMonth':
                                    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1);
                                    dateMatch = invDate.getMonth() === lastMonth.getMonth() && 
                                              invDate.getFullYear() === lastMonth.getFullYear();
                                    break;
                                case 'thisYear':
                                    dateMatch = invDate.getFullYear() === now.getFullYear();
                                    break;
                                case 'lastYear':
                                    dateMatch = invDate.getFullYear() === now.getFullYear() - 1;
                                    break;
                            }
                        }
                        
                        return productMatch && salespersonMatch && dateMatch;
                    });
                }, [paidInvoices, productFilter, salespersonFilter, dateFilter]);

                const salesByMonth = useMemo(() => {
                    const monthlyData = {};
                    const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                    
                    filteredInvoices.forEach(inv => {
                        const date = new Date(inv.invoiceDate);
                        if (isNaN(date.getTime())) return;
                        
                        const month = date.getMonth();
                        const year = date.getFullYear();
                        const key = `${year}-${monthNames[month]}`;
                        
                        if (!monthlyData[key]) monthlyData[key] = 0;
                        monthlyData[key] += inv.total;
                    });
                    
                    return Object.entries(monthlyData)
                        .map(([name, Ventas]) => ({ 
                            name, 
                            Ventas: parseFloat(Ventas.toFixed(2)) 
                        }))
                        .sort((a, b) => {
                            const [yearA, monthA] = a.name.split('-');
                            const [yearB, monthB] = b.name.split('-');
                            const dateA = new Date(yearA, monthNames.indexOf(monthA));
                            const dateB = new Date(yearB, monthNames.indexOf(monthB));
                            return dateA - dateB;
                        });
                }, [filteredInvoices]);

                const salesByQuarter = useMemo(() => {
                    const quarterlyData = {};
                    
                    filteredInvoices.forEach(inv => {
                        const date = new Date(inv.invoiceDate);
                        if (isNaN(date.getTime())) return;
                        
                        const year = date.getFullYear();
                        const quarter = Math.floor(date.getMonth() / 3) + 1;
                        const key = `${year}-T${quarter}`;
                        
                        if (!quarterlyData[key]) quarterlyData[key] = 0;
                        quarterlyData[key] += inv.total;
                    });
                    
                    return Object.entries(quarterlyData)
                        .map(([name, Ventas]) => ({ 
                            name, 
                            Ventas: parseFloat(Ventas.toFixed(2)) 
                        }))
                        .sort((a, b) => a.name.localeCompare(b.name));
                }, [filteredInvoices]);

                const topProducts = useMemo(() => {
                    const productSales = {};
                    
                    filteredInvoices.forEach(inv => {
                        if (inv.items) {
                            inv.items.forEach(item => {
                                if (item.description) {
                                    if (!productSales[item.description]) {
                                        productSales[item.description] = {
                                            name: item.description,
                                            quantity: 0,
                                            revenue: 0
                                        };
                                    }
                                    productSales[item.description].quantity += item.quantity;
                                    productSales[item.description].revenue += item.quantity * item.price;
                                }
                            });
                        }
                    });
                    
                    return Object.values(productSales)
                        .sort((a, b) => b.revenue - a.revenue)
                        .slice(0, 5);
                }, [filteredInvoices]);

                const totalSales = useMemo(() => 
                    filteredInvoices.reduce((sum, inv) => sum + inv.total, 0), 
                    [filteredInvoices]
                );

                const averageTicket = useMemo(() => 
                    filteredInvoices.length > 0 ? totalSales / filteredInvoices.length : 0, 
                    [totalSales, filteredInvoices.length]
                );

                const totalInvoices = filteredInvoices.length;
                const totalVat = useMemo(() => 
                    filteredInvoices.reduce((sum, inv) => sum + (inv.vat || 0), 0), 
                    [filteredInvoices]
                );

                return (
                    <div className="space-y-6">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-3">
                            <BarChartIcon width={32} height={32} className="text-[#008080]" /> Informes de Ventas
                        </h1>
                            <div className="text-sm text-gray-500">
                                Actualizado: {new Date().toLocaleDateString('es-ES')}
                            </div>
                        </div>
                        
                        {/* Filtros */}
                        <div className="bg-white p-4 rounded-lg shadow-sm grid grid-cols-1 md:grid-cols-3 gap-4">
                            <FormSelect 
                                label="Filtrar por Producto" 
                                value={productFilter} 
                                onChange={(e) => setProductFilter(e.target.value)} 
                                options={productOptions.map(p => ({
                                    value: p, 
                                    label: p === 'all' ? 'Todos los productos' : p
                                }))} 
                            />
                            <FormSelect 
                                label="Filtrar por Comercial" 
                                value={salespersonFilter} 
                                onChange={(e) => setSalespersonFilter(e.target.value)} 
                                options={salespersonOptions.map(s => ({
                                    value: s, 
                                    label: s === 'all' ? 'Todos los comerciales' : s.substring(0,15) + (s.length > 15 ? '...' : '')
                                }))} 
                            />
                            <FormSelect 
                                label="Filtrar por Período" 
                                value={dateFilter} 
                                onChange={(e) => setDateFilter(e.target.value)} 
                                options={[
                                    { value: 'all', label: 'Todo el tiempo' },
                                    { value: 'thisMonth', label: 'Este mes' },
                                    { value: 'lastMonth', label: 'Mes pasado' },
                                    { value: 'thisYear', label: 'Este año' },
                                    { value: 'lastYear', label: 'Año pasado' }
                                ]} 
                            />
                        </div>

                        {/* Métricas principales */}
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            <StatCard 
                                title="Ventas Totales" 
                                value={`${totalSales.toFixed(2)} €`} 
                                icon={<DollarSignIcon />}
                                className="bg-gradient-to-r from-green-500 to-green-600 text-white"
                            />
                            <StatCard 
                                title="Nº Facturas Pagadas" 
                                value={totalInvoices} 
                                icon={<CheckSquareIcon />}
                                className="bg-gradient-to-r from-blue-500 to-blue-600 text-white"
                            />
                            <StatCard 
                                title="Ticket Medio" 
                                value={`${averageTicket.toFixed(2)} €`} 
                                icon={<UserIcon />}
                                className="bg-gradient-to-r from-purple-500 to-purple-600 text-white"
                            />
                            <StatCard 
                                title="IVA Recaudado" 
                                value={`${totalVat.toFixed(2)} €`} 
                                icon={<TrendingUpIcon />}
                                className="bg-gradient-to-r from-orange-500 to-orange-600 text-white"
                            />
                        </div>

                        {/* Gráficos */}
                        <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                            {salesByMonth.length > 0 && (
                                <div className="bg-white p-6 rounded-lg shadow">
                                    <h3 className="text-xl font-semibold mb-4 text-gray-800 flex items-center gap-2">
                                        <TrendingUpIcon width={20} height={20} /> Ventas por Mes
                                    </h3>
                                    <div style={{ width: '100%', height: 300 }}>
                                        <Recharts.ResponsiveContainer>
                                            <Recharts.LineChart data={salesByMonth} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}>
                                                <Recharts.CartesianGrid strokeDasharray="3 3" />
                                                <Recharts.XAxis dataKey="name" />
                                                <Recharts.YAxis />
                                                <Recharts.Tooltip formatter={(value) => [`${value} €`, 'Ventas']} />
                                                <Recharts.Legend />
                                                <Recharts.Line 
                                                    type="monotone" 
                                                    dataKey="Ventas" 
                                                    stroke="#008080" 
                                                    strokeWidth={3}
                                                    dot={{ fill: '#008080', strokeWidth: 2, r: 4 }}
                                                />
                                            </Recharts.LineChart>
                                        </Recharts.ResponsiveContainer>
                                    </div>
                                </div>
                            )}

                            {salesByQuarter.length > 0 && (
                                <div className="bg-white p-6 rounded-lg shadow">
                                    <h3 className="text-xl font-semibold mb-4 text-gray-800 flex items-center gap-2">
                                        <BarChartIcon width={20} height={20} /> Ventas por Trimestre
                                    </h3>
                                    <div style={{ width: '100%', height: 300 }}>
                                        <Recharts.ResponsiveContainer>
                                            <Recharts.BarChart data={salesByQuarter} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}>
                                                <Recharts.CartesianGrid strokeDasharray="3 3" />
                                                <Recharts.XAxis dataKey="name" />
                                                <Recharts.YAxis />
                                                <Recharts.Tooltip formatter={(value) => [`${value} €`, 'Ventas']} />
                                                <Recharts.Legend />
                                                <Recharts.Bar 
                                                    dataKey="Ventas" 
                                                    fill="#006666"
                                                    radius={[4, 4, 0, 0]}
                                                />
                                            </Recharts.BarChart>
                                        </Recharts.ResponsiveContainer>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Top Productos */}
                        {topProducts.length > 0 && (
                            <div className="bg-white p-6 rounded-lg shadow">
                                <h3 className="text-xl font-semibold mb-4 text-gray-800 flex items-center gap-2">
                                    <TrophyIcon width={20} height={20} /> Top 5 Productos por Ingresos
                                </h3>
                                <div className="space-y-3">
                                    {topProducts.map((product, index) => (
                                        <div key={product.name} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                            <div className="flex items-center gap-3">
                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold
                                                    ${index === 0 ? 'bg-yellow-500' : 
                                                      index === 1 ? 'bg-gray-400' : 
                                                      index === 2 ? 'bg-orange-600' : 'bg-gray-300'}`}>
                                                    {index + 1}
                                                </div>
                                                <div>
                                                    <div className="font-semibold text-gray-900">{product.name}</div>
                                                    <div className="text-sm text-gray-500">
                                                        {product.quantity} unidades vendidas
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-bold text-green-600">
                                                    {product.revenue.toFixed(2)} €
                                                </div>
                                                <div className="text-sm text-gray-500">
                                                    {(product.revenue / product.quantity).toFixed(2)} €/ud
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Mensaje cuando no hay datos */}
                        {filteredInvoices.length === 0 && (
                            <div className="bg-white p-8 rounded-lg shadow text-center">
                                <div className="text-gray-400 text-6xl mb-4 flex justify-center">
                                    <BarChartIcon width={72} height={72} />
                                </div>
                                <h3 className="text-xl font-semibold text-gray-600 mb-2">
                                    No hay datos para mostrar
                                </h3>
                                <p className="text-gray-500">
                                    No se encontraron facturas pagadas que coincidan con los filtros seleccionados.
                                </p>
                                <button 
                                    onClick={() => {
                                        setProductFilter('all');
                                        setSalespersonFilter('all');
                                        setDateFilter('all');
                                    }}
                                    className="mt-4 px-4 py-2 bg-[#008080] text-white rounded-lg hover:bg-[#006666]"
                                >
                                    Limpiar filtros
                                </button>
                            </div>
                        )}
                    </div>
                );
            }
            function BulkCommunication({ clients, onBack }) {
                const [message, setMessage] = useState('');
                const [filter, setFilter] = useState('all');
               
                const eligibleClients = useMemo(() => {
                    return clients.filter(c => c.acceptsMarketing && (filter === 'all' || c.funnelStage === filter));
                }, [clients, filter]);

                const handleSendEmail = () => {
                    const emails = eligibleClients.map(c => c.email).filter(email => email).join(',');
                    if (!emails) { 
                        alert('No hay clientes elegibles para enviar email o no tienen dirección de correo.'); 
                        return; 
                    }
                    window.open(`mailto:?bcc=${emails}&subject=Novedades de Expertia Medical Solutions&body=${encodeURIComponent(message)}`, '_blank');
                };

                const handleSendWhatsapp = () => {
                    if (!message) { 
                        alert('El mensaje no puede estar vacío.'); 
                        return; 
                    }
                    window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
                };

                const funnelOptions = [
                    { value: 'all', label: 'Todas las fases' },
                    ...Object.keys(FUNNEL_TAGS).map(stage => ({ value: stage, label: stage }))
                ];

                return (
                    <div className="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
                        <div className="flex items-center gap-3 mb-6">
                            <MegaphoneIcon width={36} height={36} className="text-[#008080]" />
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900">Comunicación Masiva</h2>
                                <p className="text-sm text-gray-600">Envía mensajes únicamente a clientes que aceptan comunicaciones comerciales</p>
                            </div>
                        </div>
                        
                        {/* Panel de filtros y estadísticas */}
                        <div className="bg-gray-50 p-4 rounded-lg mb-6">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <FormSelect 
                                    label="Filtrar por Fase del Embudo" 
                                    value={filter} 
                                    onChange={(e) => setFilter(e.target.value)} 
                                    options={funnelOptions}
                                />
                                <div className="md:col-span-2 flex items-center gap-4">
                                    <div className="bg-white p-3 rounded-lg border flex-1">
                                        <div className="text-2xl font-bold text-green-600">{eligibleClients.length}</div>
                                        <div className="text-sm text-gray-600">Clientes seleccionados</div>
                                    </div>
                                    <div className="bg-white p-3 rounded-lg border flex-1">
                                        <div className="text-2xl font-bold text-blue-600">
                                            {eligibleClients.filter(c => c.email).length}
                                        </div>
                                        <div className="text-sm text-gray-600">Con email válido</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Lista de clientes seleccionados */}
                        {eligibleClients.length > 0 && (
                            <div className="mb-6">
                                <h3 className="text-lg font-semibold text-gray-800 mb-3">
                                    Clientes que recibirán el mensaje:
                                </h3>
                                <div className="bg-gray-50 p-4 rounded-lg max-h-32 overflow-y-auto">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                                        {eligibleClients.map(client => (
                                            <div key={client.id} className="flex items-center gap-2 text-sm">
                                                <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                                                <span className="font-medium">{client.name}</span>
                                                <span className="text-gray-500">({client.funnelStage})</span>
                                                {!client.email && (
                                                    <span className="text-red-500 text-xs flex items-center gap-1">
                                                        <AlertTriangleIcon width={12} height={12} /> Sin email
                                                    </span>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Editor de mensaje */}
                        <div className="mb-6">
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                Mensaje a enviar:
                            </label>
                            <textarea 
                                value={message} 
                                onChange={(e) => setMessage(e.target.value)} 
                                rows="8" 
                                placeholder="Escribe tu mensaje aquí...

Ejemplo:
¡Hola! 👋

Desde Expertia Medical Solutions queremos compartir contigo nuestras últimas novedades:

✅ Nuevos productos disponibles
✅ Ofertas especiales para este mes
✅ Próximos webinars formativos

¿Te interesa conocer más detalles? ¡Contáctanos!

Saludos,
Equipo Expertia Medical Solutions" 
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#008080] focus:border-transparent resize-none"
                            />
                            <div className="text-sm text-gray-500 mt-1">
                                Caracteres: {message.length}
                            </div>
                        </div>

                        {/* Botones de acción */}
                        <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                            <button 
                                onClick={onBack} 
                                className="bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors"
                            >
                                ← Volver al Dashboard
                            </button>
                            
                            <div className="flex flex-col sm:flex-row gap-3">
                                <button 
                                    onClick={handleSendWhatsapp}
                                    disabled={!message.trim()}
                                    className="bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors flex items-center gap-2"
                                >
                                    <SmartphoneIcon width={16} height={16} /> Enviar por WhatsApp
                                </button>
                                <button 
                                    onClick={handleSendEmail}
                                    disabled={!message.trim() || eligibleClients.filter(c => c.email).length === 0}
                                    className="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors flex items-center gap-2"
                                >
                                    <EmailIcon width={16} height={16} /> Enviar por Email (BCC)
                                </button>
                            </div>
                        </div>

                        {/* Advertencias y información */}
                        <div className="mt-6 space-y-3">
                            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div className="flex items-start gap-2">
                                    <AlertTriangleIcon width={20} height={20} className="text-yellow-600 mt-0.5" />
                                    <div>
                                        <h4 className="font-semibold text-yellow-800">Información importante:</h4>
                                        <ul className="text-sm text-yellow-700 mt-1 list-disc list-inside space-y-1">
                                            <li>Solo se enviarán mensajes a clientes que han aceptado recibir comunicaciones comerciales</li>
                                            <li>Para WhatsApp, se abrirá la aplicación con el mensaje preparado</li>
                                            <li>Para email, se abrirá tu cliente de correo con los destinatarios en BCC (copia oculta)</li>
                                            <li>Asegúrate de cumplir con la LOPD y el RGPD en tus comunicaciones</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            {eligibleClients.length === 0 && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                                    <div className="flex items-center gap-2">
                                        <div className="text-red-600 text-lg">🚫</div>
                                        <div>
                                            <h4 className="font-semibold text-red-800">No hay clientes seleccionados</h4>
                                            <p className="text-sm text-red-700 mt-1">
                                                No hay clientes que cumplan los criterios de filtrado y que hayan aceptado recibir comunicaciones comerciales.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }
            
            // Formulario de Perfil de Usuario
            function ProfileForm({ userProfile, onSave, onBack }) {
                const [profile, setProfile] = useState({ 
                    name: '', 
                    email: '', 
                    phone: '', 
                    photoURL: '',
                    role: 'comercial'
                });

                useEffect(() => {
                    if (userProfile) {
                        setProfile(userProfile);
                    }
                }, [userProfile]);

                const handleChange = (e) => {
                    const { name, value } = e.target;
                    setProfile({ ...profile, [name]: value });
                };

                const handlePhotoChange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            setProfile({ ...profile, photoURL: reader.result });
                        };
                        reader.readAsDataURL(file);
                    }
                };

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onSave(profile);
                };

                return (
                    <div className="max-w-2xl mx-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-3xl font-bold text-gray-900">Perfil de Usuario</h1>
                            <button onClick={onBack} className="text-gray-500 hover:text-gray-700">
                                <XIcon width={24} height={24} />
                            </button>
                        </div>

                        <form onSubmit={handleSubmit} className="bg-white p-8 rounded-lg shadow-lg space-y-6">
                            <div className="flex justify-center mb-6">
                                <div className="relative">
                                    <img 
                                        src={profile.photoURL || 'https://placehold.co/120x120/006666/FFFFFF?text=U'} 
                                        alt="Foto de perfil" 
                                        className="w-32 h-32 rounded-full object-cover border-4 border-[#006666]"
                                    />
                                    <input
                                        type="file"
                                        accept="image/*"
                                        onChange={handlePhotoChange}
                                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                    />
                                    <div className="absolute bottom-0 right-0 bg-[#006666] text-white rounded-full p-2">
                                        <EditIcon />
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <FormField 
                                    label="Nombre Completo" 
                                    name="name" 
                                    value={profile.name} 
                                    onChange={handleChange} 
                                    required 
                                />
                                <FormField 
                                    label="Email" 
                                    name="email" 
                                    type="email" 
                                    value={profile.email} 
                                    onChange={handleChange} 
                                    required 
                                />
                                <FormField 
                                    label="Teléfono" 
                                    name="phone" 
                                    value={profile.phone} 
                                    onChange={handleChange} 
                                />
                                <FormSelect 
                                    label="Rol en el Sistema" 
                                    name="role" 
                                    value={profile.role} 
                                    onChange={handleChange}
                                    options={[
                                        { value: 'comercial', label: 'Comercial' },
                                        { value: 'admin', label: 'Administrador' }
                                    ]}
                                />
                            </div>

                            <div className="bg-blue-50 border-l-4 border-blue-400 p-4">
                                <div className="flex">
                                    <div className="flex-shrink-0">
                                        <UserIcon />
                                    </div>
                                    <div className="ml-3">
                                        <p className="text-sm text-blue-700">
                                            <strong>Información sobre roles:</strong>
                                        </p>
                                        <ul className="mt-2 text-sm text-blue-600">
                                            <li>• <strong>Comercial:</strong> Acceso a gestión de clientes, ofertas y facturación</li>
                                            <li>• <strong>Administrador:</strong> Acceso completo + gestión de productos y usuarios</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div className="flex justify-end gap-4 pt-6">
                                <button 
                                    type="button" 
                                    onClick={onBack} 
                                    className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                >
                                    Cancelar
                                </button>
                                <button 
                                    type="submit" 
                                    className="px-6 py-3 bg-[#006666] text-white rounded-lg hover:bg-[#005555]"
                                >
                                    Guardar Perfil
                                </button>
                            </div>
                        </form>
                    </div>
                );
            }
            
            // Formulario de Productos
            function ProductForm({ product, onSave, onCancel }) {
                const [activeTab, setActiveTab] = useState('basic');
                const [formData, setFormData] = useState({
                    // Información básica
                    name: product?.name || '',
                    description: product?.description || '',
                    category: product?.category || '',
                    subcategory: product?.subcategory || '',
                    brand: product?.brand || '',
                    model: product?.model || '',
                    
                    // Códigos e identificación
                    code: product?.code || '',
                    sku: product?.sku || '',
                    
                    // Precios e inventario
                    price: product?.price || '',
                    stock: product?.stock || 0,
                    minStock: product?.minStock || 0,
                    availability: product?.availability || 'En Stock',
                    
                    // Proveedor y especificaciones
                    supplier: product?.supplier || '',
                    specifications: product?.specifications || '',
                    warranty: product?.warranty || '',
                    
                    // Estado y configuración
                    active: product?.active !== undefined ? product.active : true,
                    featured: product?.featured || false
                });

                const handleSubmit = (e) => {
                    e.preventDefault();
                    const now = new Date().toISOString();
                    const currentUser = 'Usuario Actual'; // TODO: obtener del contexto de autenticación
                    
                    const productData = {
                        ...formData,
                        price: parseFloat(formData.price) || 0,
                        stock: parseInt(formData.stock) || 0,
                        minStock: parseInt(formData.minStock) || 0,
                        active: Boolean(formData.active),
                        featured: Boolean(formData.featured),
                        id: product?.id || Date.now().toString(),
                        
                        // Auditoría
                        updatedAt: now,
                        updatedBy: currentUser,
                        ...(product ? {} : {
                            createdAt: now,
                            createdBy: currentUser
                        })
                    };
                    onSave(productData);
                };

                const handleChange = (field, value) => {
                    setFormData(prev => ({ ...prev, [field]: value }));
                };

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h1 className="text-3xl font-bold text-gray-900">
                                {product ? 'Editar Producto' : 'Nuevo Producto'}
                            </h1>
                            <button
                                onClick={onCancel}
                                className="text-gray-500 hover:text-gray-700"
                            >
                                <XIcon width={24} height={24} />
                            </button>
                        </div>

                        <div className="bg-white rounded-lg shadow p-6">
                            {/* Pestañas de navegación */}
                            <div className="border-b border-gray-200 mb-6">
                                <nav className="-mb-px flex space-x-8">
                                    <button
                                        type="button"
                                        onClick={() => setActiveTab('basic')}
                                        className={`py-2 px-1 border-b-2 font-medium text-sm flex items-center gap-2 ${
                                            activeTab === 'basic'
                                                ? 'border-[#006666] text-[#006666]'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        }`}
                                    >
                                        <InfoIcon width={20} height={20} /> Información Básica
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setActiveTab('inventory')}
                                        className={`py-2 px-1 border-b-2 font-medium text-sm flex items-center gap-2 ${
                                            activeTab === 'inventory'
                                                ? 'border-[#006666] text-[#006666]'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        }`}
                                    >
                                        <PackageIcon width={20} height={20} /> Inventario y Precios
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setActiveTab('specs')}
                                        className={`py-2 px-1 border-b-2 font-medium text-sm flex items-center gap-2 ${
                                            activeTab === 'specs'
                                                ? 'border-[#006666] text-[#006666]'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        }`}
                                    >
                                        <FileTextIcon /> Especificaciones
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setActiveTab('config')}
                                        className={`py-2 px-1 border-b-2 font-medium text-sm flex items-center gap-2 ${
                                            activeTab === 'config'
                                                ? 'border-[#006666] text-[#006666]'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        }`}
                                    >
                                        <SettingsIcon width={20} height={20} /> Configuración
                                    </button>
                                </nav>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-6">
                                {/* Pestaña: Información Básica */}
                                {activeTab === 'basic' && (
                                    <div className="space-y-6">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Nombre del Producto *
                                                </label>
                                                <input
                                                    type="text"
                                                    value={formData.name}
                                                    onChange={(e) => handleChange('name', e.target.value)}
                                                    required
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="Nombre del producto"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Marca
                                                </label>
                                                <input
                                                    type="text"
                                                    value={formData.brand}
                                                    onChange={(e) => handleChange('brand', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="Marca del producto"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Modelo
                                                </label>
                                                <input
                                                    type="text"
                                                    value={formData.model}
                                                    onChange={(e) => handleChange('model', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="Modelo del producto"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Categoría *
                                                </label>
                                                <select
                                                    value={formData.category}
                                                    onChange={(e) => handleChange('category', e.target.value)}
                                                    required
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                >
                                                    <option value="">Seleccionar categoría</option>
                                                    <option value="Equipos Médicos">Equipos Médicos</option>
                                                    <option value="Instrumentos">Instrumentos</option>
                                                    <option value="Consumibles">Consumibles</option>
                                                    <option value="Software">Software</option>
                                                    <option value="Servicios">Servicios</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Subcategoría
                                                </label>
                                                <input
                                                    type="text"
                                                    value={formData.subcategory}
                                                    onChange={(e) => handleChange('subcategory', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="Subcategoría específica"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Proveedor
                                                </label>
                                                <input
                                                    type="text"
                                                    value={formData.supplier}
                                                    onChange={(e) => handleChange('supplier', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="Nombre del proveedor"
                                                />
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Descripción
                                            </label>
                                            <textarea
                                                value={formData.description}
                                                onChange={(e) => handleChange('description', e.target.value)}
                                                rows={4}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                placeholder="Descripción detallada del producto"
                                            />
                                        </div>
                                    </div>
                                )}

                                {/* Pestaña: Inventario y Precios */}
                                {activeTab === 'inventory' && (
                                    <div className="space-y-6">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Código del Producto
                                                </label>
                                                <input
                                                    type="text"
                                                    value={formData.code}
                                                    onChange={(e) => handleChange('code', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="Código interno"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    SKU
                                                </label>
                                                <input
                                                    type="text"
                                                    value={formData.sku}
                                                    onChange={(e) => handleChange('sku', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="SKU del producto"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Precio (€) *
                                                </label>
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    value={formData.price}
                                                    onChange={(e) => handleChange('price', e.target.value)}
                                                    required
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="0.00"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Disponibilidad
                                                </label>
                                                <select
                                                    value={formData.availability}
                                                    onChange={(e) => handleChange('availability', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                >
                                                    <option value="En Stock">En Stock</option>
                                                    <option value="Bajo Stock">Bajo Stock</option>
                                                    <option value="Sin Stock">Sin Stock</option>
                                                    <option value="Descontinuado">Descontinuado</option>
                                                    <option value="Pedido Especial">Pedido Especial</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Stock Actual
                                                </label>
                                                <input
                                                    type="number"
                                                    value={formData.stock}
                                                    onChange={(e) => handleChange('stock', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="0"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Stock Mínimo
                                                </label>
                                                <input
                                                    type="number"
                                                    value={formData.minStock}
                                                    onChange={(e) => handleChange('minStock', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="0"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Pestaña: Especificaciones */}
                                {activeTab === 'specs' && (
                                    <div className="space-y-6">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Especificaciones Técnicas
                                            </label>
                                            <textarea
                                                value={formData.specifications}
                                                onChange={(e) => handleChange('specifications', e.target.value)}
                                                rows={6}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                placeholder="Especificaciones técnicas detalladas del producto..."
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Garantía
                                            </label>
                                            <input
                                                type="text"
                                                value={formData.warranty}
                                                onChange={(e) => handleChange('warranty', e.target.value)}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                placeholder="Ej: 2 años, 12 meses, De por vida"
                                            />
                                        </div>
                                    </div>
                                )}

                                {/* Pestaña: Configuración */}
                                {activeTab === 'config' && (
                                    <div className="space-y-6">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="flex items-center">
                                                <input
                                                    type="checkbox"
                                                    id="active"
                                                    checked={formData.active}
                                                    onChange={(e) => handleChange('active', e.target.checked)}
                                                    className="h-4 w-4 text-[#006666] focus:ring-[#006666] border-gray-300 rounded"
                                                />
                                                <label htmlFor="active" className="ml-2 block text-sm text-gray-900">
                                                    Producto Activo
                                                </label>
                                            </div>

                                            <div className="flex items-center">
                                                <input
                                                    type="checkbox"
                                                    id="featured"
                                                    checked={formData.featured}
                                                    onChange={(e) => handleChange('featured', e.target.checked)}
                                                    className="h-4 w-4 text-[#006666] focus:ring-[#006666] border-gray-300 rounded"
                                                />
                                                <label htmlFor="featured" className="ml-2 block text-sm text-gray-900">
                                                    Producto Destacado
                                                </label>
                                            </div>
                                        </div>

                                        {product && (
                                            <div className="bg-gray-50 p-4 rounded-lg">
                                                <h4 className="font-medium text-gray-900 mb-2 flex items-center gap-2">
                                                    <ClockIcon width={20} height={20} /> Información de Auditoría
                                                </h4>
                                                <div className="text-sm text-gray-600 space-y-1">
                                                    <p><strong>Creado:</strong> {product.createdAt ? new Date(product.createdAt).toLocaleString() : 'No disponible'}</p>
                                                    <p><strong>Creado por:</strong> {product.createdBy || 'No disponible'}</p>
                                                    <p><strong>Última actualización:</strong> {product.updatedAt ? new Date(product.updatedAt).toLocaleString() : 'No disponible'}</p>
                                                    <p><strong>Actualizado por:</strong> {product.updatedBy || 'No disponible'}</p>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                <div className="flex justify-end gap-3 pt-6 border-t border-gray-200">
                                    <button
                                        type="button"
                                        onClick={onCancel}
                                        className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        type="submit"
                                        className="px-6 py-3 bg-[#006666] text-white rounded-lg hover:bg-[#005555]"
                                    >
                                        {product ? 'Actualizar' : 'Crear'} Producto
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }
            
            // Panel de Administración
            function AdminPanel({ products, onSaveProduct, onDeleteProduct }) {
                const [activeTab, setActiveTab] = useState('products');
                const [showProductForm, setShowProductForm] = useState(false);
                const [editingProduct, setEditingProduct] = useState(null);
                
                const handleAddProduct = () => {
                    setEditingProduct(null);
                    setShowProductForm(true);
                };
                
                const handleEditProduct = (product) => {
                    setEditingProduct(product);
                    setShowProductForm(true);
                };
                
                const handleSaveProduct = (productData) => {
                    onSaveProduct(productData);
                    setShowProductForm(false);
                    setEditingProduct(null);
                };
                
                if (showProductForm) {
                    return (
                        <ProductForm 
                            product={editingProduct}
                            onSave={handleSaveProduct}
                            onCancel={() => {
                                setShowProductForm(false);
                                setEditingProduct(null);
                            }}
                        />
                    );
                }
                
                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h1 className="text-3xl font-bold text-gray-900">Panel de Administración</h1>
                        </div>
                        
                        <div className="bg-white rounded-lg shadow">
                            <div className="border-b border-gray-200">
                                <nav className="flex space-x-8 px-6">
                                    <button 
                                        onClick={() => setActiveTab('products')}
                                        className={`py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'products' ? 'border-[#006666] text-[#006666]' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                                    >
                                        Gestión de Productos
                                    </button>
                                    <button 
                                        onClick={() => setActiveTab('users')}
                                        className={`py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'users' ? 'border-[#006666] text-[#006666]' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                                    >
                                        Gestión de Usuarios
                                    </button>
                                </nav>
                            </div>
                            
                            <div className="p-6">
                                {activeTab === 'products' && (
                                    <div>
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="text-xl font-semibold">Productos del Catálogo</h2>
                                            <button 
                                                onClick={handleAddProduct}
                                                className="bg-[#006666] text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-[#005555]"
                                            >
                                                <PlusIcon width={20} height={20} />
                                                Añadir Producto
                                            </button>
                                        </div>
                                        
                                        <div className="grid gap-4">
                                            {products.map(product => (
                                                <div key={product.id} className="border border-gray-200 rounded-lg p-4">
                                                    <div className="flex justify-between items-start">
                                                        <div>
                                                            <h3 className="font-semibold text-lg">{product.name}</h3>
                                                            <p className="text-gray-600">{product.description}</p>
                                                            <p className="text-sm text-gray-500">Categoría: {product.category}</p>
                                                            <p className="text-sm text-gray-500">Proveedor: {product.supplier}</p>
                                                            <p className="text-lg font-medium text-[#006666]">{product.price?.toLocaleString('es-ES')}€</p>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button 
                                                                onClick={() => handleEditProduct(product)}
                                                                className="p-2 text-blue-600 hover:bg-blue-50 rounded"
                                                            >
                                                                <EditIcon />
                                                            </button>
                                                            <button 
                                                                onClick={() => onDeleteProduct(product.id)}
                                                                className="p-2 text-red-600 hover:bg-red-50 rounded"
                                                            >
                                                                <TrashIcon />
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                {activeTab === 'users' && (
                                    <div>
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="text-xl font-semibold">Gestión de Usuarios</h2>
                                            <button className="bg-[#006666] text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-[#005555]">
                                                <PlusIcon width={20} height={20} />
                                                Invitar Usuario
                                            </button>
                                        </div>
                                        
                                        <div className="text-center py-8 text-gray-500">
                                            <p>Gestión de usuarios en desarrollo</p>
                                            <p className="text-sm">Próximamente: invitar usuarios, asignar roles, gestionar permisos</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // === COMPONENTES DE FORMULARIO ===
            function FormField({ label, as = "input", ...props }) {
                const Component = as === "textarea" ? "textarea" : "input";
                return (
                    <div>
                        {label && (
                            <label htmlFor={props.name} className="block text-sm font-medium text-gray-700 mb-1">
                                {label}
                            </label>
                        )}
                        <Component 
                            id={props.name} 
                            {...props} 
                            className="block w-full rounded-md border-2 border-gray-400 shadow-sm focus:border-[#006666] focus:ring-[#006666] hover:border-gray-500 sm:text-sm p-3 transition-colors" 
                        />
                    </div>
                );
            }

            function FormSelect({ label, options, ...props }) {
                return (
                    <div>
                        <label htmlFor={props.name} className="block text-sm font-medium text-gray-700 mb-1">
                            {label}
                        </label>
                        <select 
                            id={props.name} 
                            {...props} 
                            className="mt-1 block w-full rounded-md border-2 border-gray-400 shadow-sm focus:border-[#006666] focus:ring-[#006666] hover:border-gray-500 sm:text-sm p-3 transition-colors"
                        >
                            {options.map(opt => (
                                <option key={opt.value || opt} value={opt.value || opt}>
                                    {opt.label || opt}
                                </option>
                            ))}
                        </select>
                    </div>
                );
            }
            
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        }
        
        // Sistema de autenticación integrado
        async function initAuthAndApp() {
            // Primero cargar nuestro sistema de autenticación
            try {
                // Crear instancia del AuthManager
                if (!window.authManager) {
                    // Importar el código de auth-simple.js si no está disponible
                    const script = document.createElement('script');
                    script.src = './auth-simple.js';
                    document.head.appendChild(script);
                    
                    // Esperar a que se cargue
                    await new Promise((resolve) => {
                        script.onload = resolve;
                    });
                }
                
                // Inicializar autenticación
                await window.authManager.init();
                
                // Verificar si hay usuario autenticado
                const currentUser = window.authManager.getCurrentUser();
                
                if (currentUser) {
                    console.log('✅ Usuario autenticado, iniciando aplicación principal');
                    startApp();
                } else {
                    console.log('❌ Usuario no autenticado, mostrando pantalla de login');
                    showAuthScreen();
                }
                
            } catch (error) {
                console.error('Error en inicialización de autenticación:', error);
                // En caso de error, mostrar pantalla de login
                showAuthScreen();
            }
        }
        
        // Función para mostrar pantalla de selección inicial
        function showAuthScreen() {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-width: 400px; width: 100%; margin: 1rem;">
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <h1 style="font-size: 1.5rem; font-weight: bold; color: #1a202c; margin-bottom: 0.5rem;">Expertia CRM</h1>
                            <p style="color: #718096;">Bienvenido</p>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <button 
                                onclick="showLoginScreen()"
                                style="width: 100%; background: #3b82f6; color: white; padding: 0.875rem; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 1rem;"
                            >
                                Iniciar Sesión
                            </button>
                            
                            <button 
                                onclick="showRegisterScreen()"
                                style="width: 100%; background: #10b981; color: white; padding: 0.875rem; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 1rem;"
                            >
                                Registrarse
                            </button>
                            
                            <div style="position: relative; margin: 1rem 0;">
                                <div style="position: absolute; inset: 0; display: flex; align-items: center;">
                                    <div style="width: 100%; border-top: 1px solid #e5e7eb;"></div>
                                </div>
                                <div style="position: relative; display: flex; justify-content: center; text-transform: uppercase;">
                                    <span style="background: white; padding: 0 1rem; color: #6b7280; font-size: 0.875rem;">O</span>
                                </div>
                            </div>
                            
                            <button 
                                onclick="handleGoogleLogin()"
                                style="width: 100%; background: white; color: #374151; padding: 0.875rem; border: 1px solid #d1d5db; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;"
                            >
                                <svg width="20" height="20" viewBox="0 0 24 24">
                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                Continuar con Google
                            </button>
                        </div>
                        
                        <div id="auth-status" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; display: none;"></div>
                    </div>
                </div>
            `;
        }
        
        // Función para mostrar pantalla de login
        function showLoginScreen() {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-width: 400px; width: 100%; margin: 1rem;">
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <h1 style="font-size: 1.5rem; font-weight: bold; color: #1a202c; margin-bottom: 0.5rem;">Iniciar Sesión</h1>
                            <p style="color: #718096;">Accede a tu cuenta</p>
                        </div>
                        
                        <form id="login-form" onsubmit="event.preventDefault(); handleLogin();">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Email</label>
                                <input 
                                    type="email" 
                                    id="auth-email" 
                                    required
                                    style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; box-sizing: border-box;"
                                    placeholder="tu@email.com"
                                >
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Contraseña</label>
                                <input 
                                    type="password" 
                                    id="auth-password" 
                                    required
                                    style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; box-sizing: border-box;"
                                    placeholder="Tu contraseña"
                                >
                            </div>
                            
                            <button 
                                type="submit"
                                style="width: 100%; background: #3b82f6; color: white; padding: 0.75rem; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; margin-bottom: 1rem;"
                            >
                                Iniciar Sesión
                            </button>
                        </form>
                        
                        <div style="text-align: center;">
                            <button 
                                onclick="showAuthScreen()"
                                style="background: none; border: none; color: #6b7280; text-decoration: underline; cursor: pointer;"
                            >
                                ← Volver
                            </button>
                        </div>
                        
                        <div id="auth-status" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; display: none;"></div>
                    </div>
                </div>
            `;
        }
        
        // Función para mostrar pantalla de registro
        function showRegisterScreen() {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-width: 400px; width: 100%; margin: 1rem;">
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <h1 style="font-size: 1.5rem; font-weight: bold; color: #1a202c; margin-bottom: 0.5rem;">Registrarse</h1>
                            <p style="color: #718096;">Crea tu cuenta nueva</p>
                        </div>
                        
                        <form id="register-form" onsubmit="event.preventDefault(); handleRegister();">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Email</label>
                                <input 
                                    type="email" 
                                    id="auth-email" 
                                    required
                                    style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; box-sizing: border-box;"
                                    placeholder="tu@email.com"
                                >
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Contraseña</label>
                                <input 
                                    type="password" 
                                    id="auth-password" 
                                    required
                                    style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; box-sizing: border-box;"
                                    placeholder="Mínimo 6 caracteres"
                                >
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Confirmar Contraseña</label>
                                <input 
                                    type="password" 
                                    id="auth-password-confirm" 
                                    required
                                    style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; box-sizing: border-box;"
                                    placeholder="Repite tu contraseña"
                                >
                            </div>
                            
                            <button 
                                type="submit"
                                style="width: 100%; background: #10b981; color: white; padding: 0.75rem; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; margin-bottom: 1rem;"
                            >
                                Crear Cuenta
                            </button>
                        </form>
                        
                        <div style="text-align: center;">
                            <button 
                                onclick="showAuthScreen()"
                                style="background: none; border: none; color: #6b7280; text-decoration: underline; cursor: pointer;"
                            >
                                ← Volver
                            </button>
                        </div>
                        
                        <div id="auth-status" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; display: none;"></div>
                    </div>
                </div>
            `;
        }
        
        // Funciones de manejo de autenticación
        async function handleLogin() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            
            if (!email || !password) {
                showAuthStatus('Por favor completa todos los campos', 'error');
                return;
            }
            
            try {
                showAuthStatus('Iniciando sesión...', 'info');
                await window.authManager.login(email, password);
                showAuthStatus('✅ Sesión iniciada, cargando aplicación...', 'success');
                
                // Esperar un momento y luego cargar la aplicación
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('Error de login:', error);
                let friendlyMessage = '';
                
                // Convertir errores de Firebase a mensajes amigables
                if (error.message.includes('auth/invalid-credential')) {
                    friendlyMessage = 'Email o contraseña incorrectos';
                } else if (error.message.includes('auth/user-not-found')) {
                    friendlyMessage = 'No existe una cuenta con este email';
                } else if (error.message.includes('auth/wrong-password')) {
                    friendlyMessage = 'Contraseña incorrecta';
                } else if (error.message.includes('auth/invalid-email')) {
                    friendlyMessage = 'El formato del email no es válido';
                } else if (error.message.includes('auth/too-many-requests')) {
                    friendlyMessage = 'Demasiados intentos fallidos. Intenta más tarde';
                } else {
                    friendlyMessage = 'Error de conexión. Verifica tu internet';
                }
                
                showAuthStatus('❌ ' + friendlyMessage, 'error');
            }
        }
        
        async function handleRegister() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const passwordConfirm = document.getElementById('auth-password-confirm') ? document.getElementById('auth-password-confirm').value : password;
            
            if (!email || !password) {
                showAuthStatus('Por favor completa todos los campos', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAuthStatus('La contraseña debe tener al menos 6 caracteres', 'error');
                return;
            }
            
            if (passwordConfirm && password !== passwordConfirm) {
                showAuthStatus('Las contraseñas no coinciden', 'error');
                return;
            }
            
            try {
                showAuthStatus('Registrando usuario...', 'info');
                await window.authManager.register(email, password);
                showAuthStatus('✅ Usuario registrado, cargando aplicación...', 'success');
                
                // Esperar un momento y luego cargar la aplicación
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('Error de registro:', error);
                let friendlyMessage = '';
                
                // Convertir errores de Firebase a mensajes amigables
                if (error.message.includes('auth/email-already-in-use')) {
                    friendlyMessage = 'Ya existe una cuenta con este email';
                } else if (error.message.includes('auth/invalid-email')) {
                    friendlyMessage = 'El formato del email no es válido';
                } else if (error.message.includes('auth/weak-password')) {
                    friendlyMessage = 'La contraseña es muy débil';
                } else if (error.message.includes('auth/operation-not-allowed')) {
                    friendlyMessage = 'El registro no está habilitado';
                } else {
                    friendlyMessage = 'Error de conexión. Verifica tu internet';
                }
                
                showAuthStatus('❌ ' + friendlyMessage, 'error');
            }
        }
        
        // Función para login con Google
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesión con Google...', 'info');
                await window.authManager.loginWithGoogle();
                showAuthStatus('✅ Sesión iniciada con Google, cargando aplicación...', 'success');
                
                // Esperar un momento y luego cargar la aplicación
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('Error de login con Google:', error);
                let friendlyMessage = '';
                
                // Convertir errores de Firebase a mensajes amigables
                if (error.message.includes('auth/popup-closed-by-user')) {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.message.includes('auth/popup-blocked')) {
                    friendlyMessage = 'Popup bloqueado. Permite popups en este sitio';
                } else if (error.message.includes('auth/cancelled-popup-request')) {
                    friendlyMessage = 'Login cancelado';
                } else if (error.message.includes('auth/operation-not-allowed')) {
                    friendlyMessage = 'Login con Google no está habilitado';
                } else {
                    friendlyMessage = 'Error de conexión. Verifica tu internet';
                }
                
                showAuthStatus('❌ ' + friendlyMessage, 'error');
            }
        }
        
        function showAuthStatus(message, type) {
            const statusDiv = document.getElementById('auth-status');
            statusDiv.textContent = message;
            
            // Estilos según el tipo
            if (type === 'error') {
                statusDiv.style.background = '#fef2f2';
                statusDiv.style.color = '#dc2626';
                statusDiv.style.border = '1px solid #fecaca';
            } else if (type === 'success') {
                statusDiv.style.background = '#f0fdf4';
                statusDiv.style.color = '#16a34a';
                statusDiv.style.border = '1px solid #bbf7d0';
            } else {
                statusDiv.style.background = '#f0f9ff';
                statusDiv.style.color = '#0284c7';
                statusDiv.style.border = '1px solid #bae6fd';
            }
            
            statusDiv.style.display = 'block';
            
            // Auto-ocultar después de 5 segundos si es éxito
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // Se llama a la función de inicialización después de que la ventana completa se haya cargado.
        window.onload = initAuthAndApp;
    </script>
</body>
</html>
