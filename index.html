<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expertia Software Solutions</title>
    <script src="https://cdn.tailwindcss.com">
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }</script>
    <script src="https://unpkg.com/react@18/umd/react.development.js">
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }</script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js">
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }</script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js">
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }</script>
    <!-- PropTypes para Recharts -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js">
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }</script>
    <script src="./recharts.min.js">
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }</script>
    <script>
        // Asegurar que PropTypes est√© disponible globalmente
        if (typeof window.PropTypes === 'undefined') {
            console.warn('[WARNING]  PropTypes no disponible, cargando desde CDN...');
        } else {
            console.log('[OK]  PropTypes cargado correctamente');
        }
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
    </script>
    
    <!-- üöÄ MEJORA 3/4: Librer√≠as para exportaci√≥n Excel/PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js">
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }</script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js">
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }</script>
    
    <link rel="icon" href="https://storage.googleapis.com/gemini-generative-ai-api/f55a1dda-6560-4321-aidb-53f36780a82f" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        @media print {
            body * { visibility: hidden; }
            #invoice-printable, #invoice-printable * { visibility: visible; }
            #invoice-printable { position: absolute; left: 0; top: 0; width: 100%; }
        }
        
        /* Estilos para toggle de contrase√±a */
        .password-toggle-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .password-toggle-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: #6b7280;
            font-size: 18px;
            transition: color 0.3s ease;
            z-index: 10;
        }
        
        .password-toggle-btn:hover {
            color: #374151;
        }
        
        .password-input {
            padding-right: 45px !important;
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="display:flex; justify-content:center; align-items:center; height:100vh; font-family: Inter, sans-serif; color: #4A5568;">
            Cargando Expertia Business Suite, un momento por favor...
        </div>
    </div>

    <script src="./firebase-config.js">
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }</script>
    <script src="./auth-simple.js">
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }</script>
    
    <!-- ÔøΩÔ∏è MODULARIZACI√ìN SEGURA: Incluir m√≥dulo de rendimiento -->
    <script src="./js/performance-utils.js">
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }</script>
    
    <!-- üß™ Script de prueba para system_settings -->
            <!-- <script src="./test-system-settings.js"></script> MOVIDO A archive/testing/ -->

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, runTransaction, setDoc, getDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";
        
        window.firebase = {
            initializeApp, getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken,
            getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, runTransaction, setDoc, getDoc, getDocs, where
        };
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
    </script>

    <script type="text/babel" data-presets="react">
        function startApp() {
            console.log('Intentando iniciar aplicaci√≥n...');
            console.log('React disponible:', typeof window.React !== 'undefined');
            console.log('ReactDOM disponible:', typeof window.ReactDOM !== 'undefined');
            console.log('Recharts disponible:', typeof window.Recharts !== 'undefined');
            console.log('Firebase disponible:', typeof window.firebase !== 'undefined');
            
            // Inicializaci√≥n mejorada de Recharts con verificaci√≥n de PropTypes
            if (typeof window.Recharts !== 'undefined' && typeof window.PropTypes !== 'undefined') {
                console.log('[OK]  Recharts cargado exitosamente desde archivo local');
                window.rechartsAvailable = true;
            } else {
                console.warn('[WARNING]  Recharts no disponible o PropTypes faltante, usando gr√°ficos fallback');
                window.rechartsAvailable = false;
            }
            
            if (typeof window.React === 'undefined' || typeof window.ReactDOM === 'undefined') {
                console.log('Esperando React...');
                setTimeout(startApp, 100);
                return;
            }

            const { useState, useEffect, useMemo } = React;
            
            // Componente de Configuraciones de Gastos
            function ExpenseSettings() {
                const [expenseConfig, setExpenseConfig] = useState({
                    categories: ['Alimentaci√≥n', 'Transporte', 'Material de Oficina', 'Servicios', 'Equipamiento', 'Marketing', 'Formaci√≥n', 'Otros'],
                    subcategories: {
                        'Alimentaci√≥n': ['Comidas', 'Bebidas', 'Catering'],
                        'Transporte': ['Gasolina', 'Taxi', 'Transporte p√∫blico', 'Parking'],
                        'Material de Oficina': ['Papeler√≠a', 'Equipos', 'Software'],
                        'Servicios': ['Limpieza', 'Mantenimiento', 'Consultor√≠a'],
                        'Equipamiento': ['Mobiliario', 'Tecnolog√≠a', 'Herramientas'],
                        'Marketing': ['Publicidad', 'Eventos', 'Material promocional'],
                        'Formaci√≥n': ['Cursos', 'Certificaciones', 'Conferencias'],
                        'Otros': ['Varios']
                    },
                    paymentTypes: ['Efectivo', 'Transferencia', 'Tarjeta', 'Cheque', 'Otros'],
                    statuses: ['Pendiente', 'Aprobado', 'Rechazado', 'Pagado'],
                    tags: ['Urgente', 'Recurrente', 'Importante', 'Reembolsable']
                });
                const [loading, setLoading] = useState(false);
                const [saved, setSaved] = useState(false);
                const [newCategory, setNewCategory] = useState('');
                const [newSubcategory, setNewSubcategory] = useState('');
                const [selectedCategory, setSelectedCategory] = useState('');
                const [newPaymentType, setNewPaymentType] = useState('');
                const [newStatus, setNewStatus] = useState('');
                const [newTag, setNewTag] = useState('');

                useEffect(() => {
                    // Esperar a que Firebase est√© disponible
                    const checkFirebaseAndLoad = () => {
                        if (window.authManager && window.authManager.app) {
                            loadExpenseSettingsFromFirebase();
                        } else {
                            // Reintentar despu√©s de un breve delay
                            setTimeout(checkFirebaseAndLoad, 100);
                        }
                    };
                    checkFirebaseAndLoad();
                }, []);

                const loadExpenseSettingsFromFirebase = async () => {
                    try {
                        console.log('üì• Cargando configuraciones de gastos desde Firebase...');
                        if (!window.authManager || !window.authManager.app) {
                            console.log('[WARNING]  Firebase no disponible, usando configuraciones por defecto');
                            return;
                        }
                        
                        // Verificar que las funciones de Firebase y la instancia db global est√©n disponibles
                        if (!window.firebase || !window.firebase.doc || !window.firebase.getDoc) {
                            console.log('[WARNING]  Funciones de Firebase no disponibles, reintentando...');
                            setTimeout(loadExpenseSettingsFromFirebase, 200);
                            return;
                        }
                        const { doc, getDoc } = window.firebase;
                        const db = window.firebaseDb;
                        // Verificar que la instancia de Firestore global sea v√°lida
                        if (!db) {
                            console.log('[WARNING]  Instancia global de Firestore no disponible, reintentando...');
                            setTimeout(loadExpenseSettingsFromFirebase, 200);
                            return;
                        }
                        
                        const settingsRef = doc(db, 'system_settings', 'main');
                        const settingsDoc = await getDoc(settingsRef);
                        if (settingsDoc.exists()) {
                            const data = settingsDoc.data();
                            if (data.expenses) {
                                setExpenseConfig(data.expenses);
                                console.log('[OK]  Configuraciones de gastos cargadas desde Firebase');
                            }
                        }
                    } catch (error) {
                        console.error('[ERROR]  Error cargando configuraciones de gastos:', error);
                    }
                };

                const saveExpenseSettingsToFirebase = async () => {
                    try {
                        setLoading(true);
                        if (!window.authManager || !window.authManager.app) {
                            throw new Error('Firebase no disponible');
                        }
                        
                        // Verificar que las funciones de Firebase y la instancia db global est√©n disponibles
                        if (!window.firebase || !window.firebase.doc || !window.firebase.setDoc) {
                            throw new Error('Funciones de Firebase no disponibles');
                        }
                        
                        const { doc, setDoc } = window.firebase;
                        const db = window.firebaseDb;
                        if (!db) {
                            throw new Error('Instancia global de Firestore no disponible');
                        }
                        const settingsRef = doc(db, 'system_settings', 'main');
                        // Usar setDoc con merge para crear/actualizar sin fallar si el documento no existe
                        await setDoc(
                            settingsRef,
                            {
                                expenses: expenseConfig,
                                updatedAt: new Date(),
                                updatedBy: window.authManager?.currentUser?.uid || null
                            },
                            { merge: true }
                        );
                        // Recargar configuraci√≥n global para reflejar cambios inmediatamente en los formularios
                        if (typeof window.loadAppConfig === 'function') {
                            await window.loadAppConfig();
                            console.log('[INFO]  Configuraci√≥n global recargada tras guardar gastos');
                        }
                        setSaved(true);
                        setHasUnsavedChanges(false);
                        setTimeout(() => setSaved(false), 3000);
                        console.log('[OK]  Configuraciones de gastos guardadas en Firebase');
                        showNotification('Configuraciones Guardadas', 'Las configuraciones de gastos se han guardado correctamente', 'success');
                    } catch (error) {
                        console.error('[ERROR]  Error guardando configuraciones de gastos:', error);
                        showNotification('Error', 'No se pudieron guardar las configuraciones de gastos', 'error');
                    } finally {
                        setLoading(false);
                    }
                };

                const addCategory = () => {
                    if (newCategory.trim() && !expenseConfig.categories.includes(newCategory.trim())) {
                        setExpenseConfig(prev => ({
                            ...prev,
                            categories: [...prev.categories, newCategory.trim()]
                        }));
                        setNewCategory('');
                    }
                };

                const removeCategory = (category) => {
                    setExpenseConfig(prev => {
                        const updated = { ...prev };
                        updated.categories = updated.categories.filter(c => c !== category);
                        if (updated.subcategories[category]) delete updated.subcategories[category];
                        return updated;
                    });
                };

                const addSubcategory = () => {
                    if (selectedCategory && newSubcategory.trim()) {
                        setExpenseConfig(prev => {
                            const updated = { ...prev };
                            if (!updated.subcategories[selectedCategory]) updated.subcategories[selectedCategory] = [];
                            if (!updated.subcategories[selectedCategory].includes(newSubcategory.trim())) {
                                updated.subcategories[selectedCategory].push(newSubcategory.trim());
                            }
                            return updated;
                        });
                        setNewSubcategory('');
                    }
                };

                const removeSubcategory = (category, subcategory) => {
                    setExpenseConfig(prev => {
                        const updated = { ...prev };
                        if (updated.subcategories[category]) {
                            updated.subcategories[category] = updated.subcategories[category].filter(s => s !== subcategory);
                        }
                        return updated;
                    });
                };

                const addPaymentType = () => {
                    if (newPaymentType.trim() && !expenseConfig.paymentTypes.includes(newPaymentType.trim())) {
                        setExpenseConfig(prev => ({
                            ...prev,
                            paymentTypes: [...prev.paymentTypes, newPaymentType.trim()]
                        }));
                        setNewPaymentType('');
                    }
                };

                const removePaymentType = (paymentType) => {
                    setExpenseConfig(prev => ({
                        ...prev,
                        paymentTypes: prev.paymentTypes.filter(pt => pt !== paymentType)
                    }));
                };

                const addStatus = () => {
                    if (newStatus.trim() && !expenseConfig.statuses.includes(newStatus.trim())) {
                        setExpenseConfig(prev => ({
                            ...prev,
                            statuses: [...prev.statuses, newStatus.trim()]
                        }));
                        setNewStatus('');
                    }
                };

                const removeStatus = (status) => {
                    setExpenseConfig(prev => ({
                        ...prev,
                        statuses: prev.statuses.filter(s => s !== status)
                    }));
                };

                const addTag = () => {
                    if (newTag.trim() && !expenseConfig.tags.includes(newTag.trim())) {
                        setExpenseConfig(prev => ({
                            ...prev,
                            tags: [...prev.tags, newTag.trim()]
                        }));
                        setNewTag('');
                    }
                };

                const removeTag = (tag) => {
                    setExpenseConfig(prev => ({
                        ...prev,
                        tags: prev.tags.filter(t => t !== tag)
                    }));
                };

                return (
                    <div className="space-y-6">
                        {/* Bot√≥n de debug */}
                        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <h5 className="font-medium text-yellow-800 mb-2">Debug - Configuraci√≥n de Gastos</h5>
                            <button
                                onClick={() => {
                                    console.log('=== DEBUG EXPENSE CONFIG ===');
                                    console.log('expenseConfig:', expenseConfig);
                                    console.log('categor√≠as:', expenseConfig.categories);
                                    console.log('subcategor√≠as:', expenseConfig.subcategories);
                                    console.log('selectedCategory:', selectedCategory);
                                }}
                                className="px-3 py-1 bg-yellow-600 text-white rounded text-sm hover:bg-yellow-700"
                            >
                                Ver en consola
                            </button>
                        </div>
                        
                        <div className="border border-gray-200 rounded-lg p-6">
                            <h4 className="font-semibold text-gray-900 mb-4">Categor√≠as de Gastos</h4>
                            <div className="space-y-4">
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={newCategory}
                                        onChange={(e) => setNewCategory(e.target.value)}
                                        placeholder="Nueva categor√≠a"
                                        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                    />
                                    <button
                                        onClick={addCategory}
                                        className="px-4 py-2 bg-[#006666] text-white rounded-lg hover:bg-[#005555]"
                                    >
                                        Agregar
                                    </button>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                    {expenseConfig.categories.map(category => (
                                        <div key={category} className="flex items-center justify-between bg-gray-50 px-3 py-2 rounded-lg">
                                            <span className="text-sm">{category}</span>
                                            <button
                                                onClick={() => removeCategory(category)}
                                                className="text-red-600 hover:text-red-800 text-sm"
                                            >
                                                √ó
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="border border-gray-200 rounded-lg p-6">
                            <h4 className="font-semibold text-gray-900 mb-4">Subcategor√≠as</h4>
                            <div className="space-y-4">
                                <div className="flex gap-2">
                                    <select
                                        value={selectedCategory}
                                        onChange={(e) => {
                                            console.log('Categor√≠a seleccionada:', e.target.value);
                                            console.log('Subcategor√≠as disponibles:', expenseConfig.subcategories[e.target.value]);
                                            setSelectedCategory(e.target.value);
                                        }}
                                        className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                    >
                                        <option value="">Selecciona una categor√≠a</option>
                                        {expenseConfig.categories.map(category => (
                                            <option key={category} value={category}>{category}</option>
                                        ))}
                                    </select>
                                    <input
                                        type="text"
                                        value={newSubcategory}
                                        onChange={(e) => setNewSubcategory(e.target.value)}
                                        placeholder="Nueva subcategor√≠a"
                                        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                    />
                                    <button
                                        onClick={addSubcategory}
                                        disabled={!selectedCategory}
                                        className="px-4 py-2 bg-[#006666] text-white rounded-lg hover:bg-[#005555] disabled:opacity-50"
                                    >
                                        Agregar
                                    </button>
                                </div>
                                
                                {/* Mostrar informaci√≥n de debug */}
                                {selectedCategory && (
                                    <div className="text-sm text-gray-600 p-2 bg-blue-50 rounded">
                                        Categor√≠a seleccionada: <strong>{selectedCategory}</strong><br/>
                                        Subcategor√≠as: {expenseConfig.subcategories[selectedCategory] ? 
                                            expenseConfig.subcategories[selectedCategory].length + ' encontradas' : 
                                            'Ninguna encontrada'}
                                    </div>
                                )}
                                
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                    {selectedCategory && expenseConfig.subcategories && expenseConfig.subcategories[selectedCategory] && expenseConfig.subcategories[selectedCategory].map(subcategory => (
                                        <div key={subcategory} className="flex items-center justify-between bg-gray-50 px-3 py-2 rounded-lg">
                                            <span className="text-sm">{subcategory}</span>
                                            <button
                                                onClick={() => removeSubcategory(selectedCategory, subcategory)}
                                                className="text-red-600 hover:text-red-800 text-sm"
                                            >
                                                √ó
                                            </button>
                                        </div>
                                    ))}
                                    {selectedCategory && (!expenseConfig.subcategories[selectedCategory] || expenseConfig.subcategories[selectedCategory].length === 0) && (
                                        <div className="col-span-full text-center text-gray-500 py-4">
                                            No hay subcategor√≠as para "{selectedCategory}". Agrega una nueva subcategor√≠a.
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="border border-gray-200 rounded-lg p-6">
                            <h4 className="font-semibold text-gray-900 mb-4">Tipos de Pago</h4>
                            <div className="space-y-4">
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={newPaymentType}
                                        onChange={(e) => setNewPaymentType(e.target.value)}
                                        placeholder="Nuevo tipo de pago"
                                        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                    />
                                    <button
                                        onClick={addPaymentType}
                                        className="px-4 py-2 bg-[#006666] text-white rounded-lg hover:bg-[#005555]"
                                    >
                                        Agregar
                                    </button>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                    {expenseConfig.paymentTypes.map(paymentType => (
                                        <div key={paymentType} className="flex items-center justify-between bg-gray-50 px-3 py-2 rounded-lg">
                                            <span className="text-sm">{paymentType}</span>
                                            <button
                                                onClick={() => removePaymentType(paymentType)}
                                                className="text-red-600 hover:text-red-800 text-sm"
                                            >
                                                √ó
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="border border-gray-200 rounded-lg p-6">
                            <h4 className="font-semibold text-gray-900 mb-4">Estados</h4>
                            <div className="space-y-4">
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={newStatus}
                                        onChange={(e) => setNewStatus(e.target.value)}
                                        placeholder="Nuevo estado"
                                        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                    />
                                    <button
                                        onClick={addStatus}
                                        className="px-4 py-2 bg-[#006666] text-white rounded-lg hover:bg-[#005555]"
                                    >
                                        Agregar
                                    </button>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                    {expenseConfig.statuses.map(status => (
                                        <div key={status} className="flex items-center justify-between bg-gray-50 px-3 py-2 rounded-lg">
                                            <span className="text-sm">{status}</span>
                                            <button
                                                onClick={() => removeStatus(status)}
                                                className="text-red-600 hover:text-red-800 text-sm"
                                            >
                                                √ó
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="border border-gray-200 rounded-lg p-6">
                            <h4 className="font-semibold text-gray-900 mb-4">Etiquetas</h4>
                            <div className="space-y-4">
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={newTag}
                                        onChange={(e) => setNewTag(e.target.value)}
                                        placeholder="Nueva etiqueta"
                                        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                    />
                                    <button
                                        onClick={addTag}
                                        className="px-4 py-2 bg-[#006666] text-white rounded-lg hover:bg-[#005555]"
                                    >
                                        Agregar
                                    </button>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                    {expenseConfig.tags.map(tag => (
                                        <div key={tag} className="flex items-center justify-between bg-gray-50 px-3 py-2 rounded-lg">
                                            <span className="text-sm">{tag}</span>
                                            <button
                                                onClick={() => removeTag(tag)}
                                                className="text-red-600 hover:text-red-800 text-sm"
                                            >
                                                √ó
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="flex justify-end">
                            <button
                                onClick={saveExpenseSettingsToFirebase}
                                disabled={loading}
                                className="px-6 py-3 bg-[#006666] text-white rounded-lg hover:bg-[#005555] disabled:opacity-50 flex items-center gap-2"
                            >
                                {loading ? (
                                    <>
                                        <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                        Guardando...
                                    </>
                                ) : (
                                    <>
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Guardar Configuraciones
                                    </>
                                )}
                            </button>
                        </div>

                        {saved && (
                            <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div className="flex items-center gap-2">
                                    <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <span className="text-green-800 font-medium">Configuraciones guardadas correctamente</span>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
            
            // Hacer Recharts opcional para evitar bloqueos
            let BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line;
            if (typeof window.Recharts !== 'undefined') {
                ({ BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line } = window.Recharts);
            }
            
            // Hacer Firebase opcional para el arranque inicial
            let initializeApp, getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken, getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, runTransaction, setDoc;
            if (typeof window.firebase !== 'undefined') {
                ({ initializeApp, getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken, getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, runTransaction, setDoc } = window.firebase);
            }

            // --- √çconos (SVG) ---
            const PlusIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
            const UserIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
            const EditIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>;
            const DollarSignIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>;
            const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
            const BuildingIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>;
            const MailIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>;
            const PhoneIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>;
            const CheckSquareIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>;
            const MapPinIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>;
            const TrendingUpIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>;
            const TrophyIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line><path d="m5 7 1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-12"></path><path d="M2 7h20"></path><path d="M4 19c0-2.2 1.8-4 4-4s4 1.8 4 4v0"></path><path d="M16 19c0-2.2 1.8-4 4-4s4 1.8 4 4v0"></path></svg>;
            const EmailIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22 6 12 13 2 6"></polyline></svg>;
            const DownloadIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
            const CopyIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>;
            const BellIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>;
            const MessageSquareIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>;
            const XIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
            const ChevronUpIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>;
            const ChevronDownIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>;
            const SearchIcon = ({ width = 20, height = 20 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>;
            const RefreshIcon = ({ width = 16, height = 16, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>;
            const EyeIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>;
            const FilterIcon = ({ width = 20, height = 20 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>;

            // --- Funciones Utilitarias ---
            const formatAddress = (address) => {
                if (!address) return 'No especificada';
                if (typeof address === 'string') return address;
                if (typeof address === 'object') {
                    const { street = '', city = '', postalCode = '', country = '' } = address;
                    return [street, city, postalCode, country].filter(Boolean).join(', ');
                }
                return 'No especificada';
            };

            // --- Componente de Input Modal Personalizado ---
            function CustomInputModal({ isOpen, title, placeholder, value, onConfirm, onCancel }) {
                const [inputValue, setInputValue] = useState(value || '');
                
                useEffect(() => {
                    setInputValue(value || '');
                }, [value]);
                
                if (!isOpen) return null;

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (inputValue.trim()) {
                        onConfirm(inputValue.trim());
                    }
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" style={{backdropFilter: 'blur(8px)'}}>
                        <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden" style={{animation: 'slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)'}}>
                            {/* Header minimalista con gradiente */}
                            <div className="bg-gradient-to-r from-emerald-500 to-teal-600 px-6 py-4 relative overflow-hidden">
                                <div className="absolute inset-0 opacity-20" style={{
                                    backgroundImage: 'repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px)'
                                }}></div>
                                <div className="flex items-center justify-between relative z-10">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                            <svg width="20" height="20" fill="none" stroke="white" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                            </svg>
                                        </div>
                                        <h3 className="text-xl font-bold text-white">{title}</h3>
                                    </div>
                                    <button 
                                        onClick={onCancel}
                                        className="p-2 hover:bg-white hover:bg-opacity-20 rounded-lg transition-all duration-200 text-white"
                                    >
                                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <form onSubmit={handleSubmit} className="p-6">
                                <div className="mb-6">
                                    <input
                                        type="text"
                                        value={inputValue}
                                        onChange={(e) => setInputValue(e.target.value)}
                                        placeholder={placeholder}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all duration-200"
                                        autoFocus
                                    />
                                </div>
                                
                                <div className="flex gap-3 justify-end">
                                    <button
                                        type="button"
                                        onClick={onCancel}
                                        className="px-6 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition-colors duration-200"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        type="submit"
                                        disabled={!inputValue.trim()}
                                        className="px-6 py-2 bg-emerald-600 text-white rounded-lg font-medium hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
                                    >
                                        Aceptar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }

            // --- Componente de Confirmaci√≥n Personalizado ---
            function CustomConfirm({ isOpen, title, message, onConfirm, onCancel, type = 'warning' }) {
                if (!isOpen) return null;

                const typeConfig = {
                    warning: {
                        icon: <AlertTriangleIcon width={24} height={24} />,
                        iconColor: 'text-orange-600',
                        bgColor: 'bg-orange-50',
                        borderColor: 'border-orange-200'
                    },
                    danger: {
                        icon: <XCircleIcon width={24} height={24} />,
                        iconColor: 'text-red-600', 
                        bgColor: 'bg-red-50',
                        borderColor: 'border-red-200'
                    },
                    info: {
                        icon: <CheckIcon width={24} height={24} />,
                        iconColor: 'text-blue-600',
                        bgColor: 'bg-blue-50', 
                        borderColor: 'border-blue-200'
                    }
                };

                const config = typeConfig[type] || typeConfig.warning;

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                            <div className={`flex items-center gap-3 p-6 ${config.bgColor} ${config.borderColor} border-b rounded-t-lg`}>
                                <div className={config.iconColor}>
                                    {config.icon}
                                </div>
                                <h3 className="text-lg font-semibold text-gray-900">{title}</h3>
                            </div>
                            <div className="p-6">
                                <p className="text-gray-600 mb-6">{message}</p>
                                <div className="flex gap-3 justify-end">
                                    <button
                                        onClick={onCancel}
                                        className="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        onClick={onConfirm}
                                        className={`px-4 py-2 text-white rounded-md transition-colors ${
                                            type === 'danger' 
                                                ? 'bg-red-600 hover:bg-red-700' 
                                                : 'bg-[#006666] hover:bg-[#005555]'
                                        }`}
                                    >
                                        Confirmar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- Componente de Notificaci√≥n Personalizado ---
            function CustomNotification({ isOpen, title, message, onClose, type = 'success', autoClose = true, duration = 3000 }) {
                const [isVisible, setIsVisible] = useState(false);

                useEffect(() => {
                    if (isOpen) {
                        setIsVisible(true);
                        if (autoClose) {
                            const timer = setTimeout(() => {
                                setIsVisible(false);
                                setTimeout(onClose, 300); // Esperar a que termine la animaci√≥n
                            }, duration);
                            return () => clearTimeout(timer);
                        }
                    }
                }, [isOpen, autoClose, duration, onClose]);

                const typeConfig = {
                    success: {
                        icon: <CheckIcon width={24} height={24} />,
                        iconColor: 'text-green-600',
                        bgColor: 'bg-green-50',
                        borderColor: 'border-green-200',
                        progressColor: 'bg-green-500'
                    },
                    info: {
                        icon: <InfoIcon width={24} height={24} />,
                        iconColor: 'text-blue-600',
                        bgColor: 'bg-blue-50',
                        borderColor: 'border-blue-200',
                        progressColor: 'bg-blue-500'
                    },
                    warning: {
                        icon: <AlertTriangleIcon width={24} height={24} />,
                        iconColor: 'text-orange-600',
                        bgColor: 'bg-orange-50',
                        borderColor: 'border-orange-200',
                        progressColor: 'bg-orange-500'
                    }
                };

                const config = typeConfig[type] || typeConfig.success;

                if (!isOpen) return null;

                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                        <div className={`bg-white rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all duration-300 ${
                            isVisible ? 'scale-100 opacity-100' : 'scale-95 opacity-0'
                        }`}>
                            <div className={`flex items-center gap-3 p-6 ${config.bgColor} ${config.borderColor} border-b rounded-t-lg relative overflow-hidden`}>
                                <div className={config.iconColor}>
                                    {config.icon}
                                </div>
                                <div className="flex-1">
                                    <h3 className="text-lg font-semibold text-gray-900">{title}</h3>
                                    {message && <p className="text-sm text-gray-600 mt-1">{message}</p>}
                                </div>
                                <button
                                    onClick={() => {
                                        setIsVisible(false);
                                        setTimeout(onClose, 300);
                                    }}
                                    className="text-gray-400 hover:text-gray-600 transition-colors"
                                >
                                    <XIcon width={20} height={20} />
                                </button>
                                {autoClose && (
                                    <div className="absolute bottom-0 left-0 h-1 bg-gray-200 w-full">
                                        <div 
                                            className={`h-full ${config.progressColor} transition-all ease-linear`}
                                            style={{
                                                width: isVisible ? '0%' : '100%',
                                                transitionDuration: `${duration}ms`
                                            }}
                                        />
                                    </div>
                                )}
                            </div>
                            <div className="p-6">
                                <div className="flex items-center gap-3">
                                    <DownloadIcon width={20} height={20} className="text-gray-500" />
                                    <span className="text-sm text-gray-600">Actualizaci√≥n completada</span>
                                </div>
                                {!autoClose && (
                                    <div className="flex justify-end mt-4">
                                        <button
                                            onClick={() => {
                                                setIsVisible(false);
                                                setTimeout(onClose, 300);
                                            }}
                                            className="px-4 py-2 bg-[#006666] hover:bg-[#005555] text-white rounded-md transition-colors"
                                        >
                                            Cerrar
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            const SendIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>;
            const PrinterIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>;
            const FileTextIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>;
            const BriefcaseIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>;
            const BarChartIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>;
            const ClockIcon = ({ width = 20, height = 20 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
            const CheckCircleIcon = ({ width = 20, height = 20 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
            const MinusCircleIcon = ({ width = 20, height = 20 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>;
            const ExclamationCircleIcon = ({ width = 20, height = 20 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;
            const AwardIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg>;
            const CheckIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>;
            const AlertTriangleIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>;
            const XCircleIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>;
            const SmartphoneIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>;
            const MegaphoneIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 11l18 0a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2z"></path><path d="M11 11V5a3 3 0 0 0-6 0v6"></path><path d="M15 11v6a3 3 0 0 0 6 0v-6"></path></svg>;
            const StopCircleIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><rect x="9" y="9" width="6" height="6"></rect></svg>;
            const PackageIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>;
            const TagIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>;
            const SettingsIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V6a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>;
            const InfoIcon = ({ width = 24, height = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>;
            const ArrowRightIcon = ({ width = 20, height = 20 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>;

            const CreditCardIcon = ({ width = 16, height = 16 }) => <svg xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>;

            // --- Constantes de la aplicaci√≥n ---
            const FUNNEL_TAGS = { 'Lead': 'bg-gray-200 text-gray-800', 'Primer Contacto': 'bg-blue-200 text-blue-800', 'Interesado': 'bg-cyan-200 text-cyan-800', 'Demo Realizada': 'bg-indigo-200 text-indigo-800', 'Negociaci√≥n': 'bg-purple-200 text-purple-800', 'En Cierre': 'bg-orange-200 text-orange-800', 'Ganado': 'bg-green-200 text-green-800', 'Perdido': 'bg-red-200 text-red-800' };
            const CONTACT_PREFERENCES = { 'Email': <MailIcon />, 'Tel√©fono': <PhoneIcon />, 'WhatsApp': <MessageSquareIcon />, 'Visita Comercial': <BuildingIcon /> };
            const INVOICE_STATUSES = { 'Borrador': 'bg-gray-200 text-gray-800', 'Finalizada': 'bg-blue-200 text-blue-800', 'Pagada': 'bg-green-200 text-green-800', 'Anulada': 'bg-red-300 text-red-900' };
            const OFFER_STATUSES = { 'Borrador': 'bg-gray-200 text-gray-800', 'Enviada': 'bg-blue-200 text-blue-800', 'Aceptada': 'bg-green-200 text-green-800', 'Rechazada': 'bg-red-200 text-red-800', 'Expirada': 'bg-orange-200 text-orange-800' };
            const VAT_RATE = 0.21;

            // --- Funci√≥n de Exportaci√≥n a Excel ---
            function exportInvoicesToExcel(invoices, clients, showNotification) {
                const getClientName = (clientId) => clients.find(c => c.id === clientId)?.name || 'N/A';
                const getClientClinic = (clientId) => clients.find(c => c.id === clientId)?.clinic || 'N/A';
                
                // Preparar datos para Excel
                const excelData = invoices.map(invoice => ({
                    'N¬∫ Factura': invoice.invoiceNumber || '',
                    'Serie': invoice.invoiceSeries || '',
                    'Tipo': invoice.type || '',
                    'Cliente': getClientName(invoice.clientId),
                    'Cl√≠nica': getClientClinic(invoice.clientId),
                    'Fecha Factura': invoice.invoiceDate || '',
                    'Fecha Vencimiento': invoice.dueDate || '',
                    'Subtotal': invoice.subtotal?.toFixed(2) || '0.00',
                    'IVA': invoice.vat?.toFixed(2) || '0.00',
                    'Total': invoice.total?.toFixed(2) || '0.00',
                    'Estado': invoice.status || '',
                    'Total Pagado': invoice.totalPaid?.toFixed(2) || '0.00',
                    'Pendiente': ((invoice.total || 0) - (invoice.totalPaid || 0)).toFixed(2)
                }));

                // Crear CSV
                const headers = Object.keys(excelData[0] || {});
                const csvContent = [
                    headers.join(','),
                    ...excelData.map(row => 
                        headers.map(header => {
                            const value = row[header];
                            // Escapar comillas y comas en los valores
                            return `"${String(value).replace(/"/g, '""')}"`;
                        }).join(',')
                    )
                ].join('\n');

                // Crear y descargar archivo
                const blob = new Blob(['\uFEFF' + csvContent], { 
                    type: 'text/csv;charset=utf-8;' 
                });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `facturas_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Mostrar notificaci√≥n de √©xito personalizada
                showNotification('Exportaci√≥n Completada', `Se han exportado ${invoices.length} facturas correctamente`, 'success');
            }

            // --- Configuraci√≥n de Firebase ---
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                // Configuraci√≥n demo para desarrollo
                apiKey: "demo-api-key",
                authDomain: "expertia-crm-demo.firebaseapp.com",
                projectId: "expertia-crm-demo",
                storageBucket: "expertia-crm-demo.appspot.com",
                messagingSenderId: "123456789",
                appId: "1:123456789:web:demo-app-id"
            };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'expertia-crm-demo';

            // --- Componente Principal: App ---
            function App() {
                const [db, setDb] = useState(null);
                const [auth, setAuth] = useState(null);
                const [user, setUser] = useState(null);
                const [userProfile, setUserProfile] = useState(null);
                const [userDoc, setUserDoc] = useState(null);
                const [isAuthReady, setIsAuthReady] = useState(false);

                const [clients, setClients] = useState([]);
                const [invoices, setInvoices] = useState([]);
                const [products, setProducts] = useState([]);
                const [offers, setOffers] = useState([]);
                const [expenses, setExpenses] = useState([]);
                const [activeView, setActiveView] = useState('welcome');
                const [selectedItem, setSelectedItem] = useState(null);
                const [isLoading, setIsLoading] = useState(true);
                const [searchTerm, setSearchTerm] = useState('');
                const [filterTag, setFilterTag] = useState('all');

                // Estado para modal de confirmaci√≥n personalizado
                const [confirmModal, setConfirmModal] = useState({
                    isOpen: false,
                    title: '',
                    message: '',
                    type: 'warning',
                    onConfirm: () => {},
                    onCancel: () => {}
                });

                // Estado para modal de notificaci√≥n personalizado
                const [notificationModal, setNotificationModal] = useState({
                    isOpen: false,
                    title: '',
                    message: '',
                    type: 'success'
                });

                // Estado para modal de input personalizado
                const [inputModal, setInputModal] = useState({
                    isOpen: false,
                    title: '',
                    placeholder: '',
                    value: '',
                    onConfirm: () => {},
                    onCancel: () => {}
                });

                // Cache de configuraci√≥n global
                const [appConfig, setAppConfig] = useState(null);
                
                // Cache de contadores desde /counters
                const [counters, setCounters] = useState({});
                
                // Funci√≥n para cargar configuraci√≥n desde system_settings
                const loadAppConfig = async () => {
                    console.log('[INFO]  loadAppConfig llamada, db:', db ? 'disponible' : 'no disponible');
                    if (!db) {
                        console.log('[WARNING]  db no disponible, saltando carga de configuraci√≥n');
                        return;
                    }
                    
                    try {
                        console.log('ÔøΩ Creando referencia a system_settings/main usando instancia global...');
                        
                        // Usar las funciones globales de Firebase ya disponibles
                        const { doc, getDoc } = window.firebase;
                        if (!doc || !getDoc) {
                            throw new Error('Funciones de Firebase no disponibles');
                        }
                        
                        const settingsRef = doc(db, 'system_settings', 'main');
                        console.log('[DEBUG]  Obteniendo documento...');
                        const settingsDoc = await getDoc(settingsRef);
                        
                        if (settingsDoc.exists()) {
                            const config = settingsDoc.data();
                            setAppConfig(config);
                            console.log('[CONFIG]  Configuraci√≥n de sistema cargada:', Object.keys(config));
                        } else {
                            console.log('[WARNING]  No se encontr√≥ configuraci√≥n del sistema, usando valores por defecto');
                            const defaultConfig = {
                                invoice: {
                                    series: ['EXP', 'ALQ', 'PROF'],
                                    offerSeries: 'OF',
                                    globalCounter: 0
                                },
                                products: {
                                    categories: ['Diagn√≥stico', 'Monitorizaci√≥n', 'Emergencias', 'Laboratorio'],
                                    suppliers: ['Storz Medical', 'Zamar Medical', 'Phillips Healthcare', 'GE Healthcare', 'Siemens']
                                },
                                sales: {
                                    sources: ['Web', 'Tel√©fono', 'Email', 'Referencia', 'Presencial', 'Redes Sociales'],
                                    funnelStages: ['Lead', 'Contactado', 'Interesado', 'Propuesta', 'Negociaci√≥n', 'Cliente', 'Perdido', 'Seguimiento'],
                                    priorities: ['Alta', 'Media', 'Baja']
                                },
                                expenses: {
                                    categories: ['Alimentaci√≥n', 'Transporte', 'Material de Oficina', 'Servicios', 'Equipamiento', 'Marketing', 'Formaci√≥n', 'Otros'],
                                    subcategories: {
                                        'Alimentaci√≥n': ['Comidas', 'Bebidas', 'Catering'],
                                        'Transporte': ['Gasolina', 'Taxi', 'Transporte p√∫blico', 'Parking'],
                                        'Material de Oficina': ['Papeler√≠a', 'Equipos', 'Software'],
                                        'Servicios': ['Limpieza', 'Mantenimiento', 'Consultor√≠a'],
                                        'Equipamiento': ['Mobiliario', 'Tecnolog√≠a', 'Herramientas'],
                                        'Marketing': ['Publicidad', 'Eventos', 'Material promocional'],
                                        'Formaci√≥n': ['Cursos', 'Certificaciones', 'Conferencias'],
                                        'Otros': ['Varios']
                                    },
                                    paymentTypes: ['Efectivo', 'Transferencia', 'Tarjeta', 'Cheque', 'Otros'],
                                    statuses: ['Pendiente', 'Aprobado', 'Rechazado', 'Pagado'],
                                    tags: ['Urgente', 'Recurrente', 'Importante', 'Reembolsable']
                                }
                            };
                            setAppConfig(defaultConfig);
                            console.log('[OK]  Configuraci√≥n por defecto cargada');
                        }
                    } catch (error) {
                        console.error('[ERROR]  Error cargando configuraci√≥n:', error);
                        console.log('[INFO]  Usando configuraci√≥n por defecto debido al error');
                        const fallbackConfig = {
                            invoice: {
                                series: ['EXP', 'ALQ', 'PROF'],
                                offerSeries: 'OF',
                                globalCounter: 0
                            },
                            products: {
                                categories: ['Diagn√≥stico', 'Monitorizaci√≥n', 'Emergencias', 'Laboratorio'],
                                suppliers: ['Storz Medical', 'Zamar Medical', 'Phillips Healthcare', 'GE Healthcare', 'Siemens']
                            },
                            sales: {
                                sources: ['Web', 'Tel√©fono', 'Email', 'Referencia', 'Presencial', 'Redes Sociales'],
                                funnelStages: ['Lead', 'Contactado', 'Interesado', 'Propuesta', 'Negociaci√≥n', 'Cliente', 'Perdido', 'Seguimiento'],
                                priorities: ['Alta', 'Media', 'Baja']
                            },
                            expenses: {
                                categories: ['Alimentaci√≥n', 'Transporte', 'Material de Oficina', 'Servicios', 'Equipamiento', 'Marketing', 'Formaci√≥n', 'Otros'],
                                subcategories: {
                                    'Alimentaci√≥n': ['Comidas', 'Bebidas', 'Catering'],
                                    'Transporte': ['Gasolina', 'Taxi', 'Transporte p√∫blico', 'Parking'],
                                    'Material de Oficina': ['Papeler√≠a', 'Equipos', 'Software'],
                                    'Servicios': ['Limpieza', 'Mantenimiento', 'Consultor√≠a'],
                                    'Equipamiento': ['Mobiliario', 'Tecnolog√≠a', 'Herramientas'],
                                    'Marketing': ['Publicidad', 'Eventos', 'Material promocional'],
                                    'Formaci√≥n': ['Cursos', 'Certificaciones', 'Conferencias'],
                                    'Otros': ['Varios']
                                },
                                paymentTypes: ['Efectivo', 'Transferencia', 'Tarjeta', 'Cheque', 'Otros'],
                                statuses: ['Pendiente', 'Aprobado', 'Rechazado', 'Pagado'],
                                tags: ['Urgente', 'Recurrente', 'Importante', 'Reembolsable']
                            }
                        };
                        setAppConfig(fallbackConfig);
                    }
                };
                
                // Funci√≥n para obtener valores de configuraci√≥n con fallback
                const getConfigValue = (section, key, defaultValue) => {
                    return appConfig?.[section]?.[key] || defaultValue;
                };
                
                // Funciones para obtener configuraciones de gastos din√°micamente
                const getExpenseConfig = () => {
                    const defaultSubcategories = {
                        'Alimentaci√≥n': ['Comidas', 'Bebidas', 'Catering'],
                        'Transporte': ['Gasolina', 'Taxi', 'Transporte p√∫blico', 'Parking'],
                        'Material de Oficina': ['Papeler√≠a', 'Equipos', 'Software'],
                        'Servicios': ['Limpieza', 'Mantenimiento', 'Consultor√≠a'],
                        'Equipamiento': ['Mobiliario', 'Tecnolog√≠a', 'Herramientas'],
                        'Marketing': ['Publicidad', 'Eventos', 'Material promocional'],
                        'Formaci√≥n': ['Cursos', 'Certificaciones', 'Conferencias'],
                        'Otros': ['Varios']
                    };
                    
                    return {
                        categories: getConfigValue('expenses', 'categories', ['Alimentaci√≥n', 'Transporte', 'Material de Oficina', 'Servicios', 'Equipamiento', 'Marketing', 'Formaci√≥n', 'Otros']),
                        subcategories: getConfigValue('expenses', 'subcategories', defaultSubcategories),
                        paymentTypes: getConfigValue('expenses', 'paymentTypes', ['Efectivo', 'Transferencia', 'Tarjeta', 'Cheque', 'Otros']),
                        statuses: getConfigValue('expenses', 'statuses', ['Pendiente', 'Aprobado', 'Rechazado', 'Pagado']),
                        tags: getConfigValue('expenses', 'tags', ['Urgente', 'Recurrente', 'Importante', 'Reembolsable'])
                    };
                };

                const getExpenseStatuses = () => {
                    const statuses = getExpenseConfig().statuses;
                    const statusClasses = {
                        'Pendiente': 'bg-gray-200 text-gray-800',
                        'Aprobado': 'bg-green-200 text-green-800',
                        'Rechazado': 'bg-red-200 text-red-800',
                        'Pagado': 'bg-blue-200 text-blue-800'
                    };
                    
                    const result = {};
                    statuses.forEach(status => {
                        result[status] = statusClasses[status] || 'bg-gray-200 text-gray-800';
                    });
                    return result;
                };
                
                // Funci√≥n para obtener todas las configuraciones (incluye fallbacks)
                const getSettings = () => {
                    if (!appConfig) {
                        // Configuraci√≥n por defecto si no hay datos cargados
                        return {
                            company: {
                                name: 'Expertia Medical Solutions',
                                address: 'Calle Innovaci√≥n 1, Madrid, 28001',
                                phone: '+34 91 000 0000',
                                email: 'info@expertia.com',
                                website: 'https://expertia.com',
                                nit: 'B12345678',
                                taxId: 'B12345678',
                                logo: './LOGO_EXPERTIA.jpg'
                            },
                            invoice: {
                                series: ['EXP', 'ALQ', 'PROF'],
                                offerSeries: 'OF',
                                globalCounter: 0,
                                defaultCurrency: 'EUR',
                                vatRate: 0.21,
                                paymentTerms: 30,
                                seriesConfig: {
                                    'EXP': { includeVAT: true, vatRate: 0.21 },
                                    'ALQ': { includeVAT: false, vatRate: 0.21 },
                                    'PROF': { includeVAT: true, vatRate: 0.21 }
                                }
                            },
                            products: {
                                categories: ['Diagn√≥stico', 'Monitorizaci√≥n', 'Emergencias', 'Laboratorio'],
                                suppliers: ['Storz Medical', 'Zamar Medical', 'Phillips Healthcare', 'GE Healthcare', 'Siemens']
                            },
                            sales: {
                                sources: ['Web', 'Tel√©fono', 'Email', 'Referencia', 'Presencial', 'Redes Sociales'],
                                funnelStages: ['Lead', 'Contactado', 'Interesado', 'Propuesta', 'Negociaci√≥n', 'Cliente', 'Perdido', 'Seguimiento'],
                                priorities: ['Alta', 'Media', 'Baja'],
                                contactPreferences: ['Email', 'Tel√©fono', 'WhatsApp', 'Visita Comercial']
                            },
                            security: {
                                sessionTimeout: 30,
                                requireEmailVerification: true,
                                allowGoogleLogin: true,
                                passwordComplexity: 'medium',
                                twoFactorAuth: false,
                                maxLoginAttempts: 5
                            },
                            notifications: {
                                emailNotifications: true,
                                newUserRegistration: true,
                                systemAlerts: true,
                                weeklyReports: false,
                                maintenanceAlerts: true
                            },
                            integrations: {
                                whatsappApiKey: '',
                                emailProvider: 'gmail',
                                smtpHost: '',
                                smtpPort: 587,
                                smtpUsername: '',
                                smtpPassword: ''
                            }
                        };
                    }
                    
                    // Mezclar configuraci√≥n cargada con defaults para campos faltantes
                    const defaults = {
                        company: {
                            name: 'Expertia Medical Solutions',
                            address: 'Calle Innovaci√≥n 1, Madrid, 28001',
                            phone: '+34 91 000 0000',
                            email: 'info@expertia.com',
                            website: 'https://expertia.com',
                            nit: 'B12345678',
                            taxId: 'B12345678',
                            logo: './LOGO_EXPERTIA.jpg'
                        },
                        invoice: {
                            series: ['EXP', 'ALQ', 'PROF'],
                            offerSeries: 'OF',
                            globalCounter: 0,
                            defaultCurrency: 'EUR',
                            vatRate: 0.21,
                            paymentTerms: 30
                        },
                        products: {
                            categories: ['Diagn√≥stico', 'Monitorizaci√≥n', 'Emergencias', 'Laboratorio'],
                            suppliers: ['Storz Medical', 'Zamar Medical', 'Phillips Healthcare', 'GE Healthcare', 'Siemens']
                        },
                        sales: {
                            sources: ['Web', 'Tel√©fono', 'Email', 'Referencia', 'Presencial', 'Redes Sociales'],
                            funnelStages: ['Lead', 'Contactado', 'Interesado', 'Propuesta', 'Negociaci√≥n', 'Cliente', 'Perdido', 'Seguimiento'],
                            priorities: ['Alta', 'Media', 'Baja'],
                            contactPreferences: ['Email', 'Tel√©fono', 'WhatsApp', 'Visita Comercial']
                        }
                    };
                    
                    return {
                        company: { ...defaults.company, ...appConfig.company },
                        invoice: { ...defaults.invoice, ...appConfig.invoice },
                        products: { ...defaults.products, ...appConfig.products },
                        sales: { ...defaults.sales, ...appConfig.sales },
                        security: { ...appConfig.security },
                        notifications: { ...appConfig.notifications },
                        integrations: { ...appConfig.integrations }
                    };
                };

                // === SISTEMA DE CONTADORES ===
                
                // Funci√≥n para cargar contadores desde /counters
                const loadCounters = async () => {
                    if (!db) {
                        console.log('[WARNING]  db no disponible, saltando carga de contadores');
                        return;
                    }
                    
                    try {
                        console.log('[DATA]  Cargando contadores desde /counters...');
                        const { collection, getDocs } = window.firebase;
                        const countersCollection = collection(db, 'counters');
                        const countersSnapshot = await getDocs(countersCollection);
                        
                        const countersData = {};
                        countersSnapshot.docs.forEach(doc => {
                            countersData[doc.id] = { id: doc.id, ...doc.data() };
                        });
                        
                        setCounters(countersData);
                        console.log('[OK]  Contadores cargados:', Object.keys(countersData));
                    } catch (error) {
                        console.error('[ERROR]  Error cargando contadores:', error);
                        // Fallback con contadores por defecto
                        const fallbackCounters = {
                            'EXP': { id: 'EXP', current: 1, description: 'Facturas EXP' },
                            'ALQ': { id: 'ALQ', current: 1, description: 'Facturas ALQ' },
                            'PROF': { id: 'PROF', current: 1, description: 'Facturas PROF' },
                            'offers': { id: 'offers', count: 1, description: 'Ofertas' }
                        };
                        setCounters(fallbackCounters);
                        console.log('[INFO]  Usando contadores por defecto');
                    }
                };
                
                // Funci√≥n para obtener lista de series desde contadores
                const getInvoiceSeries = () => {
                    return Object.keys(counters).filter(id => 
                        id !== 'offers' && counters[id] && counters[id].hasOwnProperty('current')
                    );
                };
                
                // Funci√≥n para obtener contador actual de una serie
                const getCurrentCounter = (seriesId) => {
                    return counters[seriesId]?.current || 0;
                };
                
                // Funci√≥n para actualizar contador
                const updateCounter = async (seriesId, newValue) => {
                    if (!db) {
                        console.log('[WARNING]  db no disponible, no se puede actualizar contador');
                        return;
                    }
                    
                    try {
                        const { doc, setDoc } = window.firebase;
                        const counterRef = doc(db, 'counters', seriesId);
                        await setDoc(counterRef, {
                            current: parseInt(newValue) || 0,
                            updatedAt: new Date(),
                            description: `Facturas ${seriesId}`
                        }, { merge: true });
                        
                        // Actualizar estado local
                        setCounters(prev => ({
                            ...prev,
                            [seriesId]: {
                                ...prev[seriesId],
                                current: parseInt(newValue) || 0
                            }
                        }));
                        
                        // Marcar que hay cambios pendientes
                        if (window.setHasUnsavedChanges) {
                            window.setHasUnsavedChanges(true);
                        }
                        
                        console.log(`‚úÖ Contador ${seriesId} actualizado a ${newValue}`);
                    } catch (error) {
                        console.error(`‚ùå Error actualizando contador ${seriesId}:`, error);
                        throw error;
                    }
                };
                
                // Funci√≥n para crear nueva serie
                const createNewSeries = async (seriesId) => {
                    if (!db || !seriesId) return;
                    
                    try {
                        const { doc, setDoc } = window.firebase;
                        const counterRef = doc(db, 'counters', seriesId.toUpperCase());
                        await setDoc(counterRef, {
                            current: 0,
                            updatedAt: new Date(),
                            description: `Facturas ${seriesId.toUpperCase()}`
                        });
                        
                        // Recargar contadores
                        await loadCounters();
                        
                        console.log(`‚úÖ Nueva serie ${seriesId} creada`);
                    } catch (error) {
                        console.error(`‚ùå Error creando serie ${seriesId}:`, error);
                        throw error;
                    }
                };
                
                // Funci√≥n para eliminar serie
                const deleteSeries = async (seriesId) => {
                    if (!db || !seriesId) return;
                    
                    try {
                        const { doc, deleteDoc } = window.firebase;
                        const counterRef = doc(db, 'counters', seriesId);
                        await deleteDoc(counterRef);
                        
                        // Actualizar estado local
                        setCounters(prev => {
                            const updated = { ...prev };
                            delete updated[seriesId];
                            return updated;
                        });
                        
                        console.log(`‚úÖ Serie ${seriesId} eliminada`);
                    } catch (error) {
                        console.error(`‚ùå Error eliminando serie ${seriesId}:`, error);
                        throw error;
                    }
                };
                
                // === FUNCIONES PARA OFERTAS ===
                
                // Funci√≥n para obtener contador actual de ofertas
                const getOfferCount = () => {
                    return counters['offers']?.count || 1;
                };
                
                // Funci√≥n para actualizar contador de ofertas
                const updateOfferCounter = async (newValue) => {
                    if (!db) {
                        console.log('[WARNING]  db no disponible, no se puede actualizar contador de ofertas');
                        return;
                    }
                    
                    try {
                        const { doc, setDoc } = window.firebase;
                        const counterRef = doc(db, 'counters', 'offers');
                        await setDoc(counterRef, {
                            count: parseInt(newValue) || 1,
                            updatedAt: new Date(),
                            description: 'Numeraci√≥n de ofertas'
                        }, { merge: true });
                        
                        // Actualizar estado local
                        setCounters(prev => ({
                            ...prev,
                            'offers': {
                                ...prev['offers'],
                                count: parseInt(newValue) || 1
                            }
                        }));
                        
                        console.log(`‚úÖ Contador de ofertas actualizado a ${newValue}`);
                    } catch (error) {
                        console.error(`‚ùå Error actualizando contador de ofertas:`, error);
                        throw error;
                    }
                };
                


                // Hacer funciones disponibles globalmente
                window.loadAppConfig = loadAppConfig;
                window.loadCounters = loadCounters;
                window.getConfigValue = getConfigValue;
                window.getSettings = getSettings;
                window.getInvoiceSeries = getInvoiceSeries;
                window.getCurrentCounter = getCurrentCounter;
                window.updateCounter = updateCounter;
                window.createNewSeries = createNewSeries;
                window.deleteSeries = deleteSeries;
                window.setHasUnsavedChanges = (value) => {
                    // Funci√≥n global para marcar cambios pendientes
                    if (window.SystemSettingsRef && window.SystemSettingsRef.setHasUnsavedChanges) {
                        window.SystemSettingsRef.setHasUnsavedChanges(value);
                    }
                };
                window.getOfferCount = getOfferCount;
                window.updateOfferCounter = updateOfferCounter;
                
                // Funciones para gesti√≥n de gastos
                const loadExpenses = async () => {
                    try {
                        console.log('[DEBUG] === LOAD EXPENSES START ===');
                        
                        if (!db) {
                            console.error('[ERROR] Base de datos no disponible');
                            return;
                        }
                        
                        if (!user || !user.uid) {
                            console.error('[ERROR] Usuario no disponible o sin UID');
                            console.error('[ERROR] user:', user);
                            return;
                        }
                        
                        const userId = user.uid;
                        console.log('[DEBUG] userId obtenido:', userId);
                        
                        // Peque√±a pausa para asegurar que el contexto est√° estable
                        await new Promise(resolve => setTimeout(resolve, 50));
                        
                        // Importar Firebase Firestore
                        const { getFirestore, collection, getDocs, query, orderBy } = 
                            await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                        
                        const firestoreDb = getFirestore(window.authManager.app);
                        const expensesRef = collection(firestoreDb, `users/${userId}/expenses`);
                        
                        // Verificar si orderBy est√° disponible
                        if (typeof orderBy === 'function') {
                            const q = query(expensesRef, orderBy('date', 'desc'));
                            const snapshot = await getDocs(q);
                            
                            const expensesData = [];
                            snapshot.forEach(doc => {
                                expensesData.push({ id: doc.id, ...doc.data() });
                            });
                            
                            setExpenses(expensesData);
                            console.log(`‚úÖ Cargados ${expensesData.length} gastos correctamente`);
                        } else {
                            // Fallback sin ordenaci√≥n
                            const snapshot = await getDocs(expensesRef);
                            
                            const expensesData = [];
                            snapshot.forEach(doc => {
                                expensesData.push({ id: doc.id, ...doc.data() });
                            });
                            
                            // Ordenar localmente por fecha
                            expensesData.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
                            
                            setExpenses(expensesData);
                            console.log(`‚úÖ Cargados ${expensesData.length} gastos correctamente (ordenaci√≥n local)`);
                        }
                    } catch (error) {
                        console.error('[ERROR]  Error cargando gastos:', error);
                        showNotification('Error', `No se pudieron cargar los gastos: ${error.message}`, 'error');
                    }
                };

                const saveExpense = async (expenseData) => {
                    console.log('[DEBUG]  === SAVE EXPENSE DEBUG ===');
                    console.log('[DEBUG]  db disponible:', !!db);
                    console.log('[DEBUG]  user:', user);
                    console.log('[DEBUG]  userDoc:', userDoc);
                    console.log('[DEBUG]  expenseData:', expenseData);
                    
                    if (!db) {
                        console.error('[ERROR]  Base de datos no disponible');
                        showNotification('Error', 'Base de datos no disponible', 'error');
                        return false;
                    }
                    
                    // Obtener userId directamente del user
                    let userId = user?.uid;
                    
                    if (!userId) {
                        console.error('[ERROR]  No se pudo obtener ID de usuario');
                        console.error('[ERROR]  user:', user);
                        showNotification('Error', 'No se pudo identificar al usuario', 'error');
                        return false;
                    }
                    
                    console.log('[DEBUG]  userId obtenido:', userId);
                    
                    try {
                        // Importar Firebase Firestore
                        const { getFirestore, collection, addDoc, updateDoc, doc } = 
                            await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                        
                        const firestoreDb = getFirestore(window.authManager.app);
                        const expensesRef = collection(firestoreDb, `users/${userId}/expenses`);
                        
                        // Validar datos antes de guardar
                        if (!expenseData.description || !expenseData.amount || !expenseData.category) {
                            throw new Error('Faltan datos obligatorios');
                        }
                        
                        if (expenseData.id) {
                            // Actualizar gasto existente
                            const expenseRef = doc(firestoreDb, `users/${userId}/expenses`, expenseData.id);
                            await updateDoc(expenseRef, {
                                ...expenseData,
                                updatedAt: new Date().toISOString()
                            });
                            showNotification('Gasto Actualizado', 'El gasto se ha actualizado correctamente', 'success');
                        } else {
                            // Crear nuevo gasto
                            await addDoc(expensesRef, {
                                ...expenseData,
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            });
                            showNotification('Gasto Creado', 'El gasto se ha creado correctamente', 'success');
                        }
                        
                        await loadExpenses();
                        return true;
                    } catch (error) {
                        console.error('[ERROR]  Error guardando gasto:', error);
                        showNotification('Error', `No se pudo guardar el gasto: ${error.message}`, 'error');
                        return false;
                    }
                };

                const deleteExpense = async (expense) => {
                    if (!db) {
                        console.error('[ERROR]  Base de datos no disponible');
                        showNotification('Error', 'Base de datos no disponible', 'error');
                        return;
                    }
                    
                    // Obtener userId directamente del user
                    let userId = user?.uid;
                    
                    if (!userId) {
                        console.error('[ERROR]  No se pudo obtener ID de usuario para eliminar gasto');
                        console.error('[ERROR]  user:', user);
                        showNotification('Error', 'No se pudo identificar al usuario', 'error');
                        return;
                    }
                    
                    console.log('[DEBUG]  === DELETE EXPENSE DEBUG ===');
                    console.log('[DEBUG]  userId:', userId);
                    console.log('[DEBUG]  expense:', expense);
                    
                    try {
                        // Importar Firebase Firestore
                        const { getFirestore, doc, deleteDoc } = 
                            await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                        
                        const firestoreDb = getFirestore(window.authManager.app);
                        const expenseRef = doc(firestoreDb, `users/${userId}/expenses`, expense.id);
                        await deleteDoc(expenseRef);
                        
                        showNotification('Gasto Eliminado', 'El gasto se ha eliminado correctamente', 'success');
                        await loadExpenses();
                    } catch (error) {
                        console.error('[ERROR]  Error eliminando gasto:', error);
                        showNotification('Error', `No se pudo eliminar el gasto: ${error.message}`, 'error');
                    }
                };

                // Hacer funciones de gastos disponibles globalmente
                window.loadExpenses = loadExpenses;
                window.saveExpense = saveExpense;
                window.deleteExpense = deleteExpense;
                window.getExpenseConfig = getExpenseConfig;
                window.getExpenseStatuses = getExpenseStatuses;

                // Funci√≥n para mostrar confirmaci√≥n personalizada
                const showConfirm = (title, message, onConfirm, type = 'warning') => {
                    return new Promise((resolve) => {
                        setConfirmModal({
                            isOpen: true,
                            title,
                            message,
                            type,
                            onConfirm: () => {
                                setConfirmModal({ ...confirmModal, isOpen: false });
                                onConfirm();
                                resolve(true);
                            },
                            onCancel: () => {
                                setConfirmModal({ ...confirmModal, isOpen: false });
                                resolve(false);
                            }
                        });
                    });
                };

                // Funci√≥n para mostrar notificaci√≥n personalizada
                const showNotification = (title, message = '', type = 'success') => {
                    setNotificationModal({
                        isOpen: true,
                        title,
                        message,
                        type
                    });
                };

                // Funci√≥n para mostrar modal de input personalizado
                const showInput = (title, placeholder = '', defaultValue = '') => {
                    return new Promise((resolve) => {
                        setInputModal({
                            isOpen: true,
                            title,
                            placeholder,
                            value: defaultValue,
                            onConfirm: (value) => {
                                setInputModal({ ...inputModal, isOpen: false });
                                resolve(value);
                            },
                            onCancel: () => {
                                setInputModal({ ...inputModal, isOpen: false });
                                resolve(null);
                            }
                        });
                    });
                };

                // Hacer showInput y showConfirm disponibles globalmente para AdminPanel
                window.showInput = showInput;
                window.showConfirm = showConfirm;
                window.showNotification = showNotification;

                // Funci√≥n para verificar permisos
                const isAdmin = () => userProfile?.role === 'admin';
                const isCommercialOrAdmin = () => userProfile?.role === 'admin' || userProfile?.role === 'comercial';

                useEffect(() => {
                    console.log("Iniciando inicializaci√≥n de Firebase...");
                    
                    if (typeof initializeApp === 'undefined') {
                        console.log("Firebase no disponible, ejecutando en modo demo");
                        // Modo demo con datos de ejemplo
                        setUser({ uid: "demo-user-123", email: "demo@expertia.com" });
                        setUserProfile({ 
                            id: "demo-user-123", 
                            email: "demo@expertia.com", 
                            name: "Usuario Demo", 
                            role: "admin" 
                        });
                        setIsAuthReady(true);
                        setIsLoading(false);
                        
                        // Cargar datos demo
                        loadDemoData();
                        return;
                    }

                    try {
                        // Inicializar Firebase
                        const app = initializeApp(firebaseConfig);
                        const firestoreDb = getFirestore(app);
                        const firebaseAuth = getAuth(app);
                        setDb(firestoreDb);
                        setAuth(firebaseAuth);
                        
                        // Hacer disponible globalmente para AdminPanel
                        window.firebaseDb = firestoreDb;
                        


                        // Listener de autenticaci√≥n
                        const unsubscribe = onAuthStateChanged(firebaseAuth, async (firebaseUser) => {
                            if (firebaseUser) {
                                setUser(firebaseUser);
                                // Cargar perfil del usuario desde Firestore
                                const userDocRef = await doc(firestoreDb, 'users', firebaseUser.uid);
                                setUserDoc(userDocRef); // Almacenar referencia del documento
                                onSnapshot(userDocRef, (snapshot) => {
                                    console.log('[DEBUG] onSnapshot ejecutado para UID:', firebaseUser.uid);
                                    console.log('[DEBUG] firebaseUser.displayName:', firebaseUser.displayName);
                                    console.log('[DEBUG] firebaseUser.email:', firebaseUser.email);
                                    console.log('[DEBUG] firebaseUser.photoURL:', firebaseUser.photoURL);
                                    console.log('[DEBUG] snapshot.exists():', snapshot.exists());
                                    
                                    if (snapshot.exists()) {
                                        const existingProfile = snapshot.data();
                                        console.log('[DEBUG] Perfil existente encontrado:', existingProfile);
                                        setUserProfile({ id: firebaseUser.uid, ...existingProfile });
                                    } else {
                                        console.log('[DEBUG] Perfil no existe, creando perfil b√°sico...');
                                        // Solo crear perfil b√°sico si NO viene de Google (que ya cre√≥ su perfil)
                                        const isGoogleUser = firebaseUser.providerData && 
                                            firebaseUser.providerData.some(provider => provider.providerId === 'google.com');
                                        
                                        if (!isGoogleUser) {
                                            console.log('[DEBUG] Usuario no es de Google, creando perfil b√°sico');
                                            const newProfile = {
                                                email: firebaseUser.email,
                                                name: firebaseUser.displayName || 'Usuario',
                                                role: 'comercial',
                                                createdAt: new Date().toISOString()
                                            };
                                            setDoc(userDocRef, newProfile);
                                            setUserProfile({ id: firebaseUser.uid, ...newProfile });
                                        } else {
                                            console.log('[DEBUG] Usuario de Google detectado, esperando perfil del auth-simple.js');
                                            // Para usuarios de Google, esperar a que se cree el perfil en auth-simple.js
                                            // No crear perfil aqu√≠ para evitar sobrescribir
                                        }
                                    }
                                });
                                });
                            } else {
                                // Sin autenticaci√≥n, modo demo
                                setUser({ uid: "demo-user-123", email: "demo@expertia.com" });
                                setUserProfile({ 
                                    id: "demo-user-123", 
                                    email: "demo@expertia.com", 
                                    name: "Usuario Demo", 
                                    role: "admin" 
                                });
                                loadDemoData();
                            }
                            setIsAuthReady(true);
                            setIsLoading(false);
                        });

                        return () => unsubscribe();
                    } catch (error) {
                        console.error("Error al inicializar Firebase:", error);
                        // Fallback a modo demo
                        setUser({ uid: "demo-user-123", email: "demo@expertia.com" });
                        setUserProfile({ 
                            id: "demo-user-123", 
                            email: "demo@expertia.com", 
                            name: "Usuario Demo", 
                            role: "admin" 
                        });
                        setIsAuthReady(true);
                        setIsLoading(false);
                        loadDemoData();
                    }
                }, []);
                
                // Cargar configuraci√≥n del sistema cuando db y user est√©n disponibles
                useEffect(() => {
                    console.log("[DEBUG] useEffect ejecut√°ndose - db:", !!db, "user:", !!user, "isAuthReady:", isAuthReady);
                    console.log("[DEBUG] user.uid:", user?.uid);
                    
                    if (db && user && user.uid && isAuthReady) {
                        console.log("Condiciones cumplidas para cargar configuraci√≥n");
                        console.log("- db disponible:", !!db);
                        console.log("- user disponible:", !!user);
                        console.log("- user.uid disponible:", !!user.uid);
                        console.log("- isAuthReady:", isAuthReady);
                        
                        // Cargar datos de forma secuencial para evitar problemas de timing
                        const loadData = async () => {
                            try {
                                console.log("[DEBUG] Iniciando carga secuencial de datos");
                                await loadAppConfig();
                                console.log("[DEBUG] loadAppConfig completado");
                                await loadCounters();
                                console.log("[DEBUG] loadCounters completado");
                                // Peque√±a pausa antes de cargar gastos para estabilizar React
                                await new Promise(resolve => setTimeout(resolve, 100));
                                await loadExpenses();
                                console.log("[DEBUG] loadExpenses completado");
                                console.log("[OK] Todos los datos cargados correctamente");
                            } catch (error) {
                                console.error("[ERROR] Error cargando datos:", error);
                            }
                        };
                        
                        loadData();
                    } else {
                        console.log("Esperando condiciones para cargar configuraci√≥n");
                        console.log("- db:", !!db);
                        console.log("- user:", !!user);
                        console.log("- user.uid:", !!user?.uid);
                        console.log("- isAuthReady:", isAuthReady);
                    }
                }, [db, user, isAuthReady]);

                // Funci√≥n para cargar datos demo
                const loadDemoData = () => {
                    setClients([
                        { 
                            id: '1', 
                            name: 'Hospital San Juan', 
                            email: 'contacto@hospitalsanjuan.com', 
                            phone: '+34 91 123 4567', 
                            company: 'Hospital San Juan', 
                            funnelStage: 'Ganado', 
                            lastContact: '2025-07-08',
                            address: 'Calle Mayor 123, Madrid',
                            notes: 'Cliente prioritario',
                            consentGiven: true,
                            acceptsMarketing: true
                        },
                        { 
                            id: '2', 
                            name: 'Cl√≠nica Dental L√≥pez', 
                            email: 'info@clinicalopez.com', 
                            phone: '+34 93 234 5678', 
                            company: 'Cl√≠nica Dental L√≥pez', 
                            funnelStage: 'En Cierre', 
                            lastContact: '2025-07-07',
                            address: 'Av. Diagonal 456, Barcelona',
                            notes: 'Interesado en equipos dentales',
                            consentGiven: true,
                            acceptsMarketing: false
                        },
                        { 
                            id: '3', 
                            name: 'Centro M√©dico Valle', 
                            email: 'admin@centrovalle.com', 
                            phone: '+34 95 345 6789', 
                            company: 'Centro M√©dico Valle', 
                            funnelStage: 'Interesado', 
                            lastContact: '2025-07-06',
                            address: 'Plaza Central 789, Sevilla',
                            notes: 'Contacto inicial realizado',
                            consentGiven: true,
                            acceptsMarketing: true
                        }
                    ]);
                    
                    setProducts([
                        { 
                            id: '1', 
                            name: 'Equipo de Rayos X Digital', 
                            price: 15000, 
                            description: 'Sistema completo de radiograf√≠a digital con panel detector',
                            category: 'Diagn√≥stico',
                            supplier: 'Storz Medical'
                        },
                        { 
                            id: '2', 
                            name: 'Monitor de Signos Vitales', 
                            price: 3500, 
                            description: 'Monitor multiparam√©trico para UCI',
                            category: 'Monitorizaci√≥n',
                            supplier: 'Zamar Medical'
                        },
                        { 
                            id: '3', 
                            name: 'Desfibrilador Autom√°tico', 
                            price: 8500, 
                            description: 'DEA con pantalla LCD y gu√≠a de voz',
                            category: 'Emergencias',
                            supplier: 'Storz Medical'
                        }
                    ]);
                    
                    setInvoices([
                        { 
                            id: '1', 
                            number: 'EXP-001', 
                            clientId: '1',
                            clientName: 'Hospital San Juan', 
                            amount: 15000,
                            total: 18150, // Con IVA
                            status: 'Pagada', 
                            date: '2025-07-01',
                            series: 'EXP',
                            items: [
                                { productId: '1', quantity: 1, price: 15000 }
                            ]
                        },
                        { 
                            id: '2', 
                            number: 'EXP-002', 
                            clientId: '2',
                            clientName: 'Cl√≠nica Dental L√≥pez', 
                            amount: 3500,
                            total: 4235, // Con IVA
                            status: 'Finalizada', 
                            date: '2025-07-05',
                            series: 'EXP',
                            items: [
                                { productId: '2', quantity: 1, price: 3500 }
                            ]
                        }
                    ]);
                    
                    setOffers([
                        { 
                            id: 'OF-001', 
                            offerNumber: 'OF-2025-001',
                            offerSeries: 'OF',
                            clientId: '3',
                            offerDate: '2025-07-15',
                            validUntil: '2025-08-15',
                            status: 'Enviada',
                            description: 'Propuesta de equipamiento completo para Centro M√©dico Valle',
                            items: [
                                { 
                                    productId: '1', 
                                    description: 'Equipo de Rayos X Digital', 
                                    quantity: 1, 
                                    price: 15000 
                                },
                                { 
                                    productId: '2', 
                                    description: 'Monitor de Signos Vitales', 
                                    quantity: 2, 
                                    price: 3500 
                                }
                            ],
                            subtotal: 22000,
                            vat: 4620,
                            total: 26620,
                            terms: 'Esta oferta es v√°lida hasta la fecha indicada. Los precios incluyen IVA. Forma de pago: 50% a la firma del contrato, 50% a la entrega. Garant√≠a de 2 a√±os.'
                        },
                        { 
                            id: 'OF-002', 
                            offerNumber: 'OF-2025-002',
                            offerSeries: 'OF',
                            clientId: '2',
                            offerDate: '2025-07-10',
                            validUntil: '2025-08-10',
                            status: 'Aceptada',
                            description: 'Equipos especializados para cl√≠nica dental',
                            items: [
                                { 
                                    productId: '3', 
                                    description: 'Desfibrilador Autom√°tico', 
                                    quantity: 1, 
                                    price: 8500 
                                }
                            ],
                            subtotal: 8500,
                            vat: 1785,
                            total: 10285,
                            terms: 'Oferta especial con descuento del 10%. Instalaci√≥n y formaci√≥n incluidas.'
                        },
                        { 
                            id: 'OF-003', 
                            offerNumber: 'OF-2025-003',
                            offerSeries: 'OF',
                            clientId: '1',
                            offerDate: '2025-06-15',
                            validUntil: '2025-07-15',
                            status: 'Expirada',
                            description: 'Renovaci√≥n de equipamiento existente',
                            items: [
                                { 
                                    productId: '2', 
                                    description: 'Monitor de Signos Vitales', 
                                    quantity: 3, 
                                    price: 3500 
                                }
                            ],
                            subtotal: 10500,
                            vat: 2205,
                            total: 12705,
                            terms: 'Oferta v√°lida hasta la fecha indicada. Sin compromiso de compra.'
                        }
                    ]);
                    
                    console.log("Datos demo cargados exitosamente");
                };

                // Listeners de Firestore con nueva estructura
                useEffect(() => {
                    if (!isAuthReady || !db || !user || !userProfile) return;
                    
                    console.log("Configurando listeners de Firestore...");
                    
                    if (!isCommercialOrAdmin()) {
                        console.log("Usuario sin permisos suficientes");
                        return;
                    }

                    const unsubscribers = [];

                    // Listener para clientes
                    const clientsCollection = collection(db, 'clientes');
                    unsubscribers.push(
                        onSnapshot(clientsCollection, (snapshot) => {
                            const clientsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setClients(clientsData);
                        }, (error) => {
                            console.error("Error loading clients:", error);
                        })
                    );

                    // Listener para productos
                    const productsCollection = collection(db, 'productos');
                    unsubscribers.push(
                        onSnapshot(productsCollection, (snapshot) => {
                            const productsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setProducts(productsData);
                        }, (error) => {
                            console.error("Error loading products:", error);
                        })
                    );

                    // Listener para facturas
                    const invoicesCollection = collection(db, 'facturas');
                    unsubscribers.push(
                        onSnapshot(invoicesCollection, (snapshot) => {
                            const invoicesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setInvoices(invoicesData);
                        }, (error) => {
                            console.error("Error loading invoices:", error);
                        })
                    );

                    // Listener para ofertas
                    const offersCollection = collection(db, 'ofertas');
                    unsubscribers.push(
                        onSnapshot(offersCollection, (snapshot) => {
                            const offersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setOffers(offersData);
                        }, (error) => {
                            console.error("Error loading offers:", error);
                        })
                    );

                    setIsLoading(false);

                    return () => {
                        unsubscribers.forEach(unsubscribe => unsubscribe());
                    };
                }, [isAuthReady, db, user, userProfile]);
                
                // --- Funciones CRUD con nueva estructura ---
                const handleSave = async (collectionName, data, docId) => {
                    if (!db || !user) {
                        console.log("Guardando en modo demo...");
                        return;
                    }
                    
                    const finalDocId = docId || data.id;
                    const { id, ...dataToSave } = data;
                    
                    // Agregar metadatos
                    dataToSave.updatedAt = new Date().toISOString();
                    dataToSave.updatedBy = user.uid;
                    dataToSave.updatedByName = userProfile?.name || user.email || 'Usuario';
                    
                    if (!finalDocId) {
                        dataToSave.createdAt = new Date().toISOString();
                        dataToSave.createdBy = user.uid;
                        dataToSave.createdByName = userProfile?.name || user.email || 'Usuario';
                    }
                    
                    try {
                        if (finalDocId) {
                            await setDoc(doc(db, collectionName, finalDocId), dataToSave, { merge: true });
                        } else {
                            await addDoc(collection(db, collectionName), dataToSave);
                        }
                        console.log(`Guardado exitoso en ${collectionName}`);
                    } catch (error) { 
                        console.error(`Error guardando en ${collectionName}:`, error); 
                    }
                };

                const handleDelete = async (collectionName, docId) => {
                    if (!db || !user) {
                        console.log("Eliminando en modo demo...");
                        return;
                    }
                    
                    showConfirm(
                        'Confirmar eliminaci√≥n',
                        '¬øEst√°s seguro de que quieres eliminar este elemento? Esta acci√≥n no se puede deshacer.',
                        async () => {
                            try {
                                await deleteDoc(doc(db, collectionName, docId));
                                console.log(`Eliminado exitoso de ${collectionName}`);
                            } catch (error) { 
                                console.error(`Error eliminando de ${collectionName}:`, error); 
                            }
                        },
                        'danger'
                    );
                };

                // Funci√≥n de eliminaci√≥n sin confirmaci√≥n para uso con confirmaciones personalizadas
                const handleDeleteDirect = async (collectionName, docId) => {
                    if (!db || !user) {
                        console.log("Eliminando en modo demo...");
                        return;
                    }
                    
                    try {
                        await deleteDoc(doc(db, collectionName, docId));
                        console.log(`Eliminado exitoso de ${collectionName}`);
                    } catch (error) { 
                        console.error(`Error eliminando de ${collectionName}:`, error); 
                    }
                };
                
                const handleSaveClient = async (clientData) => {
                    await handleSave('clientes', clientData, clientData.id);
                    setActiveView('dashboard');
                    setSelectedItem(null);
                };
                
                const handleSaveProfile = async (profileData) => {
                    await handleSave('users', profileData, user.uid);
                    setActiveView('dashboard');
                };

                const handleSaveProduct = async (productData) => {
                    if (!isAdmin()) {
                        showNotification('Acceso denegado', 'Solo los administradores pueden gestionar productos', 'error');
                        return;
                    }
                    await handleSave('productos', productData, productData.id);
                    setActiveView('products');
                };

                const getNextInvoiceNumber = async (type) => {
                    if (!db) {
                        // Modo demo - generar n√∫mero temporal usando contadores
                        const timestamp = Date.now();
                        const series = window.getInvoiceSeries ? window.getInvoiceSeries() : ['EXP', 'ALQ', 'PROF'];
                        const prefix = series.includes(type) ? type : series[0] || 'EXP';
                        return `${prefix}-DEMO-${timestamp}`;
                    }

                    const counterRef = doc(db, 'counters', type);
                    let nextNumber;
                    
                    try {
                        await runTransaction(db, async (transaction) => {
                            const counterDoc = await transaction.get(counterRef);
                            if (!counterDoc.exists()) {
                                const startValue = 0; // Empezar en 0 para que la primera factura sea la n√∫mero 1
                                transaction.set(counterRef, { current: startValue });
                                nextNumber = startValue;
                            } else {
                                const newCurrent = counterDoc.data().current + 1;
                                transaction.update(counterRef, { current: newCurrent });
                                nextNumber = newCurrent;
                            }
                        });
                        
                        // Usar series desde contadores
                        const series = window.getInvoiceSeries ? window.getInvoiceSeries() : ['EXP', 'ALQ', 'PROF'];
                        const prefix = series.includes(type) ? type : series[0] || 'EXP';
                        return `${prefix}${String(nextNumber).padStart(3, '0')}`;
                    } catch (error) {
                        console.error("Error obteniendo n√∫mero de factura:", error);
                        const series = window.getInvoiceSeries ? window.getInvoiceSeries() : ['EXP', 'ALQ', 'PROF'];
                        const prefix = series.includes(type) ? type : series[0] || 'EXP';
                        return `${prefix}-ERROR-${Date.now()}`;
                    }
                };

                const handleSaveInvoice = async (invoiceData, convertFromProforma = false) => {
                    let dataToSave = { ...invoiceData };
                    
                    if (convertFromProforma || !dataToSave.id) {
                        if (dataToSave.type !== 'Factura Proforma') {
                            // Usar serie por defecto desde contadores
                            const series = window.getInvoiceSeries ? window.getInvoiceSeries() : ['EXP', 'ALQ', 'PROF'];
                            const defaultSeries = series[0];
                            dataToSave.invoiceNumber = await getNextInvoiceNumber(dataToSave.invoiceSeries || defaultSeries);
                        } else {
                            dataToSave.invoiceNumber = `PROFORMA-${Date.now()}`;
                        }
                    }
                    
                    await handleSave('facturas', dataToSave, dataToSave.id);
                    setActiveView('accounting');
                };

                const handleConvertToInvoice = async (proformaInvoice) => {
                    const invoiceData = {
                        ...proformaInvoice,
                        type: 'Factura',
                        status: 'Enviada',
                    };
                    await handleSaveInvoice(invoiceData, true);
                };

                const handleCreateRectificativa = async (originalInvoice) => {
                    try {
                        // Extraer la serie y n√∫mero de la factura original
                        const originalInvoiceNumber = originalInvoice.invoiceNumber || originalInvoice.number || '';
                        const originalSeries = originalInvoice.invoiceSeries || 'EXP';
                        
                        // Generar serie y n√∫mero de rectificativa: REC + n√∫mero original completo
                        const rectificativaSeries = `REC${originalSeries}`;
                        const rectificativaNumber = `REC${originalInvoiceNumber}`;
                        
                        console.log('[PROCESS]  Generando rectificativa:', {
                            original: {
                                fullNumber: originalInvoiceNumber,
                                series: originalSeries
                            },
                            rectificativa: {
                                series: rectificativaSeries,
                                number: rectificativaNumber
                            }
                        });
                        
                        // Crear una nueva factura rectificativa
                        const rectificativaData = {
                            ...originalInvoice,
                            id: null, // Se generar√° un nuevo ID
                            type: 'Factura Rectificativa',
                            invoiceSeries: rectificativaSeries,
                            invoiceNumber: rectificativaNumber,
                            number: rectificativaNumber, // Para compatibilidad
                            originalInvoiceId: originalInvoice.id,
                            originalInvoiceNumber: originalInvoiceNumber,
                            originalInvoiceSeries: originalSeries,
                            // Mantener el cliente de la factura original
                            clientId: originalInvoice.clientId,
                            client: originalInvoice.client,
                            date: new Date().toISOString().split('T')[0],
                            status: 'Borrador',
                            total: -originalInvoice.total, // Valor negativo para rectificar
                            subtotal: -originalInvoice.subtotal,
                            totalTax: -originalInvoice.totalTax,
                            totalPaid: 0,
                            // Invertir cantidades y precios de los productos/items
                            items: (originalInvoice.items || []).map(item => ({
                                ...item,
                                quantity: -item.quantity,
                                price: item.price, // El precio se mantiene positivo
                                total: -item.total
                            }))
                        };

                        console.log('[PROCESS]  Creando factura rectificativa:', {
                            original: {
                                fullNumber: originalInvoiceNumber,
                                series: originalSeries
                            },
                            rectificativa: {
                                series: rectificativaSeries,
                                number: rectificativaNumber
                            }
                        });

                        // Cambiar a vista de creaci√≥n con los datos de la rectificativa
                        setSelectedItem(rectificativaData);
                        setActiveView('createInvoice');
                    } catch (error) {
                        console.error('Error creating rectificativa:', error);
                        alert('Error al crear la factura rectificativa');
                    }
                };

                const handleRegisterPayment = async (invoice, paymentAmount) => {
                    if (!db || !invoice || !paymentAmount) return;
                    
                    const newTotalPaid = (invoice.totalPaid || 0) + paymentAmount;
                    let newStatus;
                    if (newTotalPaid >= invoice.total) {
                        newStatus = 'Pagada';
                    } else if (newTotalPaid > 0) {
                        newStatus = 'Parcialmente Pagada';
                    } else {
                        newStatus = 'Enviada';
                    }
                    
                    const updatedInvoice = {
                        ...invoice,
                        totalPaid: newTotalPaid,
                        status: newStatus,
                    };
                    
                    // Guardar el pago en la subcolecci√≥n
                        const paymentData = { 
                            amount: paymentAmount, 
                        date: new Date().toISOString().split('T')[0], // Formato YYYY-MM-DD
                            registeredBy: user.uid
                        };
                    console.log('üíæ Guardando pago:', paymentData);
                    console.log('üíæ Ruta de guardado:', `facturas/${invoice.id}/payments`);
                        await addDoc(collection(db, `facturas/${invoice.id}/payments`), paymentData);
                    console.log('[OK]  Pago guardado correctamente');
                    
                    // Actualizar la factura principal
                    await handleSave('facturas', updatedInvoice, updatedInvoice.id);
                    
                    setSelectedItem(updatedInvoice);
                };

                // === FUNCIONES ESPEC√çFICAS PARA OFERTAS ===
                const getNextOfferNumber = async (series) => {
                    // Obtener serie por defecto de configuraci√≥n si no se especifica
                    const defaultOfferSeries = getConfigValue('invoice', 'offerSeries', 'OF');
                    const finalSeries = series || defaultOfferSeries;
                    
                    if (!db) {
                        // Modo demo - generar n√∫mero temporal usando configuraci√≥n
                        const timestamp = Date.now();
                        return `${finalSeries}-DEMO-${timestamp}`;
                    }

                    const counterRef = doc(db, 'counters', 'offers');
                    let nextNumber;
                    
                    try {
                        await runTransaction(db, async (transaction) => {
                            const counterDoc = await transaction.get(counterRef);
                            if (!counterDoc.exists()) {
                                nextNumber = 0; // Empezar en 0 para que la primera oferta sea la n√∫mero 1
                                transaction.set(counterRef, { count: 0 });
                            } else {
                                nextNumber = counterDoc.data().count + 1;
                                transaction.update(counterRef, { count: nextNumber });
                            }
                        });
                        
                        const year = new Date().getFullYear();
                        return `${finalSeries}-${year}-${String(nextNumber).padStart(3, '0')}`;
                    } catch (error) {
                        console.error("Error getting next offer number:", error);
                        return `${finalSeries}-${Date.now()}`;
                    }
                };

                const handleSaveOffer = async (offerData) => {
                    let dataToSave = { ...offerData };
                    
                    if (!dataToSave.id) {
                        // Usar serie por defecto de configuraci√≥n
                        const defaultOfferSeries = getConfigValue('invoice', 'offerSeries', 'OF');
                        dataToSave.offerNumber = await getNextOfferNumber(dataToSave.offerSeries || defaultOfferSeries);
                    }
                    
                    await handleSave('ofertas', dataToSave, dataToSave.id);
                    setActiveView('offers');
                };

                const handleAcceptOffer = async (offerId) => {
                    const offer = offers.find(o => o.id === offerId);
                    if (offer) {
                        const updatedOffer = { ...offer, status: 'Aceptada' };
                        await handleSave('ofertas', updatedOffer, offerId);
                        setSelectedItem(updatedOffer);
                    }
                };

                const handleRejectOffer = async (offerId) => {
                    const offer = offers.find(o => o.id === offerId);
                    if (offer) {
                        const updatedOffer = { ...offer, status: 'Rechazada' };
                        await handleSave('ofertas', updatedOffer, offerId);
                        setSelectedItem(updatedOffer);
                    }
                };

                const handleExpireOffer = async (offerId) => {
                    const offer = offers.find(o => o.id === offerId);
                    if (offer) {
                        const updatedOffer = { ...offer, status: 'Expirada' };
                        await handleSave('ofertas', updatedOffer, offerId);
                        setSelectedItem(updatedOffer);
                    }
                };

                const handleConvertOfferToInvoice = async (offer) => {
                    if (offer.status !== 'Aceptada') {
                        showNotification('Error de conversi√≥n', 'Solo se pueden convertir ofertas aceptadas en facturas', 'error');
                        return;
                    }

                    const invoiceData = {
                        clientId: offer.clientId,
                        invoiceDate: new Date().toISOString().split('T')[0],
                        dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'Borrador',
                        type: 'Factura',
                        invoiceSeries: (window.getInvoiceSeries ? window.getInvoiceSeries() : ['EXP', 'ALQ', 'PROF'])[0] || 'EXP',
                        items: offer.items || [],
                        subtotal: offer.subtotal,
                        vat: offer.vat,
                        total: offer.total,
                        originOfferId: offer.id,
                        originOfferNumber: offer.offerNumber
                    };

                    await handleSaveInvoice(invoiceData);
                    
                    // Opcional: actualizar estado de la oferta a "Convertida"
                    // const updatedOffer = { ...offer, status: 'Convertida' };
                    // await handleSave('ofertas', updatedOffer, offer.id);
                    
                    showNotification('Conversi√≥n exitosa', 'La oferta ha sido convertida exitosamente en factura', 'success');
                };

                const filteredClients = useMemo(() => clients.filter(client => {
                    // B√∫squeda por texto
                    const searchLower = searchTerm.toLowerCase();
                    const matchesSearch = searchTerm === '' || 
                        client.name?.toLowerCase().includes(searchLower) || 
                        client.company?.toLowerCase().includes(searchLower) ||
                        client.email?.toLowerCase().includes(searchLower) ||
                        client.phone?.toLowerCase().includes(searchLower) ||
                        client.notes?.toLowerCase().includes(searchLower) ||
                        client.sector?.toLowerCase().includes(searchLower);
                    
                    // Filtro por etapa del embudo
                    const matchesTag = filterTag === 'all' || client.funnelStage === filterTag;
                    
                    return matchesSearch && matchesTag;
                }), [clients, searchTerm, filterTag]);

                const renderView = () => {
                    if (!isCommercialOrAdmin() && activeView !== 'profile' && activeView !== 'welcome') {
                        return (
                            <div className="p-6 text-center">
                                <h2 className="text-xl font-semibold text-gray-800 mb-4">Acceso Restringido</h2>
                                <p className="text-gray-600">No tienes permisos para acceder a esta funcionalidad.</p>
                                <p className="text-sm text-gray-500 mt-2">Contacta con un administrador para obtener acceso.</p>
                            </div>
                        );
                    }

                    switch (activeView) {
                        case 'welcome':
                            return <WelcomeScreen 
                                userProfile={userProfile}
                                clients={clients}
                                invoices={invoices}
                                offers={offers}
                                onNavigate={setActiveView}
                            />;
                        case 'profile': 
                            return <ProfileForm userProfile={userProfile} onSave={handleSaveProfile} onBack={() => setActiveView('dashboard')} />;
                        case 'bulkCommunication': 
                            return <BulkCommunication clients={clients} onBack={() => setActiveView('dashboard')} />;
                        case 'addClient': 
                            return <ClientForm onSave={handleSaveClient} onCancel={() => setActiveView('dashboard')} showNotification={showNotification} getConfigValue={getConfigValue} db={db} />;
                        case 'editClient': 
                            return <ClientForm client={selectedItem} onSave={handleSaveClient} onCancel={() => setActiveView('dashboard')} showNotification={showNotification} getConfigValue={getConfigValue} db={db} />;
                        case 'detailClient': 
                            return <ClientDetail 
                                client={selectedItem} 
                                db={db} 
                                user={user} 
                                onEdit={() => { setSelectedItem(selectedItem); setActiveView('editClient'); }} 
                                onDelete={() => {
                                    showConfirm(
                                        'Eliminar Cliente',
                                        `¬øEst√°s seguro de que quieres eliminar el cliente "${selectedItem.name}"? Esta acci√≥n no se puede deshacer.`,
                                        async () => {
                                            await handleDeleteDirect('clientes', selectedItem.id);
                                            setActiveView('dashboard');
                                            setSelectedItem(null);
                                        },
                                        'danger'
                                    );
                                }} 
                                onBack={() => setActiveView('dashboard')} 
                                onCreateInvoice={() => { setSelectedItem({ client: selectedItem }); setActiveView('createInvoice'); }} 
                                onGenerateConsent={() => { setSelectedItem(selectedItem); setActiveView('consentForm'); }} 
                            />;
                        case 'consentForm': 
                            return <ConsentForm client={selectedItem} onBack={() => { setSelectedItem(selectedItem); setActiveView('detailClient'); }} />;
                        case 'offers': 
                            return <OffersDashboard 
                                offers={offers} 
                                clients={clients} 
                                products={products} 
                                onCreateOffer={() => setActiveView('createOffer')} 
                                onViewOffer={(offer) => { setSelectedItem(offer); setActiveView('viewOffer'); }} 
                                onEditOffer={(offer) => { setSelectedItem(offer); setActiveView('editOffer'); }} 
                                onDeleteOffer={(id) => handleDelete('ofertas', id)} 
                                showConfirm={showConfirm}
                            />;
                        case 'createOffer': 
                            return <OfferForm 
                                clients={clients} 
                                products={products} 
                                onSave={handleSaveOffer} 
                                onCancel={() => setActiveView('offers')} 
                                offerData={null}
                                db={db}
                            />;
                        case 'viewOffer': 
                            return <OfferDetail 
                                offer={selectedItem} 
                                clients={clients} 
                                onBack={() => setActiveView('offers')} 
                                onAcceptOffer={handleAcceptOffer}
                                onRejectOffer={handleRejectOffer}
                                onExpireOffer={handleExpireOffer}
                                onConvertToInvoice={handleConvertOfferToInvoice}
                            />;
                        case 'editOffer': 
                            return <OfferForm 
                                clients={clients} 
                                products={products} 
                                onSave={handleSaveOffer} 
                                onCancel={() => setActiveView('offers')} 
                                offerData={selectedItem}
                                db={db}
                            />;
                        case 'products': 
                            return <ProductsDashboard 
                                products={products} 
                                onCreateProduct={() => setActiveView('createProduct')} 
                                onEditProduct={(product) => { setSelectedItem(product); setActiveView('editProduct'); }} 
                                onDeleteProduct={(id) => handleDeleteDirect('productos', id)} 
                                showConfirm={showConfirm}
                            />;
                        case 'createProduct': 
                            return <ProductForm 
                                onSave={handleSaveProduct} 
                                onCancel={() => setActiveView('products')} 
                            />;
                        case 'editProduct': 
                            return <ProductForm 
                                product={selectedItem}
                                onSave={handleSaveProduct} 
                                onCancel={() => setActiveView('products')} 
                            />;
                        case 'accounting': 
                            return <AccountingDashboard 
                                invoices={invoices} 
                                clients={clients} 
                                onCreateInvoice={() => { setSelectedItem(null); setActiveView('createInvoice'); }} 
                                onViewInvoice={(invoice) => { setSelectedItem(invoice); setActiveView('viewInvoice'); }} 
                                onDeleteInvoice={(id) => handleDelete('facturas', id)}
                                showConfirm={showConfirm}
                                showNotification={showNotification}
                            />;
                        case 'expenses': 
                            return <ExpensesDashboard 
                                expenses={expenses} 
                                onAddExpense={() => { setSelectedItem(null); setActiveView('createExpense'); }} 
                                onViewExpense={(expense) => { setSelectedItem(expense); setActiveView('viewExpense'); }} 
                                onEditExpense={(expense) => { setSelectedItem(expense); setActiveView('editExpense'); }} 
                                onDeleteExpense={(expense) => {
                                    showConfirm(
                                        'Eliminar Gasto',
                                        `¬øEst√°s seguro de que quieres eliminar el gasto "${expense.description}"? Esta acci√≥n no se puede deshacer.`,
                                        async () => {
                                            await deleteExpense(expense);
                                        },
                                        'danger'
                                    );
                                }}
                                searchTerm={searchTerm} 
                                setSearchTerm={setSearchTerm} 
                                filterStatus={filterTag} 
                                setFilterStatus={setFilterTag} 
                            />;
                        case 'createExpense': 
                            return <ExpenseForm 
                                expense={null}
                                onSave={async (expenseData) => {
                                    const success = await saveExpense(expenseData);
                                    if (success) {
                                        setActiveView('expenses');
                                    }
                                }} 
                                onCancel={() => setActiveView('expenses')} 
                                clients={clients}
                                userProfile={userProfile}
                            />;
                        case 'editExpense': 
                            return <ExpenseForm 
                                expense={selectedItem}
                                onSave={async (expenseData) => {
                                    const success = await saveExpense(expenseData);
                                    if (success) {
                                        setActiveView('expenses');
                                    }
                                }} 
                                onCancel={() => setActiveView('expenses')} 
                                clients={clients}
                                userProfile={userProfile}
                            />;
                        case 'viewExpense': 
                            return <ExpenseDetail 
                                expense={selectedItem} 
                                onEdit={(expense) => { setSelectedItem(expense); setActiveView('editExpense'); }} 
                                onDelete={(expense) => {
                                    showConfirm(
                                        'Eliminar Gasto',
                                        `¬øEst√°s seguro de que quieres eliminar el gasto "${expense.description}"? Esta acci√≥n no se puede deshacer.`,
                                        async () => {
                                            await deleteExpense(expense);
                                            setActiveView('expenses');
                                        },
                                        'danger'
                                    );
                                }}
                                onBack={() => setActiveView('expenses')} 
                            />;
                        case 'createInvoice': 
                            return <InvoiceForm 
                                clients={clients} 
                                products={products} 
                                onSave={handleSaveInvoice} 
                                onCancel={() => setActiveView('accounting')} 
                                invoiceData={selectedItem} 
                            />;
                        case 'viewInvoice': 
                            return <InvoiceDetail 
                                invoice={selectedItem} 
                                clients={clients} 
                                onBack={() => setActiveView('accounting')} 
                                onRegisterPayment={handleRegisterPayment} 
                                db={db} 
                                userId={user?.uid} 
                                onConvertToInvoice={handleConvertToInvoice} 
                                onCreateRectificativa={handleCreateRectificativa}
                                showConfirm={showConfirm}
                                showNotification={showNotification}
                            />;
                        case 'reports': 
                            return <ReportsDashboard allInvoices={invoices} userProfile={userProfile} />;
                        case 'admin':
                            if (!isAdmin()) {
                                return (
                                    <div className="p-6 text-center">
                                        <h2 className="text-xl font-semibold text-red-600 mb-4">Acceso Denegado</h2>
                                        <p className="text-gray-600">Solo los administradores pueden acceder al panel de administraci√≥n.</p>
                                    </div>
                                );
                            }
                            return <AdminPanel />;
                        default: 
                            return <Dashboard 
                                clients={filteredClients} 
                                allClients={clients} 
                                onAddClient={() => setActiveView('addClient')} 
                                onBulkComm={() => setActiveView('bulkCommunication')} 
                                onViewClient={(client) => { setSelectedItem(client); setActiveView('detailClient'); }} 
                                onEditClient={(client) => { setSelectedItem(client); setActiveView('editClient'); }} 
                                onDeleteClient={(client) => {
                                    showConfirm(
                                        'Eliminar Cliente',
                                        `¬øEst√°s seguro de que quieres eliminar el cliente "${client.name}"? Esta acci√≥n no se puede deshacer.`,
                                        async () => {
                                            await handleDeleteDirect('clientes', client.id);
                                        },
                                        'danger'
                                    );
                                }} 
                                searchTerm={searchTerm} 
                                setSearchTerm={setSearchTerm} 
                                filterTag={filterTag} 
                                setFilterTag={setFilterTag} 
                            />;
                    }
                };

                return (
                    <div className="bg-gray-50 min-h-screen font-sans">
                        <Header userProfile={userProfile} activeView={activeView} setActiveView={setActiveView} />
                        <main className="p-4 sm:p-6 md:p-8">{renderView()}</main>
                        
                        {/* Modal de confirmaci√≥n personalizado */}
                        <CustomConfirm 
                            isOpen={confirmModal.isOpen}
                            title={confirmModal.title}
                            message={confirmModal.message}
                            type={confirmModal.type}
                            onConfirm={confirmModal.onConfirm}
                            onCancel={confirmModal.onCancel}
                        />
                        
                        {/* Modal de notificaci√≥n personalizado */}
                        <CustomNotification 
                            isOpen={notificationModal.isOpen}
                            title={notificationModal.title}
                            message={notificationModal.message}
                            type={notificationModal.type}
                            onClose={() => setNotificationModal({ ...notificationModal, isOpen: false })}
                        />
                        
                        {/* Modal de input personalizado */}
                        <CustomInputModal 
                            isOpen={inputModal.isOpen}
                            title={inputModal.title}
                            placeholder={inputModal.placeholder}
                            value={inputModal.value}
                            onConfirm={inputModal.onConfirm}
                            onCancel={inputModal.onCancel}
                        />
                    </div>
                );
            }

            // --- Componentes ---
            // Componente de Pantalla de Bienvenida
            function WelcomeScreen({ userProfile, clients, invoices, offers, onNavigate }) {
                const totalClients = clients.length;
                const totalInvoices = invoices.length;
                const totalOffers = offers.length;
                
                // Calcular m√©tricas
                const clientsGanados = clients.filter(c => c.funnelStage === 'Ganado').length;
                const invoicesPagadas = invoices.filter(i => i.status === 'Pagada').length;
                const offersAceptadas = offers.filter(o => o.status === 'Aceptada').length;
                
                const totalRevenue = invoices
                    .filter(i => i.status === 'Pagada')
                    .reduce((sum, i) => sum + (i.total || 0), 0);
                
                const currentDate = new Date().toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                return (
                    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-white">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            {/* Saludo de bienvenida */}
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-900 mb-2">¬°Bienvenido, {userProfile?.name}!</h1>
                                <p className="text-lg text-gray-600">{currentDate}</p>
                            </div>
                            
                            {/* M√©tricas principales */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                <StatCard 
                                    title="Total Clientes" 
                                    value={totalClients}
                                    icon={<UserIcon width={32} height={32} />}
                                    className="bg-white border-2 border-green-200 text-gray-900"
                                />
                                <StatCard 
                                    title="Clientes Ganados" 
                                    value={clientsGanados}
                                    icon={<AwardIcon width={32} height={32} />}
                                    className="bg-white border-2 border-green-200 text-gray-900"
                                />
                                <StatCard 
                                    title="Facturas Pagadas" 
                                    value={invoicesPagadas}
                                    icon={<FileTextIcon width={32} height={32} />}
                                    className="bg-white border-2 border-green-200 text-gray-900"
                                />
                                <StatCard 
                                    title="Ingresos Totales" 
                                    value={`‚Ç¨${totalRevenue.toLocaleString('es-ES', { minimumFractionDigits: 2 })}`}
                                    icon={<DollarSignIcon width={32} height={32} />}
                                    className="bg-white border-2 border-green-200 text-gray-900"
                                />
                            </div>
                            
                            {/* Resumen de actividad reciente */}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                                {/* Resumen de ofertas */}
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-lg font-semibold text-gray-900">Estado de Ofertas</h3>
                                        <PackageIcon width={24} height={24} className="text-gray-400" />
                                    </div>
                                    <div className="space-y-3">
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Total ofertas</span>
                                            <span className="font-medium text-gray-900">{totalOffers}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Aceptadas</span>
                                            <span className="font-medium text-green-600">{offersAceptadas}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Pendientes</span>
                                            <span className="font-medium text-orange-600">{offers.filter(o => o.status === 'Enviada').length}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Resumen de facturas */}
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-lg font-semibold text-gray-900">Estado de Facturas</h3>
                                        <FileTextIcon width={24} height={24} className="text-gray-400" />
                                    </div>
                                    <div className="space-y-3">
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Total facturas</span>
                                            <span className="font-medium text-gray-900">{totalInvoices}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Pagadas</span>
                                            <span className="font-medium text-green-600">{invoicesPagadas}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Pendientes</span>
                                            <span className="font-medium text-orange-600">{invoices.filter(i => i.status === 'Finalizada').length}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Pie de la pantalla de bienvenida */}
                            <div className="text-center mt-8 py-6">
                                <p className="text-sm text-gray-500">
                                    Expertia Business Suite - Sistema CRM para equipos m√©dicos
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }
            
            function Header({ userProfile, activeView, setActiveView }) {
                const [showUserDropdown, setShowUserDropdown] = React.useState(false);
                const navItemClass = (viewName) => `cursor-pointer py-2 px-3 rounded-md text-sm font-medium flex items-center gap-2 ${activeView.startsWith(viewName) ? 'bg-[#006666] text-white' : 'text-gray-600 hover:bg-gray-200'}`;
                const isAdmin = userProfile?.role === 'admin';
                
                // Cerrar dropdown al hacer clic fuera
                React.useEffect(() => {
                    const handleClickOutside = (event) => {
                        if (showUserDropdown && !event.target.closest('.user-dropdown-container')) {
                            setShowUserDropdown(false);
                        }
                    };
                    
                    document.addEventListener('click', handleClickOutside);
                    return () => document.removeEventListener('click', handleClickOutside);
                }, [showUserDropdown]);
                
                return (
                    <header className="bg-white shadow-md sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-20">
                                <div className="flex items-center">
                                    {activeView === 'welcome' ? (
                                        <img src="./LOGO_EXPERTIA.jpg" alt="Expertia Medical Solutions Logo" className="h-12 w-auto" />
                                    ) : (
                                        <button 
                                            onClick={() => setActiveView('welcome')}
                                            className="hover:opacity-80 transition-opacity"
                                            title="Volver al inicio"
                                        >
                                            <img src="./LOGO_EXPERTIA.jpg" alt="Expertia Medical Solutions Logo" className="h-12 w-auto" />
                                        </button>
                                    )}
                                </div>
                                <nav className="flex items-center gap-4">
                                    <span onClick={() => setActiveView('dashboard')} className={navItemClass('dashboard')}>
                                        <UserIcon width={16} height={16} /> Clientes
                                    </span>
                                    <span onClick={() => setActiveView('offers')} className={navItemClass('offers')}>
                                        <FileTextIcon width={16} height={16}/> Ofertas
                                    </span>
                                    <span onClick={() => setActiveView('products')} className={navItemClass('products')}>
                                        <BriefcaseIcon width={16} height={16} /> Productos
                                    </span>
                                    <span onClick={() => setActiveView('accounting')} className={navItemClass('accounting')}>
                                        <DollarSignIcon /> Contabilidad
                                    </span>
                                    <span onClick={() => setActiveView('expenses')} className={navItemClass('expenses')}>
                                        <CreditCardIcon width={16} height={16} /> Gastos
                                    </span>
                                    <span onClick={() => setActiveView('reports')} className={navItemClass('reports')}>
                                        <TrendingUpIcon width={16} height={16} /> Informes
                                    </span>
                                    {isAdmin && (
                                        <span onClick={() => setActiveView('admin')} className={navItemClass('admin')}>
                                            <CheckSquareIcon /> Admin
                                        </span>
                                    )}
                                </nav>
                                <div className="relative user-dropdown-container">
                                    <div 
                                        className="flex items-center gap-3 cursor-pointer hover:bg-gray-50 px-3 py-2 rounded-lg transition-colors" 
                                        onClick={() => setShowUserDropdown(!showUserDropdown)}
                                    >
                                        <div className="flex flex-col text-right">
                                            <div className="text-sm text-gray-600">{userProfile?.name || 'Usuario'}</div>
                                            <div className="text-xs text-gray-500 capitalize">{userProfile?.role || 'user'}</div>
                                        </div>
                                        <img src={userProfile?.photoURL || 'https://placehold.co/40x40/008080/FFFFFF?text=U'} alt="Perfil" className="h-10 w-10 rounded-full object-cover" />
                                        <svg className={`w-4 h-4 text-gray-400 transition-transform ${showUserDropdown ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                    
                                    {showUserDropdown && (
                                        <div className="absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 z-50">
                                            <div className="py-1">
                                                <div className="px-4 py-2 border-b border-gray-100">
                                                    <div className="text-xs text-gray-500 mb-1">Sesi√≥n activa</div>
                                                    <div className="text-xs text-gray-400">Auto-logout: 30 min inactividad</div>
                                                    <div className="text-xs text-gray-400 mt-1">Atajo: Ctrl+Shift+L</div>
                                                </div>
                                                <button
                                                    onClick={() => {
                                                        setShowUserDropdown(false);
                                                        setActiveView('profile');
                                                    }}
                                                    className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2"
                                                >
                                                    <UserIcon width={16} height={16} />
                                                    Mi Perfil
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        setShowUserDropdown(false);
                                                        resetInactivityTimer();
                                                        showNotification('Sesi√≥n Extendida', 'Timer de inactividad reiniciado. Tu sesi√≥n durar√° 30 minutos m√°s.', 'success');
                                                    }}
                                                    className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2"
                                                >
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                                    </svg>
                                                    Extender Sesi√≥n
                                                </button>
                                                <div className="border-t border-gray-100"></div>
                                                <button
                                                    onClick={() => {
                                                        setShowUserDropdown(false);
                                                        handleLogout();
                                                    }}
                                                    className="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"
                                                >
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                                    </svg>
                                                    Cerrar Sesi√≥n
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </header>
                );
            }

            // ... (El resto de los componentes se definen aqu√≠, igual que en la versi√≥n anterior) ...
            
            // === DASHBOARD DE CLIENTES MEJORADO ===
            function Dashboard({ clients, onAddClient, onViewClient, onEditClient, onDeleteClient, searchTerm, setSearchTerm, filterTag, setFilterTag }) {
                // Estados para filtros y ordenaci√≥n
                const [sortField, setSortField] = useState('name');
                const [sortDirection, setSortDirection] = useState('asc');

                // Obtener etapas √∫nicas para el filtro
                const uniqueStages = useMemo(() => {
                    const stages = [...new Set(clients.map(client => client.funnelStage).filter(Boolean))];
                    return stages.sort();
                }, [clients]);

                // Funci√≥n de ordenaci√≥n
                const handleSort = (field) => {
                    if (sortField === field) {
                        setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                    } else {
                        setSortField(field);
                        setSortDirection('asc');
                    }
                };

                // Funci√≥n para renderizar el icono de ordenaci√≥n
                const renderSortIcon = (field) => {
                    if (sortField !== field) {
                        return <ChevronUpIcon width={12} height={12} className="text-gray-400" />;
                    }
                    return sortDirection === 'asc' 
                        ? <ChevronUpIcon width={12} height={12} className="text-[#006666]" />
                        : <ChevronDownIcon width={12} height={12} className="text-[#006666]" />;
                };

                // Filtrar y ordenar clientes
                const filteredAndSortedClients = useMemo(() => {
                    let filtered = clients.filter(client => {
                        // Filtro por b√∫squeda
                        const searchLower = searchTerm.toLowerCase();
                        const matchesSearch = !searchTerm || 
                            client.name?.toLowerCase().includes(searchLower) ||
                            client.company?.toLowerCase().includes(searchLower) ||
                            client.email?.toLowerCase().includes(searchLower) ||
                            client.phone?.toLowerCase().includes(searchLower) ||
                            client.sector?.toLowerCase().includes(searchLower);

                        // Filtro por etapa
                        const matchesStage = filterTag === 'all' || client.funnelStage === filterTag;

                        return matchesSearch && matchesStage;
                    });

                    // Ordenar
                    filtered.sort((a, b) => {
                        let aValue, bValue;
                        
                        switch (sortField) {
                            case 'name':
                                aValue = a.name || '';
                                bValue = b.name || '';
                                break;
                            case 'company':
                                aValue = a.company || '';
                                bValue = b.company || '';
                                break;
                            case 'email':
                                aValue = a.email || '';
                                bValue = b.email || '';
                                break;
                            case 'phone':
                                aValue = a.phone || '';
                                bValue = b.phone || '';
                                break;
                            case 'funnelStage':
                                aValue = a.funnelStage || '';
                                bValue = b.funnelStage || '';
                                break;
                            case 'createdAt':
                                aValue = new Date(a.createdAt || '1970-01-01');
                                bValue = new Date(b.createdAt || '1970-01-01');
                                break;
                            case 'priority':
                                aValue = a.priority || '';
                                bValue = b.priority || '';
                                break;
                            default:
                                return 0;
                        }

                        if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
                        if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });

                    return filtered;
                }, [clients, searchTerm, filterTag, sortField, sortDirection]);

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h1 className="text-3xl font-bold text-gray-900">Dashboard de Clientes</h1>
                            <button onClick={onAddClient} className="bg-[#006666] text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-[#005555]">
                                <PlusIcon width={20} height={20} />
                                A√±adir Cliente
                            </button>
                        </div>
                        
                        <div className="bg-white p-6 rounded-lg shadow">
                            {/* T√≠tulo */}
                            <div className="mb-4">
                                <h3 className="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-4">
                                    <UserIcon width={20} height={20} /> Gesti√≥n de Clientes
                                </h3>
                                
                                {/* Barra de herramientas */}
                                <div className="flex justify-between gap-6 mb-4">
                                    <div className="flex gap-4">
                                        <div className="flex items-center">
                                            <SearchIcon className="text-gray-400" width={16} height={16} />
                                        </div>
                                        <div>
                                            <input
                                                type="text"
                                                placeholder="Buscar clientes..."
                                                value={searchTerm}
                                                onChange={(e) => setSearchTerm(e.target.value)}
                                                className="w-80 px-4 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-[#006666]"
                                            />
                                        </div>
                                        <div>
                                            <select
                                                value={filterTag}
                                                onChange={(e) => setFilterTag(e.target.value)}
                                                className="px-4 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-[#006666]"
                                            >
                                                <option value="all">Todas las etapas</option>
                                                {uniqueStages.map(stage => (
                                                    <option key={stage} value={stage}>{stage}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Informaci√≥n de resultados */}
                            <div className="mb-4 text-sm text-gray-600">
                                Mostrando {filteredAndSortedClients.length} de {clients.length} clientes
                                {(searchTerm || filterTag !== 'all') && (
                                    <span className="ml-2 text-[#006666] font-medium">
                                        (filtrado{searchTerm ? ` por "${searchTerm}"` : ''}
                                        {filterTag !== 'all' ? ` - etapa ${filterTag}` : ''})
                                    </span>
                                )}
                            </div>

                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead className="bg-gray-100">
                                        <tr>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('name')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Nombre
                                                    {renderSortIcon('name')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('company')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Empresa
                                                    {renderSortIcon('company')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('email')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Email
                                                    {renderSortIcon('email')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('phone')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Tel√©fono
                                                    {renderSortIcon('phone')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('funnelStage')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Etapa
                                                    {renderSortIcon('funnelStage')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('priority')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Prioridad
                                                    {renderSortIcon('priority')}
                                                </div>
                                            </th>
                                            <th className="p-3">
                                                Acciones
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredAndSortedClients.length > 0 ? filteredAndSortedClients.map(client => (
                                            <tr key={client.id} className="border-b hover:bg-gray-50">
                                                <td className="p-3 cursor-pointer text-[#006666] hover:text-[#004444] font-medium" onClick={() => onViewClient(client)}>
                                                    {client.name}
                                                </td>
                                                <td className="p-3">{client.company || '-'}</td>
                                                <td className="p-3">{client.email || '-'}</td>
                                                <td className="p-3">{client.phone || '-'}</td>
                                                <td className="p-3">
                                                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ${
                                                        FUNNEL_TAGS[client.funnelStage] || 'bg-gray-100 text-gray-800'
                                                    }`}>
                                                        {client.funnelStage || 'Sin etapa'}
                                                    </span>
                                                </td>
                                                <td className="p-3">
                                                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ${
                                                        client.priority === 'Alta' ? 'bg-red-100 text-red-800' :
                                                        client.priority === 'Media' ? 'bg-yellow-100 text-yellow-800' :
                                                        client.priority === 'Baja' ? 'bg-green-100 text-green-800' :
                                                        'bg-gray-100 text-gray-800'
                                                    }`}>
                                                        {client.priority || 'Normal'}
                                                    </span>
                                                </td>
                                                <td className="p-3">
                                                    <div className="flex items-center gap-2">
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                onEditClient(client);
                                                            }}
                                                            className="p-1 text-blue-600 hover:bg-blue-50 rounded"
                                                            title="Editar cliente"
                                                        >
                                                            <EditIcon width={16} height={16} />
                                                        </button>
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                onDeleteClient(client);
                                                            }}
                                                            className="p-1 text-red-600 hover:bg-red-50 rounded"
                                                            title="Eliminar cliente"
                                                        >
                                                            <TrashIcon width={16} height={16} />
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        )) : (
                                            <tr>
                                                <td colSpan="7" className="text-center py-8 text-gray-500">
                                                    {searchTerm || filterTag !== 'all' ? (
                                                        <>
                                                            No se encontraron clientes que coincidan con los filtros aplicados.
                                                            <button 
                                                                onClick={() => {
                                                                    setSearchTerm('');
                                                                    setFilterTag('all');
                                                                }}
                                                                className="text-[#006666] ml-2 underline"
                                                            >
                                                                Limpiar filtros
                                                            </button>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <UserIcon width={48} height={48} className="mx-auto mb-4 opacity-50" />
                                                            <p>No hay clientes registrados</p>
                                                            <button onClick={onAddClient} className="mt-4 text-[#006666] hover:underline">
                                                                Crear primer cliente
                                                            </button>
                                                        </>
                                                    )}
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            }
            
            // Componentes de formulario helper
            function FormField({ label, as = "input", ...props }) {
                const Component = as === "textarea" ? "textarea" : "input";
                return (
                    <div>
                        {label && <label htmlFor={props.name} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
                        <Component id={props.name} {...props} className="block w-full rounded-md border-2 border-gray-400 shadow-sm focus:border-[#006666] focus:ring-[#006666] hover:border-gray-500 sm:text-sm p-3 transition-colors" />
                    </div>
                );
            }

            function FormSelect({ label, options, ...props }) {
                return (
                    <div>
                        <label htmlFor={props.name} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                        <select id={props.name} {...props} className="mt-1 block w-full rounded-md border-2 border-gray-400 shadow-sm focus:border-[#006666] focus:ring-[#006666] hover:border-gray-500 sm:text-sm p-3 transition-colors">
                            {options.map(opt => <option key={opt.value || opt} value={opt.value || opt}>{opt.label || opt}</option>)}
                        </select>
                    </div>
                );
            }
            
            // === COMPONENTE STATCARD PARA M√âTRICAS ===
            function StatCard({ title, value, icon, className = "bg-white" }) {
                return (
                    <div className={`p-6 rounded-lg shadow ${className}`}>
                        <div className="flex items-center justify-between">
                            <div>
                                <h3 className="text-sm font-medium text-gray-600">{title}</h3>
                                <p className="text-2xl font-bold mt-1">{value}</p>
                            </div>
                            <div className="text-gray-600">
                                {icon}
                            </div>
                        </div>
                    </div>
                );
            }
            
            // Formulario de Cliente
            function ClientForm({ client = {}, onSave, onCancel, showNotification, getConfigValue, db }) {
                const [formData, setFormData] = useState({
                    id: client.id || null, 
                    name: client.name || '', 
                    company: client.company || '',
                    email: client.email || '', 
                    phone: client.phone || '', 
                    address: client.address || '',
                    funnelStage: client.funnelStage || 'Lead',
                    contactPreference: client.contactPreference || 'Email',
                    productInterest: client.productInterest || [],
                    supplierInterest: client.supplierInterest || [],
                    notes: client.notes || '',
                    consentGiven: client.consentGiven || false,
                    acceptsMarketing: client.acceptsMarketing || false,
                    lastContact: client.lastContact || new Date().toISOString().split('T')[0],
                    // Nuevos campos
                    nif: client.nif || '',
                    cifNifType: client.cifNifType || 'NIF',
                    cifNifNumber: client.cifNifNumber || '',
                    website: client.website || '',
                    sector: client.sector || '',
                    employeeCount: client.employeeCount || '',
                    source: client.source || 'Directo',
                    contactedBy: client.contactedBy || ''
                });

                // Estados para cargar datos din√°micos
                const [commercialUsers, setCommercialUsers] = useState([]);
                const [isLoadingUsers, setIsLoadingUsers] = useState(false);

                // Obtener configuraci√≥n din√°micamente para ventas
                const funnelStages = getConfigValue ? getConfigValue('sales', 'funnelStages', [
                    'Lead', 'Primer Contacto', 'Interesado', 'Demo Realizada', 'Negociaci√≥n', 'En Cierre', 'Ganado', 'Perdido'
                ]) : ['Lead', 'Primer Contacto', 'Interesado', 'Demo Realizada', 'Negociaci√≥n', 'En Cierre', 'Ganado', 'Perdido'];
                
                const contactPreferences = getConfigValue ? getConfigValue('sales', 'contactPreferences', [
                    'Email', 'Tel√©fono', 'WhatsApp', 'Visita Comercial'
                ]) : ['Email', 'Tel√©fono', 'WhatsApp', 'Visita Comercial'];
                
                const productCategories = getConfigValue ? getConfigValue('products', 'categories', [
                    'Diagn√≥stico por Imagen', 'Cardiolog√≠a', 'Laboratorio', 'Quir√≥fano', 'UCI', 'Emergencias', 'Rehabilitaci√≥n', 'Servicios'
                ]) : ['Diagn√≥stico por Imagen', 'Cardiolog√≠a', 'Laboratorio', 'Quir√≥fano', 'UCI', 'Emergencias', 'Rehabilitaci√≥n', 'Servicios'];
                
                const suppliers = getConfigValue ? getConfigValue('products', 'suppliers', [
                    'Storz Medical', 'Zamar Medical', 'Phillips Healthcare', 'GE Healthcare', 'Siemens Healthineers'
                ]) : ['Storz Medical', 'Zamar Medical', 'Phillips Healthcare', 'GE Healthcare', 'Siemens Healthineers'];



                // Cargar usuarios comerciales al montar el componente
                useEffect(() => {
                    const loadCommercialUsers = async () => {
                        setIsLoadingUsers(true);
                        try {
                            // Obtener usuarios con rol comercial desde Firebase
                            if (db) {
                                // Obtener las funciones de Firebase del objeto global
                                const { collection, query, where, getDocs } = window.firebase;
                                if (!collection || !query || !where || !getDocs) {
                                    throw new Error('Funciones de Firestore no disponibles');
                                }
                                
                                const usersRef = collection(db, 'users');
                                const q = query(usersRef, where('role', 'in', ['comercial', 'admin']));
                                const querySnapshot = await getDocs(q);
                                
                                const users = [];
                                querySnapshot.forEach((doc) => {
                                    const userData = doc.data();
                                    if (userData.active !== false) { // Solo usuarios activos
                                        users.push({
                                            id: doc.id,
                                            name: userData.name || userData.displayName || userData.email,
                                            email: userData.email,
                                            role: userData.role
                                        });
                                    }
                                });
                                
                                setCommercialUsers(users);
                            }
                        } catch (error) {
                            console.error('Error cargando usuarios comerciales:', error);
                            // Fallback con usuario actual si est√° disponible
                            if (window.currentUser) {
                                setCommercialUsers([{
                                    id: window.currentUser.uid,
                                    name: window.currentUser.displayName || window.currentUser.email,
                                    email: window.currentUser.email,
                                    role: 'comercial'
                                }]);
                            }
                        }
                        setIsLoadingUsers(false);
                    };

                    loadCommercialUsers();
                }, [db]);

                const handleChange = (e) => {
                    const { name, value, type, checked } = e.target;
                    setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
                };

                // Manejar selecci√≥n m√∫ltiple de categor√≠as de productos
                const handleProductCategoryChange = (category) => {
                    setFormData(prev => ({
                        ...prev,
                        productInterest: prev.productInterest.includes(category)
                            ? prev.productInterest.filter(item => item !== category)
                            : [...prev.productInterest, category]
                    }));
                };

                // Manejar selecci√≥n m√∫ltiple de proveedores
                const handleSupplierChange = (supplier) => {
                    setFormData(prev => ({
                        ...prev,
                        supplierInterest: prev.supplierInterest.includes(supplier)
                            ? prev.supplierInterest.filter(item => item !== supplier)
                            : [...prev.supplierInterest, supplier]
                    }));
                };

                // Funci√≥n legacy para compatibilidad
                const handleBrandChange = (e) => {
                    const { value, checked } = e.target;
                    if (checked) {
                        handleProductCategoryChange(value);
                    } else {
                        handleProductCategoryChange(value);
                    }
                };

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (!formData.consentGiven) {
                        showNotification('Consentimiento requerido', 'Debe obtener el consentimiento del cliente para guardar sus datos seg√∫n el RGPD.', 'error');
                        return;
                    }
                    onSave(formData);
                };

                return (
                    <div className="max-w-4xl mx-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-3xl font-bold text-gray-900">
                                {client.id ? 'Editar Cliente' : 'Nuevo Cliente'}
                            </h1>
                            <button onClick={onCancel} className="text-gray-500 hover:text-gray-700">
                                <XIcon width={24} height={24} />
                            </button>
                        </div>

                        <form onSubmit={handleSubmit} className="bg-white p-8 rounded-lg shadow-lg space-y-6">
                            <fieldset className="grid grid-cols-1 md:grid-cols-2 gap-6 border p-4 rounded-md">
                                <legend className="text-lg font-semibold px-2">Informaci√≥n de Contacto</legend>
                                <FormField label="Nombre del Contacto" name="name" value={formData.name} onChange={handleChange} required />
                                <FormField label="Empresa/Cl√≠nica" name="company" value={formData.company} onChange={handleChange} required />
                                <FormField label="Email" name="email" type="email" value={formData.email} onChange={handleChange} required />
                                <FormField label="Tel√©fono" name="phone" value={formData.phone} onChange={handleChange} />
                                
                                {/* Campo CIF/NIF */}
                                <div className="md:col-span-2">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Tipo de Identificaci√≥n
                                            </label>
                                            <select
                                                name="cifNifType"
                                                value={formData.cifNifType}
                                                onChange={handleChange}
                                                className="block w-full rounded-md border-gray-300 shadow-sm focus:border-[#006666] focus:ring-[#006666] sm:text-sm p-3"
                                            >
                                                <option value="NIF">NIF</option>
                                                <option value="CIF">CIF</option>
                                            </select>
                                        </div>
                                        <div>
                                            <FormField 
                                                label={`N√∫mero de ${formData.cifNifType}`} 
                                                name="cifNifNumber" 
                                                value={formData.cifNifNumber} 
                                                onChange={handleChange}
                                                placeholder={`Introduce el ${formData.cifNifType}`}
                                            />
                                        </div>
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset className="border p-4 rounded-md">
                                <legend className="text-lg font-semibold px-2">Direcci√≥n</legend>
                                <div className="mt-4">
                                    <FormField label="Direcci√≥n Completa" name="address" value={formData.address} onChange={handleChange} />
                                </div>
                            </fieldset>

                            <fieldset className="grid grid-cols-1 md:grid-cols-2 gap-6 border p-4 rounded-md">
                                <legend className="text-lg font-semibold px-2">Datos Comerciales</legend>
                                <FormSelect 
                                    label="Fase del Embudo" 
                                    name="funnelStage" 
                                    value={formData.funnelStage} 
                                    onChange={handleChange} 
                                    options={funnelStages} 
                                />
                                <FormSelect 
                                    label="Contacto Preferente" 
                                    name="contactPreference" 
                                    value={formData.contactPreference} 
                                    onChange={handleChange} 
                                    options={contactPreferences} 
                                />
                                <FormField 
                                    label="√öltimo Contacto" 
                                    name="lastContact" 
                                    type="date" 
                                    value={formData.lastContact} 
                                    onChange={handleChange} 
                                />
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Contactado por
                                    </label>
                                    {isLoadingUsers ? (
                                        <div className="flex items-center text-gray-500">
                                            <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-[#006666] mr-2"></div>
                                            Cargando usuarios...
                                        </div>
                                    ) : (
                                        <select
                                            name="contactedBy"
                                            value={formData.contactedBy}
                                            onChange={handleChange}
                                            className="block w-full rounded-md border-gray-300 shadow-sm focus:border-[#006666] focus:ring-[#006666] sm:text-sm p-3"
                                        >
                                            <option value="">Seleccionar comercial...</option>
                                            {commercialUsers.map(user => (
                                                <option key={user.id} value={user.id}>
                                                    {user.name}
                                                </option>
                                            ))}
                                        </select>
                                    )}
                                    <div className="mt-1 text-xs text-gray-500">
                                        Solo se muestran usuarios con rol comercial o admin
                                    </div>
                                </div>
                                <div className="md:col-span-2">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-4">Intereses del Cliente</h3>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        {/* Categor√≠as de Productos */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Categor√≠as de Productos de Inter√©s
                                            </label>
                                            <div className="border border-gray-200 rounded-lg p-3 max-h-40 overflow-y-auto">
                                                {productCategories.map(category => (
                                                    <label key={category} className="flex items-center gap-2 mb-2 last:mb-0">
                                                        <input 
                                                            type="checkbox" 
                                                            checked={formData.productInterest.includes(category)} 
                                                            onChange={() => handleProductCategoryChange(category)}
                                                            className="h-4 w-4 rounded border-gray-300 text-[#006666] focus:ring-[#006666]" 
                                                        />
                                                        <span className="text-sm">{category}</span>
                                                    </label>
                                                ))}
                                            </div>
                                            <div className="mt-1 text-xs text-gray-500">
                                                {formData.productInterest.length} categor√≠a(s) seleccionada(s)
                                            </div>
                                        </div>

                                        {/* Proveedores */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Proveedores de Inter√©s
                                            </label>
                                            <div className="border border-gray-200 rounded-lg p-3 max-h-40 overflow-y-auto">
                                                {suppliers.map(supplier => (
                                                    <label key={supplier} className="flex items-center gap-2 mb-2 last:mb-0">
                                                        <input 
                                                            type="checkbox" 
                                                            checked={formData.supplierInterest.includes(supplier)} 
                                                            onChange={() => handleSupplierChange(supplier)}
                                                            className="h-4 w-4 rounded border-gray-300 text-[#006666] focus:ring-[#006666]" 
                                                        />
                                                        <span className="text-sm">{supplier}</span>
                                                    </label>
                                                ))}
                                            </div>
                                            <div className="mt-1 text-xs text-gray-500">
                                                {formData.supplierInterest.length} proveedor(es) seleccionado(s)
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="mt-2 text-xs text-gray-500">
                                        üí° Las opciones se configuran en Panel Admin ‚Üí Configuraci√≥n ‚Üí Productos
                                    </div>
                                </div>
                            </fieldset>

                            <div>
                                <label htmlFor="notes" className="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                                <textarea 
                                    id="notes" 
                                    name="notes" 
                                    rows="4" 
                                    value={formData.notes} 
                                    onChange={handleChange} 
                                    className="block w-full rounded-md border-gray-300 shadow-sm focus:border-[#006666] focus:ring-[#006666] sm:text-sm p-3" 
                                    placeholder="A√±adir notas sobre el cliente..."
                                />
                            </div>

                            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 space-y-3">
                                <div className="flex items-start">
                                    <input 
                                        id="consentGiven" 
                                        name="consentGiven" 
                                        type="checkbox" 
                                        checked={formData.consentGiven} 
                                        onChange={handleChange} 
                                        className="h-4 w-4 mt-1 rounded border-gray-300 text-[#006666] focus:ring-[#006666]" 
                                    />
                                    <label htmlFor="consentGiven" className="ml-3 text-sm text-yellow-800">
                                        <strong>Confirmo que el cliente ha dado su consentimiento</strong> para el tratamiento de sus datos para la gesti√≥n del servicio (RGPD).
                                    </label>
                                </div>
                                <div className="flex items-start">
                                    <input 
                                        id="acceptsMarketing" 
                                        name="acceptsMarketing" 
                                        type="checkbox" 
                                        checked={formData.acceptsMarketing} 
                                        onChange={handleChange} 
                                        className="h-4 w-4 mt-1 rounded border-gray-300 text-[#006666] focus:ring-[#006666]" 
                                    />
                                    <label htmlFor="acceptsMarketing" className="ml-3 text-sm text-yellow-800">
                                        Confirmo que el cliente ha dado su consentimiento expl√≠cito para recibir comunicaciones comerciales.
                                    </label>
                                </div>
                            </div>

                            <div className="flex justify-end gap-4 pt-6">
                                <button 
                                    type="button" 
                                    onClick={onCancel} 
                                    className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                >
                                    Cancelar
                                </button>
                                <button 
                                    type="submit" 
                                    className="px-6 py-3 bg-[#006666] text-white rounded-lg hover:bg-[#005555]"
                                >
                                    {client.id ? 'Actualizar' : 'Crear'} Cliente
                                </button>
                            </div>
                        </form>
                    </div>
                );
            }
            
            // Detalle de Cliente
            function ClientDetail({ client, db, user, onEdit, onDelete, onBack, onCreateInvoice, onGenerateConsent }) {
                if (!client) return <div>Cliente no encontrado</div>;

                // Estado para recordatorios
                const [reminders, setReminders] = useState([]);
                const [newReminder, setNewReminder] = useState({ text: '', dueDate: '' });
                
                // Estados para resolver nombres de usuarios
                const [allUsers, setAllUsers] = useState([]);
                const [isLoadingUsers, setIsLoadingUsers] = useState(false);
                
                // Funci√≥n para obtener el nombre de un usuario por su ID
                const getUserName = (userId) => {
                    if (!userId) return 'No asignado';
                    const foundUser = allUsers.find(u => u.id === userId);
                    return foundUser ? foundUser.name : userId; // Fallback al ID si no se encuentra
                };

                // Cargar recordatorios del cliente
                useEffect(() => {
                    if (!db || !user || !client.id) return;
                    
                    const remindersPath = `clientes/${client.id}/recordatorios`;
                    const q = query(collection(db, remindersPath));
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const remindersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setReminders(remindersData);
                    }, (error) => {
                        console.error("Error loading reminders:", error);
                        // En modo demo, usar recordatorios vac√≠os
                        setReminders([]);
                    });
                    return () => unsubscribe();
                }, [db, user, client.id]);

                // Cargar usuarios para resolver nombres
                useEffect(() => {
                    const loadAllUsers = async () => {
                        setIsLoadingUsers(true);
                        try {
                            if (window.firebaseDb) {
                                const { collection, getDocs } = window.firebase;
                                const usersRef = collection(window.firebaseDb, 'users');
                                const querySnapshot = await getDocs(usersRef);
                                
                                const users = [];
                                querySnapshot.forEach((doc) => {
                                    const userData = doc.data();
                                    users.push({
                                        id: doc.id,
                                        name: userData.name || userData.displayName || userData.email,
                                        email: userData.email,
                                        role: userData.role
                                    });
                                });
                                
                                setAllUsers(users);
                            }
                        } catch (error) {
                            console.error('Error cargando usuarios:', error);
                        } finally {
                            setIsLoadingUsers(false);
                        }
                    };

                    loadAllUsers();
                }, []);

                // Agregar nuevo recordatorio
                const handleAddReminder = async (e) => {
                    e.preventDefault();
                    if (!newReminder.text || !newReminder.dueDate) return;
                    
                    if (!db || !user) {
                        // Modo demo - simular agregado
                        const demoReminder = {
                            id: Date.now().toString(),
                            text: newReminder.text,
                            dueDate: newReminder.dueDate,
                            createdAt: new Date().toISOString(),
                            createdBy: user.uid
                        };
                        setReminders(prev => [...prev, demoReminder]);
                        setNewReminder({ text: '', dueDate: '' });
                        return;
                    }

                    try {
                        const remindersPath = `clientes/${client.id}/recordatorios`;
                        const reminderData = {
                            text: newReminder.text,
                            dueDate: newReminder.dueDate,
                            createdAt: new Date().toISOString(),
                            createdBy: user.uid
                        };
                        await addDoc(collection(db, remindersPath), reminderData);
                        setNewReminder({ text: '', dueDate: '' });
                    } catch (error) {
                        console.error("Error adding reminder:", error);
                        showNotification('Error', 'Error al agregar recordatorio', 'danger');
                    }
                };

                // Eliminar recordatorio
                const handleDeleteReminder = async (reminderId) => {
                    if (!db || !user) {
                        // Modo demo - simular eliminaci√≥n
                        setReminders(prev => prev.filter(r => r.id !== reminderId));
                        return;
                    }

                    try {
                        const reminderPath = `clientes/${client.id}/recordatorios/${reminderId}`;
                        await deleteDoc(doc(db, reminderPath));
                    } catch (error) {
                        console.error("Error deleting reminder:", error);
                        alert('Error al eliminar recordatorio');
                    }
                };

                return (
                    <div className="max-w-4xl mx-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-3xl font-bold text-gray-900">{client.name}</h1>
                            <button onClick={onBack} className="text-gray-500 hover:text-gray-700">
                                <XIcon width={24} height={24} />
                            </button>
                        </div>

                        <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                            <div className="p-6">
                                <div className="flex justify-between items-start mb-6">
                                    <div>
                                        <h2 className="text-2xl font-semibold text-gray-800">{client.company}</h2>
                                        <span className={`inline-block px-3 py-1 rounded-full text-sm font-medium mt-2 ${FUNNEL_TAGS[client.funnelStage] || 'bg-gray-200 text-gray-800'}`}>
                                            {client.funnelStage}
                                        </span>
                                    </div>
                                    <div className="flex gap-2">
                                        <button 
                                            onClick={() => onEdit(client)}
                                            className="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200"
                                            title="Editar cliente"
                                        >
                                            <EditIcon />
                                        </button>
                                        <button 
                                            onClick={() => onDelete(client.id)}
                                            className="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200"
                                            title="Eliminar cliente"
                                        >
                                            <TrashIcon />
                                        </button>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-800 mb-4">Informaci√≥n de Contacto</h3>
                                        <div className="space-y-3">
                                            <div className="flex items-center gap-3">
                                                <MailIcon />
                                                <div>
                                                    <span className="text-sm text-gray-500">Email</span>
                                                    <p className="font-medium">{client.email}</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <PhoneIcon />
                                                <div>
                                                    <span className="text-sm text-gray-500">Tel√©fono</span>
                                                    <p className="font-medium">{client.phone}</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <MapPinIcon />
                                                <div>
                                                    <span className="text-sm text-gray-500">Direcci√≥n</span>
                                                    <p className="font-medium">{formatAddress(client.address)}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-800 mb-4">Datos Comerciales</h3>
                                        <div className="space-y-3">
                                            <div>
                                                <span className="text-sm text-gray-500">√öltimo Contacto</span>
                                                <p className="font-medium">{client.lastContact ? new Date(client.lastContact).toLocaleDateString('es-ES') : 'No registrado'}</p>
                                            </div>
                                            <div>
                                                <span className="text-sm text-gray-500">Contacto Preferente</span>
                                                <p className="font-medium">{client.contactPreference || 'No especificado'}</p>
                                            </div>
                                            <div>
                                                <span className="text-sm text-gray-500">Categor√≠as de Inter√©s</span>
                                                <div className="flex flex-wrap gap-2 mt-1">
                                                    {client.productInterest?.length > 0 ? 
                                                        client.productInterest.map(interest => (
                                                            <span key={interest} className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                                                {interest}
                                                            </span>
                                                        )) :
                                                        <span className="text-gray-500 text-sm">No especificadas</span>
                                                    }
                                                </div>
                                            </div>
                                            <div>
                                                <span className="text-sm text-gray-500">Proveedores de Inter√©s</span>
                                                <div className="flex flex-wrap gap-2 mt-1">
                                                    {client.supplierInterest?.length > 0 ? 
                                                        client.supplierInterest.map(supplier => (
                                                            <span key={supplier} className="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                                                {supplier}
                                                            </span>
                                                        )) :
                                                        <span className="text-gray-500 text-sm">No especificados</span>
                                                    }
                                                </div>
                                            </div>
                                            {client.contactedBy && (
                                                <div>
                                                    <span className="text-sm text-gray-500">Contactado por</span>
                                                    <p className="font-medium text-[#006666]">{getUserName(client.contactedBy)}</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {client.notes && (
                                    <div className="mt-8 pt-6 border-t border-gray-200">
                                        <h3 className="text-lg font-semibold text-gray-800 mb-3">Notas</h3>
                                        <div className="bg-gray-50 p-4 rounded-lg">
                                            <p className="text-gray-700 whitespace-pre-wrap">{client.notes}</p>
                                        </div>
                                    </div>
                                )}

                                <div className="mt-8 pt-6 border-t border-gray-200">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-4">Consentimientos RGPD</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="bg-gray-50 p-4 rounded-lg">
                                            <div className="flex items-center gap-2">
                                                {client.consentGiven ? 
                                                    <CheckIcon width={16} height={16} className="text-green-600" /> : 
                                                    <XCircleIcon width={16} height={16} className="text-red-600" />
                                                }
                                                <span className="font-medium">Consentimiento de Datos</span>
                                            </div>
                                            <p className="text-sm text-gray-600 mt-1">
                                                {client.consentGiven ? 'Consentimiento otorgado' : 'Consentimiento pendiente'}
                                            </p>
                                        </div>
                                        <div className="bg-gray-50 p-4 rounded-lg">
                                            <div className="flex items-center gap-2">
                                                {client.acceptsMarketing ? 
                                                    <CheckIcon width={16} height={16} className="text-green-600" /> : 
                                                    <EmailIcon width={16} height={16} className="text-gray-600" />
                                                }
                                                <span className="font-medium">Marketing</span>
                                            </div>
                                            <p className="text-sm text-gray-600 mt-1">
                                                {client.acceptsMarketing ? 'Acepta comunicaciones' : 'No acepta marketing'}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                {/* Sistema de Recordatorios/Tareas */}
                                <div className="mt-8 pt-6 border-t border-gray-200">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                        <BellIcon />
                                        Tareas y Recordatorios
                                    </h3>
                                    
                                    {/* Lista de recordatorios existentes */}
                                    <div className="space-y-2 mb-4 max-h-60 overflow-y-auto">
                                        {reminders.length > 0 ? (
                                            reminders.map(reminder => (
                                                <div key={reminder.id} className="bg-gray-50 p-3 rounded-lg flex justify-between items-start">
                                                    <div className="flex-1">
                                                        <p className="text-gray-800 font-medium">{reminder.text}</p>
                                                        <div className="flex items-center gap-2 mt-1">
                                                            <span className="text-xs text-gray-500">
                                                                Vence: {new Date(reminder.dueDate).toLocaleDateString('es-ES')}
                                                            </span>
                                                            {new Date(reminder.dueDate) < new Date() && (
                                                                <span className="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full">
                                                                    Vencido
                                                                </span>
                                                            )}
                                                            {new Date(reminder.dueDate).toDateString() === new Date().toDateString() && (
                                                                <span className="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full">
                                                                    Hoy
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <button 
                                                        onClick={() => handleDeleteReminder(reminder.id)}
                                                        className="text-red-500 hover:bg-red-100 p-1 rounded-full ml-2"
                                                        title="Eliminar recordatorio"
                                                    >
                                                        <TrashIcon />
                                                    </button>
                                                </div>
                                            ))
                                        ) : (
                                            <p className="text-sm text-gray-500 italic bg-gray-50 p-3 rounded-lg text-center">
                                                No hay recordatorios pendientes
                                            </p>
                                        )}
                                    </div>

                                    {/* Formulario para agregar nuevo recordatorio */}
                                    <form onSubmit={handleAddReminder} className="bg-blue-50 p-4 rounded-lg">
                                        <h4 className="font-medium text-gray-800 mb-3">Agregar Nueva Tarea</h4>
                                        <div className="flex gap-2">
                                            <input 
                                                type="text" 
                                                value={newReminder.text} 
                                                onChange={e => setNewReminder({...newReminder, text: e.target.value})} 
                                                placeholder="Descripci√≥n de la tarea..." 
                                                className="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#006666] focus:border-transparent" 
                                                required
                                            />
                                            <input 
                                                type="date" 
                                                value={newReminder.dueDate} 
                                                onChange={e => setNewReminder({...newReminder, dueDate: e.target.value})} 
                                                className="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#006666] focus:border-transparent" 
                                                required
                                            />
                                            <button 
                                                type="submit" 
                                                className="bg-[#006666] text-white px-4 py-2 rounded-md hover:bg-[#005555] flex items-center gap-2"
                                            >
                                                <PlusIcon width={16} height={16} />
                                                Agregar
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <div className="bg-gray-50 px-6 py-4">
                                <div className="flex justify-between items-center">
                                    <button 
                                        onClick={onBack}
                                        className="px-4 py-2 text-gray-600 hover:text-gray-800"
                                    >
                                        ‚Üê Volver al Dashboard
                                    </button>
                                    
                                    <div className="flex gap-3">
                                        <button 
                                            onClick={() => onGenerateConsent(client)}
                                            className="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 flex items-center gap-2"
                                        >
                                            <FileTextIcon /> Generar Consentimiento
                                        </button>
                                        <button 
                                            onClick={() => onCreateInvoice(client)}
                                            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2"
                                        >
                                            <DollarSignIcon /> Crear Factura
                                        </button>
                                        <button 
                                            onClick={() => onEdit(client)}
                                            className="px-4 py-2 bg-[#006666] text-white rounded-lg hover:bg-[#005555] flex items-center gap-2"
                                        >
                                            <EditIcon /> Editar Cliente
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            
            // Formulario de Consentimiento RGPD
            function ConsentForm({ client, onBack }) {
                const consentText = `CONSENTIMIENTO PARA EL TRATAMIENTO DE DATOS PERSONALES

Yo, ${client.name || '[Nombre del Cliente]'}, con DNI/CIF [DNI/CIF del Cliente], en mi propio nombre y representaci√≥n, o en representaci√≥n de la entidad ${client.company || '[Nombre de la Empresa/Cl√≠nica]'}, por la presente otorgo mi consentimiento expl√≠cito a EXPERTIA MEDICAL SOLUTIONS SL para el tratamiento de mis datos personales.

FINALIDADES:
[X] Gesti√≥n de la relaci√≥n comercial y contractual (necesario para el servicio).
[ ] Env√≠o de comunicaciones comerciales sobre productos, servicios y novedades de EXPERTIA MEDICAL SOLUTIONS SL.

DERECHOS:
Puede ejercer sus derechos de acceso, rectificaci√≥n, supresi√≥n, limitaci√≥n del tratamiento, portabilidad y oposici√≥n dirigi√©ndose a info@expertia.com o a la direcci√≥n postal de EXPERTIA MEDICAL SOLUTIONS SL.

M√°s informaci√≥n en nuestra pol√≠tica de privacidad: www.expertia.com/privacidad

En ${new Date().toLocaleDateString('es-ES', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
})}.

Fdo.: ${client.name || '[Firma del Cliente]'}`;

                const [text, setText] = useState(consentText);

                const handleSendEmail = () => {
                    const subject = 'Consentimiento Informado - Expertia Medical Solutions';
                    const body = encodeURIComponent(text);
                    window.open(`mailto:${client.email}?subject=${subject}&body=${body}`, '_blank');
                };

                const handleCopyToClipboard = () => {
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(text)
                            .then(() => alert('Texto copiado al portapapeles.'))
                            .catch(err => console.error('Error al copiar', err));
                    } else {
                        // Fallback para navegadores m√°s antiguos
                        const textArea = document.createElement("textarea");
                        textArea.value = text;
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            alert('Texto copiado al portapapeles.');
                        } catch (err) {
                            console.error('Fallback: No se pudo copiar', err);
                        }
                        document.body.removeChild(textArea);
                    }
                };

                const handleDownload = () => {
                    const element = document.createElement("a");
                    const file = new Blob([text], { type: 'text/plain' });
                    element.href = URL.createObjectURL(file);
                    element.download = `consentimiento_${client.name?.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
                    document.body.appendChild(element);
                    element.click();
                    document.body.removeChild(element);
                };

                return (
                    <div className="max-w-4xl mx-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-3xl font-bold text-gray-900">Generar Consentimiento Informado</h1>
                            <button onClick={onBack} className="text-gray-500 hover:text-gray-700">
                                <XIcon width={24} height={24} />
                            </button>
                        </div>

                        <div className="bg-white rounded-lg shadow-lg p-8">
                            <div className="mb-6">
                                <h2 className="text-xl font-semibold text-gray-800 mb-4">
                                    Cliente: {client.name} - {client.company}
                                </h2>
                                <div className="bg-blue-50 border-l-4 border-blue-400 p-4">
                                    <div className="flex">
                                        <div className="flex-shrink-0">
                                            <CheckSquareIcon />
                                        </div>
                                        <div className="ml-3">
                                            <p className="text-sm text-blue-700">
                                                <strong>RGPD:</strong> Este formulario genera el consentimiento necesario seg√∫n el Reglamento General de Protecci√≥n de Datos.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Texto del Consentimiento (editable)
                                </label>
                                <textarea 
                                    value={text} 
                                    onChange={(e) => setText(e.target.value)} 
                                    rows="20" 
                                    className="w-full p-4 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm"
                                    style={{ fontFamily: 'monospace' }}
                                />
                            </div>

                            <div className="flex justify-between items-center">
                                <button 
                                    onClick={onBack} 
                                    className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                >
                                    ‚Üê Volver al Cliente
                                </button>
                                
                                <div className="flex gap-3">
                                    <button 
                                        onClick={handleCopyToClipboard} 
                                        className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"
                                    >
                                        <CopyIcon width={16} height={16} /> Copiar Texto
                                    </button>
                                    <button 
                                        onClick={handleDownload} 
                                        className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2"
                                    >
                                        <DownloadIcon width={16} height={16} /> Descargar
                                    </button>
                                    <button 
                                        onClick={handleSendEmail} 
                                        className="px-6 py-3 bg-[#006666] text-white rounded-lg hover:bg-[#005555] flex items-center gap-2"
                                    >
                                        <EmailIcon width={16} height={16} /> Enviar por Email
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            
            // === DASHBOARD DE OFERTAS MEJORADO ===
            function OffersDashboard({ offers, clients, products, onCreateOffer, onViewOffer, onEditOffer, onDeleteOffer, showConfirm }) {
                // Estados para filtros y ordenaci√≥n
                const [searchTerm, setSearchTerm] = useState('');
                const [selectedStatus, setSelectedStatus] = useState('all');
                const [sortField, setSortField] = useState('offerDate');
                const [sortDirection, setSortDirection] = useState('desc');
                
                // Estados para cargar usuarios comerciales
                const [commercialUsers, setCommercialUsers] = useState([]);

                // Funci√≥n para obtener el nombre del cliente
                const getClientName = (clientId) => clients.find(c => c.id === clientId)?.name || clientId || 'N/A';
                
                // Funci√≥n para obtener el nombre del comercial
                const getCommercialName = (assignedTo) => {
                    if (!assignedTo) return 'No asignado';
                    const commercial = commercialUsers.find(u => u.id === assignedTo);
                    return commercial ? commercial.name : assignedTo;
                };
                
                // Funci√≥n para formatear los productos de una oferta
                const getProductsSummary = (items) => {
                    if (!items || items.length === 0) return 'Sin productos';
                    
                    const productNames = items.map(item => {
                        if (item.productId) {
                            const product = products.find(p => p.id === item.productId);
                            return product ? `${product.name} (${item.quantity})` : `${item.description} (${item.quantity})`;
                        }
                        return `${item.description} (${item.quantity})`;
                    }).filter(name => name && name !== ' ()');
                    
                    if (productNames.length === 0) return 'Sin productos';
                    if (productNames.length === 1) return productNames[0];
                    if (productNames.length <= 3) return productNames.join(', ');
                    
                    return `${productNames.slice(0, 2).join(', ')} y ${productNames.length - 2} m√°s`;
                };

                // Cargar usuarios comerciales al montar el componente
                useEffect(() => {
                    const loadCommercialUsers = async () => {
                        try {
                            if (window.firebaseDb) {
                                const { collection, query, where, getDocs } = window.firebase;
                                const usersRef = collection(window.firebaseDb, 'users');
                                const q = query(usersRef, where('role', 'in', ['comercial', 'admin']));
                                const querySnapshot = await getDocs(q);
                                
                                const users = [];
                                querySnapshot.forEach((doc) => {
                                    const userData = doc.data();
                                    if (userData.active !== false) {
                                        users.push({
                                            id: doc.id,
                                            name: userData.name || userData.displayName || userData.email,
                                            email: userData.email,
                                            role: userData.role
                                        });
                                    }
                                });
                                
                                setCommercialUsers(users);
                            }
                        } catch (error) {
                            console.error('Error cargando usuarios comerciales:', error);
                        }
                    };

                    loadCommercialUsers();
                }, []);

                // Obtener estados √∫nicos para el filtro
                const uniqueStatuses = useMemo(() => {
                    const statuses = [...new Set(offers.map(offer => offer.status).filter(Boolean))];
                    return statuses.sort();
                }, [offers]);

                // Funci√≥n de ordenaci√≥n
                const handleSort = (field) => {
                    if (sortField === field) {
                        setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                    } else {
                        setSortField(field);
                        setSortDirection('asc');
                    }
                };

                // Funci√≥n para renderizar el icono de ordenaci√≥n
                const renderSortIcon = (field) => {
                    if (sortField !== field) {
                        return <ChevronUpIcon width={12} height={12} className="text-gray-400" />;
                    }
                    return sortDirection === 'asc' 
                        ? <ChevronUpIcon width={12} height={12} className="text-[#006666]" />
                        : <ChevronDownIcon width={12} height={12} className="text-[#006666]" />;
                };

                // Filtrar y ordenar ofertas
                const filteredAndSortedOffers = useMemo(() => {
                    let filtered = offers.filter(offer => {
                        // Filtro por b√∫squeda
                        const searchLower = searchTerm.toLowerCase();
                        const matchesSearch = !searchTerm || 
                            offer.offerNumber?.toLowerCase().includes(searchLower) ||
                            getClientName(offer.clientId).toLowerCase().includes(searchLower) ||
                            offer.status?.toLowerCase().includes(searchLower) ||
                            offer.offerSeries?.toLowerCase().includes(searchLower) ||
                            getCommercialName(offer.assignedTo).toLowerCase().includes(searchLower) ||
                            getProductsSummary(offer.items).toLowerCase().includes(searchLower);

                        // Filtro por estado
                        const matchesStatus = selectedStatus === 'all' || offer.status === selectedStatus;

                        return matchesSearch && matchesStatus;
                    });

                    // Ordenar
                    filtered.sort((a, b) => {
                        let aValue, bValue;
                        
                        switch (sortField) {
                            case 'offerNumber':
                                aValue = a.offerNumber || '';
                                bValue = b.offerNumber || '';
                                break;
                            case 'clientName':
                                aValue = getClientName(a.clientId);
                                bValue = getClientName(b.clientId);
                                break;
                            case 'offerDate':
                                aValue = new Date(a.offerDate || '1970-01-01');
                                bValue = new Date(b.offerDate || '1970-01-01');
                                break;
                            case 'validUntil':
                                aValue = new Date(a.validUntil || '1970-01-01');
                                bValue = new Date(b.validUntil || '1970-01-01');
                                break;
                            case 'total':
                                aValue = parseFloat(a.total) || 0;
                                bValue = parseFloat(b.total) || 0;
                                break;
                            case 'status':
                                aValue = a.status || '';
                                bValue = b.status || '';
                                break;
                            case 'assignedTo':
                                aValue = getCommercialName(a.assignedTo);
                                bValue = getCommercialName(b.assignedTo);
                                break;
                            case 'products':
                                aValue = getProductsSummary(a.items);
                                bValue = getProductsSummary(b.items);
                                break;
                            default:
                                return 0;
                        }

                        if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
                        if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });

                    return filtered;
                }, [offers, searchTerm, selectedStatus, sortField, sortDirection, clients]);

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h1 className="text-3xl font-bold text-gray-900">Dashboard de Ofertas</h1>
                            <button onClick={onCreateOffer} className="bg-[#006666] text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-[#005555]">
                                <PlusIcon width={20} height={20} />
                                Nueva Oferta
                            </button>
                        </div>
                        
                        <div className="bg-white p-6 rounded-lg shadow">
                            {/* T√≠tulo */}
                            <div className="mb-4">
                                <h3 className="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-4">
                                    <FileTextIcon width={20} height={20} /> Gesti√≥n de Ofertas
                                </h3>
                                
                                {/* Barra de herramientas */}
                                <div className="flex justify-between gap-6 mb-4">
                                    <div className="flex gap-4">
                                        <div className="flex items-center">
                                            <SearchIcon className="text-gray-400" width={16} height={16} />
                                        </div>
                                        <div>
                                            <input
                                                type="text"
                                                placeholder="Buscar ofertas..."
                                                value={searchTerm}
                                                onChange={(e) => setSearchTerm(e.target.value)}
                                                className="w-80 px-4 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-[#006666]"
                                            />
                                        </div>
                                        <div>
                                            <select
                                                value={selectedStatus}
                                                onChange={(e) => setSelectedStatus(e.target.value)}
                                                className="px-4 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-[#006666]"
                                            >
                                                <option value="all">Todos los estados</option>
                                                {uniqueStatuses.map(status => (
                                                    <option key={status} value={status}>{status}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Informaci√≥n de resultados */}
                            <div className="mb-4 text-sm text-gray-600">
                                Mostrando {filteredAndSortedOffers.length} de {offers.length} ofertas
                                {(searchTerm || selectedStatus !== 'all') && (
                                    <span className="ml-2 text-[#006666] font-medium">
                                        (filtrado{searchTerm ? ` por "${searchTerm}"` : ''}
                                        {selectedStatus !== 'all' ? ` - estado ${selectedStatus}` : ''})
                                    </span>
                                )}
                            </div>

                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead className="bg-gray-100">
                                        <tr>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('offerNumber')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    N¬∫ Oferta
                                                    {renderSortIcon('offerNumber')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('clientName')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Cliente
                                                    {renderSortIcon('clientName')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('offerDate')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Fecha
                                                    {renderSortIcon('offerDate')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('validUntil')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    V√°lida hasta
                                                    {renderSortIcon('validUntil')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('total')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Total
                                                    {renderSortIcon('total')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('status')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Estado
                                                    {renderSortIcon('status')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('products')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Productos
                                                    {renderSortIcon('products')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('assignedTo')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Comercial
                                                    {renderSortIcon('assignedTo')}
                                                </div>
                                            </th>
                                            <th className="p-3">
                                                Acciones
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredAndSortedOffers.length > 0 ? filteredAndSortedOffers.map(offer => (
                                            <tr key={offer.id} className="border-b hover:bg-gray-50">
                                                <td className="p-3 font-mono text-sm cursor-pointer text-[#006666] hover:text-[#004444] font-medium" onClick={() => onViewOffer(offer)}>
                                                    {offer.offerNumber}
                                                </td>
                                                <td className="p-3">{getClientName(offer.clientId)}</td>
                                                <td className="p-3">{offer.offerDate}</td>
                                                <td className="p-3">{offer.validUntil}</td>
                                                <td className="p-3 font-semibold">‚Ç¨{Number(offer.total || 0).toFixed(2)}</td>
                                                <td className="p-3">
                                                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ${
                                                        offer.status === 'Aceptada' ? 'bg-green-100 text-green-800' :
                                                        offer.status === 'Rechazada' ? 'bg-red-100 text-red-800' :
                                                        offer.status === 'Vencida' ? 'bg-gray-100 text-gray-800' :
                                                        offer.status === 'Enviada' ? 'bg-blue-100 text-blue-800' :
                                                        'bg-yellow-100 text-yellow-800'
                                                    }`}>
                                                        {offer.status || 'Borrador'}
                                                    </span>
                                                </td>
                                                <td className="p-3 text-sm max-w-48">
                                                    <div className="truncate" title={getProductsSummary(offer.items)}>
                                                        {getProductsSummary(offer.items)}
                                                    </div>
                                                </td>
                                                <td className="p-3 text-sm">
                                                    <span className={`${offer.assignedTo ? 'text-gray-700' : 'text-gray-400 italic'}`}>
                                                        {getCommercialName(offer.assignedTo)}
                                                    </span>
                                                </td>
                                                <td className="p-3">
                                                    <div className="flex items-center gap-2">
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                onEditOffer(offer);
                                                            }}
                                                            className="p-1 text-blue-600 hover:bg-blue-50 rounded"
                                                            title="Editar oferta"
                                                        >
                                                            <EditIcon width={16} height={16} />
                                                        </button>
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                showConfirm(
                                                                    'Eliminar Oferta',
                                                                    `¬øEst√°s seguro de que quieres eliminar la oferta #${offer.offerNumber}?`,
                                                                    () => onDeleteOffer(offer.id),
                                                                    'danger'
                                                                );
                                                            }}
                                                            className="p-1 text-red-600 hover:bg-red-50 rounded"
                                                            title="Eliminar oferta"
                                                        >
                                                            <TrashIcon width={16} height={16} />
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        )) : (
                                            <tr>
                                                <td colSpan="9" className="text-center py-8 text-gray-500">
                                                    {searchTerm || selectedStatus !== 'all' ? (
                                                        <>
                                                            No se encontraron ofertas que coincidan con los filtros aplicados.
                                                            <button 
                                                                onClick={() => {
                                                                    setSearchTerm('');
                                                                    setSelectedStatus('all');
                                                                }}
                                                                className="text-[#006666] ml-2 underline"
                                                            >
                                                                Limpiar filtros
                                                            </button>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <FileTextIcon width={48} height={48} className="mx-auto mb-4 opacity-50" />
                                                            <p>No hay ofertas registradas</p>
                                                            <button onClick={onCreateOffer} className="mt-4 text-[#006666] hover:underline">
                                                                Crear primera oferta
                                                            </button>
                                                        </>
                                                    )}
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            }
            
            // === DASHBOARD DE PRODUCTOS MEJORADO ===
            function ProductsDashboard({ products, onCreateProduct, onEditProduct, onDeleteProduct, showConfirm }) {
                // Estados para filtros y ordenaci√≥n
                const [searchTerm, setSearchTerm] = useState('');
                const [selectedCategory, setSelectedCategory] = useState('all');
                const [sortField, setSortField] = useState('name');
                const [sortDirection, setSortDirection] = useState('asc');

                // Obtener categor√≠as √∫nicas para el filtro
                const uniqueCategories = useMemo(() => {
                    const categories = [...new Set(products.map(product => product.category).filter(Boolean))];
                    return categories.sort();
                }, [products]);

                // Funci√≥n de ordenaci√≥n
                const handleSort = (field) => {
                    if (sortField === field) {
                        setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                    } else {
                        setSortField(field);
                        setSortDirection('asc');
                    }
                };

                // Funci√≥n para renderizar el icono de ordenaci√≥n
                const renderSortIcon = (field) => {
                    if (sortField !== field) {
                        return <ChevronUpIcon width={12} height={12} className="text-gray-400" />;
                    }
                    return sortDirection === 'asc' 
                        ? <ChevronUpIcon width={12} height={12} className="text-[#006666]" />
                        : <ChevronDownIcon width={12} height={12} className="text-[#006666]" />;
                };

                // Filtrar y ordenar productos
                const filteredAndSortedProducts = useMemo(() => {
                    let filtered = products.filter(product => {
                        // Filtro por b√∫squeda
                        const searchLower = searchTerm.toLowerCase();
                        const matchesSearch = !searchTerm || 
                            product.name?.toLowerCase().includes(searchLower) ||
                            product.description?.toLowerCase().includes(searchLower) ||
                            product.category?.toLowerCase().includes(searchLower) ||
                            product.supplier?.toLowerCase().includes(searchLower) ||
                            product.sku?.toLowerCase().includes(searchLower);

                        // Filtro por categor√≠a
                        const matchesCategory = selectedCategory === 'all' || product.category === selectedCategory;

                        return matchesSearch && matchesCategory;
                    });

                    // Ordenar
                    filtered.sort((a, b) => {
                        let aValue, bValue;
                        
                        switch (sortField) {
                            case 'name':
                                aValue = a.name || '';
                                bValue = b.name || '';
                                break;
                            case 'category':
                                aValue = a.category || '';
                                bValue = b.category || '';
                                break;
                            case 'price':
                                aValue = parseFloat(a.price) || 0;
                                bValue = parseFloat(b.price) || 0;
                                break;
                            case 'stock':
                                aValue = parseInt(a.stock) || 0;
                                bValue = parseInt(b.stock) || 0;
                                break;
                            case 'supplier':
                                aValue = a.supplier || '';
                                bValue = b.supplier || '';
                                break;
                            case 'active':
                                aValue = a.active ? 1 : 0;
                                bValue = b.active ? 1 : 0;
                                break;
                            default:
                                return 0;
                        }

                        if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
                        if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });

                    return filtered;
                }, [products, searchTerm, selectedCategory, sortField, sortDirection]);

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h1 className="text-3xl font-bold text-gray-900">Gesti√≥n de Productos</h1>
                            <button onClick={onCreateProduct} className="bg-[#006666] text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-[#005555]">
                                <PlusIcon width={20} height={20} />
                                Nuevo Producto
                            </button>
                        </div>
                        
                        <div className="bg-white p-6 rounded-lg shadow">
                            {/* T√≠tulo */}
                            <div className="mb-4">
                                <h3 className="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-4">
                                    <BriefcaseIcon width={20} height={20} /> Gesti√≥n de Productos
                                </h3>
                                
                                {/* Barra de herramientas */}
                                <div className="flex justify-between gap-6 mb-4">
                                    <div className="flex gap-4">
                                        <div className="flex items-center">
                                            <SearchIcon className="text-gray-400" width={16} height={16} />
                                        </div>
                                        <div>
                                            <input
                                                type="text"
                                                placeholder="Buscar productos..."
                                                value={searchTerm}
                                                onChange={(e) => setSearchTerm(e.target.value)}
                                                className="w-80 px-4 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-[#006666]"
                                            />
                                        </div>
                                        <div>
                                            <select
                                                value={selectedCategory}
                                                onChange={(e) => setSelectedCategory(e.target.value)}
                                                className="px-4 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-[#006666]"
                                            >
                                                <option value="all">Todas las categor√≠as</option>
                                                {uniqueCategories.map(category => (
                                                    <option key={category} value={category}>{category}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Informaci√≥n de resultados */}
                            <div className="mb-4 text-sm text-gray-600">
                                Mostrando {filteredAndSortedProducts.length} de {products.length} productos
                                {(searchTerm || selectedCategory !== 'all') && (
                                    <span className="ml-2 text-[#006666] font-medium">
                                        (filtrado{searchTerm ? ` por "${searchTerm}"` : ''}
                                        {selectedCategory !== 'all' ? ` - categor√≠a ${selectedCategory}` : ''})
                                    </span>
                                )}
                            </div>

                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead className="bg-gray-100">
                                        <tr>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('name')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Nombre
                                                    {renderSortIcon('name')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('category')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Categor√≠a
                                                    {renderSortIcon('category')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('price')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Precio
                                                    {renderSortIcon('price')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('stock')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Stock
                                                    {renderSortIcon('stock')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('supplier')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Proveedor
                                                    {renderSortIcon('supplier')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('active')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Estado
                                                    {renderSortIcon('active')}
                                                </div>
                                            </th>
                                            <th className="p-3">
                                                Acciones
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredAndSortedProducts.length > 0 ? filteredAndSortedProducts.map(product => (
                                            <tr key={product.id} className="border-b hover:bg-gray-50">
                                                <td className="p-3">
                                                    <div>
                                                        <div className="font-medium text-gray-900">{product.name}</div>
                                                        {product.description && (
                                                            <div className="text-sm text-gray-500 truncate max-w-xs">{product.description}</div>
                                                        )}
                                                        {product.sku && (
                                                            <div className="text-xs text-gray-400">SKU: {product.sku}</div>
                                                        )}
                                                    </div>
                                                </td>
                                                <td className="p-3">
                                                    <span className="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                                        {product.category || 'Sin categor√≠a'}
                                                    </span>
                                                </td>
                                                <td className="p-3 font-semibold text-[#006666]">
                                                    ‚Ç¨{Number(product.price || 0).toFixed(2)}
                                                </td>
                                                <td className="p-3">
                                                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ${
                                                        (product.stock || 0) <= (product.minStock || 0) 
                                                            ? 'bg-red-100 text-red-800' 
                                                            : 'bg-green-100 text-green-800'
                                                    }`}>
                                                        {product.stock || 0} unidades
                                                    </span>
                                                </td>
                                                <td className="p-3">{product.supplier || '-'}</td>
                                                <td className="p-3">
                                                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ${
                                                        product.active !== false ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                                    }`}>
                                                        {product.active !== false ? 'Activo' : 'Inactivo'}
                                                    </span>
                                                </td>
                                                <td className="p-3">
                                                    <div className="flex items-center gap-2">
                                                        <button
                                                            onClick={() => onEditProduct(product)}
                                                            className="p-1 text-blue-600 hover:bg-blue-50 rounded"
                                                            title="Editar producto"
                                                        >
                                                            <EditIcon width={16} height={16} />
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                showConfirm(
                                                                    'Eliminar Producto',
                                                                    `¬øEst√°s seguro de que quieres eliminar el producto "${product.name}"?`,
                                                                    () => onDeleteProduct(product.id),
                                                                    'danger'
                                                                );
                                                            }}
                                                            className="p-1 text-red-600 hover:bg-red-50 rounded"
                                                            title="Eliminar producto"
                                                        >
                                                            <TrashIcon width={16} height={16} />
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        )) : (
                                            <tr>
                                                <td colSpan="7" className="text-center py-8 text-gray-500">
                                                    {searchTerm || selectedCategory !== 'all' ? (
                                                        <>
                                                            No se encontraron productos que coincidan con los filtros aplicados.
                                                            <button 
                                                                onClick={() => {
                                                                    setSearchTerm('');
                                                                    setSelectedCategory('all');
                                                                }}
                                                                className="text-[#006666] ml-2 underline"
                                                            >
                                                                Limpiar filtros
                                                            </button>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <BriefcaseIcon width={48} height={48} className="mx-auto mb-4 opacity-50" />
                                                            <p>No hay productos registrados</p>
                                                            <button onClick={onCreateProduct} className="mt-4 text-[#006666] hover:underline">
                                                                Crear primer producto
                                                            </button>
                                                        </>
                                                    )}
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            }
            
            // === SISTEMA DE CONTABILIDAD COMPLETO ===
            
            // === SISTEMA DE GESTI√ìN DE GASTOS COMPLETO ===
            
            // Componente principal del dashboard de gastos
            function ExpensesDashboard({ expenses, onAddExpense, onViewExpense, onEditExpense, onDeleteExpense, searchTerm, setSearchTerm, filterStatus, setFilterStatus }) {
                const [sortField, setSortField] = useState('date');
                const [sortDirection, setSortDirection] = useState('desc');
                const [viewMode, setViewMode] = useState('list'); // 'list', 'kanban', 'calendar'

                // Obtener configuraciones din√°micas
                const expenseConfig = getExpenseConfig();
                const expenseStatuses = getExpenseStatuses();

                // Obtener estados √∫nicos para el filtro
                const uniqueStatuses = useMemo(() => {
                    const statuses = [...new Set(expenses.map(expense => expense.status).filter(Boolean))];
                    return statuses.sort();
                }, [expenses]);

                // Funci√≥n de ordenaci√≥n
                const sortedExpenses = useMemo(() => {
                    return [...expenses].sort((a, b) => {
                        let aValue = a[sortField];
                        let bValue = b[sortField];
                        
                        if (sortField === 'date') {
                            aValue = new Date(aValue);
                            bValue = new Date(bValue);
                        } else if (sortField === 'amount') {
                            aValue = parseFloat(aValue) || 0;
                            bValue = parseFloat(bValue) || 0;
                        } else {
                            aValue = String(aValue || '').toLowerCase();
                            bValue = String(bValue || '').toLowerCase();
                        }
                        
                        if (sortDirection === 'asc') {
                            return aValue > bValue ? 1 : -1;
                        } else {
                            return aValue < bValue ? 1 : -1;
                        }
                    });
                }, [expenses, sortField, sortDirection]);

                // Filtrar gastos
                const filteredExpenses = useMemo(() => {
                    return sortedExpenses.filter(expense => {
                        const matchesSearch = !searchTerm || 
                            expense.description?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            expense.supplier?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            expense.category?.toLowerCase().includes(searchTerm.toLowerCase());
                        
                        const matchesStatus = filterStatus === 'all' || expense.status === filterStatus;
                        
                        return matchesSearch && matchesStatus;
                    });
                }, [sortedExpenses, searchTerm, filterStatus]);

                // Calcular estad√≠sticas
                const stats = useMemo(() => {
                    const total = expenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
                    const pending = expenses.filter(exp => exp.status === 'Pendiente').reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
                    const approved = expenses.filter(exp => exp.status === 'Aprobado').reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
                    const paid = expenses.filter(exp => exp.status === 'Pagado').reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
                    
                    return { total, pending, approved, paid };
                }, [expenses]);

                return (
                    <div className="space-y-6">
                        {/* Header con estad√≠sticas */}
                        <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h1 className="text-3xl font-bold text-gray-900">Gesti√≥n de Gastos</h1>
                                <button
                                    onClick={onAddExpense}
                                    className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors"
                                >
                                    <PlusIcon width={16} height={16} />
                                    Nuevo Gasto
                                </button>
                            </div>
                            
                            {/* Estad√≠sticas */}
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <div className="text-sm text-blue-600 font-medium">Total Gastos</div>
                                    <div className="text-2xl font-bold text-blue-900">‚Ç¨{stats.total.toFixed(2)}</div>
                                </div>
                                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                    <div className="text-sm text-yellow-600 font-medium">Pendientes</div>
                                    <div className="text-2xl font-bold text-yellow-900">‚Ç¨{stats.pending.toFixed(2)}</div>
                                </div>
                                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                    <div className="text-sm text-green-600 font-medium">Aprobados</div>
                                    <div className="text-2xl font-bold text-green-900">‚Ç¨{stats.approved.toFixed(2)}</div>
                                </div>
                                <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                    <div className="text-sm text-purple-600 font-medium">Pagados</div>
                                    <div className="text-2xl font-bold text-purple-900">‚Ç¨{stats.paid.toFixed(2)}</div>
                                </div>
                            </div>

                            {/* Filtros y b√∫squeda */}
                            <div className="flex flex-col md:flex-row gap-4 mb-6">
                                <div className="flex-1">
                                    <input
                                        type="text"
                                        placeholder="Buscar gastos..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>
                                <div className="flex gap-2">
                                    <select
                                        value={filterStatus}
                                        onChange={(e) => setFilterStatus(e.target.value)}
                                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="all">Todos los estados</option>
                                        {uniqueStatuses.map(status => (
                                            <option key={status} value={status}>{status}</option>
                                        ))}
                                    </select>
                                    <select
                                        value={`${sortField}-${sortDirection}`}
                                        onChange={(e) => {
                                            const [field, direction] = e.target.value.split('-');
                                            setSortField(field);
                                            setSortDirection(direction);
                                        }}
                                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="date-desc">Fecha (m√°s reciente)</option>
                                        <option value="date-asc">Fecha (m√°s antigua)</option>
                                        <option value="amount-desc">Importe (mayor)</option>
                                        <option value="amount-asc">Importe (menor)</option>
                                        <option value="description-asc">Descripci√≥n A-Z</option>
                                        <option value="description-desc">Descripci√≥n Z-A</option>
                                    </select>
                                </div>
                            </div>

                            {/* Modo de vista */}
                            <div className="flex gap-2 mb-4">
                                <button
                                    onClick={() => setViewMode('list')}
                                    className={`px-3 py-1 rounded-lg text-sm font-medium ${viewMode === 'list' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'}`}
                                >
                                    Lista
                                </button>
                                <button
                                    onClick={() => setViewMode('kanban')}
                                    className={`px-3 py-1 rounded-lg text-sm font-medium ${viewMode === 'kanban' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'}`}
                                >
                                    Kanban
                                </button>
                                <button
                                    onClick={() => setViewMode('calendar')}
                                    className={`px-3 py-1 rounded-lg text-sm font-medium ${viewMode === 'calendar' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'}`}
                                >
                                    Calendario
                                </button>
                            </div>
                        </div>

                        {/* Lista de gastos */}
                        {viewMode === 'list' && (
                            <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                                <div className="overflow-x-auto">
                                    <table className="min-w-full divide-y divide-gray-200">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci√≥n</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categor√≠a</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proveedor</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Importe</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                                                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white divide-y divide-gray-200">
                                            {filteredExpenses.map(expense => (
                                                <tr key={expense.id} className="hover:bg-gray-50">
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                        {new Date(expense.date).toLocaleDateString('es-ES')}
                                                    </td>
                                                    <td className="px-6 py-4 text-sm text-gray-900">
                                                        <div className="max-w-xs truncate" title={expense.description}>
                                                            {expense.description}
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                        {expense.category}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                        {expense.supplier}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                        ‚Ç¨{parseFloat(expense.amount || 0).toFixed(2)}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap">
                                                        <span className={`px-2 py-1 text-xs font-semibold rounded-full ${expenseStatuses[expense.status] || 'bg-gray-200 text-gray-800'}`}>
                                                            {expense.status}
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                        {expense.userName}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                        <div className="flex justify-end gap-2">
                                                            <button
                                                                onClick={() => onViewExpense(expense)}
                                                                className="text-blue-600 hover:text-blue-900"
                                                            >
                                                                Ver
                                                            </button>
                                                            <button
                                                                onClick={() => onEditExpense(expense)}
                                                                className="text-green-600 hover:text-green-900"
                                                            >
                                                                Editar
                                                            </button>
                                                            <button
                                                                onClick={() => onDeleteExpense(expense)}
                                                                className="text-red-600 hover:text-red-900"
                                                            >
                                                                Eliminar
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                {filteredExpenses.length === 0 && (
                                    <div className="text-center py-12">
                                        <CreditCardIcon width={48} height={48} className="mx-auto text-gray-400 mb-4" />
                                        <h3 className="text-lg font-medium text-gray-900 mb-2">No hay gastos</h3>
                                        <p className="text-gray-500 mb-4">Comienza registrando tu primer gasto</p>
                                        <button
                                            onClick={onAddExpense}
                                            className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg"
                                        >
                                            Crear Primer Gasto
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Vista Kanban */}
                        {viewMode === 'kanban' && (
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                {expenseConfig.statuses.map(status => (
                                    <div key={status} className="bg-gray-50 rounded-lg p-4">
                                        <h3 className="font-semibold text-gray-900 mb-4">{status}</h3>
                                        <div className="space-y-3">
                                            {filteredExpenses.filter(exp => exp.status === status).map(expense => (
                                                <div key={expense.id} className="bg-white rounded-lg p-3 shadow-sm border border-gray-200">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="text-sm font-medium text-gray-900 truncate">
                                                            {expense.description}
                                                        </div>
                                                        <div className="text-sm font-bold text-gray-900">
                                                            ‚Ç¨{parseFloat(expense.amount || 0).toFixed(2)}
                                                        </div>
                                                    </div>
                                                    <div className="text-xs text-gray-500 mb-2">
                                                        {expense.category} ‚Ä¢ {expense.supplier}
                                                    </div>
                                                    <div className="text-xs text-gray-500 mb-3">
                                                        {new Date(expense.date).toLocaleDateString('es-ES')}
                                                    </div>
                                                    <div className="flex gap-1">
                                                        <button
                                                            onClick={() => onViewExpense(expense)}
                                                            className="text-xs text-blue-600 hover:text-blue-900"
                                                        >
                                                            Ver
                                                        </button>
                                                        <button
                                                            onClick={() => onEditExpense(expense)}
                                                            className="text-xs text-green-600 hover:text-green-900"
                                                        >
                                                            Editar
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Vista Calendario */}
                        {viewMode === 'calendar' && (
                            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                <div className="text-center text-gray-500">
                                    Vista de calendario en desarrollo...
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            // Componente de formulario de gastos
            function ExpenseForm({ expense, onSave, onCancel, clients, userProfile }) {
                const [formData, setFormData] = useState({
                    date: expense?.date || new Date().toISOString().split('T')[0],
                    description: expense?.description || '',
                    amount: expense?.amount || '',
                    category: expense?.category || '',
                    subcategory: expense?.subcategory || '',
                    paymentType: expense?.paymentType || '',
                    supplier: expense?.supplier || '',
                    clientId: expense?.clientId || '',
                    notes: expense?.notes || '',
                    status: expense?.status || 'Pendiente',
                    tags: expense?.tags || []
                });

                const [errors, setErrors] = useState({});
                const [isSubmitting, setIsSubmitting] = useState(false);

                // Obtener configuraciones din√°micas
                const expenseConfig = getExpenseConfig();

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    
                    // Validaci√≥n
                    const newErrors = {};
                    if (!formData.description.trim()) newErrors.description = 'La descripci√≥n es obligatoria';
                    if (!formData.amount || parseFloat(formData.amount) <= 0) newErrors.amount = 'El importe debe ser mayor a 0';
                    if (!formData.category) newErrors.category = 'La categor√≠a es obligatoria';
                    if (!formData.supplier.trim()) newErrors.supplier = 'El proveedor es obligatorio';

                    if (Object.keys(newErrors).length > 0) {
                        setErrors(newErrors);
                        return;
                    }

                    setIsSubmitting(true);
                    try {
                        const expenseData = {
                            ...formData,
                            amount: parseFloat(formData.amount),
                            userId: userProfile?.id || userProfile?.uid,
                            userName: userProfile?.name,
                            createdAt: expense?.createdAt || new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };

                        await onSave(expenseData);
                    } catch (error) {
                        console.error('Error guardando gasto:', error);
                        showNotification('Error', 'No se pudo guardar el gasto', 'error');
                    } finally {
                        setIsSubmitting(false);
                    }
                };

                const handleInputChange = (field, value) => {
                    setFormData(prev => ({ ...prev, [field]: value }));
                    if (errors[field]) {
                        setErrors(prev => ({ ...prev, [field]: '' }));
                    }
                };

                return (
                    <div className="max-w-4xl mx-auto bg-white rounded-lg shadow-sm border border-gray-200">
                        <div className="px-6 py-4 border-b border-gray-200">
                            <h2 className="text-2xl font-bold text-gray-900">
                                {expense ? 'Editar Gasto' : 'Nuevo Gasto'}
                            </h2>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="p-6 space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Fecha */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Fecha del Gasto *
                                    </label>
                                    <input
                                        type="date"
                                        value={formData.date}
                                        onChange={(e) => handleInputChange('date', e.target.value)}
                                        className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${errors.date ? 'border-red-500' : 'border-gray-300'}`}
                                    />
                                    {errors.date && <p className="text-red-500 text-sm mt-1">{errors.date}</p>}
                                </div>

                                {/* Importe */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Importe (‚Ç¨) *
                                    </label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        value={formData.amount}
                                        onChange={(e) => handleInputChange('amount', e.target.value)}
                                        className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${errors.amount ? 'border-red-500' : 'border-gray-300'}`}
                                        placeholder="0.00"
                                    />
                                    {errors.amount && <p className="text-red-500 text-sm mt-1">{errors.amount}</p>}
                                </div>

                                {/* Descripci√≥n */}
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Descripci√≥n *
                                    </label>
                                    <input
                                        type="text"
                                        value={formData.description}
                                        onChange={(e) => handleInputChange('description', e.target.value)}
                                        className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${errors.description ? 'border-red-500' : 'border-gray-300'}`}
                                        placeholder="Descripci√≥n del gasto"
                                    />
                                    {errors.description && <p className="text-red-500 text-sm mt-1">{errors.description}</p>}
                                </div>

                                {/* Categor√≠a */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Categor√≠a *
                                    </label>
                                    <select
                                        value={formData.category}
                                        onChange={(e) => handleInputChange('category', e.target.value)}
                                        className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${errors.category ? 'border-red-500' : 'border-gray-300'}`}
                                    >
                                        <option value="">Seleccionar categor√≠a</option>
                                        {expenseConfig.categories.map(category => (
                                            <option key={category} value={category}>{category}</option>
                                        ))}
                                    </select>
                                    {errors.category && <p className="text-red-500 text-sm mt-1">{errors.category}</p>}
                                </div>

                                {/* Subcategor√≠a */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Subcategor√≠a
                                    </label>
                                    <select
                                        value={formData.subcategory}
                                        onChange={(e) => handleInputChange('subcategory', e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="">Seleccionar subcategor√≠a</option>
                                        {formData.category && expenseConfig.subcategories[formData.category]?.map(subcategory => (
                                            <option key={subcategory} value={subcategory}>{subcategory}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* Tipo de Pago */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Tipo de Pago
                                    </label>
                                    <select
                                        value={formData.paymentType}
                                        onChange={(e) => handleInputChange('paymentType', e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="">Seleccionar tipo</option>
                                        {expenseConfig.paymentTypes.map(type => (
                                            <option key={type} value={type}>{type}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* Proveedor */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Proveedor/Beneficiario *
                                    </label>
                                    <input
                                        type="text"
                                        value={formData.supplier}
                                        onChange={(e) => handleInputChange('supplier', e.target.value)}
                                        className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${errors.supplier ? 'border-red-500' : 'border-gray-300'}`}
                                        placeholder="Nombre del proveedor"
                                    />
                                    {errors.supplier && <p className="text-red-500 text-sm mt-1">{errors.supplier}</p>}
                                </div>

                                {/* Cliente (opcional) */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Cliente (opcional)
                                    </label>
                                    <select
                                        value={formData.clientId}
                                        onChange={(e) => handleInputChange('clientId', e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="">Sin cliente</option>
                                        {clients.map(client => (
                                            <option key={client.id} value={client.id}>{client.name}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* Estado */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Estado
                                    </label>
                                    <select
                                        value={formData.status}
                                        onChange={(e) => handleInputChange('status', e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        {expenseConfig.statuses.map(status => (
                                            <option key={status} value={status}>{status}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>

                            {/* Notas */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Notas Adicionales
                                </label>
                                <textarea
                                    value={formData.notes}
                                    onChange={(e) => handleInputChange('notes', e.target.value)}
                                    rows={4}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Notas adicionales sobre el gasto..."
                                />
                            </div>

                            {/* Botones */}
                            <div className="flex justify-end gap-4 pt-6 border-t border-gray-200">
                                <button
                                    type="button"
                                    onClick={onCancel}
                                    className="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                                >
                                    Cancelar
                                </button>
                                <button
                                    type="submit"
                                    disabled={isSubmitting}
                                    className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors disabled:opacity-50"
                                >
                                    {isSubmitting ? 'Guardando...' : (expense ? 'Actualizar Gasto' : 'Crear Gasto')}
                                </button>
                            </div>
                        </form>
                    </div>
                );
            }

            // Componente de detalle de gasto
            function ExpenseDetail({ expense, onEdit, onDelete, onBack }) {
                const expenseStatuses = getExpenseStatuses();
                const settings = getSettings();

                const handlePrintExpense = () => {
                    const printWindow = window.open('', '_blank');
                    const printContent = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Gasto - ${expense.description}</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; }
                                .header { text-align: center; margin-bottom: 30px; }
                                .company-info { margin-bottom: 20px; }
                                .expense-details { margin-bottom: 30px; }
                                .expense-details table { width: 100%; border-collapse: collapse; }
                                .expense-details th, .expense-details td { 
                                    border: 1px solid #ddd; padding: 8px; text-align: left; 
                                }
                                .expense-details th { background-color: #f8f9fa; }
                                .total { font-weight: bold; font-size: 18px; margin-top: 20px; }
                                .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #666; }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>${settings.company?.name || 'Expertia Medical Solutions'}</h1>
                                <p>${settings.company?.address || 'Direcci√≥n de la empresa'}</p>
                                <p>Tel: ${settings.company?.phone || ''} | Email: ${settings.company?.email || ''}</p>
                            </div>
                            
                            <div class="expense-details">
                                <h2>Detalle de Gasto</h2>
                                <table>
                                    <tr>
                                        <th>Fecha</th>
                                        <td>${new Date(expense.date).toLocaleDateString('es-ES')}</td>
                                    </tr>
                                    <tr>
                                        <th>Descripci√≥n</th>
                                        <td>${expense.description}</td>
                                    </tr>
                                    <tr>
                                        <th>Categor√≠a</th>
                                        <td>${expense.category}</td>
                                    </tr>
                                    <tr>
                                        <th>Subcategor√≠a</th>
                                        <td>${expense.subcategory || '-'}</td>
                                    </tr>
                                    <tr>
                                        <th>Proveedor</th>
                                        <td>${expense.supplier}</td>
                                    </tr>
                                    <tr>
                                        <th>Tipo de Pago</th>
                                        <td>${expense.paymentType || '-'}</td>
                                    </tr>
                                    <tr>
                                        <th>Estado</th>
                                        <td>${expense.status}</td>
                                    </tr>
                                    <tr>
                                        <th>Registrado por</th>
                                        <td>${expense.userName}</td>
                                    </tr>
                                    <tr>
                                        <th>Notas</th>
                                        <td>${expense.notes || '-'}</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="total">
                                <strong>Importe Total: ‚Ç¨${parseFloat(expense.amount || 0).toFixed(2)}</strong>
                            </div>
                            
                            <div class="footer">
                                <p>Documento generado el ${new Date().toLocaleDateString('es-ES')} a las ${new Date().toLocaleTimeString('es-ES')}</p>
                            </div>
                        </body>
                        </html>
                    `;
                    
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    printWindow.print();
                };

                return (
                    <div className="max-w-4xl mx-auto bg-white rounded-lg shadow-sm border border-gray-200">
                        <div className="px-6 py-4 border-b border-gray-200">
                            <div className="flex justify-between items-center">
                                <h2 className="text-2xl font-bold text-gray-900">Detalle del Gasto</h2>
                                <div className="flex gap-2">
                                    <button
                                        onClick={handlePrintExpense}
                                        className="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors"
                                    >
                                        Imprimir
                                    </button>
                                    <button
                                        onClick={() => onEdit(expense)}
                                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
                                    >
                                        Editar
                                    </button>
                                    <button
                                        onClick={() => onDelete(expense)}
                                        className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors"
                                    >
                                        Eliminar
                                    </button>
                                    <button
                                        onClick={onBack}
                                        className="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors"
                                    >
                                        Volver
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div className="p-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-900 mb-4">Informaci√≥n General</h3>
                                    <div className="space-y-3">
                                        <div>
                                            <span className="text-sm font-medium text-gray-500">Fecha:</span>
                                            <span className="ml-2 text-gray-900">{new Date(expense.date).toLocaleDateString('es-ES')}</span>
                                        </div>
                                        <div>
                                            <span className="text-sm font-medium text-gray-500">Descripci√≥n:</span>
                                            <span className="ml-2 text-gray-900">{expense.description}</span>
                                        </div>
                                        <div>
                                            <span className="text-sm font-medium text-gray-500">Categor√≠a:</span>
                                            <span className="ml-2 text-gray-900">{expense.category}</span>
                                        </div>
                                        <div>
                                            <span className="text-sm font-medium text-gray-500">Subcategor√≠a:</span>
                                            <span className="ml-2 text-gray-900">{expense.subcategory || '-'}</span>
                                        </div>
                                        <div>
                                            <span className="text-sm font-medium text-gray-500">Proveedor:</span>
                                            <span className="ml-2 text-gray-900">{expense.supplier}</span>
                                        </div>
                                        <div>
                                            <span className="text-sm font-medium text-gray-500">Tipo de Pago:</span>
                                            <span className="ml-2 text-gray-900">{expense.paymentType || '-'}</span>
                                        </div>
                                        <div>
                                            <span className="text-sm font-medium text-gray-500">Estado:</span>
                                            <span className="ml-2">
                                                <span className={`px-2 py-1 text-xs font-semibold rounded-full ${expenseStatuses[expense.status] || 'bg-gray-200 text-gray-800'}`}>
                                                    {expense.status}
                                                </span>
                                            </span>
                                        </div>
                                        <div>
                                            <span className="text-sm font-medium text-gray-500">Registrado por:</span>
                                            <span className="ml-2 text-gray-900">{expense.userName}</span>
                                        </div>
                                        <div>
                                            <span className="text-sm font-medium text-gray-500">Importe:</span>
                                            <span className="ml-2 text-lg font-bold text-gray-900">‚Ç¨{parseFloat(expense.amount || 0).toFixed(2)}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-900 mb-4">Informaci√≥n Adicional</h3>
                                    <div className="space-y-3">
                                        {expense.notes && (
                                            <div>
                                                <span className="text-sm font-medium text-gray-500">Notas:</span>
                                                <p className="mt-1 text-gray-900">{expense.notes}</p>
                                            </div>
                                        )}
                                        <div>
                                            <span className="text-sm font-medium text-gray-500">Fecha de creaci√≥n:</span>
                                            <span className="ml-2 text-gray-900">{new Date(expense.createdAt).toLocaleDateString('es-ES')}</span>
                                        </div>
                                        {expense.updatedAt && expense.updatedAt !== expense.createdAt && (
                                            <div>
                                                <span className="text-sm font-medium text-gray-500">√öltima actualizaci√≥n:</span>
                                                <span className="ml-2 text-gray-900">{new Date(expense.updatedAt).toLocaleDateString('es-ES')}</span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            function AccountingDashboard({ invoices, clients, onCreateInvoice, onViewInvoice, onDeleteInvoice, showConfirm, showNotification }) {
                // Estados para filtros y ordenaci√≥n
                const [searchTerm, setSearchTerm] = useState('');
                const [selectedSeries, setSelectedSeries] = useState('all');
                const [sortField, setSortField] = useState('invoiceDate');
                const [sortDirection, setSortDirection] = useState('desc');
                
                const getClientName = (clientId) => clients.find(c => c.id === clientId)?.name || 'N/A';

                // Obtener series √∫nicas para el filtro
                const uniqueSeries = useMemo(() => {
                    const series = [...new Set(invoices.map(inv => inv.invoiceSeries).filter(Boolean))];
                    return series.sort();
                }, [invoices]);

                // Funci√≥n de ordenaci√≥n
                const handleSort = (field) => {
                    if (sortField === field) {
                        setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                    } else {
                        setSortField(field);
                        setSortDirection('asc');
                    }
                };

                // Funci√≥n para renderizar el icono de ordenaci√≥n
                const renderSortIcon = (field) => {
                    if (sortField !== field) {
                        return <ChevronUpIcon width={12} height={12} className="text-gray-400" />;
                    }
                    return sortDirection === 'asc' 
                        ? <ChevronUpIcon width={12} height={12} className="text-[#006666]" />
                        : <ChevronDownIcon width={12} height={12} className="text-[#006666]" />;
                };

                // Filtrar y ordenar facturas
                const filteredAndSortedInvoices = useMemo(() => {
                    let filtered = invoices.filter(invoice => {
                        // Filtro por b√∫squeda
                        const searchLower = searchTerm.toLowerCase();
                        const matchesSearch = !searchTerm || 
                            invoice.invoiceNumber?.toLowerCase().includes(searchLower) ||
                            getClientName(invoice.clientId).toLowerCase().includes(searchLower) ||
                            invoice.status?.toLowerCase().includes(searchLower) ||
                            invoice.invoiceSeries?.toLowerCase().includes(searchLower);

                        // Filtro por serie
                        const matchesSeries = selectedSeries === 'all' || invoice.invoiceSeries === selectedSeries;

                        return matchesSearch && matchesSeries;
                    });

                    // Ordenar
                    filtered.sort((a, b) => {
                        let aValue, bValue;
                        
                        switch (sortField) {
                            case 'invoiceNumber':
                                aValue = a.invoiceNumber || '';
                                bValue = b.invoiceNumber || '';
                                break;
                            case 'invoiceSeries':
                                aValue = a.invoiceSeries || '';
                                bValue = b.invoiceSeries || '';
                                break;
                            case 'clientName':
                                aValue = getClientName(a.clientId);
                                bValue = getClientName(b.clientId);
                                break;
                            case 'invoiceDate':
                                aValue = new Date(a.invoiceDate || '1970-01-01');
                                bValue = new Date(b.invoiceDate || '1970-01-01');
                                break;
                            case 'dueDate':
                                aValue = new Date(a.dueDate || '1970-01-01');
                                bValue = new Date(b.dueDate || '1970-01-01');
                                break;
                            case 'total':
                                aValue = a.total || 0;
                                bValue = b.total || 0;
                                break;
                            case 'status':
                                aValue = a.status || '';
                                bValue = b.status || '';
                                break;
                            default:
                                return 0;
                        }

                        if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
                        if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });

                    return filtered;
                }, [invoices, searchTerm, selectedSeries, sortField, sortDirection, clients]);

                // Estad√≠sticas resumidas
                const stats = useMemo(() => {
                    const total = filteredAndSortedInvoices.reduce((acc, inv) => acc + (inv.total || 0), 0);
                    const paid = filteredAndSortedInvoices.reduce((acc, inv) => acc + (inv.totalPaid || 0), 0);
                    const pending = total - paid;
                    
                    return {
                        count: filteredAndSortedInvoices.length,
                        total: total,
                        paid: paid,
                        pending: pending
                    };
                }, [filteredAndSortedInvoices]);

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h1 className="text-3xl font-bold text-gray-900">Contabilidad</h1>
                        </div>
                        
                        {/* Estad√≠sticas Resumidas */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                                <div className="flex items-center">
                                    <FileTextIcon />
                                    <div className="ml-3">
                                        <p className="text-sm font-medium text-gray-600">Total Facturas</p>
                                        <p className="text-lg font-semibold text-gray-900">{stats.count}</p>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                                <div className="flex items-center">
                                    <CheckIcon width={24} height={24} />
                                    <div className="ml-3">
                                        <p className="text-sm font-medium text-gray-600">Total Facturado</p>
                                        <p className="text-lg font-semibold text-gray-900">{stats.total.toFixed(2)} ‚Ç¨</p>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-emerald-500">
                                <div className="flex items-center">
                                    <DollarSignIcon />
                                    <div className="ml-3">
                                        <p className="text-sm font-medium text-gray-600">Total Cobrado</p>
                                        <p className="text-lg font-semibold text-gray-900">{stats.paid.toFixed(2)} ‚Ç¨</p>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-orange-500">
                                <div className="flex items-center">
                                    <ClockIcon />
                                    <div className="ml-3">
                                        <p className="text-sm font-medium text-gray-600">Pendiente Cobro</p>
                                        <p className="text-lg font-semibold text-gray-900">{stats.pending.toFixed(2)} ‚Ç¨</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div className="bg-white p-6 rounded-lg shadow">
                            {/* T√≠tulo */}
                            <div className="mb-4">
                                <h3 className="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-4">
                                    <FileTextIcon /> Gesti√≥n de Facturas
                                </h3>
                                
                                {/* Barra de herramientas en una sola l√≠nea */}
                                <div className="flex justify-between gap-6 mb-4">
                                    {/* Controles de filtrado y b√∫squeda - cada uno independiente */}
                                    <div className="flex gap-4">
                                        {/* Icono de b√∫squeda - elemento completamente separado */}
                                        <div className="flex items-center">
                                            <SearchIcon className="text-gray-400" width={16} height={16} />
                                        </div>

                                        {/* Campo de b√∫squeda - elemento completamente separado */}
                                        <div>
                                            <input
                                                type="text"
                                                placeholder="Buscar facturas..."
                                                value={searchTerm}
                                                onChange={(e) => setSearchTerm(e.target.value)}
                                                className="w-80 px-4 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-[#006666]"
                                            />
                                        </div>

                                        {/* Filtro por Serie - elemento separado */}
                                        <div>
                                            <select
                                                value={selectedSeries}
                                                onChange={(e) => setSelectedSeries(e.target.value)}
                                                className="w-48 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-[#006666]"
                                            >
                                                <option value="all">Todas las series</option>
                                                {uniqueSeries.map(series => (
                                                    <option key={series} value={series}>{series}</option>
                                                ))}
                                            </select>
                                        </div>

                                        {/* Bot√≥n Reset - elemento separado */}
                                        {(searchTerm || selectedSeries !== 'all') && (
                                            <div>
                                                <button
                                                    onClick={() => {
                                                        setSearchTerm('');
                                                        setSelectedSeries('all');
                                                    }}
                                                    className="px-3 py-2 text-sm text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors flex items-center gap-1"
                                                >
                                                    <XIcon width={14} height={14} />
                                                    Limpiar
                                                </button>
                                            </div>
                                        )}
                                    </div>

                                    {/* Botones de acci√≥n - elementos separados */}
                                    <div className="flex items-center gap-4">
                                        <div>
                                            <button 
                                                onClick={() => exportInvoicesToExcel(filteredAndSortedInvoices, clients, showNotification)}
                                                className="flex items-center gap-2 bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-green-700 transition-colors"
                                            >
                                                <DownloadIcon width={16} height={16} />
                                                Exportar Excel
                                            </button>
                                        </div>
                                        <div>
                                            <button 
                                                onClick={onCreateInvoice} 
                                                className="flex items-center gap-2 bg-[#008080] text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-[#006666] transition-colors"
                                            >
                                                <PlusIcon width={16} height={16} />
                                                Crear Factura
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Informaci√≥n de resultados */}
                            <div className="mb-4 text-sm text-gray-600">
                                Mostrando {filteredAndSortedInvoices.length} de {invoices.length} facturas
                                {(searchTerm || selectedSeries !== 'all') && (
                                    <span className="ml-2 text-[#006666] font-medium">
                                        (filtrado{searchTerm ? ` por "${searchTerm}"` : ''}
                                        {selectedSeries !== 'all' ? ` - serie ${selectedSeries}` : ''})
                                    </span>
                                )}
                            </div>

                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead className="bg-gray-100">
                                        <tr>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('invoiceNumber')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    N¬∫ Factura
                                                    {renderSortIcon('invoiceNumber')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('invoiceSeries')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Serie
                                                    {renderSortIcon('invoiceSeries')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('clientName')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Cliente
                                                    {renderSortIcon('clientName')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('invoiceDate')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Fecha
                                                    {renderSortIcon('invoiceDate')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('dueDate')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Vencimiento
                                                    {renderSortIcon('dueDate')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('total')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Total
                                                    {renderSortIcon('total')}
                                                </div>
                                            </th>
                                            <th 
                                                className="p-3 cursor-pointer hover:bg-gray-200 select-none"
                                                onClick={() => handleSort('status')}
                                            >
                                                <div className="flex items-center gap-2">
                                                    Estado
                                                    {renderSortIcon('status')}
                                                </div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredAndSortedInvoices.length > 0 ? filteredAndSortedInvoices.map(inv => (
                                            <tr key={inv.id} className="border-b hover:bg-gray-50">
                                                <td className="p-3 font-mono text-sm cursor-pointer text-[#006666] hover:text-[#004444] font-medium" onClick={() => onViewInvoice(inv)}>
                                                    {inv.invoiceNumber}
                                                </td>
                                                <td className="p-3">
                                                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ${
                                                        inv.invoiceSeries === 'EXP' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'
                                                    }`}>
                                                        {inv.invoiceSeries}
                                                    </span>
                                                </td>
                                                <td className="p-3">{getClientName(inv.clientId)}</td>
                                                <td className="p-3">{inv.invoiceDate}</td>
                                                <td className="p-3">{inv.dueDate}</td>
                                                <td className="p-3 font-semibold">{inv.total?.toFixed(2) || '0.00'} ‚Ç¨</td>
                                                <td className="p-3">
                                                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ${INVOICE_STATUSES[inv.status] || 'bg-gray-200 text-gray-800'}`}>
                                                        {inv.status}
                                                    </span>
                                                </td>
                                            </tr>
                                        )) : (
                                            <tr>
                                                <td colSpan="7" className="text-center p-6 text-gray-500">
                                                    {invoices.length === 0 ? (
                                                        <>
                                                            No hay facturas. 
                                                            <button onClick={onCreateInvoice} className="text-[#008080] ml-2 underline">
                                                                Crear primera factura
                                                            </button>
                                                        </>
                                                    ) : (
                                                        <>
                                                            No se encontraron facturas que coincidan con los filtros aplicados.
                                                            <button 
                                                                onClick={() => {
                                                                    setSearchTerm('');
                                                                    setSelectedSeries('all');
                                                                }}
                                                                className="text-[#008080] ml-2 underline"
                                                            >
                                                                Limpiar filtros
                                                            </button>
                                                        </>
                                                    )}
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            }

            // === FORMULARIO DE FACTURAS ===
            function InvoiceForm({ clients, products, onSave, onCancel, invoiceData }) {
                // Obtener series din√°micas desde contadores
                let invoiceSeries = window.getInvoiceSeries ? window.getInvoiceSeries() : ['EXP', 'ALQ', 'PROF'];
                
                // Si es una factura rectificativa, agregar la serie REC a las opciones disponibles
                if (invoiceData?.type === 'Factura Rectificativa' && invoiceData?.invoiceSeries) {
                    const rectSeries = invoiceData.invoiceSeries;
                    if (!invoiceSeries.includes(rectSeries)) {
                        invoiceSeries = [...invoiceSeries, rectSeries];
                    }
                }
                
                const defaultSeries = invoiceData?.invoiceSeries || invoiceSeries[0] || 'EXP';
                
                // Funci√≥n para generar el n√∫mero de factura que se va a crear (sin incrementar contador)
                const generatePreviewInvoiceNumber = (series) => {
                    if (!series) return '';
                    const currentCounter = window.getCurrentCounter ? window.getCurrentCounter(series) : 0;
                    const nextNumber = currentCounter + 1;
                    return `${series}${String(nextNumber).padStart(3, '0')}`;
                };
                
                const [formData, setFormData] = useState({
                    id: invoiceData?.id || null, 
                    clientId: invoiceData?.client?.id || '',
                    invoiceNumber: invoiceData?.invoiceNumber || '',
                    invoiceDate: invoiceData?.invoiceDate || new Date().toISOString().split('T')[0],
                    dueDate: invoiceData?.dueDate || new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    status: invoiceData?.status || 'Borrador',
                    type: invoiceData?.type || 'Factura',
                    invoiceSeries: invoiceData?.invoiceSeries || defaultSeries,
                    items: invoiceData?.items || [{ description: '', quantity: 1, price: 0, productId: '', serialNumber: '' }],
                    includeVAT: invoiceData?.includeVAT !== undefined ? invoiceData.includeVAT : true,
                    customVATRate: invoiceData?.customVATRate || 0.21,
                });

                // Estado para el n√∫mero de factura de vista previa
                const [previewInvoiceNumber, setPreviewInvoiceNumber] = useState(
                    invoiceData?.id ? invoiceData.invoiceNumber : generatePreviewInvoiceNumber(defaultSeries)
                );

                // Actualizar n√∫mero de factura de vista previa cuando cambie la serie
                useEffect(() => {
                    if (!invoiceData?.id) { // Solo para facturas nuevas
                        const newPreviewNumber = generatePreviewInvoiceNumber(formData.invoiceSeries);
                        setPreviewInvoiceNumber(newPreviewNumber);
                    }
                }, [formData.invoiceSeries]);

                // Obtener configuraci√≥n de IVA para la serie seleccionada
                const seriesConfig = window.getSystemSettings?.()?.invoice?.seriesConfig?.[formData.invoiceSeries] || { includeVAT: true, vatRate: 0.21 };
                
                // Calcular IVA efectivo basado en configuraci√≥n y selecci√≥n manual
                const effectiveVATRate = formData.includeVAT ? (formData.customVATRate || seriesConfig.vatRate) : 0;

                const subtotal = useMemo(() => formData.items.reduce((acc, item) => acc + (item.quantity * item.price), 0), [formData.items]);
                const vat = useMemo(() => subtotal * effectiveVATRate, [subtotal, effectiveVATRate]);
                const total = useMemo(() => subtotal + vat, [subtotal, vat]);

                // Actualizar configuraci√≥n de IVA cuando cambie la serie
                useEffect(() => {
                    const seriesConfig = window.getSystemSettings?.()?.invoice?.seriesConfig?.[formData.invoiceSeries];
                    if (seriesConfig) {
                        setFormData(prev => ({
                            ...prev,
                            includeVAT: seriesConfig.includeVAT,
                            customVATRate: seriesConfig.vatRate
                        }));
                    }
                }, [formData.invoiceSeries]);

                const handleChange = (e) => { 
                    const { name, value, type } = e.target; 
                    if (type === 'checkbox') {
                        setFormData(prev => ({ ...prev, [name]: e.target.checked })); 
                    } else {
                    setFormData(prev => ({ ...prev, [name]: value })); 
                    }
                };
               
                const handleItemChange = (index, e) => {
                    const { name, value } = e.target;
                    const items = [...formData.items];
                    if (name === "productId") {
                        const product = products.find(p => p.id === value);
                        items[index].productId = value;
                        items[index].description = product ? product.name : '';
                        items[index].price = product ? product.price : 0;
                    } else {
                        items[index][name] = value;
                    }
                    setFormData(prev => ({ ...prev, items }));
                };

                const addItem = () => { 
                    setFormData(prev => ({ 
                        ...prev, 
                        items: [...prev.items, { description: '', quantity: 1, price: 0, productId: '', serialNumber: '' }] 
                    })); 
                };
                
                const removeItem = (index) => { 
                    const items = [...formData.items]; 
                    items.splice(index, 1); 
                    setFormData(prev => ({ ...prev, items })); 
                };
                
                const handleSubmit = (e) => { 
                    e.preventDefault(); 
                    onSave({ 
                        ...formData, 
                        subtotal, 
                        vat, 
                        total,
                        includeVAT: formData.includeVAT,
                        customVATRate: formData.customVATRate,
                        effectiveVATRate: effectiveVATRate
                    }); 
                };

                return (
                    <form onSubmit={handleSubmit} className="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg space-y-6">
                        <h2 className="text-2xl font-bold text-gray-900">
                            {invoiceData?.id ? 'Editar Factura' : 'Crear Nueva Factura'}
                            {!invoiceData?.id && previewInvoiceNumber && (
                                <span className="ml-3 text-lg font-normal text-[#008080]">
                                    - {previewInvoiceNumber}
                                </span>
                            )}
                        </h2>
                        
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-gray-700">Cliente</label>
                                <select 
                                    name="clientId" 
                                    value={formData.clientId} 
                                    onChange={handleChange} 
                                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#008080] focus:ring-[#008080]" 
                                    required
                                >
                                    <option value="">Seleccionar cliente...</option>
                                    {clients.map(c => (
                                        <option key={c.id} value={c.id}>{c.name} - {c.clinic}</option>
                                    ))}
                                </select>
                            </div>
                            
                            <FormField label="Fecha Factura" name="invoiceDate" type="date" value={formData.invoiceDate} onChange={handleChange} />
                            <FormField label="Fecha Vencimiento" name="dueDate" type="date" value={formData.dueDate} onChange={handleChange} />
                            
                            <FormSelect label="Tipo Documento" name="type" value={formData.type} onChange={handleChange} options={['Factura', 'Factura Proforma']} />
                            <FormSelect label="Serie Factura" name="invoiceSeries" value={formData.invoiceSeries} onChange={handleChange} options={invoiceSeries} />
                            <FormSelect label="Estado" name="status" value={formData.status} onChange={handleChange} options={Object.keys(INVOICE_STATUSES)} />
                        </div>
                        
                        <div className="border-t pt-4">
                            <h3 className="text-lg font-semibold mb-2">L√≠neas de la factura</h3>
                            {formData.items.map((item, index) => (
                                <div key={index} className="grid grid-cols-15 gap-2 mb-2 items-center">
                                    <div className="col-span-4">
                                        <select 
                                            name="productId" 
                                            value={item.productId} 
                                            onChange={(e) => handleItemChange(index, e)} 
                                            className="w-full p-2 border rounded-md bg-white shadow-sm"
                                        >
                                            <option value="">Seleccionar producto</option>
                                            {products.map(p => (
                                                <option key={p.id} value={p.id}>{p.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="col-span-3">
                                        <FormField 
                                            placeholder="N¬∫ Serie" 
                                            name="serialNumber" 
                                            type="text" 
                                            value={item.serialNumber || ''} 
                                            onChange={(e) => handleItemChange(index, e)} 
                                        />
                                    </div>
                                    <div className="col-span-2">
                                        <FormField 
                                            placeholder="Cant." 
                                            name="quantity" 
                                            type="number" 
                                            value={item.quantity} 
                                            onChange={(e) => handleItemChange(index, e)} 
                                        />
                                    </div>
                                    <div className="col-span-2">
                                        <FormField 
                                            placeholder="Precio" 
                                            name="price" 
                                            type="number" 
                                            step="0.01"
                                            value={item.price} 
                                            onChange={(e) => handleItemChange(index, e)} 
                                        />
                                    </div>
                                    <div className="col-span-2 font-semibold text-right">
                                        {(item.quantity * item.price).toFixed(2)}‚Ç¨
                                    </div>
                                    <div className="col-span-2">
                                        <button 
                                            type="button" 
                                            onClick={() => removeItem(index)} 
                                            className="text-red-500 p-2 rounded-full hover:bg-red-100"
                                        >
                                            <TrashIcon />
                                        </button>
                                    </div>
                                </div>
                            ))}
                            <button 
                                type="button" 
                                onClick={addItem} 
                                className="text-sm text-[#008080] font-bold"
                            >
                                + A√±adir l√≠nea
                            </button>
                        </div>
                        
                        {/* Controles de IVA */}
                        <div className="bg-gray-50 p-4 rounded-lg">
                            <h3 className="text-lg font-semibold text-gray-900 mb-4">Aplicaci√≥n de IVA</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="flex items-center space-x-3">
                                    <input
                                        type="checkbox"
                                        id="includeVAT"
                                        name="includeVAT"
                                        checked={formData.includeVAT}
                                        onChange={handleChange}
                                        className="h-4 w-4 text-[#008080] focus:ring-[#008080] border-gray-300 rounded"
                                    />
                                    <label htmlFor="includeVAT" className="text-sm font-medium text-gray-700">
                                        Incluir IVA en la factura
                                    </label>
                                </div>
                                
                                {formData.includeVAT && (
                                    <div className="flex items-center space-x-3">
                                        <label htmlFor="customVATRate" className="text-sm font-medium text-gray-700">
                                            Tasa de IVA (%):
                                        </label>
                                        <input
                                            type="number"
                                            id="customVATRate"
                                            name="customVATRate"
                                            value={formData.customVATRate * 100}
                                            onChange={(e) => setFormData(prev => ({ ...prev, customVATRate: parseFloat(e.target.value) / 100 }))}
                                            min="0"
                                            max="100"
                                            step="0.01"
                                            className="w-20 px-3 py-1 border border-gray-300 rounded-md focus:ring-[#008080] focus:border-[#008080]"
                                        />
                                    </div>
                                )}
                            </div>
                            
                            {/* Informaci√≥n de la serie */}
                            <div className="mt-3 text-sm text-gray-600">
                                <p>
                                    <strong>Serie {formData.invoiceSeries}:</strong> {
                                        seriesConfig.includeVAT 
                                            ? `IVA incluido por defecto (${(seriesConfig.vatRate * 100).toFixed(1)}%)`
                                            : 'Sin IVA por defecto'
                                    }
                                </p>
                            </div>
                        </div>
                        
                        <div className="flex justify-end">
                            <div className="w-full md:w-1/3 space-y-2 text-right">
                                <div className="flex justify-between">
                                    <span className="font-semibold">Subtotal:</span>
                                    <span>{subtotal.toFixed(2)} ‚Ç¨</span>
                                </div>
                                {formData.includeVAT ? (
                                <div className="flex justify-between">
                                        <span className="font-semibold">IVA ({(effectiveVATRate * 100).toFixed(1)}%):</span>
                                    <span>{vat.toFixed(2)} ‚Ç¨</span>
                                </div>
                                ) : (
                                    <div className="flex justify-between text-gray-500">
                                        <span className="font-semibold">IVA:</span>
                                        <span>Exento</span>
                                    </div>
                                )}
                                <div className="flex justify-between border-t pt-2 mt-2">
                                    <span className="font-bold text-lg">Total:</span>
                                    <span className="font-bold text-lg">{total.toFixed(2)} ‚Ç¨</span>
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex justify-end gap-4 pt-4">
                            <button 
                                type="button" 
                                onClick={onCancel} 
                                className="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300"
                            >
                                Cancelar
                            </button>
                            <button 
                                type="submit" 
                                className="bg-[#008080] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#006666]"
                            >
                                Guardar Factura
                            </button>
                        </div>
                    </form>
                );
            }

            // === FORMULARIO DE OFERTAS ===
            function OfferForm({ clients, products, onSave, onCancel, offerData, db }) {
                const [config, setConfig] = useState(null);
                
                // Cargar configuraci√≥n din√°mica
                useEffect(() => {
                    loadAppConfig().then(setConfig);
                }, []);

                // Cargar usuarios comerciales al montar el componente
                useEffect(() => {
                    const loadCommercialUsers = async () => {
                        setIsLoadingUsers(true);
                        try {
                            // Obtener usuarios con rol comercial desde Firebase
                            if (db) {
                                // Obtener las funciones de Firebase del objeto global
                                const { collection, query, where, getDocs } = window.firebase;
                                if (!collection || !query || !where || !getDocs) {
                                    throw new Error('Funciones de Firestore no disponibles');
                                }
                                
                                const usersRef = collection(db, 'users');
                                const q = query(usersRef, where('role', 'in', ['comercial', 'admin']));
                                const querySnapshot = await getDocs(q);
                                
                                const users = [];
                                querySnapshot.forEach((doc) => {
                                    const userData = doc.data();
                                    if (userData.active !== false) { // Solo usuarios activos
                                        users.push({
                                            id: doc.id,
                                            name: userData.name || userData.displayName || userData.email,
                                            email: userData.email,
                                            role: userData.role
                                        });
                                    }
                                });
                                
                                setCommercialUsers(users);
                            }
                        } catch (error) {
                            console.error('Error cargando usuarios comerciales:', error);
                            // Fallback con usuario actual si est√° disponible
                            if (window.currentUser) {
                                setCommercialUsers([{
                                    id: window.currentUser.uid,
                                    name: window.currentUser.displayName || window.currentUser.email,
                                    email: window.currentUser.email,
                                    role: 'comercial'
                                }]);
                            }
                        }
                        setIsLoadingUsers(false);
                    };

                    loadCommercialUsers();
                }, [db]);
                
                // Series din√°micas con fallback
                const offerSeries = config ? getConfigValue('offers.series', config) : ['OF'];
                const defaultOfferSeries = Array.isArray(offerSeries) && offerSeries.length > 0 ? 
                    offerSeries[0] : 'OF';
                
                // Estados din√°micos con fallback  
                const offerStatuses = config ? getConfigValue('offers.statuses', config) : 
                    ['Borrador', 'Enviada', 'Aceptada', 'Rechazada', 'Vencida'];
                    
                // T√©rminos por defecto configurables
                const defaultTerms = config ? 
                    getConfigValue('offers.defaultTerms', config) || 
                    'Esta oferta es v√°lida hasta la fecha indicada. Los precios incluyen IVA.' :
                    'Esta oferta es v√°lida hasta la fecha indicada. Los precios incluyen IVA.';

                // Estados para cargar datos din√°micos
                const [commercialUsers, setCommercialUsers] = useState([]);
                const [isLoadingUsers, setIsLoadingUsers] = useState(false);

                const [formData, setFormData] = useState({
                    id: offerData?.id || null, 
                    clientId: offerData?.client?.id || '',
                    offerDate: offerData?.offerDate || new Date().toISOString().split('T')[0],
                    validUntil: offerData?.validUntil || new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    status: offerData?.status || (offerStatuses[0] || 'Borrador'),
                    offerSeries: offerData?.offerSeries || defaultOfferSeries,
                    description: offerData?.description || '',
                    items: offerData?.items || [{ description: '', quantity: 1, price: 0, productId: '', serialNumber: '' }],
                    terms: offerData?.terms || defaultTerms,
                    assignedTo: offerData?.assignedTo || '',
                    includeVAT: offerData?.includeVAT !== undefined ? offerData.includeVAT : true,
                    customVATRate: offerData?.customVATRate || 0.21,
                    includeDiscount: offerData?.includeDiscount !== undefined ? offerData.includeDiscount : false,
                    customDiscountRate: offerData?.customDiscountRate || 0,
                });

                // Obtener configuraci√≥n de IVA para la serie seleccionada
                const seriesConfig = window.getSystemSettings?.()?.invoice?.seriesConfig?.[formData.offerSeries] || { includeVAT: true, vatRate: 0.21 };
                
                // Calcular IVA efectivo basado en configuraci√≥n y selecci√≥n manual
                const effectiveVATRate = formData.includeVAT ? (formData.customVATRate || seriesConfig.vatRate) : 0;
                
                // Calcular descuento efectivo
                const effectiveDiscountRate = formData.includeDiscount ? (formData.customDiscountRate || 0) : 0;

                const subtotal = useMemo(() => formData.items.reduce((acc, item) => acc + (Number(item.quantity) || 0) * (Number(item.price) || 0), 0), [formData.items]);
                const discount = useMemo(() => subtotal * effectiveDiscountRate, [subtotal, effectiveDiscountRate]);
                const subtotalAfterDiscount = useMemo(() => subtotal - discount, [subtotal, discount]);
                const vat = useMemo(() => subtotalAfterDiscount * effectiveVATRate, [subtotalAfterDiscount, effectiveVATRate]);
                const total = useMemo(() => subtotalAfterDiscount + vat, [subtotalAfterDiscount, vat]);

                // Actualizar configuraci√≥n de IVA cuando cambie la serie
                useEffect(() => {
                    const seriesConfig = window.getSystemSettings?.()?.invoice?.seriesConfig?.[formData.offerSeries];
                    if (seriesConfig) {
                        setFormData(prev => ({
                            ...prev,
                            includeVAT: seriesConfig.includeVAT,
                            customVATRate: seriesConfig.vatRate
                        }));
                    }
                }, [formData.offerSeries]);

                const handleChange = (e) => { 
                    const { name, value, type } = e.target; 
                    if (type === 'checkbox') {
                        setFormData(prev => ({ ...prev, [name]: e.target.checked })); 
                    } else {
                    setFormData(prev => ({ ...prev, [name]: value })); 
                    }
                };
               
                const handleItemChange = (index, e) => {
                    const { name, value } = e.target;
                    const items = [...formData.items];
                    if (name === "productId") {
                        const product = products.find(p => p.id === value);
                        items[index].productId = value;
                        items[index].description = product ? product.name : '';
                        items[index].price = product ? Number(product.price) || 0 : 0;
                    } else if (name === "quantity" || name === "price") {
                        items[index][name] = Number(value) || 0;
                    } else {
                        items[index][name] = value;
                    }
                    setFormData(prev => ({ ...prev, items }));
                };

                const addItem = () => { 
                    setFormData(prev => ({ 
                        ...prev, 
                        items: [...prev.items, { description: '', quantity: 1, price: 0, productId: '', serialNumber: '' }] 
                    })); 
                };
                
                const removeItem = (index) => { 
                    const items = [...formData.items]; 
                    items.splice(index, 1); 
                    setFormData(prev => ({ ...prev, items })); 
                };
                
                const handleSubmit = (e) => { 
                    e.preventDefault(); 
                    
                    // Validaciones obligatorias
                    const errors = [];
                    
                    // 1. Cliente obligatorio
                    if (!formData.clientId) {
                        errors.push('Debe seleccionar un cliente');
                    }
                    
                    // 2. Comercial obligatorio
                    if (!formData.assignedTo) {
                        errors.push('Debe asignar la oferta a un comercial');
                    }
                    
                    // 3. Al menos un producto con datos v√°lidos
                    const validItems = formData.items.filter(item => 
                        (item.productId || item.description.trim()) && 
                        item.quantity > 0 && 
                        item.price >= 0
                    );
                    
                    if (validItems.length === 0) {
                        errors.push('Debe a√±adir al menos un producto o servicio v√°lido');
                    }
                    
                    // Mostrar errores si los hay
                    if (errors.length > 0) {
                        showNotification('Errores de Validaci√≥n', 'Por favor, corrija los siguientes errores:\n\n‚Ä¢ ' + errors.join('\n‚Ä¢ '), 'danger');
                        return;
                    }
                    
                    // Filtrar items v√°lidos antes de guardar
                    const dataToSave = {
                        ...formData,
                        items: validItems,
                        subtotal,
                        vat,
                        total,
                        includeVAT: formData.includeVAT,
                        customVATRate: formData.customVATRate,
                        effectiveVATRate: effectiveVATRate
                    };
                    
                    onSave(dataToSave); 
                };

                return (
                    <form onSubmit={handleSubmit} className="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg space-y-6">
                        <div className="flex items-center gap-3 mb-6">
                            <BriefcaseIcon width={32} height={32} className="text-[#008080]" />
                            <h2 className="text-2xl font-bold text-gray-900">
                                {offerData?.id ? 'Editar Oferta' : 'Crear Nueva Oferta'}
                            </h2>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="md:col-span-2">
                                <FormSelect 
                                    label="Cliente *" 
                                    name="clientId" 
                                    value={formData.clientId} 
                                    onChange={handleChange} 
                                    options={[
                                        { value: "", label: "Seleccionar cliente" },
                                        ...clients.map(client => ({ value: client.id, label: client.name }))
                                    ]}
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Serie</label>
                                <select 
                                    name="offerSeries" 
                                    value={formData.offerSeries} 
                                    onChange={handleChange} 
                                    className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:border-[#008080]"
                                    required
                                >
                                    {offerSeries.map(series => (
                                        <option key={series} value={series}>{series}</option>
                                    ))}
                                </select>
                                {!config && (
                                    <p className="text-xs text-gray-500 mt-1">
                                        üí° Las series se pueden configurar en Admin ‚Üí Configuraci√≥n ‚Üí Ofertas
                                    </p>
                                )}
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <FormField label="Fecha Oferta" name="offerDate" type="date" value={formData.offerDate} onChange={handleChange} required />
                            <FormField label="V√°lida hasta" name="validUntil" type="date" value={formData.validUntil} onChange={handleChange} required />
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                                <select 
                                    name="status" 
                                    value={formData.status} 
                                    onChange={handleChange} 
                                    className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:border-[#008080]"
                                >
                                    {offerStatuses.map(status => (
                                        <option key={status} value={status}>{status}</option>
                                    ))}
                                </select>
                                {!config && (
                                    <p className="text-xs text-gray-500 mt-1">
                                        üí° Los estados se pueden configurar en Admin ‚Üí Configuraci√≥n ‚Üí Ofertas
                                    </p>
                                )}
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Asignado a (Comercial) *
                                </label>
                                {isLoadingUsers ? (
                                    <div className="flex items-center text-gray-500">
                                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-[#008080] mr-2"></div>
                                        Cargando usuarios...
                                    </div>
                                ) : (
                                    <select
                                        name="assignedTo"
                                        value={formData.assignedTo}
                                        onChange={handleChange}
                                        className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:border-[#008080]"
                                        required
                                    >
                                        <option value="">Seleccionar comercial...</option>
                                        {commercialUsers.map(user => (
                                            <option key={user.id} value={user.id}>
                                                {user.name}
                                            </option>
                                        ))}
                                    </select>
                                )}
                                <div className="mt-1 text-xs text-gray-500">
                                    Solo se muestran usuarios con rol comercial o admin
                                </div>
                            </div>
                            <div></div>
                        </div>

                        <div>
                            <FormField 
                                label="Descripci√≥n general de la oferta" 
                                as="textarea" 
                                name="description" 
                                value={formData.description} 
                                onChange={handleChange} 
                                rows="3"
                                placeholder="Describe brevemente el contenido de esta oferta..."
                            />
                        </div>

                        <div>
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-lg font-semibold text-gray-800">Items de la Oferta</h3>
                                <button type="button" onClick={addItem} className="bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">
                                    + Agregar Producto
                                </button>
                            </div>
                            
                            <div className="space-y-3">
                                {formData.items.map((item, index) => (
                                    <div key={index} className="grid grid-cols-1 md:grid-cols-7 gap-3 p-4 bg-gray-50 rounded-lg">
                                        <div className="md:col-span-2">
                                            <label className="block text-xs font-medium text-gray-700 mb-1">Producto</label>
                                            <select 
                                                name="productId" 
                                                value={item.productId} 
                                                onChange={(e) => handleItemChange(index, e)} 
                                                className="w-full text-sm border border-gray-300 rounded-md p-2"
                                            >
                                                <option value="">Manual</option>
                                                {products.map(product => (
                                                    <option key={product.id} value={product.id}>{product.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700 mb-1">Descripci√≥n</label>
                                            <input 
                                                type="text" 
                                                name="description" 
                                                value={item.description} 
                                                onChange={(e) => handleItemChange(index, e)} 
                                                className="w-full text-sm border border-gray-300 rounded-md p-2" 
                                                placeholder="Descripci√≥n"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700 mb-1">N¬∫ Serie</label>
                                            <input 
                                                type="text" 
                                                name="serialNumber" 
                                                value={item.serialNumber || ''} 
                                                onChange={(e) => handleItemChange(index, e)} 
                                                className="w-full text-sm border border-gray-300 rounded-md p-2" 
                                                placeholder="N√∫mero de serie"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700 mb-1">Cantidad</label>
                                            <input 
                                                type="number" 
                                                name="quantity" 
                                                value={item.quantity} 
                                                onChange={(e) => handleItemChange(index, e)} 
                                                className="w-full text-sm border border-gray-300 rounded-md p-2" 
                                                min="1"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700 mb-1">Precio ‚Ç¨</label>
                                            <input 
                                                type="number" 
                                                step="0.01" 
                                                name="price" 
                                                value={item.price} 
                                                onChange={(e) => handleItemChange(index, e)} 
                                                className="w-full text-sm border border-gray-300 rounded-md p-2" 
                                                min="0"
                                            />
                                        </div>
                                        <div className="flex items-end">
                                            <div className="text-sm font-semibold text-gray-900">
                                                {(item.quantity * item.price).toFixed(2)}‚Ç¨
                                            </div>
                                        </div>
                                        <div className="flex items-end">
                                            <button 
                                                type="button" 
                                                onClick={() => removeItem(index)} 
                                                className="text-red-500 hover:text-red-700 text-sm"
                                                disabled={formData.items.length === 1}
                                            >
                                                Eliminar
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div>
                            <FormField 
                                label="T√©rminos y condiciones" 
                                as="textarea" 
                                name="terms" 
                                value={formData.terms} 
                                onChange={handleChange} 
                                rows="3"
                                placeholder="Condiciones de la oferta, validez, t√©rminos de pago, etc..."
                            />
                        </div>

                        {/* Controles de IVA */}
                        <div className="bg-gray-50 p-4 rounded-lg">
                            <h3 className="text-lg font-semibold text-gray-900 mb-4">Configuraci√≥n de IVA</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="flex items-center space-x-3">
                                    <input
                                        type="checkbox"
                                        id="includeVAT"
                                        name="includeVAT"
                                        checked={formData.includeVAT}
                                        onChange={handleChange}
                                        className="h-4 w-4 text-[#008080] focus:ring-[#008080] border-gray-300 rounded"
                                    />
                                    <label htmlFor="includeVAT" className="text-sm font-medium text-gray-700">
                                        Incluir IVA en la oferta
                                    </label>
                                </div>
                                
                                {formData.includeVAT && (
                                    <div className="flex items-center space-x-3">
                                        <label htmlFor="customVATRate" className="text-sm font-medium text-gray-700">
                                            Tasa de IVA (%):
                                        </label>
                                        <input
                                            type="number"
                                            id="customVATRate"
                                            name="customVATRate"
                                            value={formData.customVATRate * 100}
                                            onChange={(e) => setFormData(prev => ({ ...prev, customVATRate: parseFloat(e.target.value) / 100 }))}
                                            min="0"
                                            max="100"
                                            step="0.01"
                                            className="w-20 px-3 py-1 border border-gray-300 rounded-md focus:ring-[#008080] focus:border-[#008080]"
                                        />
                                    </div>
                                )}
                            </div>
                            
                            {/* Informaci√≥n de la serie */}
                            <div className="mt-3 text-sm text-gray-600">
                                <p>
                                    <strong>Serie {formData.offerSeries}:</strong> {
                                        seriesConfig.includeVAT 
                                            ? `IVA incluido por defecto (${(seriesConfig.vatRate * 100).toFixed(1)}%)`
                                            : 'Sin IVA por defecto'
                                    }
                                </p>
                            </div>
                        </div>

                        {/* Controles de Descuento */}
                        <div className="bg-gray-50 p-4 rounded-lg">
                            <h3 className="text-lg font-semibold text-gray-900 mb-4">Configuraci√≥n de Descuento</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="flex items-center space-x-3">
                                    <input
                                        type="checkbox"
                                        id="includeDiscount"
                                        name="includeDiscount"
                                        checked={formData.includeDiscount}
                                        onChange={handleChange}
                                        className="h-4 w-4 text-[#008080] focus:ring-[#008080] border-gray-300 rounded"
                                    />
                                    <label htmlFor="includeDiscount" className="text-sm font-medium text-gray-700">
                                        Aplicar descuento a la oferta
                                    </label>
                                </div>
                                
                                {formData.includeDiscount && (
                                    <div className="flex items-center space-x-3">
                                        <label htmlFor="customDiscountRate" className="text-sm font-medium text-gray-700">
                                            Porcentaje de descuento (%):
                                        </label>
                                        <input
                                            type="number"
                                            id="customDiscountRate"
                                            name="customDiscountRate"
                                            value={formData.customDiscountRate * 100}
                                            onChange={(e) => setFormData(prev => ({ ...prev, customDiscountRate: parseFloat(e.target.value) / 100 }))}
                                            min="0"
                                            max="100"
                                            step="0.01"
                                            className="w-20 px-3 py-1 border border-gray-300 rounded-md focus:ring-[#008080] focus:border-[#008080]"
                                        />
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="bg-gray-50 p-4 rounded-lg">
                            <div className="grid grid-cols-4 gap-4 text-right">
                                <div>
                                    <div className="text-sm text-gray-600">Subtotal:</div>
                                    <div className="font-semibold">{subtotal.toFixed(2)} ‚Ç¨</div>
                                </div>
                                {formData.includeDiscount ? (
                                    <div>
                                        <div className="text-sm text-gray-600">Descuento ({(effectiveDiscountRate * 100).toFixed(1)}%):</div>
                                        <div className="font-semibold text-red-600">-{discount.toFixed(2)} ‚Ç¨</div>
                                    </div>
                                ) : (
                                    <div>
                                        <div className="text-sm text-gray-600">Descuento:</div>
                                        <div className="font-semibold text-gray-500">Sin descuento</div>
                                    </div>
                                )}
                                {formData.includeVAT ? (
                                <div>
                                        <div className="text-sm text-gray-600">IVA ({(effectiveVATRate * 100).toFixed(1)}%):</div>
                                    <div className="font-semibold">{vat.toFixed(2)} ‚Ç¨</div>
                                </div>
                                ) : (
                                    <div>
                                        <div className="text-sm text-gray-600">IVA:</div>
                                        <div className="font-semibold text-gray-500">Exento</div>
                                    </div>
                                )}
                                <div>
                                    <div className="text-sm text-gray-600">Total:</div>
                                    <div className="text-xl font-bold text-[#008080]">{total.toFixed(2)} ‚Ç¨</div>
                                </div>
                            </div>
                        </div>

                        <div className="flex justify-between pt-6">
                            <button 
                                type="button" 
                                onClick={onCancel} 
                                className="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300"
                            >
                                Cancelar
                            </button>
                            <button 
                                type="submit" 
                                className="bg-[#008080] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#006666]"
                            >
                                Guardar Oferta
                            </button>
                        </div>
                    </form>
                );
            }

            // === DETALLE DE FACTURA ===
            function InvoiceDetail({ invoice, clients, onBack, onRegisterPayment, db, userId, onConvertToInvoice, onCreateRectificativa, showConfirm, showNotification }) {
                if (!invoice) return null;
                
                const client = clients.find(c => c.id === invoice.clientId);
                const [payments, setPayments] = useState([]);
                const [paymentAmount, setPaymentAmount] = useState(0);
                const amountPaid = invoice.totalPaid || 0;
                const amountDue = invoice.total - amountPaid;
                
                // Obtener configuraciones din√°micas
                const settings = window.getSettings();
                
                useEffect(() => { 
                    if (!db || !userId || !invoice.id) return; 
                    const paymentsPath = `facturas/${invoice.id}/payments`; 
                    console.log('[DEBUG]  Cargando pagos desde:', paymentsPath);
                    const q = query(collection(db, paymentsPath)); 
                    const unsubscribe = onSnapshot(q, (snapshot) => { 
                        console.log('[DATA]  Pagos encontrados:', snapshot.docs.length);
                        console.log('[DATA]  Datos de pagos:', snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        setPayments(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); 
                    }, (error) => {
                        console.error('[ERROR]  Error cargando pagos:', error);
                    }); 
                    return () => unsubscribe(); 
                }, [db, userId, invoice.id]);
                
                const handlePaymentSubmit = (e) => { 
                    e.preventDefault(); 
                    const amount = parseFloat(paymentAmount); 
                    if (amount > 0 && amount <= amountDue) { 
                        onRegisterPayment(invoice, amount); 
                        setPaymentAmount(0); 
                    } else { 
                        showNotification('Error de pago', 'El importe del pago no es v√°lido. Debe ser mayor que 0 y no superior al importe pendiente.', 'error');
                    } 
                };

                // Funci√≥n para imprimir la factura
                const handlePrintInvoice = () => {
                    const settings = window.getSettings();
                    const printContent = generateInvoicePrintHTML(invoice, client, settings);
                    const printWindow = window.open('', '_blank', 'width=800,height=600');
                    printWindow.document.open();
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    printWindow.focus();
                    setTimeout(() => {
                        printWindow.print();
                        printWindow.close();
                    }, 250);
                };

                // Funci√≥n para generar el HTML de impresi√≥n
                const generateInvoicePrintHTML = (invoice, client, settings) => {
                    return `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="utf-8">
                            <title>Factura ${invoice.invoiceNumber}</title>
                            <style>
                                * { margin: 0; padding: 0; box-sizing: border-box; }
                                body { font-family: Arial, sans-serif; font-size: 12px; line-height: 1.4; color: #333; }
                                .invoice-container { max-width: 800px; margin: 0 auto; padding: 20px; }
                                .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; border-bottom: 2px solid #006666; padding-bottom: 20px; }
                                .logo-section h1 { color: #006666; font-size: 24px; margin-bottom: 5px; }
                                .logo-section h2 { color: #333; font-size: 18px; font-weight: normal; }
                                .company-info { text-align: right; }
                                .company-info h3 { color: #006666; font-size: 16px; margin-bottom: 5px; }
                                .invoice-info { display: flex; justify-content: space-between; margin-bottom: 30px; }
                                .invoice-details, .client-details { flex: 1; }
                                .client-details { margin-left: 30px; background: #f8f9fa; padding: 15px; border-radius: 5px; }
                                .invoice-details h4, .client-details h4 { color: #006666; font-size: 14px; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
                                .items-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                                .items-table th { background: #006666; color: white; padding: 10px; text-align: left; font-size: 11px; }
                                .items-table td { padding: 8px 10px; border-bottom: 1px solid #ddd; }
                                .items-table tr:nth-child(even) { background: #f8f9fa; }
                                .totals { float: right; width: 300px; }
                                .totals table { width: 100%; border-collapse: collapse; }
                                .totals td { padding: 5px 10px; }
                                .totals .total-row { background: #006666; color: white; font-weight: bold; }
                                .footer { margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 10px; color: #666; }
                                @media print { 
                                    body { print-color-adjust: exact; } 
                                    .invoice-container { padding: 0; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="invoice-container">
                                <div class="header">
                                    <div class="logo-section">
                                        <img src="./LOGO_EXPERTIA.jpg" alt="Expertia Medical Solutions" style="height: 60px; margin-bottom: 10px;">
                                        <p style="margin-top: 10px; font-weight: bold; font-size: 16px;">${invoice.type.toUpperCase()}</p>
                                        <p style="color: #666;">N¬∫: ${invoice.invoiceNumber || 'N/A'}</p>
                                    </div>
                                    <div class="company-info">
                                      <h3>${settings.company.name}</h3>
                                      <p>${settings.company.address}</p>
                                      ${settings.company.phone ? `<p>Tel: ${settings.company.phone}</p>` : ''}
                                      ${settings.company.email ? `<p>${settings.company.email}</p>` : ''}
                                      ${settings.company.website ? `<p><a href="${settings.company.website}">${settings.company.website}</a></p>` : ''}
                                    </div>
                                </div>

                                <div class="invoice-info">
                                    <div class="invoice-details">
                                        <h4>Detalles de la Factura</h4>
                                        <p><strong>Fecha de Factura:</strong> ${invoice.invoiceDate || 'N/A'}</p>
                                        <p><strong>Fecha de Vencimiento:</strong> ${invoice.dueDate || 'N/A'}</p>
                                        <p><strong>Serie:</strong> ${invoice.invoiceSeries || 'N/A'}</p>
                                        <p><strong>Estado:</strong> ${invoice.status || 'N/A'}</p>
                                    </div>
                                    <div class="client-details">
                                        <h4>Facturar a:</h4>
                                        ${client ? `
                                            <p><strong>${client.company || client.name}</strong></p>
                                            ${client.cifNifType && client.cifNifNumber ? `<p><strong>${client.cifNifType}:</strong> ${client.cifNifNumber}</p>` : ''}
                                            <p>${client.address || 'Direcci√≥n no especificada'}</p>
                                            <p>${client.postalCode || ''} ${client.city || ''}</p>
                                            <p>Att: ${client.name}</p>
                                            ${client.email ? `<p>Email: ${client.email}</p>` : ''}
                                            ${client.phone ? `<p>Tel: ${client.phone}</p>` : ''}
                                        ` : '<p>Cliente no encontrado</p>'}
                                    </div>
                                </div>

                                <table class="items-table">
                                    <thead>
                                        <tr>
                                            <th>Descripci√≥n</th>
                                            <th style="text-align: center;">N¬∫ Serie</th>
                                            <th style="width: 80px;">Cantidad</th>
                                            <th style="text-align: right;">Precio Unit.</th>
                                            <th style="text-align: right;">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${(invoice.items || []).map(item => `
                                            <tr>
                                                <td>${item.description || 'N/A'}</td>
                                                <td style="text-align: center;">${item.serialNumber || 'N/A'}</td>
                                                <td style="text-align: center;">${item.quantity || 0}</td>
                                                <td style="text-align: right;">${(parseFloat(item.price) || 0).toFixed(2)} ‚Ç¨</td>
                                                <td style="text-align: right;">${((parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0)).toFixed(2)} ‚Ç¨</td>
                                            </tr>
                                        `).join('')}
                                        ${(invoice.items || []).length === 0 ? '<tr><td colspan="4" style="text-align: center; color: #666;">No hay elementos en esta factura</td></tr>' : ''}
                                    </tbody>
                                </table>

                                <div class="totals">
                                    <table>
                                        <tr>
                                            <td style="text-align: right;"><strong>Subtotal:</strong></td>
                                            <td style="text-align: right;">${(invoice.subtotal || 0).toFixed(2)} ‚Ç¨</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: right;"><strong>IVA (21%):</strong></td>
                                            <td style="text-align: right;">${(invoice.vat || 0).toFixed(2)} ‚Ç¨</td>
                                        </tr>
                                        <tr class="total-row">
                                            <td style="text-align: right;"><strong>TOTAL:</strong></td>
                                            <td style="text-align: right;"><strong>${(invoice.total || 0).toFixed(2)} ‚Ç¨</strong></td>
                                        </tr>
                                    </table>
                                </div>

                                <div style="clear: both;"></div>

                                <div class="footer">
                                    <p><strong>Forma de pago:</strong> Transferencia bancaria</p>
                                    <p><strong>Cuenta bancaria:</strong> ES21 1234 5678 9012 3456 7890</p>
                                    <p>Gracias por confiar en ${settings.company.name}</p>
                                </div>
                            </div>
                        </body>
                        </html>
                    `;
                };

                // Funci√≥n para generar y descargar PDF de la factura
                const handleDownloadPDF = () => {
                    const settings = window.getSettings();
                    const printContent = generateInvoicePrintHTML(invoice, client, settings);
                    const printWindow = window.open('', '_blank', 'width=800,height=600');
                    printWindow.document.open();
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    printWindow.focus();
                    
                    // Abrir directamente el di√°logo de impresi√≥n
                    setTimeout(() => {
                        printWindow.print();
                    }, 250);
                };

                // Funci√≥n para enviar por correo
                const handleSendByEmail = async () => {
                    if (!client || !client.email) {
                        showNotification('Error de email', 'No se encontr√≥ el email del cliente. Por favor, verifica que el cliente tenga un email registrado.', 'error');
                        return;
                    }

                    // Preguntar si quiere generar PDF primero usando el modal personalizado
                    const userWantsPDF = await showConfirm(
                        'Generar PDF',
                        '¬øDeseas generar primero el PDF de la factura para adjuntarlo al email?',
                        () => {}, // onConfirm vac√≠o porque manejamos la Promise
                        'info'
                    );
                    
                    if (userWantsPDF) {
                        // Usuario confirm√≥ - generar PDF primero
                        handleDownloadPDF();
                        
                        // Esperar un momento y luego mostrar el email
                        setTimeout(() => {
                            openEmailCompose();
                            showNotification('PDF generado', 'No olvides adjuntar el PDF descargado al email antes de enviarlo.', 'info');
                        }, 1000);
                    } else {
                        // Usuario cancel√≥ o no quiere PDF - ir directo al email
                        openEmailCompose();
                    }
                };

                const openEmailCompose = () => {
                    const settings = window.getSettings();
                    const subject = `${settings.company.name} - Factura ${invoice.invoiceNumber} para ${client.name}`;
                    const body = `Estimado/a ${client.name},

Adjunto encontrar√° la factura ${invoice.invoiceNumber} correspondiente a los servicios prestados.

Detalles de la factura:
- N√∫mero: ${invoice.invoiceNumber}
- Fecha: ${invoice.invoiceDate}
- Importe: ${(invoice.total || 0).toFixed(2)} ‚Ç¨
- Estado: ${invoice.status}
${client.cifNifType && client.cifNifNumber ? `- ${client.cifNifType}: ${client.cifNifNumber}` : ''}

Si tiene alguna pregunta sobre esta factura, no dude en contactarnos.

Atentamente,

${settings.company.name}
Tel: ${settings.company.phone}
Email: ${settings.company.email}
Website: ${settings.company.website} `; 

                    const mailtoLink = `mailto:${client.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    // Abrir en nueva ventana/pesta√±a
                    window.open(mailtoLink, '_blank');
                };
                
                return (
                    <div className="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
                        <div className="flex justify-between items-start mb-8">
                            <div>
                                <img src="./LOGO_EXPERTIA.jpg" alt="Expertia Medical Solutions" className="h-14 mb-4" />
                                <h2 className="text-2xl font-bold text-gray-900 uppercase">{invoice.type}</h2>
                                <p className="text-gray-500">N¬∫: {invoice.invoiceNumber}</p>
                            </div>
                            <div className="text-right">
                                <div className="company-info">
                                    <strong>{settings.company.name}</strong><br />
                                    {settings.company.address}<br />
                                    {settings.company.phone && `Tel: ${settings.company.phone}`}<br />
                                    {settings.company.email && settings.company.email}<br />
                                    {settings.company.website && <a href={settings.company.website}>{settings.company.website}</a>}
                                </div>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-8 mb-8">
                            <div className="bg-gray-50 p-4 rounded-lg">
                                <h4 className="font-semibold text-gray-600 mb-2">Facturar a:</h4>
                                {client ? (
                                    <>
                                        <p className="font-bold">{client.company}</p>
                                        {client.cifNifType && client.cifNifNumber && (
                                            <p className="text-sm text-gray-600">
                                                {client.cifNifType}: {client.cifNifNumber}
                                            </p>
                                        )}
                                        <p>{formatAddress(client.address)}</p>
                                        <p>{client.postalCode} {client.city}</p>
                                        <p>Att: {client.name}</p>
                                    </>
                                ) : (
                                    <p>Cliente no encontrado</p>
                                )}
                            </div>
                            <div className="bg-gray-50 p-4 rounded-lg text-right">
                                <p><span className="font-semibold">Fecha Factura:</span> {invoice.invoiceDate}</p>
                                <p><span className="font-semibold">Vencimiento:</span> {invoice.dueDate}</p>
                                <p className="mt-2">
                                    <span className="font-semibold">Estado:</span> 
                                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ml-2 ${INVOICE_STATUSES[invoice.status]}`}>
                                        {invoice.status}
                                    </span>
                                </p>
                            </div>
                        </div>
                        
                        <table className="w-full text-left mb-8">
                            <thead className="bg-gray-100">
                                <tr>
                                    <th className="p-3">Descripci√≥n</th>
                                    <th className="p-3 text-center">N¬∫ Serie</th>
                                    <th className="p-3 text-center">Cantidad</th>
                                    <th className="p-3 text-right">Precio Unitario</th>
                                    <th className="p-3 text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {invoice.items.map((item, index) => (
                                    <tr key={index} className="border-b">
                                        <td className="p-3">{item.description}</td>
                                        <td className="p-3 text-center">{item.serialNumber}</td>
                                        <td className="p-3 text-center">{item.quantity}</td>
                                        <td className="p-3 text-right">{(parseFloat(item.price) || 0).toFixed(2)} ‚Ç¨</td>
                                        <td className="p-3 text-right">{(parseFloat(item.quantity) * parseFloat(item.price)).toFixed(2)} ‚Ç¨</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        
                        <div className="flex justify-between items-start">
                            <div className="w-1/2 pr-4">
                                <h4 className="font-semibold text-gray-600 mb-2">Pagos Registrados:</h4>
                                {payments.length > 0 ? (
                                    <ul className="text-sm space-y-1">
                                        {payments.map(p => (
                                            <li key={p.id} className="flex justify-between p-1 bg-gray-50 rounded">
                                                <span>{p.date?.toDate ? p.date.toDate().toLocaleDateString('es-ES') : (p.date ? new Date(p.date).toLocaleDateString('es-ES') : p.date)}:</span> 
                                                <span className="font-semibold">{p.amount.toFixed(2)} ‚Ç¨</span>
                                            </li>
                                        ))}
                                    </ul>
                                ) : (
                                    <p className="text-sm text-gray-500">No hay pagos registrados.</p>
                                )}
                                
                                {amountDue > 0 && (
                                    <form onSubmit={handlePaymentSubmit} className="mt-4">
                                        <h4 className="font-semibold text-gray-600 mb-2">Contabilizar Nuevo Pago:</h4>
                                        <div className="border border-gray-300 rounded-lg p-4 bg-gray-50">
                                        <div className="flex gap-2">
                                            <input 
                                                type="number" 
                                                step="0.01" 
                                                max={amountDue.toFixed(2)} 
                                                value={paymentAmount} 
                                                onChange={(e) => setPaymentAmount(e.target.value)} 
                                                    className="w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500" 
                                                placeholder="Importe" 
                                            />
                                            <button 
                                                type="submit" 
                                                className="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700"
                                            >
                                                Registrar
                                            </button>
                                            </div>
                                        </div>
                                    </form>
                                )}
                            </div>
                            
                            <div className="w-1/2 md:w-1/3 space-y-2 text-right">
                                <div className="flex justify-between">
                                    <span className="font-semibold">Subtotal:</span>
                                    <span>{invoice.subtotal.toFixed(2)} ‚Ç¨</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="font-semibold">IVA ({VAT_RATE * 100}%):</span>
                                    <span>{invoice.vat.toFixed(2)} ‚Ç¨</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="font-semibold">Total Factura:</span>
                                    <span className="font-semibold">{invoice.total.toFixed(2)} ‚Ç¨</span>
                                </div>
                                <div className="flex justify-between text-green-600">
                                    <span className="font-semibold">Total Pagado:</span>
                                    <span className="font-semibold">{amountPaid.toFixed(2)} ‚Ç¨</span>
                                </div>
                                <div className="flex justify-between border-t-2 border-gray-800 pt-2 mt-2">
                                    <span className="font-bold text-xl">Pendiente:</span>
                                    <span className="font-bold text-xl text-red-600">{amountDue.toFixed(2)} ‚Ç¨</span>
                                </div>
                            </div>
                        </div>
                        
                        <div className="mt-12 flex justify-end gap-4">
                            <button 
                                onClick={onBack} 
                                className="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300"
                            >
                                Volver
                            </button>
                            {invoice.type === 'Factura Proforma' && (
                                <button 
                                    onClick={() => onConvertToInvoice(invoice)} 
                                    className="bg-green-600 text-white font-bold py-2 px-4 rounded-lg"
                                >
                                    Convertir a Factura
                                </button>
                            )}
                            <button 
                                onClick={handlePrintInvoice}
                                className="bg-[#008080] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#006666] flex items-center gap-2"
                            >
                                <PrinterIcon width={16} height={16} />
                                Imprimir
                            </button>
                            <button 
                                onClick={handleDownloadPDF}
                                className="bg-[#006666] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#005555] flex items-center gap-2"
                            >
                                <DownloadIcon width={16} height={16} />
                                Descargar PDF
                            </button>
                            <button 
                                onClick={handleSendByEmail}
                                className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center gap-2"
                            >
                                <SendIcon width={16} height={16} />
                                Enviar por Email
                            </button>
                            {invoice.type !== 'Factura Rectificativa' && (
                                <button 
                                    onClick={() => onCreateRectificativa && onCreateRectificativa(invoice)} 
                                    className="bg-orange-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-700 flex items-center gap-2"
                                >
                                    <FileTextIcon className="w-4 h-4" />
                                    Crear rectificativa
                                </button>
                            )}
                        </div>
                    </div>
                );
            }

            // === DETALLE DE OFERTA ===
            function OfferDetail({ offer, clients, onBack, onAcceptOffer, onRejectOffer, onExpireOffer, onConvertToInvoice }) {
                if (!offer) return null;
                
                const client = clients.find(c => c.id === offer.clientId);
                const isExpired = new Date(offer.validUntil) < new Date();
                const canConvert = offer.status === 'Aceptada';
                
                // Obtener configuraciones din√°micas
                const settings = window.getSettings();

                const handleStatusUpdate = (newStatus) => {
                    switch(newStatus) {
                        case 'Aceptada':
                            onAcceptOffer(offer.id);
                            break;
                        case 'Rechazada':
                            onRejectOffer(offer.id);
                            break;
                        case 'Expirada':
                            onExpireOffer(offer.id);
                            break;
                    }
                };

                const handleSendOffer = (offer, client) => {
                    // Crear el asunto del email
                    const subject = `${settings.company.name} - Oferta ${offer.offerNumber} - ${client?.company || client?.name || 'Cliente'}`;
                    
                    // Generar la lista de items din√°micamente
                    const itemsList = offer.items?.map((item, index) => {
                        let itemText = `${index + 1}. ${item.description || 'Producto'}`;
                        
                        // Agregar n√∫mero de serie si existe
                        if (item.serialNumber) {
                            itemText += `\n   N¬∫ Serie: ${item.serialNumber}`;
                        }
                        
                        itemText += `\n   Cantidad: ${item.quantity}`;
                        itemText += `\n   Precio Unitario: ${(parseFloat(item.price) || 0).toFixed(2)} ‚Ç¨`;
                        itemText += `\n   Total: ${(parseFloat(item.quantity) * parseFloat(item.price)).toFixed(2)} ‚Ç¨`;
                        
                        return itemText;
                    }).join('\n\n') || 'No hay productos en esta oferta';

                    // Calcular totales
                    const subtotal = offer.items?.reduce((acc, item) => acc + (item.quantity * item.price), 0) || 0;
                    const vat = subtotal * 0.21;
                    const total = subtotal + vat;
                    
                    // Crear el cuerpo del email
                    const body = `Estimado/a cliente,

Adjuntamos la oferta ${offer.offerNumber} correspondiente a su consulta.

PRODUCTOS Y SERVICIOS:
${itemsList}

RESUMEN:
- Subtotal: ${subtotal.toFixed(2)} ‚Ç¨
- IVA (21%): ${vat.toFixed(2)} ‚Ç¨
- TOTAL: ${total.toFixed(2)} ‚Ç¨

DETALLES DE LA OFERTA:
- Fecha: ${offer.offerDate}
- V√°lida hasta: ${offer.validUntil}

${offer.description ? `Descripci√≥n: ${offer.description}` : ''}

Para cualquier consulta, no dude en contactarnos.

Atentamente,

${settings.company.name}
Tel: ${settings.company.phone}
Email: ${settings.company.email}
Website: ${settings.company.website}`;

                    // Crear el enlace mailto
                    const mailtoLink = `mailto:${client?.email || ''}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    
                    // Abrir el enlace en una nueva ventana
                    window.open(mailtoLink, '_blank');
                };

                const handlePrintOffer = (offer, client, settings) => {
                    // Crear contenido HTML para imprimir
                    const printContent = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Oferta ${offer.offerNumber}</title>
                            <style>
                                body { 
                                    font-family: Arial, sans-serif; 
                                    margin: 20px; 
                                    color: #333;
                                }
                                .header { 
                                    border-bottom: 2px solid #008080; 
                                    padding-bottom: 20px; 
                                    margin-bottom: 30px;
                                }
                                .company-info { 
                                    text-align: right; 
                                    color: #008080;
                                }
                                .offer-info { 
                                    display: grid; 
                                    grid-template-columns: 1fr 1fr; 
                                    gap: 30px; 
                                    margin-bottom: 30px;
                                }
                                .section { 
                                    background-color: #f8f9fa; 
                                    padding: 15px; 
                                    border-radius: 5px;
                                }
                                table { 
                                    width: 100%; 
                                    border-collapse: collapse; 
                                    margin: 20px 0;
                                }
                                th, td { 
                                    border: 1px solid #ddd; 
                                    padding: 12px; 
                                    text-align: left;
                                }
                                th { 
                                    background-color: #008080; 
                                    color: white;
                                }
                                .totals { 
                                    text-align: right; 
                                    margin-top: 20px;
                                    background-color: #f8f9fa;
                                    padding: 15px;
                                    border-radius: 5px;
                                }
                                .footer { 
                                    margin-top: 40px; 
                                    border-top: 1px solid #ddd; 
                                    padding-top: 20px; 
                                    font-size: 12px; 
                                    color: #666;
                                }
                                @media print {
                                    body { margin: 0; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h1 style="color: #008080; margin: 0;">OFERTA COMERCIAL</h1>
                                        <h2 style="margin: 5px 0 0 0;">${offer.offerNumber}</h2>
                                    </div>
                                    <div class="company-info" style="line-height: 1.3;">
                                    <h3 style="margin: 0 0 5px 0;">${settings.company.name}</h3>
                                    ${settings.company.address}<br>
                                    ${settings.company.phone ? `Tel: ${settings.company.phone}<br>` : ''}
                                    ${settings.company.email ? `${settings.company.email}<br>` : ''}
                                    ${settings.company.website ? `${settings.company.website}` : ''}
                                    </div>                          
                                </div>
                            </div>

                            <div class="offer-info">
                                <div class="section">
                                    <h3 style="margin-top: 0; color: #008080;">Informaci√≥n del Cliente</h3>
                                    <strong>${client?.company || client?.name || 'N/A'}</strong><br>
                                    ${client?.name ? `Att: ${client.name}<br>` : ''}
                                    ${client?.email ? `Email: ${client.email}<br>` : ''}
                                    ${client?.phone ? `Tel: ${client.phone}<br>` : ''}
                                </div>
                                <div class="section">
                                    <h3 style="margin-top: 0; color: #008080;">Detalles de la Oferta</h3>
                                    <strong>Fecha:</strong> ${offer.offerDate}<br>
                                    <strong>V√°lida hasta:</strong> ${offer.validUntil}<br>
                                    <strong>Estado:</strong> ${offer.status}<br>
                                    ${offer.description ? `<strong>Descripci√≥n:</strong> ${offer.description}` : ''}
                                </div>
                            </div>

                            <h3 style="color: #008080;">Items de la Oferta</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Descripci√≥n</th>
                                        <th style="text-align: center;">Referencia</th>
                                        <th style="text-align: center;">Cantidad</th>
                                        <th style="text-align: right;">Precio Unitario</th>
                                        <th style="text-align: right;">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${offer.items?.map(item => `
                                        <tr>
                                            <td>${item.description}</td>
                                            <td style="text-align: center;">${item.serialNumber}</td>
                                            <td style="text-align: center;">${item.quantity}</td>
                                            <td style="text-align: right;">${(parseFloat(item.price) || 0).toFixed(2)} ‚Ç¨</td>
                                            <td style="text-align: right;"><strong>${(parseFloat(item.quantity) * parseFloat(item.price)).toFixed(2)} ‚Ç¨</strong></td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="4">No hay items</td></tr>'}
                                </tbody>
                            </table>

                            <div class="totals">
                                <div style="margin-bottom: 10px;"><strong>Subtotal: ${offer.subtotal?.toFixed(2)} ‚Ç¨</strong></div>
                                ${offer.includeDiscount && offer.customDiscountRate > 0 ? `
                                    <div style="margin-bottom: 10px; color: #dc2626;"><strong>Descuento (${(offer.customDiscountRate * 100).toFixed(1)}%): -${((offer.subtotal || 0) * (offer.customDiscountRate || 0)).toFixed(2)} ‚Ç¨</strong></div>
                                ` : ''}
                                <div style="margin-bottom: 10px;"><strong>IVA (21%): ${offer.vat?.toFixed(2)} ‚Ç¨</strong></div>
                                <div style="font-size: 18px; color: #008080;"><strong>TOTAL: ${offer.total?.toFixed(2)} ‚Ç¨</strong></div>
                            </div>

                            ${offer.terms ? `
                                <div style="margin-top: 30px;">
                                    <h3 style="color: #008080;">T√©rminos y Condiciones</h3>
                                    <p style="background-color: #f8f9fa; padding: 15px; border-radius: 5px;">${offer.terms}</p>
                                </div>
                            ` : ''}

                            <div class="footer">
                                <p>Esta oferta ha sido generada autom√°ticamente por Expertia CRM el ${new Date().toLocaleDateString('es-ES')}.</p>
                                <p>Para cualquier consulta, no dude en contactarnos en los datos indicados arriba.</p>
                            </div>
                        </body>
                        </html>
                    `;

                    // Crear nueva ventana para imprimir
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    
                    // Esperar a que se cargue el contenido y despu√©s imprimir
                    printWindow.onload = () => {
                        printWindow.print();
                    };
                };

                return (
                    <div className="max-w-4xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-[#008080] to-[#006666] text-white p-6">
                            <div className="flex justify-between items-start">
                                <div>
                                    <h1 className="text-2xl font-bold flex items-center gap-2">
                                        <BriefcaseIcon width={24} height={24} /> Oferta {offer.offerNumber}
                                    </h1>
                                    <p className="text-blue-100 mt-1">Serie: {offer.offerSeries}</p>
                                </div>
                                <div className="text-right">
                                    <span className={`px-3 py-1 text-xs font-semibold rounded-full ml-2 ${OFFER_STATUSES[offer.status]}`}>
                                        {offer.status}
                                    </span>
                                    {isExpired && offer.status !== 'Expirada' && (
                                        <div className="text-yellow-200 text-sm mt-2 flex items-center gap-1">
                                            <AlertTriangleIcon width={14} height={14} /> Oferta expirada
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="p-6 space-y-6">
                            {/* Informaci√≥n del cliente y fechas */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        <UserIcon width={20} height={20} /> Informaci√≥n del Cliente
                                    </h3>
                                    <div className="bg-gray-50 p-4 rounded-lg space-y-2">
                                        <div><strong>Nombre:</strong> {client?.name || 'N/A'}</div>
                                        <div><strong>Empresa:</strong> {client?.company || 'N/A'}</div>
                                        <div><strong>Email:</strong> {client?.email || 'N/A'}</div>
                                        <div><strong>Tel√©fono:</strong> {client?.phone || 'N/A'}</div>
                                    </div>
                                </div>
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        <BriefcaseIcon width={20} height={20} /> Informaci√≥n de la Oferta
                                    </h3>
                                    <div className="bg-gray-50 p-4 rounded-lg space-y-2">
                                        <div><strong>Fecha:</strong> {offer.offerDate}</div>
                                        <div><strong>V√°lida hasta:</strong> {offer.validUntil}</div>
                                        <div><strong>Descripci√≥n:</strong> {offer.description || 'Sin descripci√≥n'}</div>
                                    </div>
                                </div>
                            </div>

                            {/* Items */}
                            <div>
                                <h3 className="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                    <PackageIcon width={20} height={20} /> Items de la Oferta
                                </h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full border border-gray-200 rounded-lg">
                                        <thead className="bg-gray-100">
                                            <tr>
                                                <th className="text-left p-3 border-b">Descripci√≥n</th>
                                                <th className="text-center p-3 border-b">Referencia</th>
                                                <th className="text-center p-3 border-b">Cantidad</th>
                                                <th className="text-right p-3 border-b">Precio Unitario</th>
                                                <th className="text-right p-3 border-b">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {offer.items?.map((item, index) => (
                                                <tr key={index} className="border-b">
                                                    <td className="p-3">{item.description}</td>
                                                    <td className="p-3 text-center">{item.serialNumber}</td>
                                                    <td className="p-3 text-center">{item.quantity}</td>
                                                    <td className="p-3 text-right">{(parseFloat(item.price) || 0).toFixed(2)} ‚Ç¨</td>
                                                    <td className="p-3 text-right font-semibold">{(parseFloat(item.quantity) * parseFloat(item.price)).toFixed(2)} ‚Ç¨</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {/* T√©rminos y condiciones */}
                            {offer.terms && (
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        <FileTextIcon width={20} height={20} /> T√©rminos y Condiciones
                                    </h3>
                                    <div className="bg-gray-50 p-4 rounded-lg">
                                        <p className="text-gray-700 whitespace-pre-line">{offer.terms}</p>
                                    </div>
                                </div>
                            )}

                            {/* Totales */}
                            <div className="bg-gray-50 p-4 rounded-lg">
                                <div className="grid grid-cols-4 gap-4 text-right">
                                    <div>
                                        <div className="text-sm text-gray-600">Subtotal:</div>
                                        <div className="font-semibold text-lg">{offer.subtotal?.toFixed(2)} ‚Ç¨</div>
                                    </div>
                                    {offer.includeDiscount && offer.customDiscountRate > 0 ? (
                                        <div>
                                            <div className="text-sm text-gray-600">Descuento ({(offer.customDiscountRate * 100).toFixed(1)}%):</div>
                                            <div className="font-semibold text-lg text-red-600">-{((offer.subtotal || 0) * (offer.customDiscountRate || 0)).toFixed(2)} ‚Ç¨</div>
                                        </div>
                                    ) : (
                                        <div>
                                            <div className="text-sm text-gray-600">Descuento:</div>
                                            <div className="font-semibold text-lg text-gray-500">Sin descuento</div>
                                        </div>
                                    )}
                                    <div>
                                        <div className="text-sm text-gray-600">IVA:</div>
                                        <div className="font-semibold text-lg">{offer.vat?.toFixed(2)} ‚Ç¨</div>
                                    </div>
                                    <div>
                                        <div className="text-sm text-gray-600">Total:</div>
                                        <div className="text-2xl font-bold text-[#008080]">{offer.total?.toFixed(2)} ‚Ç¨</div>
                                    </div>
                                </div>
                            </div>

                            {/* Acciones */}
                            <div className="border-t pt-6">
                                <div className="flex flex-col sm:flex-row justify-between gap-4">
                                    <button 
                                        onClick={onBack} 
                                        className="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300"
                                    >
                                        ‚Üê Volver
                                    </button>
                                    
                                    <div className="flex flex-col sm:flex-row gap-2">
                                        {/* Botones de utilidades */}
                                        <button 
                                            onClick={() => handleSendOffer(offer, client)} 
                                            className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center gap-2"
                                        >
                                            <MailIcon width={16} height={16} /> Enviar Oferta
                                        </button>
                                        
                                        <button 
                                            onClick={() => handlePrintOffer(offer, client, settings)} 
                                            className="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 flex items-center gap-2"
                                        >
                                            <PrinterIcon width={16} height={16} /> Imprimir Oferta
                                        </button>
                                        
                                        {/* Acciones de estado */}
                                        {offer.status === 'Borrador' && (
                                            <button 
                                                onClick={() => handleStatusUpdate('Enviada')} 
                                                className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center gap-2"
                                            >
                                                <MailIcon width={16} height={16} /> Marcar como Enviada
                                            </button>
                                        )}
                                        
                                        {offer.status === 'Enviada' && !isExpired && (
                                            <>
                                                <button 
                                                    onClick={() => handleStatusUpdate('Aceptada')} 
                                                    className="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center gap-2"
                                                >
                                                    <CheckIcon width={16} height={16} /> Marcar como Aceptada
                                                </button>
                                                <button 
                                                    onClick={() => handleStatusUpdate('Rechazada')} 
                                                    className="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 flex items-center gap-2"
                                                >
                                                    <XCircleIcon width={16} height={16} /> Marcar como Rechazada
                                                </button>
                                            </>
                                        )}

                                        {isExpired && offer.status !== 'Expirada' && (
                                            <button 
                                                onClick={() => handleStatusUpdate('Expirada')} 
                                                className="bg-orange-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-700 flex items-center gap-2"
                                            >
                                                <ClockIcon width={16} height={16} /> Marcar como Expirada
                                            </button>
                                        )}

                                        {/* Convertir a factura */}
                                        {canConvert && (
                                            <button 
                                                onClick={() => onConvertToInvoice(offer)} 
                                                className="bg-[#008080] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#006666] flex items-center gap-2"
                                            >
                                                <FileTextIcon width={16} height={16} /> Convertir a Factura
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // üöÄ MEJORA 3/4: Utilidades de exportaci√≥n Excel/PDF
            const ExportUtils = {
                // Exportar datos a Excel
                exportToExcel: (data, filename = 'datos_expertia') => {
                    try {
                        const wb = XLSX.utils.book_new();
                        
                        // Hoja principal con datos de ventas
                        const salesData = data.invoices.map(inv => ({
                            'Fecha': new Date(inv.createdAt?.seconds * 1000 || inv.createdAt).toLocaleDateString('es-ES'),
                            'N¬∫ Factura': inv.invoiceNumber,
                            'Cliente': inv.clientName,
                            'Comercial': inv.createdByName || inv.createdBy || 'N/A',
                            'Total (‚Ç¨)': parseFloat(inv.total || 0).toFixed(2),
                            'IVA (‚Ç¨)': parseFloat(inv.vat || 0).toFixed(2),
                            'Estado': inv.status,
                            'Productos': inv.items?.map(item => item.description).join(', ') || 'N/A'
                        }));
                        
                        const ws1 = XLSX.utils.json_to_sheet(salesData);
                        XLSX.utils.book_append_sheet(wb, ws1, "Ventas Detalladas");
                        
                        // Hoja de resumen estad√≠stico
                        const statsData = [
                            { 'M√©trica': 'Ventas Totales', 'Valor': `${data.totalSales.toFixed(2)} ‚Ç¨` },
                            { 'M√©trica': 'N√∫mero de Facturas', 'Valor': data.totalInvoices },
                            { 'M√©trica': 'Ticket Medio', 'Valor': `${data.averageTicket.toFixed(2)} ‚Ç¨` },
                            { 'M√©trica': 'IVA Total', 'Valor': `${data.totalVat.toFixed(2)} ‚Ç¨` },
                            { 'M√©trica': 'Fecha Generaci√≥n', 'Valor': new Date().toLocaleDateString('es-ES') }
                        ];
                        
                        const ws2 = XLSX.utils.json_to_sheet(statsData);
                        XLSX.utils.book_append_sheet(wb, ws2, "Resumen Estad√≠stico");
                        
                        // Hoja de top productos
                        if (data.topProducts && data.topProducts.length > 0) {
                            const productsData = data.topProducts.map((product, index) => ({
                                'Posici√≥n': index + 1,
                                'Producto': product.name,
                                'Ingresos (‚Ç¨)': product.revenue.toFixed(2),
                                'Unidades Vendidas': product.quantity,
                                'Precio Medio (‚Ç¨)': (product.revenue / product.quantity).toFixed(2)
                            }));
                            
                            const ws3 = XLSX.utils.json_to_sheet(productsData);
                            XLSX.utils.book_append_sheet(wb, ws3, "Top Productos");
                        }
                        
                        // Guardar archivo
                        XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
                        return true;
                    } catch (error) {
                        console.error('Error exportando Excel:', error);
                        return false;
                    }
                },
                
                // Exportar a PDF con gr√°ficos
                exportToPDF: async (data, filename = 'informe_expertia') => {
                    try {
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        
                        // Configuraci√≥n de colores
                        const primaryColor = [0, 128, 128]; // #008080
                        const secondaryColor = [102, 102, 102];
                        
                        // Funci√≥n para a√±adir encabezado
                        const addHeader = (pageNum) => {
                            pdf.setFillColor(...primaryColor);
                            pdf.rect(0, 0, 210, 25, 'F');
                            
                            pdf.setTextColor(255, 255, 255);
                            pdf.setFontSize(20);
                            pdf.setFont('helvetica', 'bold');
                            pdf.text('EXPERTIA CRM - Informe de Ventas', 15, 16);
                            
                            pdf.setFontSize(10);
                            pdf.setFont('helvetica', 'normal');
                            pdf.text(`P√°gina ${pageNum}`, 170, 20);
                            pdf.text(new Date().toLocaleDateString('es-ES'), 15, 20);
                        };
                        
                        // P√°gina 1: Resumen ejecutivo
                        addHeader(1);
                        pdf.setTextColor(...secondaryColor);
                        
                        // Estad√≠sticas principales
                        pdf.setFontSize(14);
                        pdf.setFont('helvetica', 'bold');
                        pdf.text(' RESUMEN EJECUTIVO', 15, 40);
                        
                        pdf.setFontSize(11);
                        pdf.setFont('helvetica', 'normal');
                        
                        const stats = [
                            ` Ventas Totales: ${data.totalSales.toFixed(2)} ‚Ç¨`,
                            ` N√∫mero de Facturas: ${data.totalInvoices}`,
                            ` Ticket Medio: ${data.averageTicket.toFixed(2)} ‚Ç¨`,
                            ` IVA Recaudado: ${data.totalVat.toFixed(2)} ‚Ç¨`,
                            ` Per√≠odo Analizado: ${data.dateFilter === 'all' ? 'Todo el tiempo' : data.dateFilter}`
                        ];
                        
                        stats.forEach((stat, index) => {
                            pdf.text(stat, 15, 55 + (index * 8));
                        });
                        
                        // Top productos
                        if (data.topProducts && data.topProducts.length > 0) {
                            pdf.setFontSize(14);
                            pdf.setFont('helvetica', 'bold');
                            pdf.text('TOP PRODUCTOS', 15, 105);
                            
                            pdf.setFontSize(10);
                            pdf.setFont('helvetica', 'normal');
                            
                            data.topProducts.slice(0, 5).forEach((product, index) => {
                                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                                pdf.text(`${medal} ${product.name}: ${product.revenue.toFixed(2)} ‚Ç¨ (${product.quantity} uds)`, 15, 120 + (index * 6));
                            });
                        }
                        
                        // Capturar gr√°ficos si existen
                        const chartElements = document.querySelectorAll('.bg-white.p-6.rounded-lg.shadow-lg, .bg-white.p-6.rounded-lg.shadow');
                        if (chartElements.length > 0) {
                            pdf.addPage();
                            addHeader(2);
                            
                            pdf.setFontSize(14);
                            pdf.setFont('helvetica', 'bold');
                            pdf.text('üìà GR√ÅFICOS Y AN√ÅLISIS', 15, 40);
                            
                            let yPosition = 60;
                            for (let i = 0; i < Math.min(chartElements.length, 2); i++) {
                                try {
                                    const canvas = await html2canvas(chartElements[i], {
                                        scale: 2,
                                        backgroundColor: '#ffffff',
                                        width: 800,
                                        height: 400
                                    });
                                    
                                    const imgData = canvas.toDataURL('image/png');
                                    pdf.addImage(imgData, 'PNG', 15, yPosition, 180, 90);
                                    yPosition += 100;
                                    
                                    if (i === 0 && chartElements.length > 1) {
                                        pdf.addPage();
                                        addHeader(i + 3);
                                        yPosition = 40;
                                    }
                                } catch (error) {
                                    console.warn('Error capturando gr√°fico:', error);
                                }
                            }
                        }
                        
                        // Pie de p√°gina en todas las p√°ginas
                        const totalPages = pdf.internal.getNumberOfPages();
                        for (let i = 1; i <= totalPages; i++) {
                            pdf.setPage(i);
                            pdf.setFontSize(8);
                            pdf.setTextColor(...secondaryColor);
                            pdf.text('Generado por Expertia CRM - Todos los derechos reservados', 15, 290);
                        }
                        
                        // Guardar PDF
                        pdf.save(`${filename}_${new Date().toISOString().split('T')[0]}.pdf`);
                        return true;
                    } catch (error) {
                        console.error('Error exportando PDF:', error);
                        return false;
                    }
                },
                
                // Copiar datos al portapapeles
                copyToClipboard: (data) => {
                    try {
                        const text = `EXPERTIA CRM - Resumen de Ventas
 ${new Date().toLocaleDateString('es-ES')}

ESTAD√çSTICAS:
Ventas Totales: ${data.totalSales.toFixed(2)} ‚Ç¨
Facturas: ${data.totalInvoices}
Ticket Medio: ${data.averageTicket.toFixed(2)} ‚Ç¨
IVA: ${data.totalVat.toFixed(2)} ‚Ç¨

TOP PRODUCTOS:
${data.topProducts.slice(0, 5).map((p, i) => 
    `${i + 1}. ${p.name}: ${p.revenue.toFixed(2)} ‚Ç¨ (${p.quantity} uds)`
).join('\n')}`;
                        
                        navigator.clipboard.writeText(text);
                        return true;
                    } catch (error) {
                        console.error('Error copiando al portapapeles:', error);
                        return false;
                    }
                }
            };

            // === DASHBOARD DE INFORMES Y ESTAD√çSTICAS ===
            function ReportsDashboard({ allInvoices, userProfile }) {
                const [productFilter, setProductFilter] = useState('all');
                const [salespersonFilter, setSalespersonFilter] = useState('all');
                const [dateFilter, setDateFilter] = useState('all');
                
                // Verificar si Recharts est√° disponible
                const hasRecharts = typeof window.Recharts !== 'undefined' && window.rechartsAvailable;
                
                const paidInvoices = allInvoices.filter(inv => 
                    inv.status === 'Pagada' || inv.status === 'Parcialmente Pagada'
                );

                const productOptions = useMemo(() => {
                    const products = new Set();
                    paidInvoices.forEach(inv => {
                        if (inv.items) {
                            inv.items.forEach(item => { 
                                if(item.description) products.add(item.description);
                            });
                        }
                    });
                    return ['all', ...Array.from(products)];
                }, [paidInvoices]);

                const salespersonOptions = useMemo(() => {
                    const salespersons = new Set();
                    paidInvoices.forEach(inv => { 
                        if(inv.createdBy) {
                            // Intentar obtener el nombre del usuario, o usar UID como fallback
                            const userName = inv.createdByName || 
                                           (userProfile?.name) || 
                                           (userProfile?.email) || 
                                           inv.createdBy;
                            salespersons.add(userName);
                        }
                    });
                    return ['all', ...Array.from(salespersons)];
                }, [paidInvoices, userProfile]);

                const filteredInvoices = useMemo(() => {
                    return paidInvoices.filter(inv => {
                        const productMatch = productFilter === 'all' || 
                            (inv.items && inv.items.some(item => item.description === productFilter));
                        
                        const salespersonMatch = salespersonFilter === 'all' || 
                            inv.createdBy === salespersonFilter || 
                            (inv.createdByName && inv.createdByName === salespersonFilter) ||
                            (userProfile?.name && userProfile.name === salespersonFilter) ||
                            (userProfile?.email && userProfile.email === salespersonFilter);
                        
                        let dateMatch = true;
                        if (dateFilter !== 'all') {
                            const invDate = new Date(inv.invoiceDate);
                            const now = new Date();
                            switch(dateFilter) {
                                case 'thisMonth':
                                    dateMatch = invDate.getMonth() === now.getMonth() && 
                                              invDate.getFullYear() === now.getFullYear();
                                    break;
                                case 'lastMonth':
                                    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1);
                                    dateMatch = invDate.getMonth() === lastMonth.getMonth() && 
                                              invDate.getFullYear() === lastMonth.getFullYear();
                                    break;
                                case 'thisYear':
                                    dateMatch = invDate.getFullYear() === now.getFullYear();
                                    break;
                                case 'lastYear':
                                    dateMatch = invDate.getFullYear() === now.getFullYear() - 1;
                                    break;
                            }
                        }
                        
                        return productMatch && salespersonMatch && dateMatch;
                    });
                }, [paidInvoices, productFilter, salespersonFilter, dateFilter]);

                const salesByMonth = useMemo(() => {
                    const monthlyData = {};
                    const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                    
                    filteredInvoices.forEach(inv => {
                        const date = new Date(inv.invoiceDate);
                        if (isNaN(date.getTime())) return;
                        
                        const month = date.getMonth();
                        const year = date.getFullYear();
                        const key = `${year}-${monthNames[month]}`;
                        
                        if (!monthlyData[key]) monthlyData[key] = 0;
                        monthlyData[key] += inv.total;
                    });
                    
                    return Object.entries(monthlyData)
                        .map(([name, Ventas]) => ({ 
                            name, 
                            Ventas: parseFloat(Ventas.toFixed(2)) 
                        }))
                        .sort((a, b) => {
                            const [yearA, monthA] = a.name.split('-');
                            const [yearB, monthB] = b.name.split('-');
                            const dateA = new Date(yearA, monthNames.indexOf(monthA));
                            const dateB = new Date(yearB, monthNames.indexOf(monthB));
                            return dateA - dateB;
                        });
                }, [filteredInvoices]);

                const salesByQuarter = useMemo(() => {
                    const quarterlyData = {};
                    
                    filteredInvoices.forEach(inv => {
                        const date = new Date(inv.invoiceDate);
                        if (isNaN(date.getTime())) return;
                        
                        const year = date.getFullYear();
                        const quarter = Math.floor(date.getMonth() / 3) + 1;
                        const key = `${year}-T${quarter}`;
                        
                        if (!quarterlyData[key]) quarterlyData[key] = 0;
                        quarterlyData[key] += inv.total;
                    });
                    
                    return Object.entries(quarterlyData)
                        .map(([name, Ventas]) => ({ 
                            name, 
                            Ventas: parseFloat(Ventas.toFixed(2)) 
                        }))
                        .sort((a, b) => a.name.localeCompare(b.name));
                }, [filteredInvoices]);

                const topProducts = useMemo(() => {
                    const productSales = {};
                    
                    filteredInvoices.forEach(inv => {
                        if (inv.items) {
                            inv.items.forEach(item => {
                                if (item.description) {
                                    if (!productSales[item.description]) {
                                        productSales[item.description] = {
                                            name: item.description,
                                            quantity: 0,
                                            revenue: 0
                                        };
                                    }
                                    productSales[item.description].quantity += item.quantity;
                                    productSales[item.description].revenue += item.quantity * item.price;
                                }
                            });
                        }
                    });
                    
                    return Object.values(productSales)
                        .sort((a, b) => b.revenue - a.revenue)
                        .slice(0, 5);
                }, [filteredInvoices]);

                // üöÄ MEJORA 4/4: Datos adicionales para nuevos gr√°ficos minimalistas
                const salesBySalesperson = useMemo(() => {
                    const salespersonSales = {};
                    
                    filteredInvoices.forEach(invoice => {
                        const salesperson = invoice.createdByName || invoice.createdBy || 'Sin asignar';
                        if (!salespersonSales[salesperson]) {
                            salespersonSales[salesperson] = {
                                name: salesperson,
                                value: 0,
                                count: 0
                            };
                        }
                        salespersonSales[salesperson].value += parseFloat(invoice.total || 0);
                        salespersonSales[salesperson].count += 1;
                    });
                    
                    return Object.values(salespersonSales)
                        .filter(item => item.value > 0)
                        .sort((a, b) => b.value - a.value);
                }, [filteredInvoices]);

                const monthlyTrend = useMemo(() => {
                    const last6Months = [];
                    const currentDate = new Date();
                    
                    // Generar √∫ltimos 6 meses
                    for (let i = 5; i >= 0; i--) {
                        const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                        const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                        const monthName = date.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' });
                        
                        last6Months.push({
                            name: monthName,
                            key: monthKey,
                            Ventas: 0
                        });
                    }
                    
                    // Calcular ventas por mes
                    filteredInvoices.forEach(invoice => {
                        const invoiceDate = new Date(invoice.createdAt?.seconds * 1000 || invoice.createdAt);
                        const monthKey = `${invoiceDate.getFullYear()}-${(invoiceDate.getMonth() + 1).toString().padStart(2, '0')}`;
                        
                        const monthData = last6Months.find(month => month.key === monthKey);
                        if (monthData) {
                            monthData.Ventas += parseFloat(invoice.total || 0);
                        }
                    });
                    
                    return last6Months.filter(month => month.Ventas > 0);
                }, [filteredInvoices]);

                // üöÄ C√ÅLCULOS CORREGIDOS: Facturas cobradas y pendientes
                const invoicesByStatus = useMemo(() => {
                    const issued = allInvoices.filter(inv => 
                        inv.status === 'Enviada' || 
                        inv.status === 'Parcialmente Pagada' || 
                        inv.status === 'Pagada'
                    );
                    const paid = allInvoices.filter(inv => inv.status === 'Pagada');
                    const partiallyPaid = allInvoices.filter(inv => inv.status === 'Parcialmente Pagada');
                    const pending = allInvoices.filter(inv => inv.status === 'Enviada');
                    
                    return {
                        totalInvoices: issued.length,
                        issued: issued.length,
                        paid: paid.length,
                        partiallyPaid: partiallyPaid.length,
                        pending: pending.length
                    };
                }, [allInvoices]);

                const financialTotals = useMemo(() => {
                    const totalEmitted = allInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
                    const totalCollected = allInvoices.reduce((sum, inv) => sum + (inv.totalPaid || 0), 0);
                    const totalPending = totalEmitted - totalCollected;
                    
                    return {
                        totalEmitted,
                        totalCollected,
                        totalPending,
                        collectionRate: totalEmitted > 0 ? (totalCollected / totalEmitted) * 100 : 0
                    };
                }, [allInvoices]);

                const totalSales = useMemo(() => 
                    filteredInvoices.reduce((sum, inv) => sum + inv.total, 0), 
                    [filteredInvoices]
                );

                const averageTicket = useMemo(() => 
                    filteredInvoices.length > 0 ? totalSales / filteredInvoices.length : 0, 
                    [totalSales, filteredInvoices.length]
                );

                const totalInvoices = filteredInvoices.length;
                const totalVat = useMemo(() => 
                    filteredInvoices.reduce((sum, inv) => sum + (inv.vat || 0), 0), 
                    [filteredInvoices]
                );

                // üöÄ MEJORA 2/4: Componente de gr√°fico interactivo como fallback
                const SimpleBarChart = ({ data, title }) => {
                    const [hoveredIndex, setHoveredIndex] = React.useState(null);
                    const [isVisible, setIsVisible] = React.useState(false);
                    
                    React.useEffect(() => {
                        // Animaci√≥n de entrada
                        const timer = setTimeout(() => setIsVisible(true), 100);
                        return () => clearTimeout(timer);
                    }, []);

                    // Validar datos
                    if (!data || !Array.isArray(data) || data.length === 0) {
                        return (
                            <div className="bg-white p-6 rounded-lg shadow-lg">
                                <h3 className="text-xl font-semibold mb-4 text-gray-800">{title}</h3>
                                <p className="text-gray-500 text-center py-8">No hay datos disponibles</p>
                            </div>
                        );
                    }

                    // Filtrar datos v√°lidos
                    const validData = data.filter(d => d && d.Ventas && !isNaN(d.Ventas));
                    if (validData.length === 0) {
                        return (
                            <div className="bg-white p-6 rounded-lg shadow-lg">
                                <h3 className="text-xl font-semibold mb-4 text-gray-800">{title}</h3>
                                <p className="text-gray-500 text-center py-8">No hay datos v√°lidos disponibles</p>
                            </div>
                        );
                    }

                    const maxValue = Math.max(...validData.map(d => d.Ventas));
                    const totalValue = validData.reduce((sum, item) => sum + item.Ventas, 0);
                    
                    return (
                        <div className={`bg-white p-6 rounded-lg shadow-lg transition-all duration-500 transform ${
                            isVisible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'
                        }`}>
                            <h3 className="text-xl font-semibold mb-4 text-gray-800 flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <BarChartIcon width={20} height={20} className="text-[#008080]" />
                                    {title}
                                </div>
                                <div className="text-sm text-gray-500 font-normal">
                                    Total: <span className="font-bold text-[#008080]">{totalValue.toFixed(0)} ‚Ç¨</span>
                                </div>
                            </h3>
                            
                            <div className="space-y-3">
                                {validData.slice(0, 6).map((item, index) => {
                                    const percentage = (item.Ventas / maxValue) * 100;
                                    const isHovered = hoveredIndex === index;
                                    const marketShare = ((item.Ventas / totalValue) * 100).toFixed(1);
                                    
                                    return (
                                        <div 
                                            key={item.name} 
                                            className="relative group"
                                            onMouseEnter={() => setHoveredIndex(index)}
                                            onMouseLeave={() => setHoveredIndex(null)}
                                        >
                                            <div className={`flex items-center gap-3 p-2 rounded-lg transition-all duration-300 ${
                                                isHovered ? 'bg-[#008080]/5 shadow-md transform scale-105' : 'hover:bg-gray-50'
                                            }`}>
                                                <div className="w-24 text-sm text-gray-700 font-medium truncate" title={item.name}>
                                                    {item.name}
                                                </div>
                                                <div className="flex-1 bg-gray-200 rounded-full h-8 relative overflow-hidden shadow-inner">
                                                    <div 
                                                        className={`h-8 rounded-full flex items-center justify-end pr-3 transition-all duration-1000 ease-out ${
                                                            isHovered 
                                                                ? 'bg-gradient-to-r from-[#008080] to-[#00a6a6] shadow-lg'
                                                                : 'bg-gradient-to-r from-[#008080] to-[#006666]'
                                                        }`}
                                                        style={{ 
                                                            width: isVisible ? `${percentage}%` : '0%',
                                                            animation: isVisible ? `growBar-${index} 1s ease-out ${index * 0.1}s both` : 'none'
                                                        }}
                                                    >
                                                        <span className="text-white text-xs font-bold">
                                                            {item.Ventas.toFixed(0)} ‚Ç¨
                                                        </span>
                                                        
                                                        {/* Brillo animado */}
                                                        <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent transform -skew-x-12 opacity-0 group-hover:opacity-100 transition-opacity duration-300 animate-pulse"></div>
                                                    </div>
                                                    
                                                    {/* Tooltip interactivo */}
                                                    {isHovered && (
                                                        <div className="absolute -top-12 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-3 py-2 rounded-lg text-xs font-medium shadow-xl z-10 animate-bounce">
                                                            <div className="text-center">
                                                                <div>{item.Ventas.toFixed(2)} ‚Ç¨</div>
                                                                <div className="text-gray-300">{marketShare}% del total</div>
                                                            </div>
                                                            <div className="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                                        </div>
                                                    )}
                                                </div>
                                                
                                                {/* Indicador de posici√≥n */}
                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold transition-all duration-300 ${
                                                    index === 0 ? 'bg-yellow-100 text-yellow-700' :
                                                    index === 1 ? 'bg-gray-100 text-gray-700' :
                                                    index === 2 ? 'bg-orange-100 text-orange-700' :
                                                    'bg-blue-100 text-blue-700'
                                                } ${isHovered ? 'transform scale-110 shadow-lg' : ''}`}>
                                                    #{index + 1}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            
                            {/* Leyenda estad√≠stica */}
                            <div className="mt-4 pt-4 border-t border-gray-200">
                                <div className="grid grid-cols-2 gap-4 text-sm">
                                    <div className="text-center">
                                        <div className="text-gray-500">Promedio</div>
                                        <div className="font-bold text-[#008080]">
                                            {(totalValue / data.length).toFixed(0)} ‚Ç¨
                                        </div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-gray-500">M√°ximo</div>
                                        <div className="font-bold text-green-600">
                                            {maxValue.toFixed(0)} ‚Ç¨
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* A√±adir estilos de animaci√≥n */}
                            <style>{`
                                ${validData.map((_, index) => `
                                    @keyframes growBar-${index} {
                                        from { width: 0%; }
                                        to { width: ${(validData[index].Ventas / maxValue) * 100}%; }
                                    }
                                `).join('')}
                            `}</style>
                        </div>
                    );
                };

                // üöÄ MEJORA 2/4: Componente de gr√°fico circular interactivo como fallback
                const SimplePieChart = ({ data, title }) => {
                    const [selectedSegment, setSelectedSegment] = React.useState(null);
                    const [isVisible, setIsVisible] = React.useState(false);
                    
                    React.useEffect(() => {
                        const timer = setTimeout(() => setIsVisible(true), 200);
                        return () => clearTimeout(timer);
                    }, []);

                    const total = data.reduce((sum, item) => sum + item.Ventas, 0);
                    const colors = ['#008080', '#00a6a6', '#20b2aa', '#4fb3b3', '#7dcccc', '#aadddd'];
                    
                    let currentAngle = 0;
                    const segments = data.slice(0, 6).map((item, index) => {
                        const percentage = (item.Ventas / total) * 100;
                        const angle = (item.Ventas / total) * 360;
                        const startAngle = currentAngle;
                        currentAngle += angle;
                        
                        return {
                            ...item,
                            percentage,
                            angle,
                            startAngle,
                            color: colors[index % colors.length]
                        };
                    });

                    const createPath = (centerX, centerY, radius, startAngle, endAngle) => {
                        const start = polarToCartesian(centerX, centerY, radius, endAngle);
                        const end = polarToCartesian(centerX, centerY, radius, startAngle);
                        const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
                        return [
                            "M", centerX, centerY, 
                            "L", start.x, start.y, 
                            "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y,
                            "Z"
                        ].join(" ");
                    };

                    const polarToCartesian = (centerX, centerY, radius, angleInDegrees) => {
                        const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
                        return {
                            x: centerX + (radius * Math.cos(angleInRadians)),
                            y: centerY + (radius * Math.sin(angleInRadians))
                        };
                    };

                    return (
                        <div className={`bg-white p-6 rounded-lg shadow-lg transition-all duration-500 transform ${
                            isVisible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'
                        }`}>
                            <h3 className="text-xl font-semibold mb-6 text-gray-800 flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <svg className="w-5 h-5 text-[#008080]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                                    </svg>
                                    {title}
                                </div>
                                <div className="text-sm text-gray-500 font-normal">
                                    Total: <span className="font-bold text-[#008080]">{total.toFixed(0)} ‚Ç¨</span>
                                </div>
                            </h3>
                            
                            <div className="flex flex-col lg:flex-row gap-6">
                                {/* Gr√°fico circular SVG */}
                                <div className="flex-shrink-0 flex justify-center">
                                    <div className="relative">
                                        <svg width="200" height="200" className="transform -rotate-90">
                                            {segments.map((segment, index) => {
                                                const isSelected = selectedSegment === index;
                                                const radius = isSelected ? 85 : 80;
                                                const path = createPath(100, 100, radius, segment.startAngle, segment.startAngle + segment.angle);
                                                
                                                return (
                                                    <g key={index}>
                                                        <path
                                                            d={path}
                                                            fill={segment.color}
                                                            stroke="white"
                                                            strokeWidth="2"
                                                            className={`cursor-pointer transition-all duration-300 ${
                                                                isSelected ? 'drop-shadow-lg' : 'hover:brightness-110'
                                                            }`}
                                                            style={{
                                                                opacity: isVisible ? 1 : 0,
                                                                transform: isSelected ? 'scale(1.05)' : 'scale(1)',
                                                                transformOrigin: '100px 100px',
                                                                animation: isVisible ? `fadeInSegment 0.8s ease-out ${index * 0.1}s both` : 'none'
                                                            }}
                                                            onMouseEnter={() => setSelectedSegment(index)}
                                                            onMouseLeave={() => setSelectedSegment(null)}
                                                        />
                                                        {isSelected && (
                                                            <circle
                                                                cx="100"
                                                                cy="100"
                                                                r="3"
                                                                fill={segment.color}
                                                                className="animate-ping"
                                                            />
                                                        )}
                                                    </g>
                                                );
                                            })}
                                            
                                            {/* Centro del gr√°fico */}
                                            <circle cx="100" cy="100" r="35" fill="white" stroke="#e5e7eb" strokeWidth="2"/>
                                            <text x="100" y="95" textAnchor="middle" className="text-xs font-bold fill-gray-700 rotate-90" transform="rotate(90 100 95)">
                                                Total
                                            </text>
                                            <text x="100" y="110" textAnchor="middle" className="text-xs font-bold fill-[#008080] rotate-90" transform="rotate(90 100 110)">
                                                {total.toFixed(0)}‚Ç¨
                                            </text>
                                        </svg>
                                        
                                        {/* Tooltip flotante */}
                                        {selectedSegment !== null && (
                                            <div className="absolute -top-16 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-xl z-10 animate-bounce">
                                                <div className="text-center">
                                                    <div className="font-bold">{segments[selectedSegment].name}</div>
                                                    <div>{segments[selectedSegment].Ventas.toFixed(2)} ‚Ç¨</div>
                                                    <div className="text-gray-300">{segments[selectedSegment].percentage.toFixed(1)}%</div>
                                                </div>
                                                <div className="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Leyenda interactiva */}
                                <div className="flex-1 space-y-2">
                                    {segments.map((segment, index) => (
                                        <div
                                            key={index}
                                            className={`flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-all duration-300 ${
                                                selectedSegment === index 
                                                    ? 'bg-gray-100 shadow-md transform scale-105' 
                                                    : 'hover:bg-gray-50'
                                            }`}
                                            onMouseEnter={() => setSelectedSegment(index)}
                                            onMouseLeave={() => setSelectedSegment(null)}
                                        >
                                            <div 
                                                className="w-4 h-4 rounded-full shadow-sm"
                                                style={{ backgroundColor: segment.color }}
                                            ></div>
                                            <div className="flex-1">
                                                <div className="font-medium text-gray-900">{segment.name}</div>
                                                <div className="text-sm text-gray-500">
                                                    {segment.percentage.toFixed(1)}% del total
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-bold text-[#008080]">
                                                    {segment.Ventas.toFixed(0)} ‚Ç¨
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            <style>{`
                                @keyframes fadeInSegment {
                                    from { opacity: 0; transform: scale(0.8); }
                                    to { opacity: 1; transform: scale(1); }
                                }
                            `}</style>
                        </div>
                    );
                };

                // üöÄ MEJORA 4/4: Gr√°fico de tendencias minimalista 
                const TrendLineChart = ({ data, title }) => {
                    const [isVisible, setIsVisible] = React.useState(false);
                    const [hoveredPoint, setHoveredPoint] = React.useState(null);
                    
                    React.useEffect(() => {
                        const timer = setTimeout(() => setIsVisible(true), 300);
                        return () => clearTimeout(timer);
                    }, []);

                    // Validar datos
                    if (!data || !Array.isArray(data) || data.length === 0) {
                        return (
                            <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <h3 className="text-lg font-medium mb-4 text-gray-800">{title}</h3>
                                <p className="text-gray-500 text-center py-8">No hay datos disponibles</p>
                            </div>
                        );
                    }

                    // Filtrar datos v√°lidos
                    const validData = data.filter(d => d && d.Ventas && !isNaN(d.Ventas));
                    if (validData.length === 0) {
                        return (
                            <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <h3 className="text-lg font-medium mb-4 text-gray-800">{title}</h3>
                                <p className="text-gray-500 text-center py-8">No hay datos v√°lidos disponibles</p>
                            </div>
                        );
                    }

                    const maxValue = Math.max(...validData.map(d => d.Ventas));
                    const minValue = Math.min(...validData.map(d => d.Ventas));
                    const range = maxValue - minValue || 1; // Evitar divisi√≥n por cero
                    
                    const createPath = () => {
                        const width = 280;
                        const height = 120;
                        const padding = 20;
                        
                        return validData.map((item, index) => {
                            const x = padding + (index * (width - 2 * padding)) / (validData.length - 1);
                            const y = padding + ((maxValue - item.Ventas) / range) * (height - 2 * padding);
                            return { x, y, value: item.Ventas, name: item.name };
                        });
                    };

                    const points = createPath();
                    const pathD = points.reduce((path, point, index) => {
                        const command = index === 0 ? 'M' : 'L';
                        return `${path} ${command} ${point.x} ${point.y}`;
                    }, '');

                    return (
                        <div className={`bg-white p-6 rounded-lg shadow-sm border border-gray-200 transition-all duration-500 ${
                            isVisible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'
                        }`}>
                            <h3 className="text-lg font-medium mb-4 text-gray-800 flex items-center gap-2">
                                <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                                {title}
                            </h3>
                            
                            <div className="relative flex justify-center">
                                <svg width="280" height="120" className="border border-gray-100 rounded">
                                    {/* L√≠neas de cuadr√≠cula minimalistas */}
                                    <defs>
                                        <pattern id="grid" width="40" height="30" patternUnits="userSpaceOnUse">
                                            <path d="M 40 0 L 0 0 0 30" fill="none" stroke="#f3f4f6" strokeWidth="0.5"/>
                                        </pattern>
                                    </defs>
                                    <rect width="100%" height="100%" fill="url(#grid)" />
                                    
                                    {/* L√≠nea de tendencia */}
                                    <path
                                        d={pathD}
                                        fill="none"
                                        stroke="#008080"
                                        strokeWidth="2"
                                        strokeLinecap="round"
                                        strokeLinejoin="round"
                                        className="transition-all duration-1000"
                                        style={{
                                            strokeDasharray: isVisible ? 'none' : '300',
                                            strokeDashoffset: isVisible ? '0' : '300',
                                            opacity: isVisible ? 1 : 0
                                        }}
                                    />
                                    
                                    {/* √Årea bajo la curva (sutil) */}
                                    <path
                                        d={`${pathD} L ${points[points.length - 1].x} 120 L ${points[0].x} 120 Z`}
                                        fill="url(#gradient)"
                                        className="transition-opacity duration-1000"
                                        style={{ opacity: isVisible ? 0.1 : 0 }}
                                    />
                                    
                                    {/* Gradiente sutil */}
                                    <defs>
                                        <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" stopColor="#008080" stopOpacity="0.2"/>
                                            <stop offset="100%" stopColor="#008080" stopOpacity="0.05"/>
                                        </linearGradient>
                                    </defs>
                                    
                                    {/* Puntos de datos */}
                                    {points.map((point, index) => (
                                        <g key={index}>
                                            <circle
                                                cx={point.x}
                                                cy={point.y}
                                                r={hoveredPoint === index ? "4" : "3"}
                                                fill="white"
                                                stroke="#008080"
                                                strokeWidth="2"
                                                className="cursor-pointer transition-all duration-200"
                                                onMouseEnter={() => setHoveredPoint(index)}
                                                onMouseLeave={() => setHoveredPoint(null)}
                                                style={{
                                                    opacity: isVisible ? 1 : 0,
                                                    transform: `scale(${isVisible ? 1 : 0})`,
                                                    transition: `all 0.3s ease ${index * 0.1}s`
                                                }}
                                            />
                                            
                                            {/* Tooltip minimalista */}
                                            {hoveredPoint === index && (
                                                <g>
                                                    <rect
                                                        x={point.x - 30}
                                                        y={point.y - 35}
                                                        width="60"
                                                        height="25"
                                                        fill="rgba(0, 0, 0, 0.8)"
                                                        rx="4"
                                                        className="animate-fadeIn"
                                                    />
                                                    <text
                                                        x={point.x}
                                                        y={point.y - 25}
                                                        textAnchor="middle"
                                                        className="text-xs fill-white font-medium"
                                                    >
                                                        {point.value.toFixed(0)}‚Ç¨
                                                    </text>
                                                    <text
                                                        x={point.x}
                                                        y={point.y - 15}
                                                        textAnchor="middle"
                                                        className="text-xs fill-gray-300"
                                                    >
                                                        {point.name.substring(0, 6)}
                                                    </text>
                                                </g>
                                            )}
                                        </g>
                                    ))}
                                </svg>
                            </div>
                            
                            {/* Estad√≠sticas minimalistas */}
                            <div className="mt-4 pt-3 border-t border-gray-100">
                                <div className="flex justify-between text-sm text-gray-600">
                                    <span>Min: <span className="font-medium text-gray-800">{minValue.toFixed(0)}‚Ç¨</span></span>
                                    <span>Promedio: <span className="font-medium text-gray-800">{(data.reduce((sum, d) => sum + d.Ventas, 0) / data.length).toFixed(0)}‚Ç¨</span></span>
                                    <span>Max: <span className="font-medium text-gray-800">{maxValue.toFixed(0)}‚Ç¨</span></span>
                                </div>
                            </div>
                        </div>
                    );
                };

                // üöÄ MEJORA 4/4: Gr√°fico de distribuci√≥n por comercial minimalista
                const SalespersonDistribution = ({ data, title }) => {
                    const [isVisible, setIsVisible] = React.useState(false);
                    
                    React.useEffect(() => {
                        const timer = setTimeout(() => setIsVisible(true), 400);
                        return () => clearTimeout(timer);
                    }, []);

                    if (!data || data.length === 0) return null;

                    const total = data.reduce((sum, item) => sum + item.value, 0);
                    const sortedData = data.sort((a, b) => b.value - a.value).slice(0, 5);
                    
                    return (
                        <div className={`bg-white p-6 rounded-lg shadow-sm border border-gray-200 transition-all duration-500 ${
                            isVisible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'
                        }`}>
                            <h3 className="text-lg font-medium mb-4 text-gray-800 flex items-center gap-2">
                                <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                {title}
                            </h3>
                            
                            <div className="space-y-3">
                                {sortedData.map((item, index) => {
                                    const percentage = (item.value / total) * 100;
                                    const initials = item.name.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
                                    
                                    return (
                                        <div key={index} className="flex items-center gap-3 group">
                                            {/* Avatar minimalista */}
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium ${
                                                index === 0 ? 'bg-gray-800 text-white' :
                                                index === 1 ? 'bg-gray-600 text-white' :
                                                index === 2 ? 'bg-gray-400 text-white' :
                                                'bg-gray-200 text-gray-700'
                                            } transition-transform group-hover:scale-110`}>
                                                {initials}
                                            </div>
                                            
                                            {/* Informaci√≥n */}
                                            <div className="flex-1">
                                                <div className="flex justify-between items-center mb-1">
                                                    <span className="font-medium text-gray-800 text-sm truncate max-w-32" title={item.name}>
                                                        {item.name.length > 20 ? item.name.substring(0, 20) + '...' : item.name}
                                                    </span>
                                                    <span className="text-sm font-medium text-gray-800">
                                                        {item.value.toFixed(0)}‚Ç¨
                                                    </span>
                                                </div>
                                                
                                                {/* Barra de progreso minimalista */}
                                                <div className="w-full bg-gray-100 rounded-full h-2">
                                                    <div 
                                                        className="bg-gray-600 h-2 rounded-full transition-all duration-1000 ease-out"
                                                        style={{ 
                                                            width: isVisible ? `${percentage}%` : '0%',
                                                            transitionDelay: `${index * 100}ms`
                                                        }}
                                                    ></div>
                                                </div>
                                                
                                                {/* Porcentaje */}
                                                <div className="text-xs text-gray-500 mt-1">
                                                    {percentage.toFixed(1)}% del total
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            
                            {data.length > 5 && (
                                <div className="mt-4 pt-3 border-t border-gray-100 text-center">
                                    <span className="text-xs text-gray-500">
                                        y {data.length - 5} comerciales m√°s
                                    </span>
                                </div>
                            )}
                        </div>
                    );
                };

                return (
                    <div className="space-y-6">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-3">
                                <BarChartIcon width={32} height={32} className="text-[#008080]" /> Informes de Ventas
                            </h1>
                            <div className="flex flex-col sm:flex-row items-end sm:items-center gap-2">
                                <div className="text-sm text-gray-500">
                                    Actualizado: {new Date().toLocaleDateString('es-ES')}
                                </div>
                                
                                {/* üöÄ MEJORA 3/4: Botones de exportaci√≥n */}
                                <div className="flex gap-2">
                                    <button
                                        onClick={async () => {
                                            const exportData = {
                                                invoices: filteredInvoices,
                                                totalSales,
                                                totalInvoices,
                                                averageTicket,
                                                totalVat,
                                                topProducts,
                                                dateFilter
                                            };
                                            const success = ExportUtils.exportToExcel(exportData);
                                            if (success) {
                                                showNotification(
                                                    ' Exportaci√≥n Exitosa',
                                                    'Los datos se han exportado a Excel correctamente.',
                                                    'success'
                                                );
                                            } else {
                                                alert('‚ùå Error al exportar a Excel');
                                            }
                                        }}
                                        className="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium flex items-center gap-2"
                                        title="Exportar datos a Excel"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Excel
                                    </button>
                                    
                                    <button
                                        onClick={async () => {
                                            const exportData = {
                                                invoices: filteredInvoices,
                                                totalSales,
                                                totalInvoices,
                                                averageTicket,
                                                totalVat,
                                                topProducts,
                                                dateFilter
                                            };
                                            const success = await ExportUtils.exportToPDF(exportData);
                                            if (success) {
                                                showNotification(
                                                    'PDF Generado',
                                                    'El informe PDF se ha generado exitosamente.',
                                                    'success'
                                                );
                                            } else {
                                                alert('‚ùå Error al generar PDF');
                                            }
                                        }}
                                        className="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-medium flex items-center gap-2"
                                        title="Exportar informe completo a PDF"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                        </svg>
                                        PDF
                                    </button>
                                    
                                    <button
                                        onClick={() => {
                                            const exportData = {
                                                totalSales,
                                                totalInvoices,
                                                averageTicket,
                                                totalVat,
                                                topProducts
                                            };
                                            const success = ExportUtils.copyToClipboard(exportData);
                                            if (success) {
                                                showNotification(
                                                    'Datos Copiados',
                                                    'Los datos se han copiado al portapapeles correctamente.',
                                                    'success'
                                                );
                                            } else {
                                                alert('‚ùå Error al copiar datos');
                                            }
                                        }}
                                        className="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium flex items-center gap-2"
                                        title="Copiar resumen al portapapeles"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2H7a2 2 0 01-2-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Copiar
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        
                        {/* Filtros */}
                        <div className="bg-white p-4 rounded-lg shadow-sm grid grid-cols-1 md:grid-cols-3 gap-4">
                            <FormSelect 
                                label="Filtrar por Producto" 
                                value={productFilter} 
                                onChange={(e) => setProductFilter(e.target.value)} 
                                options={productOptions.map(p => ({
                                    value: p, 
                                    label: p === 'all' ? 'Todos los productos' : p
                                }))} 
                            />
                            <FormSelect 
                                label="Filtrar por Comercial" 
                                value={salespersonFilter} 
                                onChange={(e) => setSalespersonFilter(e.target.value)} 
                                options={salespersonOptions.map(s => ({
                                    value: s, 
                                    label: s === 'all' ? 'Todos los comerciales' : s.substring(0,15) + (s.length > 15 ? '...' : '')
                                }))} 
                            />
                            <FormSelect 
                                label="Filtrar por Per√≠odo" 
                                value={dateFilter} 
                                onChange={(e) => setDateFilter(e.target.value)} 
                                options={[
                                    { value: 'all', label: 'Todo el tiempo' },
                                    { value: 'thisMonth', label: 'Este mes' },
                                    { value: 'lastMonth', label: 'Mes pasado' },
                                    { value: 'thisYear', label: 'Este a√±o' },
                                    { value: 'lastYear', label: 'A√±o pasado' }
                                ]} 
                            />
                        </div>

                       

                        {/* M√©tricas principales */}
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            <StatCard 
                                title="Total Facturado" 
                                value={`${financialTotals.totalEmitted.toFixed(2)} ‚Ç¨`} 
                                icon={<DollarSignIcon />}
                                className="bg-white border-2 border-blue-200 text-gray-900"
                            />
                            <StatCard 
                                title="Total Cobrado" 
                                value={`${financialTotals.totalCollected.toFixed(2)} ‚Ç¨`} 
                                icon={<CheckSquareIcon />}
                                className="bg-white border-2 border-green-200 text-gray-900"
                            />
                            <StatCard 
                                title="Pendiente Cobro" 
                                value={`${financialTotals.totalPending.toFixed(2)} ‚Ç¨`} 
                                icon={<ClockIcon />}
                                className="bg-white border-2 border-orange-200 text-gray-900"
                            />
                            <StatCard 
                                title="Ratio Cobro" 
                                value={`${financialTotals.collectionRate.toFixed(1)}%`} 
                                icon={<TrendingUpIcon />}
                                className="bg-white border-2 border-green-200 text-gray-900"
                            />
                        </div>

                        {/* M√©tricas por estado de facturas */}
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            <StatCard 
                                title="Facturas Emitidas" 
                                value={invoicesByStatus.issued} 
                                icon={<FileTextIcon />}
                                className="bg-white border-2 border-gray-200 text-gray-900"
                            />
                            <StatCard 
                                title="Facturas Pagadas" 
                                value={invoicesByStatus.paid} 
                                icon={<CheckCircleIcon />}
                                className="bg-white border-2 border-green-200 text-gray-900"
                            />
                            <StatCard 
                                title="Pagos Parciales" 
                                value={invoicesByStatus.partiallyPaid} 
                                icon={<MinusCircleIcon />}
                                className="bg-white border-2 border-yellow-200 text-gray-900"
                            />
                            <StatCard 
                                title="Facturas Pendientes" 
                                value={invoicesByStatus.pending} 
                                icon={<ExclamationCircleIcon />}
                                className="bg-white border-2 border-red-200 text-gray-900"
                            />
                        </div>

                        {/* Gr√°ficos */}
                        <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                            {hasRecharts ? (
                                // Gr√°ficos con Recharts (versi√≥n expandida con nuevos componentes)
                                <>
                                    {salesByMonth.length > 0 && (
                                        <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                            <h3 className="text-lg font-medium mb-4 text-gray-800 flex items-center gap-2">
                                                <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                                </svg>
                                                Ventas por Mes
                                            </h3>
                                            <div style={{ width: '100%', height: 300 }}>
                                                <Recharts.ResponsiveContainer>
                                                    <Recharts.LineChart data={salesByMonth} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}>
                                                        <Recharts.CartesianGrid strokeDasharray="3 3" stroke="#f3f4f6" />
                                                        <Recharts.XAxis dataKey="name" tick={{ fontSize: 12 }} />
                                                        <Recharts.YAxis tick={{ fontSize: 12 }} />
                                                        <Recharts.Tooltip formatter={(value) => [`${value} ‚Ç¨`, 'Ventas']} />
                                                        <Recharts.Line 
                                                            type="monotone" 
                                                            dataKey="Ventas" 
                                                            stroke="#008080" 
                                                            strokeWidth={2}
                                                            dot={{ fill: '#008080', strokeWidth: 2, r: 4 }}
                                                        />
                                                    </Recharts.LineChart>
                                                </Recharts.ResponsiveContainer>
                                            </div>
                                        </div>
                                    )}

                                    {salesByQuarter.length > 0 && (
                                        <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                            <h3 className="text-lg font-medium mb-4 text-gray-800 flex items-center gap-2">
                                                <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                                </svg>
                                                Ventas por Trimestre
                                            </h3>
                                            <div style={{ width: '100%', height: 300 }}>
                                                <Recharts.ResponsiveContainer>
                                                    <Recharts.BarChart data={salesByQuarter} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}>
                                                        <Recharts.CartesianGrid strokeDasharray="3 3" stroke="#f3f4f6" />
                                                        <Recharts.XAxis dataKey="name" tick={{ fontSize: 12 }} />
                                                        <Recharts.YAxis tick={{ fontSize: 12 }} />
                                                        <Recharts.Tooltip formatter={(value) => [`${value} ‚Ç¨`, 'Ventas']} />
                                                        <Recharts.Bar 
                                                            dataKey="Ventas" 
                                                            fill="#008080"
                                                            radius={[4, 4, 0, 0]}
                                                        />
                                                    </Recharts.BarChart>
                                                </Recharts.ResponsiveContainer>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* üöÄ MEJORA 4/4: Nuevos gr√°ficos Recharts minimalistas */}
                                    {monthlyTrend.length > 0 && (
                                        <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                            <h3 className="text-lg font-medium mb-4 text-gray-800 flex items-center gap-2">
                                                <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                                </svg>
                                                Tendencia √öltimos 6 Meses
                                            </h3>
                                            <div style={{ width: '100%', height: 300 }}>
                                                <Recharts.ResponsiveContainer>
                                                    <Recharts.AreaChart data={monthlyTrend} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}>
                                                        <Recharts.CartesianGrid strokeDasharray="3 3" stroke="#f3f4f6" />
                                                        <Recharts.XAxis dataKey="name" tick={{ fontSize: 12 }} />
                                                        <Recharts.YAxis tick={{ fontSize: 12 }} />
                                                        <Recharts.Tooltip formatter={(value) => [`${value} ‚Ç¨`, 'Ventas']} />
                                                        <Recharts.Area 
                                                            type="monotone" 
                                                            dataKey="Ventas" 
                                                            stroke="#008080" 
                                                            fill="#008080"
                                                            fillOpacity={0.1}
                                                            strokeWidth={2}
                                                        />
                                                    </Recharts.AreaChart>
                                                </Recharts.ResponsiveContainer>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {salesBySalesperson.length > 0 && (
                                        <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                            <h3 className="text-lg font-medium mb-4 text-gray-800 flex items-center gap-2">
                                                <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                                </svg>
                                                Rendimiento por Comercial
                                            </h3>
                                            <div style={{ width: '100%', height: 300 }}>
                                                <Recharts.ResponsiveContainer>
                                                    <Recharts.BarChart 
                                                        data={salesBySalesperson.slice(0, 5)} 
                                                        layout="horizontal"
                                                        margin={{ top: 5, right: 20, left: 40, bottom: 5 }}
                                                    >
                                                        <Recharts.CartesianGrid strokeDasharray="3 3" stroke="#f3f4f6" />
                                                        <Recharts.XAxis type="number" tick={{ fontSize: 12 }} />
                                                        <Recharts.YAxis 
                                                            type="category" 
                                                            dataKey="name" 
                                                            width={80}
                                                            tick={{ fontSize: 10 }}
                                                        />
                                                        <Recharts.Tooltip formatter={(value) => [`${value.toFixed(0)} ‚Ç¨`, 'Ventas']} />
                                                        <Recharts.Bar 
                                                            dataKey="value" 
                                                            fill="#6b7280"
                                                            radius={[0, 4, 4, 0]}
                                                        />
                                                    </Recharts.BarChart>
                                                </Recharts.ResponsiveContainer>
                                            </div>
                                        </div>
                                    )}
                                </>
                            ) : (
                                // üöÄ MEJORAS 2/4 + 4/4: Gr√°ficos fallback expandidos con nuevos componentes minimalistas
                                <>
                                    {/* Fila principal: barras y circular */}
                                    <div className="xl:col-span-2 grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        {salesByMonth.length > 0 && (
                                            <SimpleBarChart data={salesByMonth} title="Ventas por Mes" />
                                        )}
                                        {salesByQuarter.length > 0 && (
                                            <SimplePieChart data={salesByQuarter} title="Distribuci√≥n por Trimestre" />
                                        )}
                                    </div>
                                    
                                    {/* üöÄ MEJORA 4/4: Nueva fila con gr√°ficos adicionales minimalistas */}
                                    <div className="xl:col-span-2 grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        {/* Tendencia temporal minimalista */}
                                        {monthlyTrend.length > 0 && (
                                            <TrendLineChart 
                                                data={monthlyTrend} 
                                                title="Tendencia √öltimos 6 Meses" 
                                            />
                                        )}
                                        
                                        {/* Distribuci√≥n por comercial */}
                                        {salesBySalesperson.length > 0 && (
                                            <SalespersonDistribution 
                                                data={salesBySalesperson} 
                                                title="Rendimiento por Comercial" 
                                            />
                                        )}
                                    </div>
                                    
                                    {/* Gr√°fico adicional: Top productos como circular */}
                                    {topProducts.length > 0 && (
                                        <SimplePieChart 
                                            data={topProducts.map(p => ({ name: p.name, Ventas: p.revenue }))} 
                                            title="Top Productos por Ingresos" 
                                        />
                                    )}
                                </>
                            )}
                        </div>

                        {/* Top Productos */}
                        {topProducts.length > 0 && (
                            <div className="bg-white p-6 rounded-lg shadow">
                                <h3 className="text-xl font-semibold mb-4 text-gray-800 flex items-center gap-2">
                                    <TrophyIcon width={20} height={20} /> Top 5 Productos por Ingresos
                                </h3>
                                <div className="space-y-3">
                                    {topProducts.map((product, index) => (
                                        <div key={product.name} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                            <div className="flex items-center gap-3">
                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold
                                                    ${index === 0 ? 'bg-yellow-500' : 
                                                      index === 1 ? 'bg-gray-400' : 
                                                      index === 2 ? 'bg-orange-600' : 'bg-gray-300'}`}>
                                                    {index + 1}
                                                </div>
                                                <div>
                                                    <div className="font-semibold text-gray-900">{product.name}</div>
                                                    <div className="text-sm text-gray-500">
                                                        {product.quantity} unidades vendidas
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-bold text-green-600">
                                                    {product.revenue.toFixed(2)} ‚Ç¨
                                                </div>
                                                <div className="text-sm text-gray-500">
                                                    {(product.revenue / product.quantity).toFixed(2)} ‚Ç¨/ud
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                         {/* üöÄ MEJORA 3/4: Panel avanzado de exportaci√≥n */}
                         <div className="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-xl shadow-sm border border-blue-200">
                            <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-800 flex items-center gap-2 mb-2">
                                        <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path>
                                        </svg>
                                         Centro de Exportaci√≥n Avanzada
                                    </h3>
                                    <p className="text-sm text-gray-600">
                                        Exporta tus datos de ventas en m√∫ltiples formatos profesionales
                                    </p>
                                </div>
                                
                                <div className="flex flex-wrap gap-3">
                                    {/* Exportaci√≥n Excel Avanzada */}
                                    <div className="group relative">
                                        <button
                                            onClick={async () => {
                                                const exportData = {
                                                    invoices: filteredInvoices,
                                                    totalSales,
                                                    totalInvoices,
                                                    averageTicket,
                                                    totalVat,
                                                    topProducts,
                                                    dateFilter,
                                                    salesByMonth,
                                                    salesByQuarter
                                                };
                                                const success = ExportUtils.exportToExcel(exportData, 'informe_completo_expertia');
                                                if (success) {
                                                    // Animaci√≥n de √©xito
                                                    const btn = event.target.closest('button');
                                                    btn.classList.add('animate-pulse');
                                                    setTimeout(() => btn.classList.remove('animate-pulse'), 1000);
                                                    alert(' ¬°Excel generado con 3 hojas: Ventas, Estad√≠sticas y Top Productos!');
                                                } else {
                                                    alert('‚ùå Error al exportar a Excel');
                                                }
                                            }}
                                            className="px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transform hover:scale-105 transition-all duration-300 font-medium flex items-center gap-2 shadow-lg hover:shadow-xl"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                             Excel Completo
                                        </button>
                                        <div className="absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-3 py-2 rounded-lg text-xs opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                                            Incluye datos detallados, estad√≠sticas y gr√°ficos
                                        </div>
                                    </div>
                                    
                                    {/* PDF Profesional */}
                                    <div className="group relative">
                                        <button
                                            onClick={async () => {
                                                const exportData = {
                                                    invoices: filteredInvoices,
                                                    totalSales,
                                                    totalInvoices,
                                                    averageTicket,
                                                    totalVat,
                                                    topProducts,
                                                    dateFilter
                                                };
                                                const success = await ExportUtils.exportToPDF(exportData, 'informe_profesional_expertia');
                                                if (success) {
                                                    const btn = event.target.closest('button');
                                                    btn.classList.add('animate-bounce');
                                                    setTimeout(() => btn.classList.remove('animate-bounce'), 1000);
                                                    alert(' ¬°PDF profesional generado con gr√°ficos incluidos!');
                                                } else {
                                                    alert('‚ùå Error al generar PDF');
                                                }
                                            }}
                                            className="px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transform hover:scale-105 transition-all duration-300 font-medium flex items-center gap-2 shadow-lg hover:shadow-xl"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                            </svg>
                                             PDF Profesional
                                        </button>
                                        <div className="absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-3 py-2 rounded-lg text-xs opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                                            Informe ejecutivo con gr√°ficos capturados
                                        </div>
                                    </div>
                                    
                                    {/* Compartir Datos */}
                                    <div className="group relative">
                                        <button
                                            onClick={() => {
                                                const exportData = {
                                                    totalSales,
                                                    totalInvoices,
                                                    averageTicket,
                                                    totalVat,
                                                    topProducts,
                                                    filteredInvoices: filteredInvoices.length
                                                };
                                                const success = ExportUtils.copyToClipboard(exportData);
                                                if (success) {
                                                    const btn = event.target.closest('button');
                                                    btn.innerHTML = `
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                        </svg>
                                                        ‚úÖ ¬°Copiado!
                                                    `;
                                                    setTimeout(() => {
                                                        btn.innerHTML = `
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
                                                            </svg>
                                                            üìã Compartir
                                                        `;
                                                    }, 2000);
                                                } else {
                                                    alert('‚ùå Error al copiar datos');
                                                }
                                            }}
                                            className="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transform hover:scale-105 transition-all duration-300 font-medium flex items-center gap-2 shadow-lg hover:shadow-xl"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
                                            </svg>
                                             Compartir
                                        </button>
                                        <div className="absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-3 py-2 rounded-lg text-xs opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                                            Copia resumen al portapapeles
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Estad√≠sticas de exportaci√≥n */}
                            <div className="mt-4 pt-4 border-t border-blue-200">
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <div className="text-center">
                                        <div className="text-blue-600 font-bold">{filteredInvoices.length}</div>
                                        <div className="text-gray-600">Facturas a exportar</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-blue-600 font-bold">{totalSales.toFixed(0)} ‚Ç¨</div>
                                        <div className="text-gray-600">Valor total</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-blue-600 font-bold">{topProducts.length}</div>
                                        <div className="text-gray-600">Productos √∫nicos</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-blue-600 font-bold">{new Set(filteredInvoices.map(inv => inv.createdBy)).size}</div>
                                        <div className="text-gray-600">Comerciales</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* üöÄ MEJORA 2/4: Mensaje mejorado cuando no hay datos */}
                        {filteredInvoices.length === 0 && (
                            <div className="bg-gradient-to-br from-gray-50 to-gray-100 p-12 rounded-xl shadow-lg text-center border-2 border-dashed border-gray-300 hover:border-[#008080] transition-all duration-300">
                                <div className="text-gray-400 text-6xl mb-6 flex justify-center animate-pulse">
                                    <BarChartIcon width={72} height={72} className="transform hover:scale-110 transition-transform duration-300" />
                                </div>
                                <h3 className="text-2xl font-bold text-gray-700 mb-3">
                                     No hay datos para mostrar
                                </h3>
                                <p className="text-gray-600 mb-2 max-w-md mx-auto">
                                    No se encontraron facturas pagadas que coincidan con los filtros seleccionados.
                                </p>
                                <p className="text-sm text-gray-500 mb-6">
                                     Intenta ajustar los filtros o limpiarlos para ver m√°s datos
                                </p>
                                <div className="flex gap-3 justify-center">
                                    <button 
                                        onClick={() => {
                                            setProductFilter('all');
                                            setSalespersonFilter('all');
                                            setDateFilter('all');
                                        }}
                                        className="px-6 py-3 bg-gradient-to-r from-[#008080] to-[#00a6a6] text-white rounded-lg hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300 font-medium"
                                    >
                                         Limpiar todos los filtros
                                    </button>
                                    <button 
                                        onClick={() => setDateFilter('thisYear')}
                                        className="px-6 py-3 bg-white text-[#008080] border-2 border-[#008080] rounded-lg hover:bg-[#008080] hover:text-white transform hover:-translate-y-1 transition-all duration-300 font-medium"
                                    >
                                         Ver este a√±o
                                    </button>
                                </div>
                                
                                {/* Elemento decorativo animado */}
                                <div className="mt-8 flex justify-center space-x-2">
                                    <div className="w-3 h-3 bg-[#008080] rounded-full animate-bounce"></div>
                                    <div className="w-3 h-3 bg-[#00a6a6] rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                                    <div className="w-3 h-3 bg-[#20b2aa] rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
            function BulkCommunication({ clients, onBack }) {
                const [message, setMessage] = useState('');
                const [filter, setFilter] = useState('all');
               
                const eligibleClients = useMemo(() => {
                    return clients.filter(c => c.acceptsMarketing && (filter === 'all' || c.funnelStage === filter));
                }, [clients, filter]);

                const handleSendEmail = () => {
                    const emails = eligibleClients.map(c => c.email).filter(email => email).join(',');
                    if (!emails) { 
                        showNotification(
                            'Sin Destinatarios',
                            'No hay clientes elegibles para enviar email o no tienen direcci√≥n de correo.',
                            'warning'
                        ); 
                        return; 
                    }
                    window.open(`mailto:?bcc=${emails}&subject=Novedades de Expertia Medical Solutions&body=${encodeURIComponent(message)}`, '_blank');
                };

                const handleSendWhatsapp = () => {
                    if (!message) { 
                        showNotification(
                            'Mensaje Vac√≠o',
                            'El mensaje no puede estar vac√≠o.',
                            'warning'
                        ); 
                        return; 
                    }
                    window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
                };

                const funnelOptions = [
                    { value: 'all', label: 'Todas las fases' },
                    ...Object.keys(FUNNEL_TAGS).map(stage => ({ value: stage, label: stage }))
                ];

                return (
                    <div className="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
                        <div className="flex items-center gap-3 mb-6">
                            <MegaphoneIcon width={36} height={36} className="text-[#008080]" />
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900">Comunicaci√≥n Masiva</h2>
                                <p className="text-sm text-gray-600">Env√≠a mensajes √∫nicamente a clientes que aceptan comunicaciones comerciales</p>
                            </div>
                        </div>
                        
                        {/* Panel de filtros y estad√≠sticas */}
                        <div className="bg-gray-50 p-4 rounded-lg mb-6">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <FormSelect 
                                    label="Filtrar por Fase del Embudo" 
                                    value={filter} 
                                    onChange={(e) => setFilter(e.target.value)} 
                                    options={funnelOptions}
                                />
                                <div className="md:col-span-2 flex items-center gap-4">
                                    <div className="bg-white p-3 rounded-lg border flex-1">
                                        <div className="text-2xl font-bold text-green-600">{eligibleClients.length}</div>
                                        <div className="text-sm text-gray-600">Clientes seleccionados</div>
                                    </div>
                                    <div className="bg-white p-3 rounded-lg border flex-1">
                                        <div className="text-2xl font-bold text-blue-600">
                                            {eligibleClients.filter(c => c.email).length}
                                        </div>
                                        <div className="text-sm text-gray-600">Con email v√°lido</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Lista de clientes seleccionados */}
                        {eligibleClients.length > 0 && (
                            <div className="mb-6">
                                <h3 className="text-lg font-semibold text-gray-800 mb-3">
                                    Clientes que recibir√°n el mensaje:
                                </h3>
                                <div className="bg-gray-50 p-4 rounded-lg max-h-32 overflow-y-auto">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                                        {eligibleClients.map(client => (
                                            <div key={client.id} className="flex items-center gap-2 text-sm">
                                                <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                                                <span className="font-medium">{client.name}</span>
                                                <span className="text-gray-500">({client.funnelStage})</span>
                                                {!client.email && (
                                                    <span className="text-red-500 text-xs flex items-center gap-1">
                                                        <AlertTriangleIcon width={12} height={12} /> Sin email
                                                    </span>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Editor de mensaje */}
                        <div className="mb-6">
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                Mensaje a enviar:
                            </label>
                            <textarea 
                                value={message} 
                                onChange={(e) => setMessage(e.target.value)} 
                                rows="8" 
                                placeholder="Escribe tu mensaje aqu√≠...

Ejemplo:
¬°Hola! üëã

Desde Expertia Medical Solutions queremos compartir contigo nuestras √∫ltimas novedades:

‚úÖ Nuevos productos disponibles
‚úÖ Ofertas especiales para este mes
‚úÖ Pr√≥ximos webinars formativos

¬øTe interesa conocer m√°s detalles? ¬°Cont√°ctanos!

Saludos,
Equipo Expertia Medical Solutions" 
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#008080] focus:border-transparent resize-none"
                            />
                            <div className="text-sm text-gray-500 mt-1">
                                Caracteres: {message.length}
                            </div>
                        </div>

                        {/* Botones de acci√≥n */}
                        <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                            <button 
                                onClick={onBack} 
                                className="bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors"
                            >
                                ‚Üê Volver al Dashboard
                            </button>
                            
                            <div className="flex flex-col sm:flex-row gap-3">
                                <button 
                                    onClick={handleSendWhatsapp}
                                    disabled={!message.trim()}
                                    className="bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors flex items-center gap-2"
                                >
                                    <SmartphoneIcon width={16} height={16} /> Enviar por WhatsApp
                                </button>
                                <button 
                                    onClick={handleSendEmail}
                                    disabled={!message.trim() || eligibleClients.filter(c => c.email).length === 0}
                                    className="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors flex items-center gap-2"
                                >
                                    <EmailIcon width={16} height={16} /> Enviar por Email (BCC)
                                </button>
                            </div>
                        </div>

                        {/* Advertencias y informaci√≥n */}
                        <div className="mt-6 space-y-3">
                            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div className="flex items-start gap-2">
                                    <AlertTriangleIcon width={20} height={20} className="text-yellow-600 mt-0.5" />
                                    <div>
                                        <h4 className="font-semibold text-yellow-800">Informaci√≥n importante:</h4>
                                        <ul className="text-sm text-yellow-700 mt-1 list-disc list-inside space-y-1">
                                            <li>Solo se enviar√°n mensajes a clientes que han aceptado recibir comunicaciones comerciales</li>
                                            <li>Para WhatsApp, se abrir√° la aplicaci√≥n con el mensaje preparado</li>
                                            <li>Para email, se abrir√° tu cliente de correo con los destinatarios en BCC (copia oculta)</li>
                                            <li>Aseg√∫rate de cumplir con la LOPD y el RGPD en tus comunicaciones</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            {eligibleClients.length === 0 && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                                    <div className="flex items-center gap-2">
                                        <div className="text-red-600 text-lg">üö´</div>
                                        <div>
                                            <h4 className="font-semibold text-red-800">No hay clientes seleccionados</h4>
                                            <p className="text-sm text-red-700 mt-1">
                                                No hay clientes que cumplan los criterios de filtrado y que hayan aceptado recibir comunicaciones comerciales.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }
            
            // Formulario de Perfil de Usuario
            function ProfileForm({ userProfile, onSave, onBack }) {
                const [profile, setProfile] = useState({ 
                    name: '', 
                    email: '', 
                    phone: '', 
                    photoURL: '',
                    role: 'comercial'
                });

                useEffect(() => {
                    if (userProfile) {
                        setProfile(userProfile);
                    }
                }, [userProfile]);

                const handleChange = (e) => {
                    const { name, value } = e.target;
                    setProfile({ ...profile, [name]: value });
                };

                const handlePhotoChange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            setProfile({ ...profile, photoURL: reader.result });
                        };
                        reader.readAsDataURL(file);
                    }
                };

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onSave(profile);
                };

                return (
                    <div className="max-w-2xl mx-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-3xl font-bold text-gray-900">Perfil de Usuario</h1>
                            <button onClick={onBack} className="text-gray-500 hover:text-gray-700">
                                <XIcon width={24} height={24} />
                            </button>
                        </div>

                        <form onSubmit={handleSubmit} className="bg-white p-8 rounded-lg shadow-lg space-y-6">
                            <div className="flex justify-center mb-6">
                                <div className="relative">
                                    <img 
                                        src={profile.photoURL || 'https://placehold.co/120x120/006666/FFFFFF?text=U'} 
                                        alt="Foto de perfil" 
                                        className="w-32 h-32 rounded-full object-cover border-4 border-[#006666]"
                                    />
                                    <input
                                        type="file"
                                        accept="image/*"
                                        onChange={handlePhotoChange}
                                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                    />
                                    <div className="absolute bottom-0 right-0 bg-[#006666] text-white rounded-full p-2">
                                        <EditIcon />
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <FormField 
                                    label="Nombre Completo" 
                                    name="name" 
                                    value={profile.name} 
                                    onChange={handleChange} 
                                    required 
                                />
                                <FormField 
                                    label="Email" 
                                    name="email" 
                                    type="email" 
                                    value={profile.email} 
                                    onChange={handleChange} 
                                    required 
                                />
                                <FormField 
                                    label="Tel√©fono" 
                                    name="phone" 
                                    value={profile.phone} 
                                    onChange={handleChange} 
                                />
                                <FormSelect 
                                    label="Rol en el Sistema" 
                                    name="role" 
                                    value={profile.role} 
                                    onChange={handleChange}
                                    options={[
                                        { value: 'comercial', label: 'Comercial' },
                                        { value: 'admin', label: 'Administrador' }
                                    ]}
                                />
                            </div>

                            <div className="bg-blue-50 border-l-4 border-blue-400 p-4">
                                <div className="flex">
                                    <div className="flex-shrink-0">
                                        <UserIcon />
                                    </div>
                                    <div className="ml-3">
                                        <p className="text-sm text-blue-700">
                                            <strong>Informaci√≥n sobre roles:</strong>
                                        </p>
                                        <ul className="mt-2 text-sm text-blue-600">
                                            <li>‚Ä¢ <strong>Comercial:</strong> Acceso a gesti√≥n de clientes, ofertas y facturaci√≥n</li>
                                            <li>‚Ä¢ <strong>Administrador:</strong> Acceso completo + gesti√≥n de productos y usuarios</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div className="flex justify-end gap-4 pt-6">
                                <button 
                                    type="button" 
                                    onClick={onBack} 
                                    className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                >
                                    Cancelar
                                </button>
                                <button 
                                    type="submit" 
                                    className="px-6 py-3 bg-[#006666] text-white rounded-lg hover:bg-[#005555]"
                                >
                                    Guardar Perfil
                                </button>
                            </div>
                        </form>
                    </div>
                );
            }
            
            // Formulario de Productos
            function ProductForm({ product, onSave, onCancel }) {
                const [activeTab, setActiveTab] = useState('basic');
                const [formData, setFormData] = useState({
                    // Informaci√≥n b√°sica
                    name: product?.name || '',
                    description: product?.description || '',
                    category: product?.category || '',
                    subcategory: product?.subcategory || '',
                    brand: product?.brand || '',
                    model: product?.model || '',
                    
                    // C√≥digos e identificaci√≥n
                    code: product?.code || '',
                    sku: product?.sku || '',
                    
                    // Precios e inventario
                    price: product?.price || '',
                    stock: product?.stock || 0,
                    minStock: product?.minStock || 0,
                    availability: product?.availability || 'En Stock',
                    
                    // Proveedor y especificaciones
                    supplier: product?.supplier || '',
                    specifications: product?.specifications || '',
                    warranty: product?.warranty || '',
                    
                    // Estado y configuraci√≥n
                    active: product?.active !== undefined ? product.active : true,
                    featured: product?.featured || false
                });

                // Obtener configuraci√≥n din√°micamente (con fallbacks)
                const categories = getConfigValue('products', 'categories', [
                    'Equipos M√©dicos', 'Instrumentos', 'Consumibles', 'Software', 'Servicios'
                ]);
                const suppliers = getConfigValue('products', 'suppliers', [
                    'Proveedor 1', 'Proveedor 2', 'Proveedor 3'
                ]);

                const handleSubmit = (e) => {
                    e.preventDefault();
                    const now = new Date().toISOString();
                    const currentUser = 'Usuario Actual'; // TODO: obtener del contexto de autenticaci√≥n
                    
                    const productData = {
                        ...formData,
                        price: parseFloat(formData.price) || 0,
                        stock: parseInt(formData.stock) || 0,
                        minStock: parseInt(formData.minStock) || 0,
                        active: Boolean(formData.active),
                        featured: Boolean(formData.featured),
                        id: product?.id || Date.now().toString(),
                        
                        // Auditor√≠a
                        updatedAt: now,
                        updatedBy: currentUser,
                        ...(product ? {} : {
                            createdAt: now,
                            createdBy: currentUser
                        })
                    };
                    onSave(productData);
                };

                const handleChange = (field, value) => {
                    setFormData(prev => ({ ...prev, [field]: value }));
                };

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h1 className="text-3xl font-bold text-gray-900">
                                {product ? 'Editar Producto' : 'Nuevo Producto'}
                            </h1>
                            <button
                                onClick={onCancel}
                                className="text-gray-500 hover:text-gray-700"
                            >
                                <XIcon width={24} height={24} />
                            </button>
                        </div>

                        <div className="bg-white rounded-lg shadow p-6">
                            {/* Pesta√±as de navegaci√≥n */}
                            <div className="border-b border-gray-200 mb-6">
                                <nav className="-mb-px flex space-x-8">
                                    <button
                                        type="button"
                                        onClick={() => setActiveTab('basic')}
                                        className={`py-2 px-1 border-b-2 font-medium text-sm flex items-center gap-2 ${
                                            activeTab === 'basic'
                                                ? 'border-[#006666] text-[#006666]'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        }`}
                                    >
                                        <InfoIcon width={20} height={20} /> Informaci√≥n B√°sica
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setActiveTab('inventory')}
                                        className={`py-2 px-1 border-b-2 font-medium text-sm flex items-center gap-2 ${
                                            activeTab === 'inventory'
                                                ? 'border-[#006666] text-[#006666]'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        }`}
                                    >
                                        <PackageIcon width={20} height={20} /> Inventario y Precios
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setActiveTab('specs')}
                                        className={`py-2 px-1 border-b-2 font-medium text-sm flex items-center gap-2 ${
                                            activeTab === 'specs'
                                                ? 'border-[#006666] text-[#006666]'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        }`}
                                    >
                                        <FileTextIcon /> Especificaciones
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setActiveTab('config')}
                                        className={`py-2 px-1 border-b-2 font-medium text-sm flex items-center gap-2 ${
                                            activeTab === 'config'
                                                ? 'border-[#006666] text-[#006666]'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        }`}
                                    >
                                        <SettingsIcon width={20} height={20} /> Configuraci√≥n
                                    </button>
                                </nav>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-6">
                                {/* Pesta√±a: Informaci√≥n B√°sica */}
                                {activeTab === 'basic' && (
                                    <div className="space-y-6">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Nombre del Producto *
                                                </label>
                                                <input
                                                    type="text"
                                                    value={formData.name}
                                                    onChange={(e) => handleChange('name', e.target.value)}
                                                    required
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="Nombre del producto"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Marca
                                                </label>
                                                <input
                                                    type="text"
                                                    value={formData.brand}
                                                    onChange={(e) => handleChange('brand', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="Marca del producto"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Modelo
                                                </label>
                                                <input
                                                    type="text"
                                                    value={formData.model}
                                                    onChange={(e) => handleChange('model', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="Modelo del producto"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Categor√≠a *
                                                </label>
                                                <select
                                                    value={formData.category}
                                                    onChange={(e) => handleChange('category', e.target.value)}
                                                    required
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                >
                                                    <option value="">Seleccionar categor√≠a</option>
                                                    {categories.map(category => (
                                                        <option key={category} value={category}>
                                                            {category}
                                                        </option>
                                                    ))}
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Subcategor√≠a
                                                </label>
                                                <input
                                                    type="text"
                                                    value={formData.subcategory}
                                                    onChange={(e) => handleChange('subcategory', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="Subcategor√≠a espec√≠fica"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Proveedor
                                                </label>
                                                <select
                                                    value={formData.supplier}
                                                    onChange={(e) => handleChange('supplier', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                >
                                                    <option value="">Seleccionar proveedor</option>
                                                    {suppliers.map(supplier => (
                                                        <option key={supplier} value={supplier}>
                                                            {supplier}
                                                        </option>
                                                    ))}
                                                </select>
                                                <div className="mt-1 text-xs text-gray-500">
                                                    üí° Los proveedores se configuran en Panel Admin ‚Üí Configuraci√≥n ‚Üí Productos
                                                </div>
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Descripci√≥n
                                            </label>
                                            <textarea
                                                value={formData.description}
                                                onChange={(e) => handleChange('description', e.target.value)}
                                                rows={4}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                placeholder="Descripci√≥n detallada del producto"
                                            />
                                        </div>
                                    </div>
                                )}

                                {/* Pesta√±a: Inventario y Precios */}
                                {activeTab === 'inventory' && (
                                    <div className="space-y-6">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    C√≥digo del Producto
                                                </label>
                                                <input
                                                    type="text"
                                                    value={formData.code}
                                                    onChange={(e) => handleChange('code', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="C√≥digo interno"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    SKU
                                                </label>
                                                <input
                                                    type="text"
                                                    value={formData.sku}
                                                    onChange={(e) => handleChange('sku', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="SKU del producto"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Precio (‚Ç¨) *
                                                </label>
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    value={formData.price}
                                                    onChange={(e) => handleChange('price', e.target.value)}
                                                    required
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="0.00"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Disponibilidad
                                                </label>
                                                <select
                                                    value={formData.availability}
                                                    onChange={(e) => handleChange('availability', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                >
                                                    <option value="En Stock">En Stock</option>
                                                    <option value="Bajo Stock">Bajo Stock</option>
                                                    <option value="Sin Stock">Sin Stock</option>
                                                    <option value="Descontinuado">Descontinuado</option>
                                                    <option value="Pedido Especial">Pedido Especial</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Stock Actual
                                                </label>
                                                <input
                                                    type="number"
                                                    value={formData.stock}
                                                    onChange={(e) => handleChange('stock', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="0"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Stock M√≠nimo
                                                </label>
                                                <input
                                                    type="number"
                                                    value={formData.minStock}
                                                    onChange={(e) => handleChange('minStock', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                    placeholder="0"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Pesta√±a: Especificaciones */}
                                {activeTab === 'specs' && (
                                    <div className="space-y-6">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Especificaciones T√©cnicas
                                            </label>
                                            <textarea
                                                value={formData.specifications}
                                                onChange={(e) => handleChange('specifications', e.target.value)}
                                                rows={6}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                placeholder="Especificaciones t√©cnicas detalladas del producto..."
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Garant√≠a
                                            </label>
                                            <input
                                                type="text"
                                                value={formData.warranty}
                                                onChange={(e) => handleChange('warranty', e.target.value)}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#006666] focus:border-[#006666]"
                                                placeholder="Ej: 2 a√±os, 12 meses, De por vida"
                                            />
                                        </div>
                                    </div>
                                )}

                                {/* Pesta√±a: Configuraci√≥n */}
                                {activeTab === 'config' && (
                                    <div className="space-y-6">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="flex items-center">
                                                <input
                                                    type="checkbox"
                                                    id="active"
                                                    checked={formData.active}
                                                    onChange={(e) => handleChange('active', e.target.checked)}
                                                    className="h-4 w-4 text-[#006666] focus:ring-[#006666] border-gray-300 rounded"
                                                />
                                                <label htmlFor="active" className="ml-2 block text-sm text-gray-900">
                                                    Producto Activo
                                                </label>
                                            </div>

                                            <div className="flex items-center">
                                                <input
                                                    type="checkbox"
                                                    id="featured"
                                                    checked={formData.featured}
                                                    onChange={(e) => handleChange('featured', e.target.checked)}
                                                    className="h-4 w-4 text-[#006666] focus:ring-[#006666] border-gray-300 rounded"
                                                />
                                                <label htmlFor="featured" className="ml-2 block text-sm text-gray-900">
                                                    Producto Destacado
                                                </label>
                                            </div>
                                        </div>

                                        {product && (
                                            <div className="bg-gray-50 p-4 rounded-lg">
                                                <h4 className="font-medium text-gray-900 mb-2 flex items-center gap-2">
                                                    <ClockIcon width={20} height={20} /> Informaci√≥n de Auditor√≠a
                                                </h4>
                                                <div className="text-sm text-gray-600 space-y-1">
                                                    <p><strong>Creado:</strong> {product.createdAt ? new Date(product.createdAt).toLocaleString() : 'No disponible'}</p>
                                                    <p><strong>Creado por:</strong> {product.createdByName || product.createdBy || 'Sistema'}</p>
                                                    <p><strong>√öltima actualizaci√≥n:</strong> {product.updatedAt ? new Date(product.updatedAt).toLocaleString() : 'No disponible'}</p>
                                                    <p><strong>Actualizado por:</strong> {product.updatedByName || product.updatedBy || 'Sistema'}</p>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                <div className="flex justify-end gap-3 pt-6 border-t border-gray-200">
                                    <button
                                        type="button"
                                        onClick={onCancel}
                                        className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        type="submit"
                                        className="px-6 py-3 bg-[#006666] text-white rounded-lg hover:bg-[#005555]"
                                    >
                                        {product ? 'Actualizar' : 'Crear'} Producto
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }
            
            // Panel de Administraci√≥n
            function AdminPanel() {
                const [activeTab, setActiveTab] = useState('users');
                const [users, setUsers] = useState([]);
                const [loading, setLoading] = useState(true);
                const [error, setError] = useState(null);
                const [showInviteModal, setShowInviteModal] = useState(false);
                const [showEditModal, setShowEditModal] = useState(false);
                const [editingUser, setEditingUser] = useState(null);
                const [showViewModal, setShowViewModal] = useState(false);
                const [viewingUser, setViewingUser] = useState(null);
                
                // Cargar usuarios al inicializar el componente
                useEffect(() => {
                    loadUsers();
                }, []);
                
                const loadUsers = async (retryCount = 0) => {
                    try {
                        setLoading(true);
                        setError(null);
                        
                        // Verificar que authManager est√° disponible
                        if (!window.authManager) {
                            throw new Error('Sistema de autenticaci√≥n no disponible');
                        }
                        
                        // Si no existe el m√©todo, lo agregamos directamente
                        if (typeof window.authManager.getAllUsers !== 'function') {
                            console.log('[CONFIG]  Agregando m√©todo getAllUsers al authManager...');
                            
                            window.authManager.getAllUsers = async function() {
                                try {
                                    if (!this.currentUser) {
                                        throw new Error('Usuario no autenticado');
                                    }

                                    // Verificar que el usuario actual es administrador
                                    const currentProfile = await this.getUserProfile();
                                    if (!currentProfile || currentProfile.role !== 'admin') {
                                        throw new Error('Acceso denegado: Solo los administradores pueden ver la lista de usuarios');
                                    }

                                    console.log('üì• Obteniendo usuarios desde Firebase...');
                                    
                                    const { getFirestore, collection, getDocs, orderBy, query } = 
                                        await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                                    
                                    const db = getFirestore(this.app);
                                    const usersCollection = collection(db, 'users');
                                    
                                    // Ordenar por fecha de creaci√≥n descendente
                                    const q = query(usersCollection, orderBy('createdAt', 'desc'));
                                    const usersSnapshot = await getDocs(q);
                                    
                                    if (usersSnapshot.empty) {
                                        console.log('[INFO]  No hay usuarios adicionales en la base de datos');
                                        
                                        // Retornar al menos el usuario actual
                                        return [{
                                            id: this.currentUser.uid,
                                            name: this.currentUser.displayName || 'Administrador',
                                            email: this.currentUser.email,
                                            role: 'admin',
                                            active: true,
                                            emailVerified: this.currentUser.emailVerified,
                                            createdAt: new Date(),
                                            isFirstUser: true,
                                            photoURL: this.currentUser.photoURL
                                        }];
                                    }
                                    
                                    const users = [];
                                    usersSnapshot.forEach((doc) => {
                                        const userData = doc.data();
                                        users.push({
                                            id: doc.id,
                                            ...userData,
                                            // Convertir timestamps de Firestore a objetos Date
                                            createdAt: userData.createdAt?.toDate?.() || userData.createdAt || new Date(),
                                            updatedAt: userData.updatedAt?.toDate?.() || userData.updatedAt,
                                            lastSignInTime: userData.lastSignInTime?.toDate?.() || userData.lastSignInTime,
                                            // Ocultar informaci√≥n sensible
                                            password: undefined
                                        });
                                    });

                                    console.log(`üìã Obtenidos ${users.length} usuarios desde Firebase`);
                                    return users;
                                    
                                } catch (error) {
                                    console.error('[ERROR]  Error obteniendo usuarios desde Firebase:', error);
                                    
                                    // Fallback: intentar con datos de demostraci√≥n
                                    console.log('[INFO]  Usando datos de demostraci√≥n como fallback...');
                                    
                                    if (this.currentUser) {
                                        return [{
                                            id: this.currentUser.uid,
                                            name: this.currentUser.displayName || 'Usuario Demo',
                                            email: this.currentUser.email,
                                            role: 'admin',
                                            active: true,
                                            emailVerified: this.currentUser.emailVerified,
                                            createdAt: new Date(),
                                            isFirstUser: true,
                                            photoURL: this.currentUser.photoURL,
                                            _isDemo: true // Marcador para datos demo
                                        }];
                                    }
                                    
                                    throw error;
                                }
                            };
                        }
                        
                        const allUsers = await window.authManager.getAllUsers();
                        setUsers(allUsers);
                        console.log(`‚úÖ Cargados ${allUsers.length} usuarios correctamente`);
                    } catch (error) {
                        console.error('Error cargando usuarios:', error);
                        setError(error.message);
                    } finally {
                        setLoading(false);
                    }
                };
                
                const formatDate = (timestamp) => {
                    if (!timestamp) return 'No disponible';
                    try {
                        const date = new Date(timestamp);
                        return date.toLocaleDateString('es-ES', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch {
                        return 'Fecha inv√°lida';
                    }
                };
                
                const getRoleBadge = (role) => {
                    const styles = {
                        admin: 'bg-red-100 text-red-800 border-red-200',
                        comercial: 'bg-blue-100 text-blue-800 border-blue-200',
                        usuario: 'bg-gray-100 text-gray-800 border-gray-200'
                    };
                    
                    const labels = {
                        admin: 'Administrador',
                        comercial: 'Comercial', 
                        usuario: 'Usuario'
                    };
                    
                    return (
                        <span className={`px-2 py-1 rounded-full text-xs font-medium border ${styles[role] || styles.usuario}`}>
                            {labels[role] || 'Desconocido'}
                        </span>
                    );
                };
                
                const handleInviteUser = () => {
                    setShowInviteModal(true);
                };
                
                const handleUserAction = async (action, userId, userData = null) => {
                    try {
                        switch (action) {
                            case 'edit':
                                console.log('[CONFIG]  Editar usuario:', userId);
                                setEditingUser(userData);
                                setShowEditModal(true);
                                break;
                            case 'view':
                                console.log('üëÅÔ∏è Ver detalles usuario:', userId);
                                setViewingUser(userData);
                                setShowViewModal(true);
                                break;
                            case 'deactivate':
                                const action = userData.active !== false ? 'desactivar' : 'activar';
                                const actionUpper = userData.active !== false ? 'DESACTIVAR' : 'ACTIVAR';
                                const consequence = userData.active !== false ? 'El usuario no podr√° iniciar sesi√≥n hasta ser reactivado.' : 'El usuario podr√° iniciar sesi√≥n nuevamente.';
                                
                                await showConfirm(
                                    `${action.charAt(0).toUpperCase() + action.slice(1)} Usuario`,
                                    `¬øEst√°s seguro de ${action} este usuario?\n\nUsuario: ${userData.name || userData.email}\nAcci√≥n: ${actionUpper} cuenta\n\n${consequence}`,
                                    async () => {
                                    try {
                                        setLoading(true);
                                        const newActiveState = userData.active === false;
                                        console.log(`ÔøΩ ${newActiveState ? 'Activando' : 'Desactivando'} usuario:`, userId);
                                        
                                        if (!window.authManager || !window.authManager.app) {
                                            throw new Error('Sistema de autenticaci√≥n no disponible');
                                        }
                                        
                                        // Importar Firestore
                                        const { getFirestore, doc, updateDoc, getDoc } = 
                                            await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                                        
                                        const db = getFirestore(window.authManager.app);
                                        const userRef = doc(db, 'users', userId);
                                        
                                        // Verificar que el usuario existe
                                        const userDoc = await getDoc(userRef);
                                        if (!userDoc.exists()) {
                                            throw new Error('Usuario no encontrado en la base de datos');
                                        }
                                        
                                        // Preparar datos para actualizar
                                        const updateData = {
                                            active: newActiveState,
                                            updatedAt: new Date(),
                                            updatedBy: window.authManager.currentUser.uid
                                        };
                                        
                                        // Agregar metadatos de la acci√≥n
                                        if (newActiveState) {
                                            updateData.activatedAt = new Date();
                                            updateData.activatedBy = window.authManager.currentUser.uid;
                                            updateData.deactivatedAt = null;
                                            updateData.deactivatedBy = null;
                                        } else {
                                            updateData.deactivatedAt = new Date();
                                            updateData.deactivatedBy = window.authManager.currentUser.uid;
                                        }
                                        
                                        // Actualizar en Firebase
                                        await updateDoc(userRef, updateData);
                                        
                                        console.log(`‚úÖ Usuario ${newActiveState ? 'activado' : 'desactivado'} exitosamente en Firebase`);
                                        
                                        showNotification(
                                            'Usuario Actualizado',
                                            `Usuario ${newActiveState ? 'activado' : 'desactivado'} exitosamente.\n\nUsuario: ${userData.name || userData.email}\nEmail: ${userData.email}\nEstado: ${newActiveState ? 'ACTIVO' : 'INACTIVO'}\n\n${newActiveState ? 'El usuario puede iniciar sesi√≥n' : 'El usuario no puede iniciar sesi√≥n'}`,
                                            'success',
                                            6000
                                        );
                                        
                                        
                                        // Recargar usuarios para reflejar el cambio
                                        loadUsers();
                                        
                                    } catch (error) {
                                        console.error('Error cambiando estado del usuario:', error);
                                        showNotification(
                                            'Error de Usuario',
                                            'Error cambiando el estado del usuario: ' + error.message,
                                            'error',
                                            5000
                                        );
                                    } finally {
                                        setLoading(false);
                                    }
                                    },
                                    'warning'
                                );
                                break;
                            default:
                                console.log('Acci√≥n no reconocida:', action);
                        }
                    } catch (error) {
                        console.error('Error en acci√≥n de usuario:', error);
                        showNotification('Error', 'Error realizando la acci√≥n: ' + error.message, 'danger');
                    }
                };
                
                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h1 className="text-3xl font-bold text-gray-900">Panel de Administraci√≥n</h1>
                        </div>
                        
                        <div className="bg-white rounded-lg shadow">
                            <div className="border-b border-gray-200">
                                <nav className="flex space-x-8 px-6">
                                    <button 
                                        onClick={() => setActiveTab('users')}
                                        className={`py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'users' ? 'border-[#006666] text-[#006666]' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                                    >
                                        Gesti√≥n de Usuarios
                                    </button>
                                    <button 
                                        onClick={() => setActiveTab('settings')}
                                        className={`py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'settings' ? 'border-[#006666] text-[#006666]' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                                    >
                                        Configuraci√≥n del Sistema
                                    </button>
                                    
                                </nav>
                            </div>
                            
                            <div className="p-6">
                                {activeTab === 'users' && (
                                    <div>
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="text-xl font-semibold">Gesti√≥n de Usuarios</h2>
                                            <div className="flex items-center gap-3">
                                                <button 
                                                    onClick={loadUsers}
                                                    className="px-3 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2"
                                                    disabled={loading}
                                                >
                                                    <RefreshIcon width={16} height={16} className={loading ? 'animate-spin' : ''} />
                                                    Actualizar
                                                </button>
                                                <button 
                                                    onClick={handleInviteUser}
                                                    className="bg-[#006666] text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-[#005555]"
                                                >
                                                    <PlusIcon width={20} height={20} />
                                                    Invitar Usuario
                                                </button>
                                            </div>
                                        </div>
                                        
                                        {error && (
                                            <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                                                <div className="flex items-center gap-2">
                                                    <svg width="20" height="20" className="text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                                    </svg>
                                                    <div>
                                                        <h4 className="font-semibold text-red-800">Error cargando usuarios</h4>
                                                        <p className="text-sm text-red-700 mt-1">{error}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {loading ? (
                                            <div className="text-center py-8">
                                                <div className="inline-flex items-center gap-2 text-gray-500">
                                                    <div className="w-5 h-5 border-2 border-gray-300 border-t-[#006666] rounded-full animate-spin"></div>
                                                    Cargando usuarios...
                                                </div>
                                            </div>
                                        ) : users.length === 0 ? (
                                            <div className="text-center py-8 text-gray-500">
                                                <svg width="48" height="48" className="mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                                </svg>
                                                <p className="text-lg">No hay usuarios registrados</p>
                                                <p className="text-sm">Los usuarios aparecer√°n aqu√≠ cuando se registren en el sistema</p>
                                            </div>
                                        ) : (
                                            <div className="overflow-x-auto">
                                                <table className="min-w-full divide-y divide-gray-200">
                                                    <thead className="bg-gray-50">
                                                        <tr>
                                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rol</th>
                                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Registro</th>
                                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                                            <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="bg-white divide-y divide-gray-200">
                                                        {users.map((user, index) => (
                                                            <tr key={user.id} className="hover:bg-gray-50">
                                                                <td className="px-6 py-4 whitespace-nowrap">
                                                                    <div className="flex items-center">
                                                                        <img 
                                                                            src={user.photoURL || `https://placehold.co/40x40/006666/FFFFFF?text=${(user.name || user.email)?.[0]?.toUpperCase() || 'U'}`}
                                                                            alt="Avatar" 
                                                                            className="w-10 h-10 rounded-full"
                                                                        />
                                                                        <div className="ml-4">
                                                                            <div className="text-sm font-medium text-gray-900">
                                                                                {user.name || 'Sin nombre'}
                                                                            </div>
                                                                            <div className="text-sm text-gray-500">
                                                                                Usuario #{index + 1}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td className="px-6 py-4 whitespace-nowrap">
                                                                    <div className="text-sm text-gray-900">{user.email}</div>
                                                                    {user.phone && (
                                                                        <div className="text-sm text-gray-500">{user.phone}</div>
                                                                    )}
                                                                </td>
                                                                <td className="px-6 py-4 whitespace-nowrap">
                                                                    {getRoleBadge(user.role)}
                                                                    {user.isFirstUser && (
                                                                        <div className="text-xs text-yellow-600 mt-1 flex items-center gap-1">
                                                                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                                                                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                                                            </svg>
                                                                            Primer usuario
                                                                        </div>
                                                                    )}
                                                                </td>
                                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                                    {formatDate(user.createdAt)}
                                                                </td>
                                                                <td className="px-6 py-4 whitespace-nowrap">
                                                                    <div className="flex items-center">
                                                                        <div className={`w-3 h-3 rounded-full mr-2 ${
                                                                            user.active !== false ? 'bg-green-500' : 'bg-red-500'
                                                                        }`}></div>
                                                                        <span className={`text-sm font-medium ${
                                                                            user.active !== false ? 'text-green-700' : 'text-red-700'
                                                                        }`}>
                                                                            {user.active !== false ? 'Activo' : 'Inactivo'}
                                                                        </span>
                                                                    </div>
                                                                </td>
                                                                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                                    <div className="flex justify-end gap-2">
                                                                        <button 
                                                                            onClick={() => handleUserAction('edit', user.id, user)}
                                                                            className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                                                            title="Editar usuario"
                                                                        >
                                                                            <EditIcon width={16} height={16} />
                                                                        </button>
                                                                        <button 
                                                                            onClick={() => handleUserAction('view', user.id, user)}
                                                                            className="p-2 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors"
                                                                            title="Ver detalles"
                                                                        >
                                                                            <EyeIcon width={16} height={16} />
                                                                        </button>
                                                                        {user.role !== 'admin' && (
                                                                            <button 
                                                                                onClick={() => handleUserAction('deactivate', user.id, user)}
                                                                                className={`p-2 rounded-lg transition-colors ${
                                                                                    user.active !== false 
                                                                                        ? 'text-red-600 hover:bg-red-50' 
                                                                                        : 'text-green-600 hover:bg-green-50'
                                                                                }`}
                                                                                title={user.active !== false ? 'Desactivar usuario' : 'Activar usuario'}
                                                                            >
                                                                                {user.active !== false ? (
                                                                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                                                                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                                                                    </svg>
                                                                                ) : (
                                                                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                                                                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                                                                    </svg>
                                                                                )}
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                                
                                                <div className="px-6 py-3 bg-gray-50 border-t border-gray-200">
                                                    <div className="text-sm text-gray-700">
                                                        Mostrando <span className="font-medium">{users.length}</span> usuario{users.length !== 1 ? 's' : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                {activeTab === 'settings' && (
                                    <div>
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="text-xl font-semibold">Configuraci√≥n del Sistema</h2>
                                        </div>
                                        
                                        <SystemSettings />
                                    </div>
                                )}
                                
                                
                            </div>
                        </div>
                        
                        {/* Modal de Invitaci√≥n de Usuario */}
                        {showInviteModal && (
                            <InviteUserModal 
                                onClose={() => setShowInviteModal(false)}
                                onUserInvited={() => {
                                    setShowInviteModal(false);
                                    loadUsers(); // Recargar usuarios
                                }}
                            />
                        )}
                        
                        {/* Modal de Edici√≥n de Usuario */}
                        {showEditModal && editingUser && (
                            <EditUserModal 
                                user={editingUser}
                                onClose={() => {
                                    setShowEditModal(false);
                                    setEditingUser(null);
                                }}
                                onUserUpdated={() => {
                                    setShowEditModal(false);
                                    setEditingUser(null);
                                    loadUsers(); // Recargar usuarios
                                }}
                            />
                        )}
                        
                        {/* Modal de Vista Detallada de Usuario */}
                        {showViewModal && viewingUser && (
                            <ViewUserModal 
                                user={viewingUser}
                                onClose={() => {
                                    setShowViewModal(false);
                                    setViewingUser(null);
                                }}
                                onEdit={() => {
                                    setShowViewModal(false);
                                    setEditingUser(viewingUser);
                                    setViewingUser(null);
                                    setShowEditModal(true);
                                }}
                            />
                        )}
                    </div>
                );
            }
            
            // Componente de Configuraciones del Sistema
            function SystemSettings() {
                const [activeSection, setActiveSection] = useState('company');
                const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
                
                // Exponer las funciones globalmente
                useEffect(() => {
                    window.SystemSettingsRef = { 
                        setHasUnsavedChanges,
                        markChangesAsSaved: () => setHasUnsavedChanges(false)
                    };
                    return () => {
                        window.SystemSettingsRef = null;
                    };
                }, []);

                // Funci√≥n para cambiar de secci√≥n con confirmaci√≥n
                const handleSectionChange = async (newSection) => {
                    if (hasUnsavedChanges) {
                        const confirmed = await showConfirm(
                            'Cambios no guardados',
                            'Has modificado los contadores de facturas. ¬øEst√°s seguro de que quieres cambiar de secci√≥n sin guardar los cambios?',
                            () => {},
                            'warning'
                        );
                        if (!confirmed) return;
                    }
                    setActiveSection(newSection);
                    setHasUnsavedChanges(false);
                };
                const [settings, setSettings] = useState({
                    // Configuraciones de empresa
                    company: {
                        name: 'Expertia Medical Solutions',
                        nit: '123456789-0',
                        taxId: 'B12345678',
                        address: 'Calle 123 #45-67, Bogot√°, Colombia',
                        phone: '+57 1 234 5678',
                        email: 'info@expertiamed.com',
                        website: 'https://expertiamed.com',
                        logo: null
                    },
                    // Configuraciones de seguridad
                    security: {
                        sessionTimeout: 30, // minutos
                        requireEmailVerification: true,
                        allowGoogleLogin: true,
                        passwordComplexity: 'medium',
                        twoFactorAuth: false,
                        maxLoginAttempts: 5
                    },
                    // Configuraciones de notificaciones
                    notifications: {
                        emailNotifications: true,
                        newUserRegistration: true,
                        systemAlerts: true,
                        weeklyReports: false,
                        maintenanceAlerts: true
                    },
                    // Configuraciones de integraci√≥n
                    integrations: {
                        whatsappApiKey: '',
                        emailProvider: 'gmail',
                        smtpHost: '',
                        smtpPort: 587,
                        smtpUsername: '',
                        smtpPassword: ''
                    },
                    // Configuraciones de productos
                    products: {
                        categories: [
                            'Diagn√≥stico por Imagen',
                            'Cardiolog√≠a',
                            'Laboratorio',
                            'Quir√≥fano',
                            'UCI',
                            'Emergencias',
                            'Rehabilitaci√≥n',
                            'Servicios'
                        ],
                        suppliers: [
                            'Storz Medical',
                            'Zamar Medical',
                            'Phillips Healthcare',
                            'GE Healthcare',
                            'Siemens Healthineers'
                        ]
                    },
                    // Configuraciones de ventas
                    sales: {
                        sources: ['Web', 'Referido', 'Llamada Fr√≠a', 'Evento', 'Partner', 'Publicidad'],
                        funnelStages: ['Lead', 'Primer Contacto', 'Interesado', 'Demo Realizada', 'Negociaci√≥n', 'En Cierre', 'Ganado', 'Perdido'],
                        contactPreferences: ['Email', 'Tel√©fono', 'WhatsApp', 'Visita Comercial'],
                        priorities: ['Alta', 'Media', 'Baja']
                    },
                    // Configuraciones de facturaci√≥n
                    invoice: {
                        globalCounter: 0,
                        series: ['EXP', 'ALQ', 'PROF'],
                        nextNumbers: { EXP: 0, ALQ: 0, PROF: 0 },
                        defaultCurrency: 'EUR',
                        vatRate: 0.21,
                        paymentTerms: 30
                    }
                });
                const [loading, setLoading] = useState(false);
                const [saved, setSaved] = useState(false);
                
                // Cargar configuraciones al inicializar
                useEffect(() => {
                    loadSettingsFromFirebase();
                }, []);
                
                const loadSettingsFromFirebase = async () => {
                    try {
                        console.log('üì• Cargando configuraciones desde Firebase...');
                        
                        if (!window.authManager || !window.authManager.app) {
                            console.log('[WARNING]  Firebase no disponible, usando configuraciones por defecto');
                            return;
                        }
                        
                        // Usar las funciones globales de Firebase
                        const { doc, getDoc } = window.firebase;
                        if (!doc || !getDoc) {
                            throw new Error('Funciones de Firebase no disponibles');
                        }
                        
                        // Usar la instancia db global que ya est√° disponible
                        const db = window.firebaseDb;
                        const settingsRef = doc(db, 'system_settings', 'main');
                        const settingsDoc = await getDoc(settingsRef);
                        
                        if (settingsDoc.exists()) {
                            const firebaseSettings = settingsDoc.data();
                            console.log('[OK]  Configuraciones cargadas desde Firebase');
                            
                            // Mantener estructura por defecto y sobrescribir con datos de Firebase
                            setSettings(prevSettings => ({
                                ...prevSettings,
                                ...firebaseSettings,
                                // Asegurar que las fechas se conviertan correctamente
                                updatedAt: firebaseSettings.updatedAt?.toDate?.() || firebaseSettings.updatedAt
                            }));
                        } else {
                            console.log('[INFO]  No hay configuraciones guardadas, usando valores por defecto');
                        }
                        
                    } catch (error) {
                        console.error('[ERROR]  Error cargando configuraciones desde Firebase:', error);
                        console.log('[INFO]  Usando configuraciones por defecto');
                    }
                };
                
                const handleSettingChange = (section, key, value) => {
                    setSettings(prev => ({
                        ...prev,
                        [section]: {
                            ...prev[section],
                            [key]: value
                        }
                    }));
                    setHasUnsavedChanges(true);
                };
                
                const handleSave = async () => {
                    try {
                        setLoading(true);
                        
                        console.log('üíæ [DEBUG] Intentando guardar configuraciones en Firebase:', JSON.stringify(settings, null, 2));
                        
                        if (!window.authManager || !window.authManager.app) {
                            throw new Error('Sistema de autenticaci√≥n no disponible');
                        }
                        
                        // Usar las funciones globales de Firebase
                        const { doc, setDoc, getDoc } = window.firebase;
                        if (!doc || !setDoc || !getDoc) {
                            throw new Error('Funciones de Firebase no disponibles');
                        }
                        
                        // Usar la instancia db global que ya est√° disponible
                        const db = window.firebaseDb;
                        const settingsRef = doc(db, 'system_settings', 'main');
                        
                        // Preparar datos para guardar
                        const settingsData = {
                            ...settings,
                            updatedAt: new Date(),
                            updatedBy: window.authManager.currentUser.uid,
                            version: Date.now() // Para control de versiones
                        };
                        
                        console.log('üíæ [DEBUG] settingsData final que se enviar√° a setDoc:', JSON.stringify(settingsData, null, 2));
                        // Guardar en Firebase usando setDoc para crear o actualizar
                        await setDoc(settingsRef, settingsData, { merge: true });
                        
                        console.log('[OK]  [DEBUG] Configuraciones guardadas exitosamente en Firebase');
                        
                        // IMPORTANTE: Recargar la configuraci√≥n global de la aplicaci√≥n
                        if (window.loadAppConfig && typeof window.loadAppConfig === 'function') {
                            await window.loadAppConfig();
                            console.log('[INFO]  Configuraci√≥n global recargada');
                        }
                        
                        setSaved(true);
                        setTimeout(() => setSaved(false), 3000);
                        
                        // Mostrar confirmaci√≥n con notificaci√≥n moderna
                        showNotification(
                            'Configuraciones Guardadas',
                            `Fecha de actualizaci√≥n:\n${new Date().toLocaleString('es-ES')}`,
                            'success',
                            6000
                        );
                        
                    } catch (error) {
                        console.error('[ERROR]  [DEBUG] Error guardando configuraciones en Firebase:', error);
                        showNotification(
                            'Error al Guardar',
                            'No se pudieron guardar las configuraciones: ' + error.message,
                            'error',
                            5000
                        );
                    } finally {
                        setLoading(false);
                    }
                };
                
                const sections = [
                    { id: 'company', label: 'Empresa', icon: 'building' },
                    { id: 'security', label: 'Seguridad', icon: 'shield' },
                    { id: 'notifications', label: 'Notificaciones', icon: 'bell' },
                    { id: 'integrations', label: 'Integraciones', icon: 'plug' },
                    { id: 'expenses', label: 'Gastos', icon: 'credit-card' },
                    { id: 'products', label: 'Productos', icon: 'package' },
                    { id: 'sales', label: 'Ventas', icon: 'trending-up' },
                    { id: 'invoice', label: 'Facturaci√≥n', icon: 'file-text' },
                    { id: 'analysis', label: 'An√°lisis DB', icon: 'database' }
                ];
                
                const getSectionIcon = (iconName) => {
                    const icons = {
                        building: (
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clipRule="evenodd" />
                            </svg>
                        ),
                        shield: (
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                            </svg>
                        ),
                        bell: (
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" />
                            </svg>
                        ),
                        plug: (
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" />
                            </svg>
                        ),
                        package: (
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                            </svg>
                        ),
                        'trending-up': (
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clipRule="evenodd"/>
                            </svg>
                        ),
                        'file-text': (
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clipRule="evenodd"/>
                            </svg>
                        ),
                        'credit-card': (
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4h14a2 2 0 012 2v1H1V6a2 2 0 012-2z"/>
                                <path d="M1 9h18v5a2 2 0 01-2 2H3a2 2 0 01-2-2V9zm3 3h4a1 1 0 010 2H4a1 1 0 110-2z"/>
                            </svg>
                        ),
                        database: (
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 12v3c0 1.657 3.134 3 7 3s7-1.343 7-3v-3c0 1.657-3.134 3-7 3s-7-1.343-7-3z"/>
                                <path d="M3 7v3c0 1.657 3.134 3 7 3s7-1.343 7-3V7c0 1.657-3.134 3-7 3S3 8.657 3 7z"/>
                                <path d="M17 5c0 1.657-3.134 3-7 3S3 6.657 3 5s3.134-3 7-3 7 1.343 7 3z"/>
                            </svg>
                        )
                    };
                    return icons[iconName] || icons.building;
                };
                
                return (
                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        {/* Navegaci√≥n lateral */}
                        <div className="lg:col-span-1">
                            <nav className="space-y-1">
                                {sections.map(section => (
                                    <button
                                        key={section.id}
                                        onClick={() => handleSectionChange(section.id)}
                                        className={`w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 transition-colors ${
                                            activeSection === section.id
                                                ? 'bg-[#006666] text-white'
                                                : 'text-gray-700 hover:bg-gray-100'
                                        }`}
                                    >
                                        {getSectionIcon(section.icon)}
                                        <span className="font-medium">{section.label}</span>
                                    </button>
                                ))}
                            </nav>
                        </div>
                        
                        {/* Contenido principal */}
                        <div className="lg:col-span-3">
                            <div className="bg-white rounded-lg shadow p-6">
                                {/* Configuraciones de Empresa */}
                                {activeSection === 'company' && (
                                    <div>
                                        <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                                            {getSectionIcon('building')}
                                            Informaci√≥n de la Empresa
                                        </h3>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Nombre de la empresa
                                                </label>
                                                <input
                                                    type="text"
                                                    value={settings.company.name}
                                                    onChange={(e) => handleSettingChange('company', 'name', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    NIT/RUC
                                                </label>
                                                <input
                                                    type="text"
                                                    value={settings.company.nit}
                                                    onChange={(e) => handleSettingChange('company', 'nit', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                />
                                            </div>
                                            
                                            <div className="md:col-span-2">
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Direcci√≥n
                                                </label>
                                                <input
                                                    type="text"
                                                    value={settings.company.address}
                                                    onChange={(e) => handleSettingChange('company', 'address', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Tel√©fono
                                                </label>
                                                <input
                                                    type="tel"
                                                    value={settings.company.phone}
                                                    onChange={(e) => handleSettingChange('company', 'phone', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Email
                                                </label>
                                                <input
                                                    type="email"
                                                    value={settings.company.email}
                                                    onChange={(e) => handleSettingChange('company', 'email', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                />
                                            </div>
                                            
                                            <div className="md:col-span-2">
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Sitio web
                                                </label>
                                                <input
                                                    type="url"
                                                    value={settings.company.website}
                                                    onChange={(e) => handleSettingChange('company', 'website', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Configuraciones de Seguridad */}
                                {activeSection === 'security' && (
                                    <div>
                                        <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                                            {getSectionIcon('shield')}
                                            Configuraciones de Seguridad
                                        </h3>
                                        
                                        <div className="space-y-6">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Tiempo l√≠mite de sesi√≥n (minutos)
                                                </label>
                                                <select
                                                    value={settings.security.sessionTimeout}
                                                    onChange={(e) => handleSettingChange('security', 'sessionTimeout', parseInt(e.target.value))}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                >
                                                    <option value={15}>15 minutos</option>
                                                    <option value={30}>30 minutos</option>
                                                    <option value={60}>1 hora</option>
                                                    <option value={120}>2 horas</option>
                                                    <option value={480}>8 horas</option>
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Complejidad de contrase√±as
                                                </label>
                                                <select
                                                    value={settings.security.passwordComplexity}
                                                    onChange={(e) => handleSettingChange('security', 'passwordComplexity', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                >
                                                    <option value="low">Baja (m√≠nimo 6 caracteres)</option>
                                                    <option value="medium">Media (8+ caracteres, may√∫sculas y n√∫meros)</option>
                                                    <option value="high">Alta (12+ caracteres, s√≠mbolos especiales)</option>
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Intentos m√°ximos de login
                                                </label>
                                                <input
                                                    type="number"
                                                    min="3"
                                                    max="10"
                                                    value={settings.security.maxLoginAttempts}
                                                    onChange={(e) => handleSettingChange('security', 'maxLoginAttempts', parseInt(e.target.value))}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                />
                                            </div>
                                            
                                            <div className="space-y-3">
                                                <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                                    <div>
                                                        <h4 className="font-medium text-gray-900">Verificaci√≥n de email obligatoria</h4>
                                                        <p className="text-sm text-gray-600">Los usuarios deben verificar su email antes de acceder</p>
                                                    </div>
                                                    <label className="relative inline-flex items-center cursor-pointer">
                                                        <input
                                                            type="checkbox"
                                                            checked={settings.security.requireEmailVerification}
                                                            onChange={(e) => handleSettingChange('security', 'requireEmailVerification', e.target.checked)}
                                                            className="sr-only peer"
                                                        />
                                                        <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-[#006666]/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#006666]"></div>
                                                    </label>
                                                </div>
                                                
                                                <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                                    <div>
                                                        <h4 className="font-medium text-gray-900">Login con Google</h4>
                                                        <p className="text-sm text-gray-600">Permitir autenticaci√≥n con cuentas de Google</p>
                                                    </div>
                                                    <label className="relative inline-flex items-center cursor-pointer">
                                                        <input
                                                            type="checkbox"
                                                            checked={settings.security.allowGoogleLogin}
                                                            onChange={(e) => handleSettingChange('security', 'allowGoogleLogin', e.target.checked)}
                                                            className="sr-only peer"
                                                        />
                                                        <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-[#006666]/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#006666]"></div>
                                                    </label>
                                                </div>
                                                
                                                <div className="flex items-center justify-between p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                                    <div>
                                                        <h4 className="font-medium text-gray-900 flex items-center gap-2">
                                                            <span className="bg-yellow-500 text-white px-2 py-1 rounded text-xs">PR√ìXIMAMENTE</span>
                                                            Autenticaci√≥n de dos factores
                                                        </h4>
                                                        <p className="text-sm text-gray-600">Capa adicional de seguridad con SMS o aplicaci√≥n</p>
                                                    </div>
                                                    <label className="relative inline-flex items-center cursor-not-allowed opacity-50">
                                                        <input
                                                            type="checkbox"
                                                            checked={settings.security.twoFactorAuth}
                                                            disabled
                                                            className="sr-only peer"
                                                        />
                                                        <div className="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Configuraciones de Notificaciones */}
                                {activeSection === 'notifications' && (
                                    <div>
                                        <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                                            {getSectionIcon('bell')}
                                            Configuraciones de Notificaciones
                                        </h3>
                                        
                                        <div className="space-y-3">
                                            <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                                <div>
                                                    <h4 className="font-medium text-gray-900">Notificaciones por email</h4>
                                                    <p className="text-sm text-gray-600">Enviar notificaciones importantes por correo electr√≥nico</p>
                                                </div>
                                                <label className="relative inline-flex items-center cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={settings.notifications.emailNotifications}
                                                        onChange={(e) => handleSettingChange('notifications', 'emailNotifications', e.target.checked)}
                                                        className="sr-only peer"
                                                    />
                                                    <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-[#006666]/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#006666]"></div>
                                                </label>
                                            </div>
                                            
                                            <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                                <div>
                                                    <h4 className="font-medium text-gray-900">Registro de nuevos usuarios</h4>
                                                    <p className="text-sm text-gray-600">Notificar cuando se registren nuevos usuarios</p>
                                                </div>
                                                <label className="relative inline-flex items-center cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={settings.notifications.newUserRegistration}
                                                        onChange={(e) => handleSettingChange('notifications', 'newUserRegistration', e.target.checked)}
                                                        className="sr-only peer"
                                                    />
                                                    <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-[#006666]/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#006666]"></div>
                                                </label>
                                            </div>
                                            
                                            <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                                <div>
                                                    <h4 className="font-medium text-gray-900">Alertas del sistema</h4>
                                                    <p className="text-sm text-gray-600">Notificaciones sobre errores y eventos importantes</p>
                                                </div>
                                                <label className="relative inline-flex items-center cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={settings.notifications.systemAlerts}
                                                        onChange={(e) => handleSettingChange('notifications', 'systemAlerts', e.target.checked)}
                                                        className="sr-only peer"
                                                    />
                                                    <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-[#006666]/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#006666]"></div>
                                                </label>
                                            </div>
                                            
                                            <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                                <div>
                                                    <h4 className="font-medium text-gray-900">Reportes semanales</h4>
                                                    <p className="text-sm text-gray-600">Resumen semanal de actividad del sistema</p>
                                                </div>
                                                <label className="relative inline-flex items-center cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={settings.notifications.weeklyReports}
                                                        onChange={(e) => handleSettingChange('notifications', 'weeklyReports', e.target.checked)}
                                                        className="sr-only peer"
                                                    />
                                                    <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-[#006666]/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#006666]"></div>
                                                </label>
                                            </div>
                                            
                                            <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                                <div>
                                                    <h4 className="font-medium text-gray-900">Alertas de mantenimiento</h4>
                                                    <p className="text-sm text-gray-600">Notificar sobre mantenimientos programados</p>
                                                </div>
                                                <label className="relative inline-flex items-center cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={settings.notifications.maintenanceAlerts}
                                                        onChange={(e) => handleSettingChange('notifications', 'maintenanceAlerts', e.target.checked)}
                                                        className="sr-only peer"
                                                    />
                                                    <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-[#006666]/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#006666]"></div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Configuraciones de Integraciones */}
                                {activeSection === 'integrations' && (
                                    <div>
                                        <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                                            {getSectionIcon('plug')}
                                            Integraciones Externas
                                        </h3>
                                        
                                        <div className="space-y-6">
                                            <div className="border border-gray-200 rounded-lg p-4">
                                                <h4 className="font-medium text-gray-900 mb-4 flex items-center gap-2">
                                                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" className="text-green-500">
                                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.465 3.516"/>
                                                    </svg>
                                                    WhatsApp Business API
                                                </h4>
                                                <div className="space-y-3">
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                                            API Key
                                                        </label>
                                                        <input
                                                            type="password"
                                                            value={settings.integrations.whatsappApiKey}
                                                            onChange={(e) => handleSettingChange('integrations', 'whatsappApiKey', e.target.value)}
                                                            placeholder="Ingresa tu API key de WhatsApp"
                                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                        />
                                                        <p className="text-sm text-gray-500 mt-1">
                                                            Obt√©n tu API key en WhatsApp Business Platform
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div className="border border-gray-200 rounded-lg p-4">
                                                <h4 className="font-medium text-gray-900 mb-4 flex items-center gap-2">
                                                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" className="text-red-500">
                                                        <path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-.904.732-1.636 1.636-1.636h.273L12 10.845l10.091-7.024h.273c.904 0 1.636.732 1.636 1.636z"/>
                                                    </svg>
                                                    Configuraci√≥n de Email
                                                </h4>
                                                <div className="space-y-3">
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                                            Proveedor de email
                                                        </label>
                                                        <select
                                                            value={settings.integrations.emailProvider}
                                                            onChange={(e) => handleSettingChange('integrations', 'emailProvider', e.target.value)}
                                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                        >
                                                            <option value="gmail">Gmail/Google Workspace</option>
                                                            <option value="outlook">Outlook/Office 365</option>
                                                            <option value="smtp">SMTP Personalizado</option>
                                                        </select>
                                                    </div>
                                                    
                                                    {settings.integrations.emailProvider === 'smtp' && (
                                                        <>
                                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                                <div>
                                                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                                                        Host SMTP
                                                                    </label>
                                                                    <input
                                                                        type="text"
                                                                        value={settings.integrations.smtpHost}
                                                                        onChange={(e) => handleSettingChange('integrations', 'smtpHost', e.target.value)}
                                                                        placeholder="smtp.example.com"
                                                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                                    />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                                                        Puerto
                                                                    </label>
                                                                    <input
                                                                        type="number"
                                                                        value={settings.integrations.smtpPort}
                                                                        onChange={(e) => handleSettingChange('integrations', 'smtpPort', parseInt(e.target.value))}
                                                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                                    />
                                                                </div>
                                                            </div>
                                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                                <div>
                                                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                                                        Usuario
                                                                    </label>
                                                                    <input
                                                                        type="text"
                                                                        value={settings.integrations.smtpUsername}
                                                                        onChange={(e) => handleSettingChange('integrations', 'smtpUsername', e.target.value)}
                                                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                                    />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                                                        Contrase√±a
                                                                    </label>
                                                                    <input
                                                                        type="password"
                                                                        value={settings.integrations.smtpPassword}
                                                                        onChange={(e) => handleSettingChange('integrations', 'smtpPassword', e.target.value)}
                                                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                                    />
                                                                </div>
                                                            </div>
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {/* An√°lisis de Base de Datos */}
                                {activeSection === 'analysis' && (
                                    <div>
                                        <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                                            {getSectionIcon('database')}
                                            An√°lisis de Base de Datos
                                        </h3>
                                        
                                        <div className="space-y-6">
                                            {/* Informaci√≥n de la tabla system_settings */}
                                            <div className="border border-blue-200 rounded-lg p-6 bg-blue-50">
                                                <h4 className="font-semibold text-blue-900 mb-3 flex items-center gap-2">
                                                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20" className="text-blue-600">
                                                        <path d="M3 12v3c0 1.657 3.134 3 7 3s7-1.343 7-3v-3c0 1.657-3.134 3-7 3s-7-1.343-7-3z"/>
                                                        <path d="M3 7v3c0 1.657 3.134 3 7 3s7-1.343 7-3V7c0 1.657-3.134 3-7 3S3 8.657 3 7z"/>
                                                        <path d="M17 5c0 1.657-3.134 3-7 3S3 6.657 3 5s3.134-3 7-3 7 1.343 7 3z"/>
                                                    </svg>
                                                    Tabla: /system_settings
                                                </h4>
                                                <p className="text-blue-800 mb-4">
                                                    Esta tabla almacena todas las configuraciones del sistema incluyendo datos de empresa, 
                                                    seguridad, notificaciones e integraciones.
                                                </p>
                                                
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                    <div className="bg-white p-3 rounded border">
                                                        <div className="text-sm text-gray-600">Estructura</div>
                                                        <div className="font-medium">4 Secciones principales</div>
                                                        <div className="text-xs text-gray-500">company, security, notifications, integrations</div>
                                                    </div>
                                                    <div className="bg-white p-3 rounded border">
                                                        <div className="text-sm text-gray-600">Documento principal</div>
                                                        <div className="font-medium">/system_settings/main</div>
                                                        <div className="text-xs text-gray-500">Configuraciones activas</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Herramientas de an√°lisis */}
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                <button 
                                                    onClick={() => {
                                                        if (window.analyzeFirebaseSettings) {
                                                            window.analyzeFirebaseSettings().then(result => {
                                                                console.log('[DEBUG]  An√°lisis completado:', result);
                                                                showNotification(
                                                                    'An√°lisis Completado',
                                                                    'Revisa la consola del navegador (F12) para ver los detalles completos del an√°lisis de la base de datos.',
                                                                    'success',
                                                                    5000
                                                                );
                                                            }).catch(error => {
                                                                console.error('Error en an√°lisis:', error);
                                                                showNotification('Error de An√°lisis', 'No se pudo completar el an√°lisis: ' + error.message, 'error');
                                                            });
                                                        } else {
                                                            showNotification('Herramienta no disponible', 'Firebase Analyzer no est√° cargado', 'warning');
                                                        }
                                                    }}
                                                    className="flex flex-col items-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors group"
                                                >
                                                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20" className="text-gray-400 group-hover:text-blue-500 mb-2">
                                                        <path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd"/>
                                                    </svg>
                                                    <span className="text-sm font-medium text-gray-700 group-hover:text-blue-700">
                                                        Analizar Estructura
                                                    </span>
                                                    <span className="text-xs text-gray-500 text-center mt-1">
                                                        Inspeccionar datos y metadatos
                                                    </span>
                                                </button>
                                                
                                                <button 
                                                    onClick={() => {
                                                        if (window.exportFirebaseSettings) {
                                                            window.exportFirebaseSettings().then(result => {
                                                                console.log('üíæ Exportaci√≥n completada:', result);
                                                                showNotification(
                                                                    'Exportaci√≥n Completada',
                                                                    'Las configuraciones se han descargado como archivo JSON.',
                                                                    'success'
                                                                );
                                                            }).catch(error => {
                                                                console.error('Error en exportaci√≥n:', error);
                                                                showNotification('Error de Exportaci√≥n', error.message, 'error');
                                                            });
                                                        } else {
                                                            showNotification('Herramienta no disponible', 'Firebase Analyzer no est√° cargado', 'warning');
                                                        }
                                                    }}
                                                    className="flex flex-col items-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-green-500 hover:bg-green-50 transition-colors group"
                                                >
                                                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20" className="text-gray-400 group-hover:text-green-500 mb-2">
                                                        <path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clipRule="evenodd"/>
                                                    </svg>
                                                    <span className="text-sm font-medium text-gray-700 group-hover:text-green-700">
                                                        Exportar Datos
                                                    </span>
                                                    <span className="text-xs text-gray-500 text-center mt-1">
                                                        Descargar como JSON
                                                    </span>
                                                </button>
                                                
                                                <button 
                                                    onClick={() => {
                                                        if (window.backupFirebaseSettings) {
                                                            window.backupFirebaseSettings().then(backupId => {
                                                                console.log('üóÑÔ∏è Backup creado:', backupId);
                                                                showNotification(
                                                                    'Backup Creado',
                                                                    `Backup guardado con ID: ${backupId}`,
                                                                    'success'
                                                                );
                                                            }).catch(error => {
                                                                console.error('Error creando backup:', error);
                                                                showNotification('Error de Backup', error.message, 'error');
                                                            });
                                                        } else {
                                                            showNotification('Herramienta no disponible', 'Firebase Analyzer no est√° cargado', 'warning');
                                                        }
                                                    }}
                                                    className="flex flex-col items-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors group"
                                                >
                                                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20" className="text-gray-400 group-hover:text-purple-500 mb-2">
                                                        <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"/>
                                                        <path fillRule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clipRule="evenodd"/>
                                                    </svg>
                                                    <span className="text-sm font-medium text-gray-700 group-hover:text-purple-700">
                                                        Crear Backup
                                                    </span>
                                                    <span className="text-xs text-gray-500 text-center mt-1">
                                                        Respaldo en Firebase
                                                    </span>
                                                </button>
                                            </div>
                                            
                                            {/* Comandos de consola */}
                                            <div className="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                                <h4 className="font-medium text-gray-900 mb-3">Comandos de consola disponibles:</h4>
                                                <div className="space-y-2 text-sm font-mono">
                                                    <div className="flex items-center justify-between">
                                                        <code className="bg-white px-2 py-1 rounded border">analyzeFirebaseSettings()</code>
                                                        <span className="text-gray-600 text-xs">Analizar estructura completa</span>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <code className="bg-white px-2 py-1 rounded border">exportFirebaseSettings()</code>
                                                        <span className="text-gray-600 text-xs">Exportar y descargar datos</span>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <code className="bg-white px-2 py-1 rounded border">backupFirebaseSettings()</code>
                                                        <span className="text-gray-600 text-xs">Crear backup en Firebase</span>
                                                    </div>
                                                </div>
                                                <p className="text-xs text-gray-500 mt-2">
                                                    üí° Abre la consola del navegador (F12) y ejecuta estos comandos para an√°lisis avanzado
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Configuraciones de Productos */}
                                {activeSection === 'products' && (
                                    <div>
                                        <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                                            {getSectionIcon('package')}
                                            Configuraciones de Productos
                                        </h3>
                                        
                                        <div className="space-y-6">
                                            {/* Categor√≠as */}
                                            <div className="border border-gray-200 rounded-lg p-6">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h4 className="font-semibold text-gray-900">Categor√≠as de Productos</h4>
                                                    <button
                                                        type="button"
                                                        onClick={async () => {
                                                            const newCategory = await showInput('Agregar Categor√≠a', 'Nombre de la nueva categor√≠a');
                                                            if (newCategory) {
                                                                handleSettingChange('products', 'categories', [...settings.products.categories, newCategory]);
                                                            }
                                                        }}
                                                        className="px-3 py-1 bg-[#006666] text-white rounded-md text-sm hover:bg-[#004d4d] transition-colors"
                                                    >
                                                        Agregar Categor√≠a
                                                    </button>
                                                </div>
                                                <div className="space-y-2">
                                                    {settings.products.categories.map((category, index) => (
                                                        <div key={index} className="flex items-center justify-between bg-gray-50 px-3 py-2 rounded">
                                                            <span className="text-gray-700">{category}</span>
                                                            <button
                                                                type="button"
                                                                onClick={async () => {
                                                                    const confirmed = await showConfirm(
                                                                        'Eliminar Categor√≠a', 
                                                                        `¬øEst√°s seguro de que quieres eliminar la categor√≠a "${category}"? Esta acci√≥n no se puede deshacer.`,
                                                                        () => {
                                                                            const updatedCategories = settings.products.categories.filter((_, i) => i !== index);
                                                                            handleSettingChange('products', 'categories', updatedCategories);
                                                                        },
                                                                        'danger'
                                                                    );
                                                                }}
                                                                className="text-red-500 hover:text-red-700 text-sm"
                                                            >
                                                                Eliminar
                                                            </button>
                                                        </div>
                                                    ))}
                                                    {settings.products.categories.length === 0 && (
                                                        <p className="text-gray-500 text-sm italic">No hay categor√≠as configuradas</p>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* Proveedores */}
                                            <div className="border border-gray-200 rounded-lg p-6">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h4 className="font-semibold text-gray-900">Proveedores</h4>
                                                    <button
                                                        type="button"
                                                        onClick={async () => {
                                                            const newSupplier = await showInput('Agregar Proveedor', 'Nombre del nuevo proveedor');
                                                            if (newSupplier) {
                                                                handleSettingChange('products', 'suppliers', [...settings.products.suppliers, newSupplier]);
                                                            }
                                                        }}
                                                        className="px-3 py-1 bg-[#006666] text-white rounded-md text-sm hover:bg-[#004d4d] transition-colors"
                                                    >
                                                        Agregar Proveedor
                                                    </button>
                                                </div>
                                                <div className="space-y-2">
                                                    {settings.products.suppliers.map((supplier, index) => (
                                                        <div key={index} className="flex items-center justify-between bg-gray-50 px-3 py-2 rounded">
                                                            <span className="text-gray-700">{supplier}</span>
                                                            <button
                                                                type="button"
                                                                onClick={async () => {
                                                                    const confirmed = await showConfirm(
                                                                        'Eliminar Proveedor', 
                                                                        `¬øEst√°s seguro de que quieres eliminar el proveedor "${supplier}"? Esta acci√≥n no se puede deshacer.`,
                                                                        () => {
                                                                            const updatedSuppliers = settings.products.suppliers.filter((_, i) => i !== index);
                                                                            handleSettingChange('products', 'suppliers', updatedSuppliers);
                                                                        },
                                                                        'danger'
                                                                    );
                                                                }}
                                                                className="text-red-500 hover:text-red-700 text-sm"
                                                            >
                                                                Eliminar
                                                            </button>
                                                        </div>
                                                    ))}
                                                    {settings.products.suppliers.length === 0 && (
                                                        <p className="text-gray-500 text-sm italic">No hay proveedores configurados</p>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Configuraciones de Ventas */}
                                {activeSection === 'sales' && (
                                    <div>
                                        <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                                            {getSectionIcon('trending-up')}
                                            Configuraciones de Ventas
                                        </h3>
                                        
                                        <div className="space-y-6">
                                            {/* Fuentes de Leads */}
                                            <div className="border border-gray-200 rounded-lg p-6">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h4 className="font-semibold text-gray-900">Fuentes de Leads</h4>
                                                    <button
                                                        type="button"
                                                        onClick={async () => {
                                                            const newSource = await showInput('Agregar Fuente', 'Nombre de la nueva fuente');
                                                            if (newSource) {
                                                                handleSettingChange('sales', 'sources', [...settings.sales.sources, newSource]);
                                                            }
                                                        }}
                                                        className="px-3 py-1 bg-[#006666] text-white rounded-md text-sm hover:bg-[#004d4d] transition-colors"
                                                    >
                                                        Agregar Fuente
                                                    </button>
                                                </div>
                                                <div className="space-y-2">
                                                    {settings.sales.sources.map((source, index) => (
                                                        <div key={index} className="flex items-center justify-between bg-gray-50 px-3 py-2 rounded">
                                                            <span className="text-gray-700">{source}</span>
                                                            <button
                                                                type="button"
                                                                onClick={async () => {
                                                                    const confirmed = await showConfirm(
                                                                        'Eliminar Fuente', 
                                                                        `¬øEst√°s seguro de que quieres eliminar la fuente "${source}"? Esta acci√≥n no se puede deshacer.`,
                                                                        () => {
                                                                            const updatedSources = settings.sales.sources.filter((_, i) => i !== index);
                                                                            handleSettingChange('sales', 'sources', updatedSources);
                                                                        },
                                                                        'danger'
                                                                    );
                                                                }}
                                                                className="text-red-500 hover:text-red-700 text-sm"
                                                            >
                                                                Eliminar
                                                            </button>
                                                        </div>
                                                    ))}
                                                    {settings.sales.sources.length === 0 && (
                                                        <p className="text-gray-500 text-sm italic">No hay fuentes configuradas</p>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* Etapas del Embudo */}
                                            <div className="border border-gray-200 rounded-lg p-6">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h4 className="font-semibold text-gray-900">Etapas del Embudo de Ventas</h4>
                                                    <button
                                                        type="button"
                                                        onClick={async () => {
                                                            const newStage = await showInput('Agregar Etapa', 'Nombre de la nueva etapa');
                                                            if (newStage) {
                                                                handleSettingChange('sales', 'funnelStages', [...settings.sales.funnelStages, newStage]);
                                                            }
                                                        }}
                                                        className="px-3 py-1 bg-[#006666] text-white rounded-md text-sm hover:bg-[#004d4d] transition-colors"
                                                    >
                                                        Agregar Etapa
                                                    </button>
                                                </div>
                                                <div className="space-y-2">
                                                    {settings.sales.funnelStages.map((stage, index) => (
                                                        <div key={index} className="flex items-center justify-between bg-gray-50 px-3 py-2 rounded">
                                                            <span className="text-gray-700">{stage}</span>
                                                            <button
                                                                type="button"
                                                                onClick={async () => {
                                                                    const confirmed = await showConfirm(
                                                                        'Eliminar Etapa', 
                                                                        `¬øEst√°s seguro de que quieres eliminar la etapa "${stage}"? Esta acci√≥n no se puede deshacer.`,
                                                                        () => {
                                                                            const updatedStages = settings.sales.funnelStages.filter((_, i) => i !== index);
                                                                            handleSettingChange('sales', 'funnelStages', updatedStages);
                                                                        },
                                                                        'danger'
                                                                    );
                                                                }}
                                                                className="text-red-500 hover:text-red-700 text-sm"
                                                            >
                                                                Eliminar
                                                            </button>
                                                        </div>
                                                    ))}
                                                    {settings.sales.funnelStages.length === 0 && (
                                                        <p className="text-gray-500 text-sm italic">No hay etapas configuradas</p>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* Preferencias de Contacto */}
                                            <div className="border border-gray-200 rounded-lg p-6">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h4 className="font-semibold text-gray-900">Preferencias de Contacto</h4>
                                                    <button
                                                        type="button"
                                                        onClick={async () => {
                                                            const newPreference = await showInput('Agregar Preferencia', 'Nueva preferencia de contacto');
                                                            if (newPreference) {
                                                                handleSettingChange('sales', 'contactPreferences', [...settings.sales.contactPreferences, newPreference]);
                                                            }
                                                        }}
                                                        className="px-3 py-1 bg-[#006666] text-white rounded-md text-sm hover:bg-[#004d4d] transition-colors"
                                                    >
                                                        Agregar Preferencia
                                                    </button>
                                                </div>
                                                <div className="space-y-2">
                                                    {settings.sales.contactPreferences.map((preference, index) => (
                                                        <div key={index} className="flex items-center justify-between bg-gray-50 px-3 py-2 rounded">
                                                            <span className="text-gray-700">{preference}</span>
                                                            <button
                                                                type="button"
                                                                onClick={async () => {
                                                                    const confirmed = await showConfirm(
                                                                        'Eliminar Preferencia', 
                                                                        `¬øEst√°s seguro de que quieres eliminar la preferencia "${preference}"? Esta acci√≥n no se puede deshacer.`,
                                                                        () => {
                                                                            const updatedPreferences = settings.sales.contactPreferences.filter((_, i) => i !== index);
                                                                            handleSettingChange('sales', 'contactPreferences', updatedPreferences);
                                                                        },
                                                                        'danger'
                                                                    );
                                                                }}
                                                                className="text-red-500 hover:text-red-700 text-sm"
                                                            >
                                                                Eliminar
                                                            </button>
                                                        </div>
                                                    ))}
                                                    {settings.sales.contactPreferences.length === 0 && (
                                                        <p className="text-gray-500 text-sm italic">No hay preferencias configuradas</p>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* Prioridades */}
                                            <div className="border border-gray-200 rounded-lg p-6">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h4 className="font-semibold text-gray-900">Niveles de Prioridad</h4>
                                                    <button
                                                        type="button"
                                                        onClick={async () => {
                                                            const newPriority = await showInput('Agregar Prioridad', 'Nuevo nivel de prioridad');
                                                            if (newPriority) {
                                                                handleSettingChange('sales', 'priorities', [...settings.sales.priorities, newPriority]);
                                                            }
                                                        }}
                                                        className="px-3 py-1 bg-[#006666] text-white rounded-md text-sm hover:bg-[#004d4d] transition-colors"
                                                    >
                                                        Agregar Prioridad
                                                    </button>
                                                </div>
                                                <div className="space-y-2">
                                                    {settings.sales.priorities.map((priority, index) => (
                                                        <div key={index} className="flex items-center justify-between bg-gray-50 px-3 py-2 rounded">
                                                            <span className="text-gray-700">{priority}</span>
                                                            <button
                                                                type="button"
                                                                onClick={async () => {
                                                                    const confirmed = await showConfirm(
                                                                        'Eliminar Prioridad', 
                                                                        `¬øEst√°s seguro de que quieres eliminar la prioridad "${priority}"? Esta acci√≥n no se puede deshacer.`,
                                                                        () => {
                                                                            const updatedPriorities = settings.sales.priorities.filter((_, i) => i !== index);
                                                                            handleSettingChange('sales', 'priorities', updatedPriorities);
                                                                        },
                                                                        'danger'
                                                                    );
                                                                }}
                                                                className="text-red-500 hover:text-red-700 text-sm"
                                                            >
                                                                Eliminar
                                                            </button>
                                                        </div>
                                                    ))}
                                                    {settings.sales.priorities.length === 0 && (
                                                        <p className="text-gray-500 text-sm italic">No hay prioridades configuradas</p>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Configuraci√≥n de Gastos (movida dentro de Configuraci√≥n del Sistema) */}
                                {activeSection === 'expenses' && (
                                    <div>
                                        <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                                            {getSectionIcon('credit-card')}
                                            Configuraci√≥n de Gastos
                                        </h3>
                                        <ExpenseSettings />
                                    </div>
                                )}
                                
                                {/* Configuraciones de Facturas */}
                                {activeSection === 'invoice' && (
                                    <div>
                                        <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                                            {getSectionIcon('file-text')}
                                            Configuraciones de Facturas
                                        </h3>
                                        
                                        <div className="space-y-6">
                                            {/* Series de Facturas - Desde /counters */}
                                            <div className="border border-gray-200 rounded-lg p-6">
                                                <div className="flex items-center justify-between mb-4">
                                                    <div>
                                                        <h4 className="font-semibold text-gray-900">Series de Facturas</h4>
                                                        <p className="text-sm text-gray-500 mt-1">Gesti√≥n de contadores desde la colecci√≥n /counters</p>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        {hasUnsavedChanges && (
                                                            <button
                                                                type="button"
                                                                onClick={() => {
                                                                    setHasUnsavedChanges(false);
                                                                    showNotification(
                                                                        'Cambios Guardados',
                                                                        'Los cambios en los contadores han sido marcados como guardados.',
                                                                        'success',
                                                                        2000
                                                                    );
                                                                }}
                                                                className="px-3 py-1 bg-green-600 text-white rounded-md text-sm hover:bg-green-700 transition-colors"
                                                            >
                                                                Marcar como Guardado
                                                            </button>
                                                        )}
                                                    <button
                                                        type="button"
                                                        onClick={async () => {
                                                            const newSeries = await showInput('Crear Nueva Serie', 'C√≥digo de la nueva serie (ej: A, B, C)');
                                                            if (newSeries) {
                                                                const seriesCode = newSeries.toUpperCase();
                                                                const currentSeries = window.getInvoiceSeries ? window.getInvoiceSeries() : [];
                                                                
                                                                if (!currentSeries.includes(seriesCode)) {
                                                                    try {
                                                                        await window.createNewSeries(seriesCode);
                                                                        showNotification(
                                                                            'Serie Creada',
                                                                            `La serie ${seriesCode} ha sido creada exitosamente.`,
                                                                            'success'
                                                                        );
                                                                        await window.loadCounters(); // Cargar contadores actualizados
                                                                    } catch (error) {
                                                                        showNotification(
                                                                            'Error',
                                                                            `No se pudo crear la serie: ${error.message}`,
                                                                            'error'
                                                                        );
                                                                    }
                                                                } else {
                                                                    showNotification('Error', 'Esta serie ya existe', 'error');
                                                                }
                                                            }
                                                        }}
                                                        className="px-3 py-1 bg-[#006666] text-white rounded-md text-sm hover:bg-[#004d4d] transition-colors"
                                                    >
                                                        Crear Serie
                                                    </button>
                                                    </div>
                                                </div>
                                                <div className="space-y-3">
                                                    {(window.getInvoiceSeries ? window.getInvoiceSeries() : []).map((seriesId) => {
                                                        const currentCounter = window.getCurrentCounter ? window.getCurrentCounter(seriesId) : 0;
                                                        const nextNumber = String(currentCounter).padStart(6, '0');
                                                        
                                                        return (
                                                            <div key={seriesId} className="bg-gray-50 px-4 py-4 rounded-lg space-y-3">
                                                                {/* Informaci√≥n de la serie */}
                                                                <div className="flex items-center justify-between">
                                                                    <div>
                                                                        <h5 className="font-medium text-gray-900 text-lg">Serie {seriesId}</h5>
                                                                    </div>
                                                                    <button
                                                                        type="button"
                                                                        onClick={async () => {
                                                                            const confirmed = await showConfirm(
                                                                                'Eliminar Serie', 
                                                                                `¬øEst√°s seguro de que quieres eliminar la serie "${seriesId}"? Esta acci√≥n no se puede deshacer y afectar√° la numeraci√≥n de facturas.`,
                                                                                () => {},
                                                                                'danger'
                                                                            );
                                                                            
                                                                            if (confirmed) {
                                                                                try {
                                                                                    await window.deleteSeries(seriesId);
                                                                                    showNotification(
                                                                                        'Serie Eliminada',
                                                                                        `La serie ${seriesId} ha sido eliminada.`,
                                                                                        'success'
                                                                                    );
                                                                                } catch (error) {
                                                                                    showNotification(
                                                                                        'Error',
                                                                                        `No se pudo eliminar la serie: ${error.message}`,
                                                                                        'error'
                                                                                    );
                                                                                }
                                                                            }
                                                                        }}
                                                                        className="text-red-600 hover:text-red-800 text-sm px-3 py-1 rounded-md border border-red-200 hover:border-red-300 transition-colors"
                                                                    >
                                                                        Eliminar Serie
                                                                    </button>
                                                                </div>
                                                                
                                                                {/* Control para modificar contador */}
                                                                <div className="flex items-center gap-3 pt-3 border-t border-gray-200">
                                                                    <label className="text-sm font-medium text-gray-700 min-w-fit">
                                                                        Modificar contador a:
                                                                    </label>
                                                                    <input
                                                                        type="number"
                                                                        value={currentCounter}
                                                                        onChange={async (e) => {
                                                                            const newValue = parseInt(e.target.value);
                                                                            if (isNaN(newValue) || newValue < 0) return;
                                                                            
                                                                            try {
                                                                                await window.updateCounter(seriesId, newValue);
                                                                                // Sin notificaci√≥n autom√°tica - solo actualizar silenciosamente
                                                                            } catch (error) {
                                                                                showNotification(
                                                                                    'Error',
                                                                                    `No se pudo actualizar el contador: ${error.message}`,
                                                                                    'error'
                                                                                );
                                                                            }
                                                                        }}
                                                                        className="w-24 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                                        min="0"
                                                                    />
                                                                    <span className="text-xs text-gray-500">
                                                                        La pr√≥xima factura ser√°: <span className="font-medium">{seriesId}-{String(currentCounter + 1).padStart(6, '0')}</span>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                    {(!window.getInvoiceSeries || window.getInvoiceSeries().length === 0) && (
                                                        <div className="text-center py-8">
                                                            <div className="text-gray-400 mb-2">üìã</div>
                                                            <p className="text-gray-500 text-sm">No hay series configuradas</p>
                                                            <p className="text-gray-400 text-xs mt-1">Crea tu primera serie usando el bot√≥n "Crear Serie"</p>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* Contador de Ofertas */}
                                            <div className="border border-gray-200 rounded-lg p-6">
                                                <div className="bg-gray-50 px-4 py-4 rounded-lg">
                                                    <div className="flex items-center justify-between mb-3">
                                                        <div>
                                                            <h5 className="font-medium text-gray-900 text-lg">Contador de Ofertas</h5>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="flex items-center gap-3 pt-3 border-t border-gray-200">
                                                        <label className="text-sm font-medium text-gray-700 min-w-fit">
                                                            Modificar contador a:
                                                        </label>
                                                        <input
                                                            type="number"
                                                            value={window.getOfferCount ? window.getOfferCount() : 1}
                                                            onChange={async (e) => {
                                                                const newValue = parseInt(e.target.value) || 1;
                                                                try {
                                                                    await window.updateOfferCounter(newValue);
                                                                    showNotification(
                                                                        'Contador de Ofertas Actualizado',
                                                                        `El contador de ofertas ha sido actualizado a ${newValue}.`,
                                                                        'success',
                                                                        3000
                                                                    );
                                                                } catch (error) {
                                                                    showNotification(
                                                                        'Error',
                                                                        `No se pudo actualizar el contador: ${error.message}`,
                                                                        'error'
                                                                    );
                                                                }
                                                            }}
                                                            className="w-24 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                            min="1"
                                                        />
                                                        <span className="text-xs text-gray-500">
                                                            La pr√≥xima oferta ser√°: <span className="font-medium">OF-{new Date().getFullYear()}-{String((window.getOfferCount ? window.getOfferCount() : 1) + 1).padStart(3, '0')}</span>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Configuraciones generales */}
                                            <div className="border border-gray-200 rounded-lg p-6">
                                                <h4 className="font-semibold text-gray-900 mb-4">Configuraciones Generales</h4>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                                            Moneda por defecto
                                                        </label>
                                                        <input
                                                            type="text"
                                                            value={settings.invoice.defaultCurrency}
                                                            onChange={(e) => handleSettingChange('invoice', 'defaultCurrency', e.target.value)}
                                                            placeholder="EUR"
                                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                        />
                                                    </div>
                                                    
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                                            IVA por defecto (%)
                                                        </label>
                                                        <input
                                                            type="number"
                                                            step="0.01"
                                                            value={settings.invoice.vatRate}
                                                            onChange={(e) => handleSettingChange('invoice', 'vatRate', parseFloat(e.target.value) || 0)}
                                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                        />
                                                    </div>
                                                </div>
                                                
                                                <div className="mt-4">
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                                        T√©rminos de pago por defecto
                                                    </label>
                                                    <textarea
                                                        value={settings.invoice.paymentTerms}
                                                        onChange={(e) => handleSettingChange('invoice', 'paymentTerms', e.target.value)}
                                                        rows="3"
                                                        placeholder="Ejemplo: Pago a 30 d√≠as desde la fecha de factura"
                                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Botones de acci√≥n */}
                                <div className="flex justify-end gap-3 pt-6 border-t border-gray-200 mt-8">
                                    <button
                                        type="button"
                                        className="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                                        onClick={() => {
                                            const proceed = !hasUnsavedChanges || confirm('Tienes cambios sin guardar. ¬øDeseas descartarlos y volver a la pantalla de bienvenida?');
                                            if (!proceed) return;
                                            try {
                                                // Deshacer cambios locales restaurando desde appConfig persistida
                                                if (typeof loadSettingsFromFirebase === 'function') {
                                                    loadSettingsFromFirebase();
                                                }
                                                setHasUnsavedChanges(false);
                                                // Volver a Bienvenida desde Admin Panel
                                                if (typeof setActiveTab === 'function') {
                                                    setActiveTab('users');
                                                }
                                                if (typeof setActiveView === 'function') {
                                                    setActiveView('welcome');
                                                } else if (typeof window.showWelcomeScreen === 'function') {
                                                    window.showWelcomeScreen();
                                                }
                                            } catch (e) {
                                                console.warn('Cancel fallback:', e);
                                            }
                                        }}
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        type="button"
                                        onClick={handleSave}
                                        disabled={loading}
                                        style={{
                                            background: loading 
                                                ? '#9ca3af' 
                                                : saved 
                                                ? 'linear-gradient(135deg, #059669 0%, #047857 100%)' 
                                                : 'linear-gradient(135deg, #0891b2 0%, #0e7490 100%)',
                                            color: 'white',
                                            border: 'none',
                                            padding: '0.75rem 1.5rem',
                                            borderRadius: '10px',
                                            fontWeight: '600',
                                            fontSize: '0.9375rem',
                                            cursor: loading ? 'not-allowed' : 'pointer',
                                            transition: 'all 0.3s ease',
                                            boxShadow: loading 
                                                ? 'none' 
                                                : saved 
                                                ? '0 4px 12px rgba(5, 150, 105, 0.3)' 
                                                : '0 4px 12px rgba(8, 145, 178, 0.3)',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: '0.5rem',
                                            minWidth: '160px'
                                        }}
                                        onMouseOver={(e) => {
                                            if (!loading) {
                                                e.target.style.transform = 'translateY(-1px)';
                                                e.target.style.boxShadow = saved 
                                                    ? '0 6px 16px rgba(5, 150, 105, 0.4)' 
                                                    : '0 6px 16px rgba(8, 145, 178, 0.4)';
                                            }
                                        }}
                                        onMouseOut={(e) => {
                                            if (!loading) {
                                                e.target.style.transform = 'translateY(0)';
                                                e.target.style.boxShadow = saved 
                                                    ? '0 4px 12px rgba(5, 150, 105, 0.3)' 
                                                    : '0 4px 12px rgba(8, 145, 178, 0.3)';
                                            }
                                        }}
                                    >
                                        {loading ? (
                                            <>
                                                <svg width="18" height="18" className="animate-spin" fill="none" viewBox="0 0 24 24">
                                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                Guardando...
                                            </>
                                        ) : saved ? (
                                            <>
                                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/>
                                                </svg>
                                                Guardado
                                            </>
                                        ) : (
                                            <>
                                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                                                </svg>
                                                Guardar Configuraci√≥n
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            function InviteUserModal({ onClose, onUserInvited }) {
                const [formData, setFormData] = useState({
                    email: '',
                    name: '',
                    role: 'usuario',
                    sendEmail: true
                });
                const [loading, setLoading] = useState(false);
                const [error, setError] = useState(null);
                
                const handleSubmit = async (e) => {
                    e.preventDefault();
                    
                    if (!formData.email.trim()) {
                        setError('El email es requerido');
                        return;
                    }
                    
                    if (!formData.email.includes('@')) {
                        setError('Ingresa un email v√°lido');
                        return;
                    }
                    
                    try {
                        setLoading(true);
                        setError(null);
                        
                        console.log(' Creando invitaci√≥n de usuario en Firebase:', formData);
                        
                        if (!window.authManager || !window.authManager.app) {
                            throw new Error('Sistema de autenticaci√≥n no disponible');
                        }
                        
                        // Importar Firestore
                        const { getFirestore, collection, addDoc, query, where, getDocs } = 
                            await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                        
                        const db = getFirestore(window.authManager.app);
                        
                        // Verificar que el email no est√© ya registrado
                        const usersRef = collection(db, 'users');
                        const emailQuery = query(usersRef, where('email', '==', formData.email.toLowerCase()));
                        const existingUsers = await getDocs(emailQuery);
                        
                        if (!existingUsers.empty) {
                            setError('Ya existe un usuario registrado con este email');
                            return;
                        }
                        
                        // Verificar invitaciones pendientes
                        const invitationsRef = collection(db, 'invitations');
                        const inviteQuery = query(invitationsRef, where('email', '==', formData.email.toLowerCase()), where('status', '==', 'pending'));
                        const pendingInvites = await getDocs(inviteQuery);
                        
                        if (!pendingInvites.empty) {
                            setError('Ya existe una invitaci√≥n pendiente para este email');
                            return;
                        }
                        
                        // Crear la invitaci√≥n en Firebase
                        const invitationData = {
                            email: formData.email.toLowerCase(),
                            name: formData.name.trim() || '',
                            role: formData.role,
                            status: 'pending',
                            createdAt: new Date(),
                            createdBy: window.authManager.currentUser.uid,
                            inviteToken: generateInviteToken(), // Generar token √∫nico
                            expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7 d√≠as
                        };
                        
                        const docRef = await addDoc(invitationsRef, invitationData);
                        console.log('[OK]  Invitaci√≥n creada con ID:', docRef.id);
                        
                        // TODO: Enviar email real de invitaci√≥n
                        // await sendInvitationEmail(formData.email, invitationData.inviteToken);
                        
                        console.log('[OK]  Invitaci√≥n enviada exitosamente');
                        alert(`‚úÖ Invitaci√≥n enviada a ${formData.email}\n\n` +
                            `üìß Se ha creado la invitaci√≥n en la base de datos\n` +
                            `üë§ Nombre: ${formData.name || 'Sin especificar'}\n` +
                            `üîê Rol: ${formData.role}\n` +
                            `‚è∞ V√°lida por: 7 d√≠as\n\n` +
                            `üîÑ Funcionalidades implementadas:\n` +
                            `- ‚úÖ Validaci√≥n de email duplicado\n` +
                            `- ‚úÖ Control de invitaciones pendientes\n` +
                            `- ‚úÖ Almacenamiento en Firebase\n` +
                            `- üîÑ Env√≠o de email autom√°tico (pr√≥ximamente)`);
                        
                        onUserInvited();
                        
                    } catch (error) {
                        console.error('[ERROR]  Error creando invitaci√≥n:', error);
                        setError('Error enviando la invitaci√≥n: ' + error.message);
                    } finally {
                        setLoading(false);
                    }
                    
                    // Funci√≥n auxiliar para generar token √∫nico
                    function generateInviteToken() {
                        return 'inv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    }
                };
                
                const handleChange = (e) => {
                    const { name, value, type, checked } = e.target;
                    setFormData(prev => ({
                        ...prev,
                        [name]: type === 'checkbox' ? checked : value
                    }));
                };
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" style={{backdropFilter: 'blur(8px)'}}>
                        <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden" style={{animation: 'slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)'}}>
                            {/* Header minimalista con gradiente */}
                            <div className="bg-gradient-to-r from-teal-500 to-cyan-600 px-6 py-4 relative overflow-hidden">
                                <div className="absolute inset-0 opacity-20" style={{
                                    backgroundImage: 'repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px)'
                                }}></div>
                                <div className="flex items-center justify-between relative z-10">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                            <svg width="20" height="20" fill="none" stroke="white" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                            </svg>
                                        </div>
                                        <h3 className="text-xl font-bold text-white">Invitar Usuario</h3>
                                    </div>
                                    <button 
                                        onClick={onClose}
                                        className="p-2 hover:bg-white hover:bg-opacity-20 rounded-lg transition-all duration-200 text-white"
                                    >
                                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <form onSubmit={handleSubmit} className="p-6 space-y-5">
                                {error && (
                                    <div className="bg-red-50 border-l-4 border-red-400 rounded-lg p-4">
                                        <div className="flex items-center gap-3">
                                            <div className="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                                                <svg width="16" height="16" className="text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/>
                                                </svg>
                                            </div>
                                            <span className="text-sm text-red-700 font-medium">{error}</span>
                                        </div>
                                    </div>
                                )}
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            üìß Direcci√≥n de email *
                                        </label>
                                        <input 
                                            type="email"
                                            name="email"
                                            value={formData.email}
                                            onChange={handleChange}
                                            className="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-300 text-sm"
                                            placeholder="usuario@ejemplo.com"
                                            required
                                            disabled={loading}
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            üë§ Nombre (Opcional)
                                        </label>
                                        <input 
                                            type="text"
                                            name="name"
                                            value={formData.name}
                                            onChange={handleChange}
                                            className="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-300 text-sm"
                                            placeholder="Nombre del usuario"
                                            disabled={loading}
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            üè∑Ô∏è Rol del usuario
                                        </label>
                                        <select 
                                            name="role"
                                            value={formData.role}
                                            onChange={handleChange}
                                            className="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-300 text-sm appearance-none bg-white"
                                            disabled={loading}
                                        >
                                            <option value="usuario">üë• Usuario - Acceso b√°sico</option>
                                            <option value="comercial">üíº Comercial - Gesti√≥n de ventas</option>
                                            <option value="admin">‚ö° Administrador - Acceso completo</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div className="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-xl p-4">
                                    <div className="flex items-start gap-3">
                                        <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                            <svg width="16" height="16" className="text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                        </div>
                                        <div className="text-sm text-blue-800">
                                            <p className="font-semibold mb-1">Proceso de invitaci√≥n:</p>
                                            <p className="opacity-90">Se enviar√° un email de invitaci√≥n con un enlace seguro para completar el registro. La invitaci√≥n ser√° v√°lida por 7 d√≠as.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="flex flex-col sm:flex-row gap-3 pt-6">
                                    <button 
                                        type="button"
                                        onClick={onClose}
                                        className="flex-1 px-6 py-3 text-gray-600 bg-gray-100 border-2 border-gray-200 rounded-xl hover:bg-gray-200 hover:border-gray-300 transition-all duration-300 font-medium text-sm flex items-center justify-center gap-2"
                                        disabled={loading}
                                    >
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                        Cancelar
                                    </button>
                                    <button 
                                        type="submit"
                                        className="flex-1 px-6 py-3 bg-gradient-to-r from-teal-500 to-cyan-600 text-white rounded-xl hover:from-teal-600 hover:to-cyan-700 transition-all duration-300 font-semibold text-sm flex items-center justify-center gap-2 disabled:opacity-50 shadow-lg hover:shadow-xl"
                                        disabled={loading}
                                    >
                                        {loading ? (
                                            <>
                                                <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                Enviando...
                                            </>
                                        ) : (
                                            <>
                                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                                </svg>
                                                Enviar Invitaci√≥n
                                            </>
                                        )}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }
            
            // Modal de Edici√≥n de Usuario
            function EditUserModal({ user, onClose, onUserUpdated }) {
                const [formData, setFormData] = useState({
                    name: user.name || '',
                    email: user.email || '',
                    phone: user.phone || '',
                    role: user.role || 'usuario',
                    active: user.active !== undefined ? user.active : true
                });
                const [loading, setLoading] = useState(false);
                const [error, setError] = useState(null);
                
                const handleSubmit = async (e) => {
                    e.preventDefault();
                    
                    if (!formData.name.trim()) {
                        setError('El nombre es requerido');
                        return;
                    }
                    
                    if (!formData.email.trim()) {
                        setError('El email es requerido');
                        return;
                    }
                    
                    if (!formData.email.includes('@')) {
                        setError('Ingresa un email v√°lido');
                        return;
                    }
                    
                    try {
                        setLoading(true);
                        setError(null);
                        
                        console.log('üíæ Actualizando usuario en Firebase:', user.id, formData);
                        
                        if (!window.authManager || !window.authManager.app) {
                            throw new Error('Sistema de autenticaci√≥n no disponible');
                        }
                        
                        // Importar Firestore
                        const { getFirestore, doc, updateDoc, getDoc } = 
                            await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                        
                        const db = getFirestore(window.authManager.app);
                        const userRef = doc(db, 'users', user.id);
                        
                        // Verificar que el usuario existe
                        const userDoc = await getDoc(userRef);
                        if (!userDoc.exists()) {
                            throw new Error('Usuario no encontrado en la base de datos');
                        }
                        
                        // Preparar datos para actualizar
                        const updateData = {
                            name: formData.name.trim(),
                            phone: formData.phone.trim(),
                            role: formData.role,
                            active: formData.active,
                            updatedAt: new Date(),
                            updatedBy: window.authManager.currentUser.uid
                        };
                        
                        // Solo actualizar email si cambi√≥ (requiere validaci√≥n adicional)
                        const currentData = userDoc.data();
                        if (formData.email.toLowerCase() !== currentData.email.toLowerCase()) {
                            // TODO: Implementar cambio de email con re-verificaci√≥n
                            console.log('[WARNING]  Cambio de email detectado - funcionalidad avanzada');
                            updateData.email = formData.email.toLowerCase();
                            updateData.emailChangeRequested = true;
                            updateData.emailChangeRequestedAt = new Date();
                        }
                        
                        // Actualizar en Firebase
                        await updateDoc(userRef, updateData);
                        
                        console.log('[OK]  Usuario actualizado exitosamente en Firebase');
                        
                        // Mostrar confirmaci√≥n con notificaci√≥n moderna
                        const changes = [];
                        if (formData.name !== currentData.name) changes.push(`‚Ä¢ Nombre: ${formData.name}`);
                        if (formData.phone !== currentData.phone) changes.push(`‚Ä¢ Tel√©fono: ${formData.phone}`);
                        if (formData.role !== currentData.role) changes.push(`‚Ä¢ Rol: ${formData.role}`);
                        if (formData.active !== currentData.active) changes.push(`‚Ä¢ Estado: ${formData.active ? 'Activo' : 'Inactivo'}`);
                        if (formData.email !== currentData.email) changes.push(`‚Ä¢ Email: ${formData.email} (pendiente verificaci√≥n)`);
                        
                        showNotification(
                            'Usuario Actualizado',
                            `ÔøΩ ${formData.name}\n${formData.email}\n\nCambios realizados:\n${changes.join('\n')}\n\nCambios guardados ‚Ä¢ ${new Date().toLocaleString('es-ES')}`,
                            'success',
                            7000
                        );
                        
                        onUserUpdated();
                        
                    } catch (error) {
                        console.error('[ERROR]  Error actualizando usuario en Firebase:', error);
                        setError('Error actualizando el usuario: ' + error.message);
                    } finally {
                        setLoading(false);
                    }
                };
                
                const handleChange = (e) => {
                    const { name, value, type, checked } = e.target;
                    setFormData(prev => ({
                        ...prev,
                        [name]: type === 'checkbox' ? checked : value
                    }));
                };
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" style={{backdropFilter: 'blur(8px)'}}>
                        <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden" style={{animation: 'slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)'}}>
                            {/* Header minimalista con gradiente */}
                            <div className="bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-4 relative overflow-hidden">
                                <div className="absolute inset-0 opacity-20" style={{
                                    backgroundImage: 'repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px)'
                                }}></div>
                                <div className="flex items-center justify-between relative z-10">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                            <svg width="20" height="20" fill="none" stroke="white" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                            </svg>
                                        </div>
                                        <h3 className="text-xl font-bold text-white">Editar Usuario</h3>
                                    </div>
                                    <button 
                                        onClick={onClose}
                                        className="p-2 hover:bg-white hover:bg-opacity-20 rounded-lg transition-all duration-200 text-white"
                                    >
                                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <form onSubmit={handleSubmit} className="p-6 space-y-5">
                                {error && (
                                    <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                        <div className="flex items-center gap-2">
                                            <svg width="16" height="16" className="text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                            </svg>
                                            <span className="text-sm text-red-700">{error}</span>
                                        </div>
                                    </div>
                                )}
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Nombre *
                                    </label>
                                    <input 
                                        type="text"
                                        name="name"
                                        value={formData.name}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                        placeholder="Nombre completo"
                                        required
                                        disabled={loading}
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Email *
                                    </label>
                                    <input 
                                        type="email"
                                        name="email"
                                        value={formData.email}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 cursor-not-allowed"
                                        disabled={true}
                                        title="El email no se puede modificar"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">El email no se puede modificar por seguridad</p>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Tel√©fono
                                    </label>
                                    <input 
                                        type="tel"
                                        name="phone"
                                        value={formData.phone}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                        placeholder="+34 600 000 000"
                                        disabled={loading}
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Rol
                                    </label>
                                    <select 
                                        name="role"
                                        value={formData.role}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006666] focus:border-transparent"
                                        disabled={loading || user.isFirstUser}
                                    >
                                        <option value="usuario">Usuario</option>
                                        <option value="comercial">Comercial</option>
                                        <option value="admin">Administrador</option>
                                    </select>
                                    {user.isFirstUser && (
                                        <p className="text-xs text-yellow-600 mt-1 flex items-center gap-1">
                                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                            </svg>
                                            El rol del primer usuario no se puede cambiar
                                        </p>
                                    )}
                                </div>
                                
                                <div className="flex items-center gap-3">
                                    <input 
                                        type="checkbox"
                                        name="active"
                                        id="user-active"
                                        checked={formData.active}
                                        onChange={handleChange}
                                        className="w-4 h-4 text-[#006666] border-gray-300 rounded focus:ring-[#006666]"
                                        disabled={loading}
                                    />
                                    <label htmlFor="user-active" className="text-sm font-medium text-gray-700">
                                        Usuario activo
                                    </label>
                                </div>
                                
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <div className="flex items-start gap-2">
                                        <svg width="16" height="16" className="text-blue-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                                        </svg>
                                        <div className="text-sm text-blue-800">
                                            Los cambios se aplicar√°n inmediatamente y el usuario ser√° notificado
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="flex justify-end gap-3 pt-4">
                                    <button 
                                        type="button"
                                        onClick={onClose}
                                        className="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                                        disabled={loading}
                                    >
                                        Cancelar
                                    </button>
                                    <button 
                                        type="submit"
                                        disabled={loading}
                                        style={{
                                            background: loading 
                                                ? '#9ca3af' 
                                                : 'linear-gradient(135deg, #0891b2 0%, #0e7490 100%)',
                                            color: 'white',
                                            border: 'none',
                                            padding: '0.75rem 1.5rem',
                                            borderRadius: '10px',
                                            fontWeight: '600',
                                            fontSize: '0.9375rem',
                                            cursor: loading ? 'not-allowed' : 'pointer',
                                            transition: 'all 0.3s ease',
                                            boxShadow: loading ? 'none' : '0 4px 12px rgba(8, 145, 178, 0.3)',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: '0.5rem',
                                            minWidth: '140px'
                                        }}
                                        onMouseOver={(e) => {
                                            if (!loading) {
                                                e.target.style.transform = 'translateY(-1px)';
                                                e.target.style.boxShadow = '0 6px 16px rgba(8, 145, 178, 0.4)';
                                            }
                                        }}
                                        onMouseOut={(e) => {
                                            if (!loading) {
                                                e.target.style.transform = 'translateY(0)';
                                                e.target.style.boxShadow = '0 4px 12px rgba(8, 145, 178, 0.3)';
                                            }
                                        }}
                                    >
                                        {loading ? (
                                            <>
                                                <svg width="18" height="18" className="animate-spin" fill="none" viewBox="0 0 24 24">
                                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                Actualizando...
                                            </>
                                        ) : (
                                            <>
                                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                </svg>
                                                Guardar Cambios
                                            </>
                                        )}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }
            
            // Modal de Vista Detallada de Usuario
            function ViewUserModal({ user, onClose, onEdit }) {
                const formatDate = (timestamp) => {
                    if (!timestamp) return 'No disponible';
                    try {
                        const date = new Date(timestamp);
                        return date.toLocaleDateString('es-ES', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                    } catch {
                        return 'Fecha inv√°lida';
                    }
                };
                
                const getRoleInfo = (role) => {
                    const roles = {
                        admin: { 
                            label: 'Administrador',
                            description: 'Acceso completo al sistema',
                            color: 'text-red-700',
                            bgColor: 'bg-red-50',
                            borderColor: 'border-red-200'
                        },
                        comercial: { 
                            label: 'Comercial',
                            description: 'Gesti√≥n de clientes y ventas',
                            color: 'text-blue-700',
                            bgColor: 'bg-blue-50', 
                            borderColor: 'border-blue-200'
                        },
                        usuario: { 
                            label: 'Usuario',
                            description: 'Acceso b√°sico al sistema',
                            color: 'text-gray-700',
                            bgColor: 'bg-gray-50',
                            borderColor: 'border-gray-200'
                        }
                    };
                    return roles[role] || roles.usuario;
                };
                
                const roleInfo = getRoleInfo(user.role);
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            {/* Header */}
                            <div className="flex justify-between items-center p-6 border-b border-gray-200">
                                <div className="flex items-center gap-4">
                                    <img 
                                        src={user.photoURL || `https://placehold.co/60x60/006666/FFFFFF?text=${(user.name || user.email)?.[0]?.toUpperCase() || 'U'}`}
                                        alt="Avatar usuario" 
                                        className="w-16 h-16 rounded-full border-2 border-gray-200"
                                    />
                                    <div>
                                        <h3 className="text-xl font-semibold text-gray-900">
                                            {user.name || 'Sin nombre'}
                                        </h3>
                                        <p className="text-gray-600">{user.email}</p>
                                        {user.isFirstUser && (
                                            <div className="flex items-center gap-1 mt-1">
                                                <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20" className="text-yellow-500">
                                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                                </svg>
                                                <span className="text-sm text-yellow-600 font-medium">Primer usuario</span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <button 
                                    onClick={onClose}
                                    className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                                >
                                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                        <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            
                            {/* Content */}
                            <div className="p-6 space-y-6">
                                {/* Informaci√≥n Personal */}
                                <div>
                                    <h4 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" />
                                        </svg>
                                        Informaci√≥n Personal
                                    </h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="bg-gray-50 p-4 rounded-lg">
                                            <label className="text-sm font-medium text-gray-700">Nombre completo</label>
                                            <p className="text-gray-900 mt-1">{user.name || 'No especificado'}</p>
                                        </div>
                                        <div className="bg-gray-50 p-4 rounded-lg">
                                            <label className="text-sm font-medium text-gray-700">Email</label>
                                            <p className="text-gray-900 mt-1">{user.email}</p>
                                        </div>
                                        <div className="bg-gray-50 p-4 rounded-lg">
                                            <label className="text-sm font-medium text-gray-700">Tel√©fono</label>
                                            <p className="text-gray-900 mt-1">{user.phone || 'No especificado'}</p>
                                        </div>
                                        <div className="bg-gray-50 p-4 rounded-lg">
                                            <label className="text-sm font-medium text-gray-700">ID de usuario</label>
                                            <p className="text-gray-900 mt-1 font-mono text-sm">{user.id}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Rol y Permisos */}
                                <div>
                                    <h4 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        Rol y Permisos
                                    </h4>
                                    <div className={`p-4 rounded-lg border-2 ${roleInfo.bgColor} ${roleInfo.borderColor}`}>
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <h5 className={`font-semibold ${roleInfo.color}`}>{roleInfo.label}</h5>
                                                <p className={`text-sm mt-1 ${roleInfo.color} opacity-80`}>
                                                    {roleInfo.description}
                                                </p>
                                            </div>
                                            <div className={`px-3 py-1 rounded-full text-sm font-medium ${roleInfo.bgColor} ${roleInfo.color} border ${roleInfo.borderColor}`}>
                                                {roleInfo.label}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Estado de la cuenta */}
                                <div>
                                    <h4 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                        </svg>
                                        Estado de la Cuenta
                                    </h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="bg-gray-50 p-4 rounded-lg">
                                            <label className="text-sm font-medium text-gray-700">Estado</label>
                                            <div className="mt-2">
                                                <span className={`inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium ${
                                                    user.active !== false 
                                                        ? 'bg-green-100 text-green-800 border border-green-200' 
                                                        : 'bg-red-100 text-red-800 border border-red-200'
                                                }`}>
                                                    <svg width="8" height="8" fill="currentColor" viewBox="0 0 20 20">
                                                        <circle cx="10" cy="10" r="6"/>
                                                    </svg>
                                                    {user.active !== false ? 'Activo' : 'Inactivo'}
                                                </span>
                                            </div>
                                        </div>
                                        <div className="bg-gray-50 p-4 rounded-lg">
                                            <label className="text-sm font-medium text-gray-700">Verificado</label>
                                            <div className="mt-2">
                                                <span className={`inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium ${
                                                    user.emailVerified 
                                                        ? 'bg-green-100 text-green-800 border border-green-200' 
                                                        : 'bg-yellow-100 text-yellow-800 border border-yellow-200'
                                                }`}>
                                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                                                        {user.emailVerified ? (
                                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                                        ) : (
                                                            <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                                        )}
                                                    </svg>
                                                    {user.emailVerified ? 'Email verificado' : 'Email sin verificar'}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Fechas importantes */}
                                <div>
                                    <h4 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd" />
                                        </svg>
                                        Historial
                                    </h4>
                                    <div className="space-y-3">
                                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                            <div className="flex items-center gap-3">
                                                <div className="p-2 bg-green-100 rounded-full">
                                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" className="text-green-600">
                                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                                        <path fillRule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clipRule="evenodd"/>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <p className="font-medium text-gray-900">Fecha de registro</p>
                                                    <p className="text-sm text-gray-600">{formatDate(user.createdAt)}</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {user.updatedAt && user.updatedAt !== user.createdAt && (
                                            <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                <div className="flex items-center gap-3">
                                                    <div className="p-2 bg-blue-100 rounded-full">
                                                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" className="text-blue-600">
                                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                                        </svg>
                                                    </div>
                                                    <div>
                                                        <p className="font-medium text-gray-900">√öltima modificaci√≥n</p>
                                                        <p className="text-sm text-gray-600">{formatDate(user.updatedAt)}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {user.lastSignInTime && (
                                            <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                <div className="flex items-center gap-3">
                                                    <div className="p-2 bg-purple-100 rounded-full">
                                                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" className="text-purple-600">
                                                            <path fillRule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd"/>
                                                        </svg>
                                                    </div>
                                                    <div>
                                                        <p className="font-medium text-gray-900">√öltimo acceso</p>
                                                        <p className="text-sm text-gray-600">{formatDate(user.lastSignInTime)}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Footer */}
                            <div className="flex justify-end gap-3 p-6 border-t border-gray-200">
                                <button 
                                    onClick={onClose}
                                    className="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                                >
                                    Cerrar
                                </button>
                                <button 
                                    onClick={onEdit}
                                    className="px-4 py-2 bg-[#006666] text-white rounded-lg hover:bg-[#005555] transition-colors flex items-center gap-2"
                                >
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                    </svg>
                                    Editar Usuario
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // === COMPONENTES DE FORMULARIO ===
            function FormField({ label, as = "input", ...props }) {
                const Component = as === "textarea" ? "textarea" : "input";
                return (
                    <div>
                        {label && (
                            <label htmlFor={props.name} className="block text-sm font-medium text-gray-700 mb-1">
                                {label}
                            </label>
                        )}
                        <Component 
                            id={props.name} 
                            {...props} 
                            className="block w-full rounded-md border-2 border-gray-400 shadow-sm focus:border-[#006666] focus:ring-[#006666] hover:border-gray-500 sm:text-sm p-3 transition-colors" 
                        />
                    </div>
                );
            }
            
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
            
            // Inicializar detecci√≥n de inactividad despu√©s de cargar la app
            setTimeout(() => {
                initInactivityDetection();
                console.log('üïê Sistema de detecci√≥n de inactividad activado (30 min)');
            }, 2000);
        }
        
        // Funci√≥n para crear perfil de usuario faltante
        async function createMissingUserProfile(currentUser) {
            console.log('üõ†Ô∏è Creando perfil para usuario:', currentUser.email);
            console.log('üë§ UID:', currentUser.uid);
            console.log('üìß Email verificado:', currentUser.emailVerified);
            
            try {
                const { getFirestore, doc, setDoc, collection, getDocs } = 
                    await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                const db = getFirestore(window.authManager.app);
                console.log('üî• Firestore inicializado para creaci√≥n de perfil');
                
                // Verificar si es el primer usuario (simplificado para evitar errores de Firestore)
                let isFirstUser = false;
                console.log('üèÜ Asumiendo usuario comercial (verificaci√≥n de primer usuario deshabilitada temporalmente)');
                
                // Crear perfil b√°sico
                const userProfile = {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    role: isFirstUser ? 'admin' : 'comercial', // Por defecto comercial para nuevos usuarios
                    name: currentUser.displayName || currentUser.email.split('@')[0],
                    photoURL: currentUser.photoURL || null,
                    createdAt: new Date().toISOString(),
                    isFirstUser: isFirstUser,
                    provider: currentUser.providerData[0]?.providerId || 'email',
                    active: true,
                    emailVerified: currentUser.emailVerified
                };
                
                console.log('üìÑ Datos del perfil a crear:', userProfile);
                
                // Intentar crear el documento
                await setDoc(doc(db, 'users', currentUser.uid), userProfile);
                
                console.log('[OK]  Perfil de usuario creado exitosamente:', userProfile);
                return userProfile;
                
            } catch (error) {
                console.error('[ERROR]  Error creando perfil de usuario:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                throw error;
            }
        }

        // Sistema de autenticaci√≥n integrado
        async function initAuthAndApp() {
            // Verificar si el usuario viene de un email de verificaci√≥n
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('verified') === 'true') {
                console.log('[OK]  Usuario viene de verificaci√≥n de email exitosa');
                showAuthStatus('[OK]  Email verificado correctamente. Ya puedes iniciar sesi√≥n.', 'success');
                // Limpiar la URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            // Inicializar seguridad
            initializeCSRF();
            
            // Primero cargar nuestro sistema de autenticaci√≥n
            try {
                // Crear instancia del AuthManager
                if (!window.authManager) {
                    console.log('[INFO]  Cargando sistema de autenticaci√≥n...');
                    // Importar el c√≥digo de auth-simple.js si no est√° disponible
                    const script = document.createElement('script');
                    script.src = `./auth-simple.js?t=${Date.now()}`; // Cache busting
                    document.head.appendChild(script);
                    
                    // Esperar a que se cargue
                    await new Promise((resolve, reject) => {
                        script.onload = () => {
                            console.log('[OK]  Script de autenticaci√≥n cargado');
                            resolve();
                        };
                        script.onerror = () => {
                            console.error('[ERROR]  Error cargando script de autenticaci√≥n');
                            reject(new Error('Error cargando script de autenticaci√≥n'));
                        };
                        
                        // Timeout de seguridad
                        setTimeout(() => {
                            reject(new Error('Timeout cargando script de autenticaci√≥n'));
                        }, 10000);
                    });
                    
                    // Verificar que authManager est√© disponible
                    if (!window.authManager) {
                        throw new Error('AuthManager no se inicializ√≥ correctamente');
                    }
                    
                    console.log('[CONFIG]  AuthManager disponible con m√©todos:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.authManager)));
                }
                
                // Firebase Analyzer movido a archive/tools/ para limpieza del c√≥digo principal
                
                // Inicializar autenticaci√≥n
                await window.authManager.init();
                
                // Verificar si hay usuario autenticado
                const currentUser = window.authManager.getCurrentUser();
                
                if (currentUser) {
                    console.log('[OK]  Usuario autenticado encontrado:', currentUser.email);
                    console.log('üë§ UID:', currentUser.uid);
                    console.log('üìß Email verificado:', currentUser.emailVerified);
                    console.log('[DEBUG]  Estado de autenticaci√≥n:', window.authManager.isLoggedIn());
                    
                    // Obtener perfil completo del usuario con manejo de errores mejorado
                    try {
                        const userProfile = await window.authManager.getUserProfile();
                        if (userProfile) {
                            console.log('üë§ Perfil cargado:', userProfile.name, '- Rol:', userProfile.role);
                            console.log('üìß Email verificado en perfil:', userProfile.emailVerified);
                            
                            // üîí PUNTO DE SEGURIDAD CR√çTICO: Verificar que el email est√© verificado
                            if (!currentUser.emailVerified) {
                                console.log('üö´ Acceso denegado: Email no verificado');
                                console.log('[DEBUG]  Estado del usuario:', {
                                    uid: currentUser.uid,
                                    email: currentUser.email,
                                    emailVerified: currentUser.emailVerified,
                                    provider: currentUser.providerData[0]?.providerId
                                });
                                showAuthStatus('[ERROR]  Tu email no ha sido verificado. Por favor, revisa tu correo y haz clic en el enlace de verificaci√≥n.', 'error');
                                showEmailVerificationScreen(currentUser.email);
                                return;
                            }
                            
                            // üîí VERIFICACI√ìN ADICIONAL: Confirmar que realmente est√° verificado
                            console.log('[OK]  Email verificado correctamente, permitiendo acceso a la aplicaci√≥n');
                            
                            // Mostrar mensaje de bienvenida espec√≠fico seg√∫n el rol
                            if (userProfile.isFirstUser) {
                                console.log('¬°Bienvenido, administrador! Eres el primer usuario del sistema.');
                            }
                            
                            startApp();
                        } else {
                            console.log('[WARNING]  Perfil no encontrado, intentando crear...');
                            await createMissingUserProfile(currentUser);
                            
                            // Reintentar obtener perfil
                            const newProfile = await window.authManager.getUserProfile();
                            if (newProfile) {
                                console.log('[OK]  Perfil creado y cargado:', newProfile.name, '- Rol:', newProfile.role);
                                
                                // üîí PUNTO DE SEGURIDAD: Verificar que el email est√© verificado
                                if (!currentUser.emailVerified) {
                                    console.log('üö´ Acceso denegado: Email no verificado');
                                    showAuthStatus('[ERROR]  Tu email no ha sido verificado. Por favor, revisa tu correo y haz clic en el enlace de verificaci√≥n.', 'error');
                                    showEmailVerificationScreen(currentUser.email);
                                    return;
                                }
                                
                                startApp();
                            } else {
                                console.error('[ERROR]  No se pudo crear el perfil del usuario');
                                showAuthScreen();
                            }
                        }
                    } catch (error) {
                        console.error('[ERROR]  Error obteniendo perfil del usuario:', error);
                        console.error('üîç C√≥digo de error:', error.code);
                        console.error('üìù Mensaje:', error.message);
                        
                        // Si es error de permisos, intentar crear perfil
                        if (error.message.includes('permissions') || error.message.includes('Missing or insufficient permissions')) {
                            console.log('üõ†Ô∏è Detectado error de permisos, intentando crear perfil...');
                            try {
                                await createMissingUserProfile(currentUser);
                                
                                // Reintentar obtener perfil
                                const newProfile = await window.authManager.getUserProfile();
                                if (newProfile) {
                                    console.log('[OK]  Perfil creado exitosamente:', newProfile.name, '- Rol:', newProfile.role);
                                    
                                    // üîí PUNTO DE SEGURIDAD: Verificar que el email est√© verificado
                                    if (!currentUser.emailVerified) {
                                        console.log('üö´ Acceso denegado: Email no verificado');
                                        showAuthStatus('[ERROR]  Tu email no ha sido verificado. Por favor, revisa tu correo y haz clic en el enlace de verificaci√≥n.', 'error');
                                        showEmailVerificationScreen(currentUser.email);
                                        return;
                                    }
                                    
                                    startApp();
                                } else {
                                    throw new Error('No se pudo obtener el perfil despu√©s de crearlo');
                                }
                            } catch (createError) {
                                console.error('[ERROR]  Error creando perfil de usuario:', createError);
                                console.error('üîç C√≥digo de error:', createError.code);
                                console.error('üìù Mensaje:', createError.message);
                                showAuthScreen();
                            }
                        } else {
                            showAuthScreen();
                        }
                    }
                } else {
                    console.log('‚ùå Usuario no autenticado, mostrando pantalla de login');
                    showAuthScreen();
                }
                
                // Mensaje informativo sobre an√°lisis de Firebase
                if (window.authManager && window.authManager.isLoggedIn()) {
                    console.log('');
                    console.log('üî• === HERRAMIENTAS DE AN√ÅLISIS DE FIREBASE ===');
                    console.log('[DATA]  Para analizar la tabla system_settings, usa:');
                    console.log('   analyzeFirebaseSettings()');
                    console.log('üíæ Para exportar configuraciones:');
                    console.log('   exportFirebaseSettings()');
                    console.log('üóÑÔ∏è Para crear backup:');
                    console.log('   backupFirebaseSettings()');
                    console.log('[DEBUG]  Para analizar referencias hardcodeadas:');
                    console.log('   analyzeConfigReferences()');
                    console.log('===============================================');
                    console.log('');
                }
                
            } catch (error) {
                console.error('Error en inicializaci√≥n de autenticaci√≥n:', error);
                // En caso de error, mostrar pantalla de login
                showAuthScreen();
            }
        }
        
        // Funci√≥n para mostrar pantalla de login principal
        function showAuthScreen() {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div style="min-height: 100vh; display: flex; background: url('./imagen_fondo_manos.webp') center/cover no-repeat fixed;">
                    <!-- Panel izquierdo - Formulario -->
                    <div style="width: 40%; min-height: 100vh; background: white; display: flex; flex-direction: column; justify-content: center; padding: 3rem 4rem; box-shadow: 2px 0 10px rgba(0,0,0,0.1);">
                        <!-- Logo -->
                        <div style="text-align: center; margin-bottom: 3rem;">
                            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                                    <svg width="30" height="30" viewBox="0 0 24 24" fill="white">
                                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                    </svg>
                                </div>
                                <h1 style="font-size: 1.75rem; font-weight: 700; color: #1a202c; margin: 0;">Expertia Business Suite</h1>
                            </div>
                        </div>
                        
                        <!-- T√≠tulo -->
                        <h2 style="font-size: 2rem; font-weight: 600; color: #1a202c; text-align: center; margin-bottom: 0.5rem;">Login</h2>
                        
                        <!-- Enlace crear cuenta -->
                        <p style="text-align: center; color: #6b7280; margin-bottom: 2rem; font-size: 0.95rem;">
                            ¬øNo tienes cuenta? 
                            <a href="#" onclick="showRegisterScreen(); return false;" style="color: #f59e0b; text-decoration: none; font-weight: 500;">Crear cuenta ahora</a>
                        </p>
                        
                        <!-- Formulario -->
                        <form id="login-form" onsubmit="event.preventDefault(); handleLogin();">
                            <!-- Email -->
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-size: 0.9rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Email</label>
                                <div style="position: relative;">
                                    <input 
                                        type="email" 
                                        id="auth-email" 
                                        required
                                        style="width: 100%; padding: 0.875rem 1rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: border-color 0.3s ease;"
                                        placeholder="tu@email.com"
                                        onfocus="this.style.borderColor='#3b82f6'"
                                        onblur="this.style.borderColor='#d1d5db'"
                                    >
                                </div>
                            </div>
                            
                            <!-- Contrase√±a -->
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.9rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Contrase√±a</label>
                                <div class="password-toggle-container">
                                    <input 
                                        type="password" 
                                        id="auth-password" 
                                        required
                                        class="password-input"
                                        style="width: 100%; padding: 0.875rem 1rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: border-color 0.3s ease;"
                                        placeholder="Tu contrase√±a"
                                        onfocus="this.style.borderColor='#3b82f6'"
                                        onblur="this.style.borderColor='#d1d5db'"
                                    >
                                    <button 
                                        type="button" 
                                        class="password-toggle-btn"
                                        onclick="togglePasswordVisibility('auth-password')"
                                        title="Mostrar contrase√±a"
                                    >
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                            <line x1="1" y1="1" x2="23" y2="23"/>
                                        </svg>
                                    </button>
                                </div>
                                </div>
                            
                            <!-- Recordar usuario -->
                            <div style="display: flex; align-items: center; margin-bottom: 1.5rem;">
                                <input 
                                    type="checkbox" 
                                    id="remember-me"
                                    style="margin-right: 0.5rem; width: 16px; height: 16px; accent-color: #3b82f6;"
                                >
                                <label for="remember-me" style="font-size: 0.9rem; color: #374151; cursor: pointer;">Recordar usuario</label>
                            </div>
                            
                            <!-- Bot√≥n Login -->
                            <button 
                                type="submit"
                                style="width: 100%; background: #f59e0b; color: white; padding: 0.875rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: background-color 0.3s ease; margin-bottom: 1rem;"
                                onmouseover="this.style.backgroundColor='#d97706'"
                                onmouseout="this.style.backgroundColor='#f59e0b'"
                            >
                                Iniciar Sesi√≥n
                            </button>
                        </form>
                        
                        <!-- Separador -->
                        <div style="text-align: center; margin: 1.5rem 0; position: relative;">
                            <div style="height: 1px; background: #e5e7eb; width: 100%;"></div>
                            <span style="background: white; padding: 0 1rem; color: #6b7280; font-size: 0.875rem; position: absolute; top: -8px; left: 50%; transform: translateX(-50%);">o</span>
                        </div>
                        <!-- Bot√≥n Login con Google - Mejores Pr√°cticas -->
                        <button 
                            type="button"
                            onclick="handleGoogleLogin()"
                            style="width: 100%; background: white; color: #374151; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: all 0.3s ease; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 0.75rem;"
                            onmouseover="this.style.borderColor='#d1d5db'; this.style.backgroundColor='#f9fafb'"
                            onmouseout="this.style.borderColor='#e5e7eb'; this.style.backgroundColor='white'"
                        >
                            <svg width="20" height="20" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Continuar con Google
                        </button>
                        <!-- Bot√≥n Login con Google - Mejores Pr√°cticas -->
                        <button 
                            type="button"
                            onclick="handleGoogleLogin()"
                            style="width: 100%; background: white; color: #374151; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: all 0.3s ease; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 0.75rem;"
                            onmouseover="this.style.borderColor='#d1d5db'; this.style.backgroundColor='#f9fafb'"
                            onmouseout="this.style.borderColor='#e5e7eb'; this.style.backgroundColor='white'"
                        >
                            <svg width="20" height="20" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Continuar con Google
                        </button>
                        
                        <!-- Bot√≥n Login con Google -->
                        <button 
                            type="button"
                            onclick="handleGoogleLogin()"
                            style="width: 100%; background: white; color: #374151; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: all 0.3s ease; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 0.75rem;"
                            onmouseover="this.style.borderColor='#d1d5db'; this.style.backgroundColor='#f9fafb'"
                            onmouseout="this.style.borderColor='#e5e7eb'; this.style.backgroundColor='white'"
                        >
                            <svg width="20" height="20" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Continuar con Google
                        </button>
                        
                        <!-- Olvid√≥ contrase√±a -->
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <a href="#" onclick="showPasswordRecoveryScreen(); return false;" style="color: #f59e0b; text-decoration: none; font-size: 0.9rem; font-weight: 500;">¬øOlvid√≥ su contrase√±a?</a>
                        </div>
                        
                        <!-- Enlaces legales -->
                        <div style="text-align: center; margin-top: auto; padding-top: 2rem;">
                            <p style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem;">Copyright ¬© 2025 de Expertia Software Solutions</p>
                            <div style="display: flex; justify-content: center; gap: 1rem;">
                                <a href="terminos-servicio.html" target="_blank" style="color: #6b7280; text-decoration: none; font-size: 0.8rem;">T√©rminos de Servicio</a>
                                <span style="color: #d1d5db;">|</span>
                                <a href="politica-privacidad.html" target="_blank" style="color: #6b7280; text-decoration: none; font-size: 0.8rem;">Pol√≠tica de Privacidad</a>
                            </div>
                        </div>
                        
                        <div id="auth-status" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; display: none;"></div>
                    </div>
                    
                    <!-- Panel derecho - Imagen de fondo -->
                    <div style="width: 60%; min-height: 100vh; background: url('./imagen_fondo_manos.webp') center/cover no-repeat; position: relative;">
                        <!-- Overlay sutil para mejorar legibilidad si es necesario -->
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.1);"></div>
                    </div>
                </div>
            `;
        }
        
        // Funci√≥n para mostrar pantalla de login
        function showLoginScreen() {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: url('./data/bg-auth.jpg') center/cover no-repeat fixed;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-width: 400px; width: 100%; margin: 1rem;">
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <h1 style="font-size: 1.5rem; font-weight: bold; color: #1a202c; margin-bottom: 0.5rem;">Iniciar Sesi√≥n</h1>
                            <p style="color: #718096;">Accede a tu cuenta</p>
                        </div>
                        
                        <form id="login-form" onsubmit="event.preventDefault(); handleLogin();">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Email</label>
                                <input 
                                    type="email" 
                                    id="auth-email" 
                                    required
                                    style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; box-sizing: border-box;"
                                    placeholder="tu@email.com"
                                >
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Contrase√±a</label>
                                <div class="password-toggle-container">
                                <input 
                                    type="password" 
                                    id="auth-password" 
                                    required
                                        class="password-input"
                                    style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; box-sizing: border-box;"
                                    placeholder="Tu contrase√±a"
                                >
                                    <button 
                                        type="button" 
                                        class="password-toggle-btn"
                                        onclick="togglePasswordVisibility('auth-password')"
                                        title="Mostrar contrase√±a"
                                    >
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                            <line x1="1" y1="1" x2="23" y2="23"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <button 
                                type="submit"
                                style="width: 100%; background: #3b82f6; color: white; padding: 0.75rem; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; margin-bottom: 1rem;"
                            >
                                Iniciar Sesi√≥n
                            </button>
                        </form>
                        
                        <div style="text-align: center;">
                            <button 
                                onclick="showAuthScreen()"
                                style="background: none; border: none; color: #6b7280; text-decoration: underline; cursor: pointer;"
                            >
                                ‚Üê Volver
                            </button>
                        </div>
                        
                        <div id="auth-status" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; display: none;"></div>
                    </div>
                </div>
            `;
        }
        
        // Funci√≥n para mostrar pantalla de registro
        function showRegisterScreen() {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div style="min-height: 100vh; display: flex; background: url('./imagen_fondo_manos.webp') center/cover no-repeat fixed;">
                    <!-- Panel izquierdo - Formulario de Registro -->
                    <div style="width: 40%; min-height: 100vh; background: white; display: flex; flex-direction: column; justify-content: center; padding: 3rem 4rem; box-shadow: 2px 0 10px rgba(0,0,0,0.1);">
                        <!-- Logo -->
                        <div style="text-align: center; margin-bottom: 3rem;">
                            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                                    <svg width="30" height="30" viewBox="0 0 24 24" fill="white">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
                                    </svg>
                                </div>
                                <h1 style="font-size: 1.75rem; font-weight: 700; color: #1a202c; margin: 0;">Expertia Business Suite</h1>
                            </div>
                        </div>
                        
                        <!-- T√≠tulo -->
                        <h2 style="font-size: 2rem; font-weight: 600; color: #1a202c; text-align: center; margin-bottom: 0.5rem;">Registrarse</h2>
                        
                        <!-- Enlace volver a login -->
                        <p style="text-align: center; color: #6b7280; margin-bottom: 2rem; font-size: 0.95rem;">
                            ¬øYa tienes cuenta? 
                            <a href="#" onclick="showAuthScreen(); return false;" style="color: #f59e0b; text-decoration: none; font-weight: 500;">Iniciar sesi√≥n</a>
                        </p>
                        
                        <!-- Formulario de registro -->
                        <form id="register-form" onsubmit="event.preventDefault(); handleRegister();">
                            <!-- Email -->
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-size: 0.9rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Email</label>
                                <div style="position: relative;">
                                <input 
                                    type="email" 
                                    id="auth-email" 
                                    required
                                        style="width: 100%; padding: 0.875rem 1rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: border-color 0.3s ease;"
                                    placeholder="tu@email.com"
                                        onfocus="this.style.borderColor='#10b981'"
                                        onblur="this.style.borderColor='#d1d5db'"
                                >
                                </div>
                            </div>
                            
                            <!-- Contrase√±a -->
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-size: 0.9rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Contrase√±a</label>
                                <div class="password-toggle-container">
                                <input 
                                    type="password" 
                                    id="auth-password" 
                                    required
                                        class="password-input"
                                        style="width: 100%; padding: 0.875rem 1rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: border-color 0.3s ease;"
                                    placeholder="M√≠nimo 6 caracteres"
                                        onfocus="this.style.borderColor='#10b981'; clearPasswordError();"
                                        onblur="this.style.borderColor='#d1d5db'"
                                        oninput="clearPasswordError();"
                                >
                                    <button 
                                        type="button" 
                                        class="password-toggle-btn"
                                        onclick="togglePasswordVisibility('auth-password')"
                                        title="Mostrar contrase√±a"
                                    >
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                            <line x1="1" y1="1" x2="23" y2="23"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Confirmar Contrase√±a -->
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-size: 0.9rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Confirmar Contrase√±a</label>
                                <div class="password-toggle-container">
                                <input 
                                    type="password" 
                                    id="auth-password-confirm" 
                                    required
                                        class="password-input"
                                        style="width: 100%; padding: 0.875rem 1rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: border-color 0.3s ease;"
                                    placeholder="Repite tu contrase√±a"
                                        onfocus="this.style.borderColor='#10b981'; clearPasswordError();"
                                        onblur="this.style.borderColor='#d1d5db'"
                                        oninput="clearPasswordError();"
                                >
                                    <button 
                                        type="button" 
                                        class="password-toggle-btn"
                                        onclick="togglePasswordVisibility('auth-password-confirm')"
                                        title="Mostrar contrase√±a"
                                    >
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                            <line x1="1" y1="1" x2="23" y2="23"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Casillas de Aceptaci√≥n -->
                            <div style="margin-bottom: 1.5rem;">
                                <!-- T√©rminos y Condiciones -->
                                <div style="display: flex; align-items: flex-start; margin-bottom: 1rem;">
                                    <input 
                                        type="checkbox" 
                                        id="accept-terms"
                                        style="margin-right: 0.75rem; margin-top: 0.125rem; width: 16px; height: 16px; accent-color: #10b981; flex-shrink: 0;"
                                    >
                                    <label for="accept-terms" style="font-size: 0.9rem; color: #374151; cursor: pointer; line-height: 1.4;">
                                        He le√≠do y acepto los <a href="terminos-servicio.html" target="_blank" style="color: #10b981; text-decoration: underline;">T√©rminos y Condiciones</a>
                                    </label>
                                </div>
                                
                                <!-- Pol√≠tica de Privacidad -->
                                <div style="display: flex; align-items: flex-start; margin-bottom: 1rem;">
                                    <input 
                                        type="checkbox" 
                                        id="accept-privacy"
                                        style="margin-right: 0.75rem; margin-top: 0.125rem; width: 16px; height: 16px; accent-color: #10b981; flex-shrink: 0;"
                                    >
                                    <label for="accept-privacy" style="font-size: 0.9rem; color: #374151; cursor: pointer; line-height: 1.4;">
                                        He le√≠do y acepto la <a href="politica-privacidad.html" target="_blank" style="color: #10b981; text-decoration: underline;">Pol√≠tica de Privacidad</a> y consiento el tratamiento de mis datos para la creaci√≥n y gesti√≥n de mi cuenta.
                                    </label>
                                </div>
                            </div>
                            
                            
                            <!-- Bot√≥n Crear Cuenta -->
                            <button 
                                type="submit"
                                style="width: 100%; background: #10b981; color: white; padding: 0.875rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: background-color 0.3s ease; margin-bottom: 1rem;"
                                onmouseover="this.style.backgroundColor='#059669'"
                                onmouseout="this.style.backgroundColor='#10b981'"
                            >
                                Crear Cuenta
                            </button>
                        </form>
                        
                        <!-- Bot√≥n Volver -->
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <button 
                                onclick="showAuthScreen()"
                                style="background: none; border: none; color: #6b7280; text-decoration: none; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: color 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin: 0 auto;"
                                onmouseover="this.style.color='#374151'"
                                onmouseout="this.style.color='#6b7280'"
                            >
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                                </svg>
                                Volver al Login
                            </button>
                        </div>
                        
                        <!-- Informaci√≥n de Protecci√≥n de Datos (Primera Capa RGPD) -->
                        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                            <h4 style="font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Informaci√≥n sobre Protecci√≥n de Datos</h4>
                            <div style="font-size: 0.8rem; color: #4a5568; line-height: 1.4;">
                                <p style="margin-bottom: 0.25rem;"><strong>Responsable:</strong> Expertia Software Solutions</p>
                                <p style="margin-bottom: 0.25rem;"><strong>Finalidad:</strong> Gesti√≥n de su alta como usuario y prestaci√≥n de los servicios asociados a su cuenta.</p>
                                <p style="margin-bottom: 0.25rem;"><strong>Legitimaci√≥n:</strong> Su consentimiento al marcar la casilla.</p>
                                <p style="margin-bottom: 0.25rem;"><strong>Destinatarios:</strong> No se ceder√°n datos a terceros, salvo obligaci√≥n legal.</p>
                                <p style="margin-bottom: 0;"><strong>Derechos:</strong> Puede acceder, rectificar y suprimir sus datos, as√≠ como otros derechos, como se explica en la <a href="politica-privacidad.html" target="_blank" style="color: #10b981; text-decoration: underline;">Pol√≠tica de Privacidad</a>.</p>
                            </div>
                        </div>
                        
                        <!-- Enlaces legales -->
                        <div style="text-align: center; margin-top: auto; padding-top: 2rem;">
                            <p style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem;">Copyright ¬© 2025 de Expertia Software Solutions</p>
                            <div style="display: flex; justify-content: center; gap: 1rem;">
                                <a href="terminos-servicio.html" target="_blank" style="color: #6b7280; text-decoration: none; font-size: 0.8rem;">T√©rminos de Servicio</a>
                                <span style="color: #d1d5db;">|</span>
                                <a href="politica-privacidad.html" target="_blank" style="color: #6b7280; text-decoration: none; font-size: 0.8rem;">Pol√≠tica de Privacidad</a>
                            </div>
                        </div>
                        
                        <div id="auth-status" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; display: none;"></div>
                    </div>
                    
                    <!-- Panel derecho - Imagen de fondo -->
                    <div style="width: 60%; min-height: 100vh; background: url('./imagen_fondo_manos.webp') center/cover no-repeat; position: relative;">
                        <!-- Overlay sutil para mejorar legibilidad si es necesario -->
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.1);"></div>
                    </div>
                </div>
            `;
        }
        
        // Funciones de manejo de autenticaci√≥n
        async function handleLogin() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            
            // Validaciones de seguridad
            if (!email || !password) {
                showAuthStatus('Por favor completa todos los campos', 'error');
                return;
            }
            
            if (!validateEmail(email)) {
                showAuthStatus('Por favor introduce un email v√°lido', 'error');
                return;
            }
            
            if (!validatePassword(password)) {
                showAuthStatus('La contrase√±a debe tener entre 6 y 128 caracteres', 'error');
                return;
            }
            
            // Sanitizar inputs
            const sanitizedEmail = sanitizeInput(email);
            const sanitizedPassword = sanitizeInput(password);
            
            try {
                showAuthStatus('Iniciando sesi√≥n...', 'info');
                console.log('[INFO]  Iniciando proceso de login para:', sanitizedEmail);
                
                const user = await window.authManager.login(email, password);
                console.log('[OK]  Usuario logueado exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                
                showAuthStatus('[OK]  Sesi√≥n iniciada, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR]  Error de login:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                const friendlyMessage = getFirebaseErrorMessage(error, 'login');
                showAuthStatus('[ERROR]  ' + friendlyMessage, 'error');
            }
        }
        
        // Funci√≥n para manejar login con Google
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google...');
                
                const user = await window.authManager.loginWithGoogle();
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
        
        async function handleRegister() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const passwordConfirm = document.getElementById('auth-password-confirm') ? document.getElementById('auth-password-confirm').value : password;
            const acceptTerms = document.getElementById('accept-terms') ? document.getElementById('accept-terms').checked : false;
            const acceptPrivacy = document.getElementById('accept-privacy') ? document.getElementById('accept-privacy').checked : false;
            
            // Validaciones de seguridad
            if (!email || !password) {
                showAuthStatus('Por favor completa todos los campos', 'error');
                return;
            }
            
            if (!validateEmail(email)) {
                showAuthStatus('Por favor introduce un email v√°lido', 'error');
                return;
            }
            
            if (!validatePassword(password)) {
                showAuthStatus('La contrase√±a debe tener entre 6 y 128 caracteres', 'error');
                return;
            }
            
            if (passwordConfirm && password !== passwordConfirm) {
                showAuthStatus('Las contrase√±as no coinciden', 'error');
                return;
            }
            
            if (!acceptTerms) {
                showAuthStatus('Debe aceptar los T√©rminos y Condiciones para continuar', 'error');
                return;
            }
            
            if (!acceptPrivacy) {
                showAuthStatus('Debe aceptar la Pol√≠tica de Privacidad para continuar', 'error');
                return;
            }
            
            // Sanitizar inputs
            const sanitizedEmail = sanitizeInput(email);
            const sanitizedPassword = sanitizeInput(password);
            
            try {
                showAuthStatus('Registrando usuario...', 'info');
                console.log('[INFO]  Iniciando proceso de registro para:', sanitizedEmail);
                
                const user = await window.authManager.register(email, password);
                console.log('[OK]  Usuario registrado exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                
                // CR√çTICO: Verificar que el usuario NO est√© verificado
                if (user.emailVerified === true) {
                    console.error('üö® PROBLEMA CR√çTICO: Usuario registrado como verificado sin haber verificado el email');
                    showAuthStatus('[ERROR]  ERROR CR√çTICO: El usuario fue marcado como verificado incorrectamente. Contacta al administrador.', 'error');
                    return;
                }
                
                // Verificar si el email se envi√≥ correctamente
                showAuthStatus('[OK]  Cuenta creada. Se ha enviado un email de verificaci√≥n a ' + sanitizedEmail + '. Por favor, verifica tu correo antes de continuar.', 'success');
                    
                    // Mostrar pantalla de verificaci√≥n
                    showEmailVerificationScreen(sanitizedEmail);
                    return;
                
                // Obtener perfil para mostrar informaci√≥n del rol
                const userProfile = await window.authManager.getUserProfile();
                if (userProfile) {
                    if (userProfile.isFirstUser) {
                        showAuthStatus('[OK]  ¬°Cuenta creada como ADMINISTRADOR! T√©rminos y Pol√≠tica aceptados. Cargando aplicaci√≥n...', 'success');
                    } else {
                        showAuthStatus('[OK]  Cuenta creada como USUARIO. T√©rminos y Pol√≠tica aceptados. Cargando aplicaci√≥n...', 'success');
                    }
                } else {
                    showAuthStatus('[OK]  Usuario registrado. T√©rminos y Pol√≠tica aceptados. Cargando aplicaci√≥n...', 'success');
                }
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1500); // Un poco m√°s de tiempo para leer el mensaje
                
            } catch (error) {
                console.error('Error de registro:', error);
                console.error('Tipo de error:', error.constructor.name);
                console.error('C√≥digo de error:', error.code);
                console.error('Mensaje completo:', error.message);
                
                // Manejar error espec√≠fico de l√≠mite de emails
                if (error.message.includes('L√≠mite de emails de verificaci√≥n alcanzado')) {
                    showAuthStatus('‚ö†Ô∏è L√≠mite de emails alcanzado. Firebase ha bloqueado el env√≠o temporalmente. Espera 1 hora antes de intentar nuevamente.', 'warning');
                    return;
                }
                
                const friendlyMessage = getFirebaseErrorMessage(error, 'register');
                
                // Si es un error de contrase√±a, mostrarlo espec√≠ficamente
                if (error.code === 'auth/password-does-not-meet-requirements' || 
                    error.message.includes('password-does-not-meet-requirements')) {
                    showPasswordError(friendlyMessage);
                    showAuthStatus('[ERROR]  ' + friendlyMessage, 'error');
                } else {
                    // Limpiar errores de contrase√±a si no es ese tipo de error
                    clearPasswordError();
                    showAuthStatus('[ERROR]  ' + friendlyMessage, 'error');
                }
            }
        }
        
        // Funci√≥n para manejar el logout
        async function handleLogout() {
            // Mostrar modal de confirmaci√≥n personalizado
            showLogoutConfirmModal();
        }
        
        // Funci√≥n para mostrar modal de advertencia de inactividad
        function showInactivityWarningModal() {
            // Crear overlay del modal
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'inactivity-warning-modal-overlay';
            modalOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(8px);
                animation: fadeIn 0.3s ease-out;
            `;
            
            // Crear contenido del modal
            modalOverlay.innerHTML = `
                <div id="inactivity-warning-modal" style="
                    background: white;
                    border-radius: 16px;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                    max-width: 420px;
                    width: 92%;
                    margin: 1rem;
                    overflow: hidden;
                    animation: slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                ">
                    <!-- Header con icono y gradiente sutil -->
                    <div style="
                        background: rgba(0,0,0,0.6);
                        padding: 2rem 1.5rem 1rem 1.5rem;
                        text-align: center;
                        position: relative;
                        overflow: hidden;
                    ">
                        <div style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px);
                            opacity: 0.5;
                        "></div>
                        <div style="
                            width: 64px;
                            height: 64px;
                            background: rgba(255, 255, 255, 0.9);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 1rem auto;
                            position: relative;
                            z-index: 1;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        ">
                            <svg width="32" height="32" fill="none" stroke="#d97706" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h3 style="
                            font-size: 1.5rem;
                            font-weight: 700;
                            color: #1f2937;
                            margin: 0 0 0.5rem 0;
                            position: relative;
                            z-index: 1;
                        ">Sesi√≥n por Expirar</h3>
                        <p style="
                            font-size: 1rem;
                            color: #4b5563;
                            margin: 0;
                            position: relative;
                            z-index: 1;
                            font-weight: 500;
                        ">Tu sesi√≥n expirar√° en 5 minutos</p>
                    </div>
                    
                    <!-- Contenido -->
                    <div style="padding: 1.5rem;">
                        <div style="
                            background: #f8fafc;
                            border: 1px solid #e2e8f0;
                            border-radius: 12px;
                            padding: 1rem;
                            margin-bottom: 1.5rem;
                        ">
                            <div style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div style="
                                    width: 20px;
                                    height: 20px;
                                    background: #dbeafe;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    margin-top: 2px;
                                    flex-shrink: 0;
                                ">
                                    <svg width="12" height="12" fill="none" stroke="#3b82f6" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div>
                                    <p style="
                                        font-size: 0.875rem; 
                                        color: #374151; 
                                        margin: 0 0 0.25rem 0;
                                        font-weight: 600;
                                        line-height: 1.4;
                                    ">Inactividad detectada</p>
                                    <p style="
                                        font-size: 0.8125rem;
                                        color: #6b7280;
                                        margin: 0;
                                        line-height: 1.4;
                                    ">No hemos detectado actividad en los √∫ltimos 25 minutos</p>
                                </div>
                            </div>
                            <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                                <div style="
                                    width: 20px;
                                    height: 20px;
                                    background: #d1fae5;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    margin-top: 2px;
                                    flex-shrink: 0;
                                ">
                                    <svg width="12" height="12" fill="none" stroke="#059669" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div>
                                    <p style="
                                        font-size: 0.875rem; 
                                        color: #374151; 
                                        margin: 0 0 0.25rem 0;
                                        font-weight: 600;
                                        line-height: 1.4;
                                    ">Datos seguros</p>
                                    <p style="
                                        font-size: 0.8125rem;
                                        color: #6b7280;
                                        margin: 0;
                                        line-height: 1.4;
                                    ">Todos tus datos est√°n guardados autom√°ticamente</p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <button 
                                onclick="extendInactivitySession()"
                                style="
                                    background: linear-gradient(135deg, #006666 0%, #004d4d 100%);
                                    color: white;
                                    border: none;
                                    padding: 0.875rem 1.5rem;
                                    border-radius: 10px;
                                    font-weight: 600;
                                    font-size: 0.9375rem;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 12px rgba(0, 102, 102, 0.3);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 0.5rem;
                                "
                                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 16px rgba(0, 102, 102, 0.4)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 102, 102, 0.3)'"
                            >
                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                                Mantener Sesi√≥n Activa
                            </button>
                            <button 
                                onclick="closeInactivitySession()"
                                style="
                                    background: #f8fafc;
                                    color: #475569;
                                    border: 1px solid #e2e8f0;
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 10px;
                                    font-weight: 500;
                                    font-size: 0.875rem;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 0.5rem;
                                "
                                onmouseover="this.style.background='#f1f5f9'; this.style.borderColor='#cbd5e1'"
                                onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'"
                            >
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                </svg>
                                Cerrar Sesi√≥n
                            </button>
                        </div>
                        
                        <p style="
                            font-size: 0.75rem;
                            color: #94a3b8;
                            text-align: center;
                            margin: 1rem 0 0 0;
                            font-style: italic;
                        ">Esta ventana se cerrar√° autom√°ticamente en 5 minutos</p>
                    </div>
                </div>
                
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes slideIn {
                        from { 
                            opacity: 0;
                            transform: translateY(-30px) scale(0.9);
                        }
                        to { 
                            opacity: 1;
                            transform: translateY(0) scale(1);
                        }
                    }
                </style>
            `;
            
            // Agregar al DOM
            document.body.appendChild(modalOverlay);
            
            // Prevenir scroll del body
            document.body.style.overflow = 'hidden';
            
            // Cerrar con ESC (opcional - mantener sesi√≥n)
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    extendInactivitySession();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }
        
        // Funci√≥n universal para mostrar notificaciones minimalistas
        function showNotification(title, message, type = 'info', duration = 4000) {
            // Remover notificaci√≥n anterior si existe
            const existingNotification = document.getElementById('app-notification-overlay');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Configuraci√≥n por tipo
            const typeConfig = {
                success: {
                    icon: `<svg width="20" height="20" fill="none" stroke="#ffffff" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                           </svg>`,
                    gradient: 'linear-gradient(135deg, #059669 0%, #047857 100%)',
                    borderColor: '#059669',
                    shadowColor: 'rgba(5, 150, 105, 0.4)'
                },
                error: {
                    icon: `<svg width="20" height="20" fill="none" stroke="#ffffff" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                           </svg>`,
                    gradient: 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)',
                    borderColor: '#dc2626',
                    shadowColor: 'rgba(220, 38, 38, 0.4)'
                },
                warning: {
                    icon: `<svg width="20" height="20" fill="none" stroke="#ffffff" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01"/>
                           </svg>`,
                    gradient: 'linear-gradient(135deg, #d97706 0%, #b45309 100%)',
                    borderColor: '#d97706',
                    shadowColor: 'rgba(217, 119, 6, 0.4)'
                },
                info: {
                    icon: `<svg width="20" height="20" fill="none" stroke="#ffffff" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01"/>
                           </svg>`,
                    gradient: 'linear-gradient(135deg, #0891b2 0%, #0e7490 100%)',
                    borderColor: '#0891b2',
                    shadowColor: 'rgba(8, 145, 178, 0.4)'
                }
            };
            
            const config = typeConfig[type] || typeConfig.info;
            
            // Crear overlay del modal
            const notificationOverlay = document.createElement('div');
            notificationOverlay.id = 'app-notification-overlay';
            notificationOverlay.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10001;
                animation: slideInRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            `;
            
            // Crear contenido de la notificaci√≥n
            notificationOverlay.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                    max-width: 420px;
                    min-width: 360px;
                    overflow: hidden;
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                    border: 1px solid rgba(0, 0, 0, 0.05);
                ">
                    <!-- Header con gradiente moderno -->
                    <div style="
                        background: ${config.gradient};
                        padding: 1.25rem 1.5rem 1rem 1.5rem;
                        position: relative;
                        overflow: hidden;
                    ">
                        <!-- Patr√≥n de fondo sutil -->
                        <div style="
                            position: absolute;
                            top: 0;
                            right: 0;
                            bottom: 0;
                            left: 0;
                            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px);
                            opacity: 0.6;
                        "></div>
                        
                        <!-- Contenido del header -->
                        <div style="display: flex; align-items: center; gap: 1rem; position: relative; z-index: 1;">
                            <div style="
                                width: 48px;
                                height: 48px;
                                background: rgba(255, 255, 255, 0.2);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                                backdrop-filter: blur(10px);
                                border: 1px solid rgba(255, 255, 255, 0.3);
                            ">
                                ${config.icon}
                            </div>
                            <div style="flex: 1;">
                                <h4 style="
                                    font-size: 1.25rem;
                                    font-weight: 700;
                                    color: #ffffff;
                                    margin: 0;
                                    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                                ">${title}</h4>
                            </div>
                            <button 
                                onclick="document.getElementById('app-notification-overlay').remove()"
                                style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    border-radius: 8px;
                                    width: 36px;
                                    height: 36px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    cursor: pointer;
                                    transition: all 0.2s ease;
                                    backdrop-filter: blur(10px);
                                    border: 1px solid rgba(255, 255, 255, 0.3);
                                "
                                onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'; this.style.transform='scale(1.05)'"
                                onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'; this.style.transform='scale(1)'"
                            >
                                <svg width="16" height="16" fill="none" stroke="#ffffff" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Contenido -->
                    <div style="padding: 1.5rem;">
                        <div style="
                            font-size: 0.9375rem;
                            color: #4b5563;
                            line-height: 1.6;
                            white-space: pre-line;
                        ">${message}</div>
                    </div>
                    
                    <!-- Barra de progreso moderna -->
                    <div style="
                        height: 4px;
                        background: #f1f5f9;
                        position: relative;
                        overflow: hidden;
                    ">
                        <div style="
                            height: 100%;
                            background: ${config.gradient};
                            width: 100%;
                            animation: progressBar ${duration}ms linear forwards;
                            border-radius: 0 0 16px 16px;
                        "></div>
                    </div>
                </div>
                
                <style>
                    @keyframes slideInRight {
                        from {
                            opacity: 0;
                            transform: translateX(100px) translateY(-20px) scale(0.9);
                        }
                        to {
                            opacity: 1;
                            transform: translateX(0) translateY(0) scale(1);
                        }
                    }
                    
                    @keyframes slideOutRight {
                        from {
                            opacity: 1;
                            transform: translateX(0) translateY(0) scale(1);
                        }
                        to {
                            opacity: 0;
                            transform: translateX(100px) translateY(-20px) scale(0.9);
                        }
                    }
                    
                    @keyframes progressBar {
                        from { 
                            transform: translateX(-100%); 
                            opacity: 1;
                        }
                        to { 
                            transform: translateX(0%); 
                            opacity: 0.8;
                        }
                    }
                </style>
            `;
            
            // Agregar al DOM
            document.body.appendChild(notificationOverlay);
            
            // Auto-remover despu√©s del tiempo especificado
            setTimeout(() => {
                if (notificationOverlay && notificationOverlay.parentNode) {
                    notificationOverlay.style.animation = 'slideOutRight 0.3s ease-out forwards';
                    setTimeout(() => {
                        if (notificationOverlay && notificationOverlay.parentNode) {
                            notificationOverlay.remove();
                        }
                    }, 300);
                }
            }, duration);
        }
        
        // Funci√≥n para extender la sesi√≥n de inactividad
        function extendInactivitySession() {
            const modal = document.getElementById('inactivity-warning-modal-overlay');
            if (modal) {
                modal.style.animation = 'fadeOut 0.2s ease-out';
                setTimeout(() => {
                    modal.remove();
                    document.body.style.overflow = '';
                }, 200);
            }
            resetInactivityTimer(); // Reiniciar timer
        }
        
        // Funci√≥n para cerrar sesi√≥n desde modal de inactividad
        function closeInactivitySession() {
            const modal = document.getElementById('inactivity-warning-modal-overlay');
            if (modal) {
                modal.style.animation = 'fadeOut 0.2s ease-out';
                setTimeout(() => {
                    modal.remove();
                    document.body.style.overflow = '';
                }, 200);
            }
            performLogout();
        }
        
        // Funci√≥n para mostrar modal de confirmaci√≥n de logout
        function showLogoutConfirmModal() {
            // Crear overlay del modal
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'logout-modal-overlay';
            modalOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                backdrop-filter: blur(8px);
                animation: fadeIn 0.3s ease-out;
            `;
            
            // Crear contenido del modal
            modalOverlay.innerHTML = `
                <div id="logout-modal" style="
                    background: white;
                    border-radius: 16px;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                    max-width: 400px;
                    width: 92%;
                    margin: 1rem;
                    overflow: hidden;
                    animation: slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                ">
                    <!-- Header con icono y gradiente -->
                    <div style="
                        background: linear-gradient(135deg, #fee2e2 0%, #ef4444 100%);
                        padding: 2rem 1.5rem 1rem 1.5rem;
                        text-align: center;
                        position: relative;
                        overflow: hidden;
                    ">
                        <div style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px);
                            opacity: 0.3;
                        "></div>
                        <div style="
                            width: 64px;
                            height: 64px;
                            background: rgba(255, 255, 255, 0.95);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 1rem auto;
                            position: relative;
                            z-index: 1;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        ">
                            <svg width="28" height="28" fill="none" stroke="#dc2626" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                            </svg>
                        </div>
                        <h3 style="
                            font-size: 1.5rem;
                            font-weight: 700;
                            color: #1f2937;
                            margin: 0 0 0.5rem 0;
                            position: relative;
                            z-index: 1;
                        ">Cerrar Sesi√≥n</h3>
                        <p style="
                            font-size: 1rem;
                            color: #4b5563;
                            margin: 0;
                            position: relative;
                            z-index: 1;
                            font-weight: 500;
                        ">¬øEst√°s seguro de que quieres salir?</p>
                    </div>
                    
                    <!-- Contenido -->
                    <div style="padding: 1.5rem;">
                        <div style="
                            background: #f8fafc;
                            border: 1px solid #e2e8f0;
                            border-radius: 12px;
                            padding: 1rem;
                            margin-bottom: 1.5rem;
                        ">
                            <div style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div style="
                                    width: 20px;
                                    height: 20px;
                                    background: #d1fae5;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    margin-top: 2px;
                                    flex-shrink: 0;
                                ">
                                    <svg width="12" height="12" fill="none" stroke="#059669" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                                <div>
                                    <p style="
                                        font-size: 0.875rem; 
                                        color: #374151; 
                                        margin: 0 0 0.25rem 0;
                                        font-weight: 600;
                                        line-height: 1.4;
                                    ">Datos seguros</p>
                                    <p style="
                                        font-size: 0.8125rem;
                                        color: #6b7280;
                                        margin: 0;
                                        line-height: 1.4;
                                    ">Todos los datos se guardar√°n autom√°ticamente</p>
                                </div>
                            </div>
                            <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                                <div style="
                                    width: 20px;
                                    height: 20px;
                                    background: #dbeafe;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    margin-top: 2px;
                                    flex-shrink: 0;
                                ">
                                    <svg width="12" height="12" fill="none" stroke="#0891b2" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div>
                                    <p style="
                                        font-size: 0.875rem; 
                                        color: #374151; 
                                        margin: 0 0 0.25rem 0;
                                        font-weight: 600;
                                        line-height: 1.4;
                                    ">Acceso r√°pido</p>
                                    <p style="
                                        font-size: 0.8125rem;
                                        color: #6b7280;
                                        margin: 0;
                                        line-height: 1.4;
                                    ">Puedes volver a iniciar sesi√≥n en cualquier momento</p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <button 
                                onclick="confirmLogout()"
                                style="
                                    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
                                    color: white;
                                    border: none;
                                    padding: 0.875rem 1.5rem;
                                    border-radius: 10px;
                                    font-weight: 600;
                                    font-size: 0.9375rem;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 0.5rem;
                                "
                                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 16px rgba(220, 38, 38, 0.4)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(220, 38, 38, 0.3)'"
                            >
                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                </svg>
                                Cerrar Sesi√≥n
                            </button>
                            <button 
                                onclick="closeLogoutModal()"
                                style="
                                    background: #f8fafc;
                                    color: #475569;
                                    border: 1px solid #e2e8f0;
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 10px;
                                    font-weight: 500;
                                    font-size: 0.875rem;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 0.5rem;
                                "
                                onmouseover="this.style.background='#f1f5f9'; this.style.borderColor='#cbd5e1'"
                                onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'"
                            >
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
                
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                    
                    @keyframes slideIn {
                        from { 
                            opacity: 0;
                            transform: translateY(-30px) scale(0.9);
                        }
                        to { 
                            opacity: 1;
                            transform: translateY(0) scale(1);
                        }
                    }
                </style>
            `;
                
            // Agregar al DOM
            document.body.appendChild(modalOverlay);
            document.body.appendChild(modalOverlay);
            
            // Prevenir scroll del body
            document.body.style.overflow = 'hidden';
            
            // Cerrar con ESC
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeLogoutModal();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
            
            // Cerrar al hacer clic fuera
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    closeLogoutModal();
                }
            });
        }
        
        // Funci√≥n para cerrar el modal de logout
        function closeLogoutModal() {
            const modal = document.getElementById('logout-modal-overlay');
            if (modal) {
                modal.style.animation = 'fadeOut 0.2s ease-out';
                setTimeout(() => {
                    document.body.removeChild(modal);
                    document.body.style.overflow = '';
                }, 200);
            }
        }
        
        // Funci√≥n para confirmar logout
        async function confirmLogout() {
            closeLogoutModal();
            await performLogout();
        }
        
        // Funci√≥n para realizar el logout (reutilizable)
        async function performLogout() {
            try {
                console.log('üö™ Cerrando sesi√≥n...');
                
                // Limpiar la aplicaci√≥n primero
                const root = document.getElementById('root');
                root.innerHTML = `
                    <div style="display:flex; flex-direction: column; justify-content:center; align-items:center; height:100vh; font-family: Inter, sans-serif; color: #4A5568;">
                        <div style="margin-bottom: 1rem;">Cerrando sesi√≥n...</div>
                        <div style="width: 32px; height: 32px; border: 3px solid #e2e8f0; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    </div>
                    <style>
                        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                    </style>
                `;
                
                // Esperar un momento para mostrar el mensaje
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Cerrar sesi√≥n en Firebase
                await window.authManager.logout();
                
                console.log('[OK]  Sesi√≥n cerrada exitosamente');
                
                // Limpiar timers de inactividad
                clearInactivityTimers();
                
                // Mostrar pantalla de login
                showAuthScreen();
                
            } catch (error) {
                console.error('[ERROR]  Error cerrando sesi√≥n:', error);
                
                // En caso de error, mostrar mensaje y volver a pantalla de login
                alert('Error cerrando sesi√≥n. Te redirigiremos al login.');
                showAuthScreen();
            }
        }
        
        // Sistema de detecci√≥n de inactividad
        let inactivityTimer;
        let warningTimer;
        const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minutos
        const WARNING_TIMEOUT = 25 * 60 * 1000; // 25 minutos (5 min antes)
        
        function resetInactivityTimer() {
            clearInactivityTimers();
            
            // Solo activar si hay usuario logueado
            if (window.authManager && window.authManager.isLoggedIn()) {
                // Timer de advertencia
                warningTimer = setTimeout(() => {
                    showInactivityWarningModal();
                }, WARNING_TIMEOUT);
                
                // Timer de logout autom√°tico
                inactivityTimer = setTimeout(() => {
                    alert('Tu sesi√≥n ha expirado por inactividad.');
                    performLogout();
                }, INACTIVITY_TIMEOUT);
            }
        }
        
        function clearInactivityTimers() {
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
                inactivityTimer = null;
            }
            if (warningTimer) {
                clearTimeout(warningTimer);
                warningTimer = null;
            }
        }
        
        // Eventos que reinician el timer de inactividad
        const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
        
        function initInactivityDetection() {
            activityEvents.forEach(event => {
                document.addEventListener(event, resetInactivityTimer, true);
            });
            
            // Agregar atajo de teclado para logout (Ctrl+Shift+L)
            document.addEventListener('keydown', (event) => {
                if (event.ctrlKey && event.shiftKey && event.key === 'L') {
                    event.preventDefault();
                    handleLogout();
                }
            });
            
            // Iniciar timer
            resetInactivityTimer();
            
            console.log('‚å®Ô∏è  Atajo de teclado activado: Ctrl+Shift+L para logout r√°pido');
        }
        
        function removeInactivityDetection() {
            activityEvents.forEach(event => {
                document.removeEventListener(event, resetInactivityTimer, true);
            });
            clearInactivityTimers();
        }
        
        // Funciones de Seguridad - Protecci√≥n XSS
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            return input
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#x27;')
                .replace(/\//g, '&#x2F;');
        }

        function sanitizeHTML(html) {
            if (typeof html !== 'string') return html;
            return html
                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                .replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '')
                .replace(/javascript:/gi, '')
                .replace(/on\w+\s*=/gi, '');
        }

        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email) && email.length <= 254;
        }

        function validatePassword(password) {
            return password && password.length >= 6 && password.length <= 128;
        }
        
        // Funci√≥n para toggle de contrase√±a
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = document.querySelector(`[onclick="togglePasswordVisibility('${inputId}')"]`);
            
            if (input && button) {
                if (input.type === 'password') {
                    input.type = 'text';
                    button.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                    `;
                    button.title = 'Ocultar contrase√±a';
                } else {
                    input.type = 'password';
                    button.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                            <line x1="1" y1="1" x2="23" y2="23"/>
                        </svg>
                    `;
                    button.title = 'Mostrar contrase√±a';
                }
            }
        }

        // Generador de tokens CSRF
        function generateCSRFToken() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        }

        // Almacenamiento seguro de tokens CSRF
        let csrfToken = null;
        
        function initializeCSRF() {
            csrfToken = generateCSRFToken();
            sessionStorage.setItem('csrf_token', csrfToken);
        }

        function getCSRFToken() {
            if (!csrfToken) {
                csrfToken = sessionStorage.getItem('csrf_token');
                if (!csrfToken) {
                    initializeCSRF();
                }
            }
            return csrfToken;
        }

        function validateCSRFToken(token) {
            return token && token === getCSRFToken();
        }

        // Funci√≥n para mostrar errores espec√≠ficos de contrase√±a
        function showPasswordError(message) {
            // Buscar el campo de contrase√±a en el formulario de registro
            const passwordField = document.getElementById('auth-password');
            const confirmPasswordField = document.getElementById('auth-password-confirm');
            
            if (passwordField && confirmPasswordField) {
                // Crear o actualizar el mensaje de error
                let errorDiv = document.getElementById('password-error');
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.id = 'password-error';
                    errorDiv.style.marginTop = '0.5rem';
                    errorDiv.style.padding = '0.75rem';
                    errorDiv.style.backgroundColor = '#fef2f2';
                    errorDiv.style.color = '#dc2626';
                    errorDiv.style.border = '1px solid #fecaca';
                    errorDiv.style.borderRadius = '6px';
                    errorDiv.style.fontSize = '0.9rem';
                    errorDiv.style.lineHeight = '1.4';
                    
                    // Insertar despu√©s del campo de confirmar contrase√±a
                    confirmPasswordField.parentNode.parentNode.insertAdjacentElement('afterend', errorDiv);
                }
                
                // Mostrar el mensaje
                if (message.includes('\n')) {
                    errorDiv.innerHTML = message.replace(/\n/g, '<br>');
                } else {
                    errorDiv.textContent = message;
                }
                
                errorDiv.style.display = 'block';
                
                // Resaltar los campos de contrase√±a
                passwordField.style.borderColor = '#dc2626';
                confirmPasswordField.style.borderColor = '#dc2626';
                
                // Scroll al error
                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // Funci√≥n para limpiar errores de contrase√±a
        function clearPasswordError() {
            const errorDiv = document.getElementById('password-error');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
            
            // Restaurar colores normales de los campos
            const passwordField = document.getElementById('auth-password');
            const confirmPasswordField = document.getElementById('auth-password-confirm');
            
            if (passwordField) {
                passwordField.style.borderColor = '#d1d5db';
            }
            if (confirmPasswordField) {
                confirmPasswordField.style.borderColor = '#d1d5db';
            }
        }

        // Funci√≥n centralizada para convertir errores de Firebase a mensajes amigables
        function getFirebaseErrorMessage(error, context = 'general') {
            const errorCode = error.code || '';
            const errorMessage = error.message || '';
            
            console.log('[DEBUG]  Analizando error Firebase:', { code: errorCode, message: errorMessage, context });
            
            // Errores de autenticaci√≥n comunes
            const authErrors = {
                'auth/invalid-credential': 'Email o contrase√±a incorrectos',
                'auth/user-not-found': 'No existe una cuenta con este email',
                'auth/wrong-password': 'Contrase√±a incorrecta',
                'auth/invalid-email': 'El formato del email no es v√°lido',
                'auth/email-already-in-use': 'Ya existe una cuenta con este email',
                'auth/weak-password': 'La contrase√±a debe tener al menos 6 caracteres',
                'auth/password-does-not-meet-requirements': 'La contrase√±a no cumple con los requisitos de seguridad',
                'auth/too-many-requests': 'Demasiados intentos fallidos. Intenta m√°s tarde',
                'auth/operation-not-allowed': context === 'register' ? 'El registro no est√° habilitado' : 'Login con Google no est√° habilitado',
                'auth/popup-closed-by-user': 'Login cancelado por el usuario',
                'auth/popup-blocked': 'Popup bloqueado. Permite popups en este sitio',
                'auth/cancelled-popup-request': 'Login cancelado',
                'auth/user-disabled': 'Esta cuenta ha sido deshabilitada',
                'auth/requires-recent-login': 'Por seguridad, necesitas iniciar sesi√≥n nuevamente',
                'auth/network-request-failed': 'Error de conexi√≥n. Verifica tu internet',
                'auth/timeout': 'La operaci√≥n tard√≥ demasiado. Int√©ntalo de nuevo'
            };
            
            // Errores de Firestore
            const firestoreErrors = {
                'permission-denied': 'Permisos insuficientes. Contacta al administrador',
                'unavailable': 'Servicio temporalmente no disponible',
                'deadline-exceeded': 'La operaci√≥n tard√≥ demasiado. Int√©ntalo de nuevo',
                'resource-exhausted': 'L√≠mite de recursos alcanzado. Int√©ntalo m√°s tarde',
                'unauthenticated': 'Debes iniciar sesi√≥n para realizar esta acci√≥n',
                'not-found': 'El recurso solicitado no existe',
                'already-exists': 'El recurso ya existe',
                'failed-precondition': 'No se pueden realizar cambios en este momento',
                'aborted': 'Operaci√≥n cancelada. Int√©ntalo de nuevo',
                'out-of-range': 'Valor fuera del rango permitido',
                'unimplemented': 'Esta funci√≥n no est√° disponible',
                'internal': 'Error interno del servidor',
                'data-loss': 'Error de integridad de datos'
            };
            
            // Manejo especial para requisitos de contrase√±a
            if (errorCode.includes('auth/password-does-not-meet-requirements') || errorMessage.includes('password-does-not-meet-requirements')) {
                // Extraer los requisitos espec√≠ficos del mensaje de Firebase
                const requirements = [];
                if (errorMessage.includes('Password must contain an upper case character')) {
                    requirements.push('‚Ä¢ Al menos una letra may√∫scula');
                }
                if (errorMessage.includes('Password must contain a lower case character')) {
                    requirements.push('‚Ä¢ Al menos una letra min√∫scula');
                }
                if (errorMessage.includes('Password must contain a non-alphanumeric character')) {
                    requirements.push('‚Ä¢ Al menos un car√°cter especial (!@#$%^&*)');
                }
                if (errorMessage.includes('Password must contain a numeric character')) {
                    requirements.push('‚Ä¢ Al menos un n√∫mero');
                }
                if (errorMessage.includes('Password must be at least')) {
                    const minLength = errorMessage.match(/Password must be at least (\d+)/);
                    if (minLength) {
                        requirements.push(`‚Ä¢ M√≠nimo ${minLength[1]} caracteres`);
                    }
                }
                
                if (requirements.length > 0) {
                    return 'La contrase√±a debe cumplir los siguientes requisitos:\n' + requirements.join('\n');
                }
                return 'La contrase√±a no cumple con los requisitos de seguridad';
            }
            
            // Buscar en errores de autenticaci√≥n
            for (const [code, message] of Object.entries(authErrors)) {
                if (errorCode.includes(code) || errorMessage.includes(code)) {
                    return message;
                }
            }
            
            // Buscar en errores de Firestore
            for (const [code, message] of Object.entries(firestoreErrors)) {
                if (errorCode.includes(code) || errorMessage.includes(code)) {
                    return message;
                }
            }
            
            // Errores espec√≠ficos por contexto
            if (context === 'password-recovery') {
                if (errorMessage.includes('user-not-found')) {
                    return 'No existe una cuenta con este email';
                }
                if (errorMessage.includes('invalid-email')) {
                    return 'Email inv√°lido';
                }
                if (errorMessage.includes('too-many-requests')) {
                    return 'Demasiados intentos. Int√©ntalo m√°s tarde';
                }
                return 'Error al enviar el email de recuperaci√≥n';
            }
            
            if (context === 'email-verification') {
                if (errorMessage.includes('too-many-requests')) {
                    return 'Demasiados intentos de verificaci√≥n. Int√©ntalo m√°s tarde';
                }
                return 'Error al enviar el email de verificaci√≥n';
            }
            
            // Mensaje gen√©rico si no se encuentra un error espec√≠fico
            console.warn('[WARNING]  Error no reconocido:', { code: errorCode, message: errorMessage, context });
            return 'Error inesperado. Int√©ntalo de nuevo';
        }

        // Pantalla de verificaci√≥n de email
        function showEmailVerificationScreen(email) {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div style="min-height: 100vh; display: flex; background: url('./imagen_fondo_manos.webp') center/cover no-repeat fixed;">
                    <!-- Panel izquierdo - Verificaci√≥n -->
                    <div style="width: 40%; min-height: 100vh; background: white; display: flex; flex-direction: column; justify-content: center; padding: 3rem 4rem; box-shadow: 2px 0 10px rgba(0,0,0,0.1);">
                        <!-- Logo -->
                        <div style="text-align: center; margin-bottom: 3rem;">
                            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                                    <svg width="30" height="30" viewBox="0 0 24 24" fill="white">
                                        <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                                    </svg>
                                </div>
                                <h1 style="font-size: 1.75rem; font-weight: 700; color: #1a202c; margin: 0;">Expertia Business Suite</h1>
                            </div>
                        </div>
                        
                        <!-- T√≠tulo -->
                        <h2 style="font-size: 2rem; font-weight: 600; color: #1a202c; text-align: center; margin-bottom: 0.5rem;">Verifica tu Email</h2>
                        
                        <!-- Mensaje -->
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <p style="color: #6b7280; font-size: 1rem; line-height: 1.5;">
                                Hemos enviado un enlace de verificaci√≥n a:<br>
                                <strong style="color: #1a202c;">${sanitizeInput(email)}</strong>
                            </p>
                            <p style="color: #6b7280; font-size: 0.9rem; margin-top: 1rem;">
                                Por favor, revisa tu bandeja de entrada y haz clic en el enlace para verificar tu cuenta.
                            </p>
                        </div>
                        
                        <!-- Botones -->
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <button 
                                onclick="checkEmailVerification()"
                                style="width: 100%; background: #3b82f6; color: white; padding: 0.875rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: background-color 0.3s ease;"
                                onmouseover="this.style.backgroundColor='#2563eb'"
                                onmouseout="this.style.backgroundColor='#3b82f6'"
                            >
                                Ya verifiqu√© mi email
                            </button>
                            
                            <button 
                                onclick="resendVerificationEmail()"
                                style="width: 100%; background: #10b981; color: white; padding: 0.875rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: background-color 0.3s ease;"
                                onmouseover="this.style.backgroundColor='#059669'"
                                onmouseout="this.style.backgroundColor='#10b981'"
                            >
                                Reenviar email de verificaci√≥n
                            </button>
                            
                            <button 
                                onclick="showAuthScreen()"
                                style="width: 100%; background: none; border: 1px solid #d1d5db; color: #6b7280; padding: 0.875rem; border-radius: 8px; font-weight: 500; cursor: pointer; font-size: 1rem; transition: all 0.3s ease;"
                                onmouseover="this.style.backgroundColor='#f9fafb'; this.style.borderColor='#9ca3af'"
                                onmouseout="this.style.backgroundColor='transparent'; this.style.borderColor='#d1d5db'"
                            >
                                Volver al Login
                            </button>
                        </div>
                        
                        <div id="auth-status" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; display: none;"></div>
                    </div>
                    
                    <!-- Panel derecho - Imagen de fondo -->
                    <div style="width: 60%; min-height: 100vh; background: url('./imagen_fondo_manos.webp') center/cover no-repeat; position: relative;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.1);"></div>
                    </div>
                </div>
            `;
        }

        // Funci√≥n para verificar si el email ha sido verificado
        async function checkEmailVerification() {
            try {
                showAuthStatus('Verificando estado del email...', 'info');
                console.log('[INFO]  Verificando estado del email...');
                
                await window.authManager.reloadUser();
                const user = window.authManager.getCurrentUser();
                
                console.log('üë§ Usuario actual:', user?.email);
                console.log('üìß Email verificado:', user?.emailVerified);
                
                if (user && user.emailVerified) {
                    console.log('[OK]  Email verificado correctamente');
                    showAuthStatus('[OK]  Email verificado correctamente. Cargando aplicaci√≥n...', 'success');
                    setTimeout(() => {
                        startApp();
                    }, 1500);
                } else {
                    console.log('‚ùå Email a√∫n no verificado');
                    showAuthStatus('[ERROR]  El email a√∫n no ha sido verificado. Por favor, revisa tu correo y haz clic en el enlace de verificaci√≥n.', 'error');
                }
            } catch (error) {
                console.error('[ERROR]  Error verificando email:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                const friendlyMessage = getFirebaseErrorMessage(error, 'email-verification');
                showAuthStatus('[ERROR]  ' + friendlyMessage, 'error');
            }
        }

        // Funci√≥n para reenviar email de verificaci√≥n
        async function resendVerificationEmail() {
            try {
                showAuthStatus('Reenviando email de verificaci√≥n...', 'info');
                console.log('[INFO]  Reenviando email de verificaci√≥n...');
                
                await window.authManager.sendEmailVerification();
                console.log('[OK]  Email de verificaci√≥n reenviado exitosamente');
                
                showAuthStatus('[OK]  Email de verificaci√≥n reenviado. Revisa tu bandeja de entrada.', 'success');
            } catch (error) {
                console.error('[ERROR]  Error reenviando email:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                const friendlyMessage = getFirebaseErrorMessage(error, 'email-verification');
                showAuthStatus('[ERROR]  ' + friendlyMessage, 'error');
            }
        }

        // Pantalla de recuperaci√≥n de contrase√±a
        function showPasswordRecoveryScreen() {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div style="min-height: 100vh; display: flex; background: url('./imagen_fondo_manos.webp') center/cover no-repeat fixed;">
                    <!-- Panel izquierdo - Recuperaci√≥n -->
                    <div style="width: 40%; min-height: 100vh; background: white; display: flex; flex-direction: column; justify-content: center; padding: 3rem 4rem; box-shadow: 2px 0 10px rgba(0,0,0,0.1);">
                        <!-- Logo -->
                        <div style="text-align: center; margin-bottom: 3rem;">
                            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                                    <svg width="30" height="30" viewBox="0 0 24 24" fill="white">
                                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                                    </svg>
                                </div>
                                <h1 style="font-size: 1.75rem; font-weight: 700; color: #1a202c; margin: 0;">Expertia Business Suite</h1>
                            </div>
                        </div>
                        
                        <!-- T√≠tulo -->
                        <h2 style="font-size: 2rem; font-weight: 600; color: #1a202c; text-align: center; margin-bottom: 0.5rem;">Recuperar Contrase√±a</h2>
                        
                        <!-- Mensaje -->
                        <p style="text-align: center; color: #6b7280; margin-bottom: 2rem; font-size: 0.95rem;">
                            Introduce tu email y te enviaremos un enlace para restablecer tu contrase√±a.
                        </p>
                        
                        <!-- Formulario de recuperaci√≥n -->
                        <form id="recovery-form" onsubmit="event.preventDefault(); handlePasswordRecovery();">
                            <!-- Email -->
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-size: 0.9rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Email</label>
                                <div style="position: relative;">
                                    <input 
                                        type="email" 
                                        id="recovery-email" 
                                        required
                                        style="width: 100%; padding: 0.875rem 1rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: border-color 0.3s ease;"
                                        placeholder="tu@email.com"
                                        onfocus="this.style.borderColor='#ef4444'"
                                        onblur="this.style.borderColor='#d1d5db'"
                                    >
                                </div>
                            </div>
                            
                            <!-- Bot√≥n Enviar -->
                            <button 
                                type="submit"
                                style="width: 100%; background: #ef4444; color: white; padding: 0.875rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: background-color 0.3s ease; margin-bottom: 1rem;"
                                onmouseover="this.style.backgroundColor='#dc2626'"
                                onmouseout="this.style.backgroundColor='#ef4444'"
                            >
                                Enviar Enlace de Recuperaci√≥n
                            </button>
                        </form>
                        
                        <!-- Bot√≥n Volver -->
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <button 
                                onclick="showAuthScreen()"
                                style="background: none; border: none; color: #6b7280; text-decoration: none; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: color 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin: 0 auto;"
                                onmouseover="this.style.color='#374151'"
                                onmouseout="this.style.color='#6b7280'"
                            >
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                                </svg>
                                Volver al Login
                            </button>
                        </div>
                        
                        <div id="auth-status" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; display: none;"></div>
                    </div>
                    
                    <!-- Panel derecho - Imagen de fondo -->
                    <div style="width: 60%; min-height: 100vh; background: url('./imagen_fondo_manos.webp') center/cover no-repeat; position: relative;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.1);"></div>
                    </div>
                </div>
            `;
        }

        // Funci√≥n para manejar la recuperaci√≥n de contrase√±a
        async function handlePasswordRecovery() {
            const email = document.getElementById('recovery-email').value;
            
            if (!email) {
                showAuthStatus('Por favor introduce tu email', 'error');
                return;
            }
            
            if (!validateEmail(email)) {
                showAuthStatus('Por favor introduce un email v√°lido', 'error');
                return;
            }
            
            const sanitizedEmail = sanitizeInput(email);
            
            try {
                showAuthStatus('Enviando enlace de recuperaci√≥n...', 'info');
                await window.authManager.sendPasswordResetEmail(sanitizedEmail);
                showAuthStatus('[OK]  Se ha enviado un enlace de recuperaci√≥n a ' + sanitizedEmail + '. Revisa tu bandeja de entrada.', 'success');
                
                // Mostrar pantalla de confirmaci√≥n
                setTimeout(() => {
                    showPasswordRecoveryConfirmationScreen(sanitizedEmail);
                }, 2000);
                
            } catch (error) {
                console.error('Error enviando email de recuperaci√≥n:', error);
                const friendlyMessage = getFirebaseErrorMessage(error, 'password-recovery');
                showAuthStatus('[ERROR]  ' + friendlyMessage, 'error');
            }
        }

        // Pantalla de confirmaci√≥n de recuperaci√≥n
        function showPasswordRecoveryConfirmationScreen(email) {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div style="min-height: 100vh; display: flex; background: url('./imagen_fondo_manos.webp') center/cover no-repeat fixed;">
                    <!-- Panel izquierdo - Confirmaci√≥n -->
                    <div style="width: 40%; min-height: 100vh; background: white; display: flex; flex-direction: column; justify-content: center; padding: 3rem 4rem; box-shadow: 2px 0 10px rgba(0,0,0,0.1);">
                        <!-- Logo -->
                        <div style="text-align: center; margin-bottom: 3rem;">
                            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                                    <svg width="30" height="30" viewBox="0 0 24 24" fill="white">
                                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <h1 style="font-size: 1.75rem; font-weight: 700; color: #1a202c; margin: 0;">Expertia Business Suite</h1>
                            </div>
                        </div>
                        
                        <!-- T√≠tulo -->
                        <h2 style="font-size: 2rem; font-weight: 600; color: #1a202c; text-align: center; margin-bottom: 0.5rem;">Email Enviado</h2>
                        
                        <!-- Mensaje -->
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <p style="color: #6b7280; font-size: 1rem; line-height: 1.5;">
                                Hemos enviado un enlace de recuperaci√≥n a:<br>
                                <strong style="color: #1a202c;">${sanitizedEmail}</strong>
                            </p>
                            <p style="color: #6b7280; font-size: 0.9rem; margin-top: 1rem;">
                                Revisa tu bandeja de entrada y sigue las instrucciones para restablecer tu contrase√±a.
                            </p>
                            <p style="color: #6b7280; font-size: 0.8rem; margin-top: 1rem; font-style: italic;">
                                El enlace expirar√° en 1 hora por seguridad.
                            </p>
                        </div>
                        
                        <!-- Bot√≥n Volver -->
                        <div style="text-align: center;">
                            <button 
                                onclick="showAuthScreen()"
                                style="background: #10b981; color: white; padding: 0.875rem 2rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: background-color 0.3s ease;"
                                onmouseover="this.style.backgroundColor='#059669'"
                                onmouseout="this.style.backgroundColor='#10b981'"
                            >
                                Volver al Login
                            </button>
                        </div>
                    </div>
                    
                    <!-- Panel derecho - Imagen de fondo -->
                    <div style="width: 60%; min-height: 100vh; background: url('./imagen_fondo_manos.webp') center/cover no-repeat; position: relative;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.1);"></div>
                    </div>
                </div>
            `;
        }
        
        function showAuthStatus(message, type) {
            const statusDiv = document.getElementById('auth-status');
            
            // Manejar mensajes multil√≠nea
            if (message.includes('\n')) {
                statusDiv.innerHTML = message.replace(/\n/g, '<br>');
            } else {
                statusDiv.textContent = message;
            }
            
            // Estilos seg√∫n el tipo
            if (type === 'error') {
                statusDiv.style.background = '#fef2f2';
                statusDiv.style.color = '#dc2626';
                statusDiv.style.border = '1px solid #fecaca';
            } else if (type === 'success') {
                statusDiv.style.background = '#f0fdf4';
                statusDiv.style.color = '#16a34a';
                statusDiv.style.border = '1px solid #bbf7d0';
            } else {
                statusDiv.style.background = '#f0f9ff';
                statusDiv.style.color = '#0284c7';
                statusDiv.style.border = '1px solid #bae6fd';
            }
            
            statusDiv.style.display = 'block';
            statusDiv.style.padding = '0.75rem';
            statusDiv.style.borderRadius = '6px';
            statusDiv.style.fontSize = '0.9rem';
            statusDiv.style.lineHeight = '1.4';
            
            // Auto-ocultar despu√©s de 5 segundos si es √©xito
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // Funci√≥n para analizar referencias hardcodeadas de configuracion
        // ‚ùå FUNCI√ìN MOVIDA A archive/tools/firebase-analyzer.js
        /*
        async function analyzeConfigReferences() {
            try {
                if (!window.authManager || !window.authManager.app) {
                    console.log('‚ùå Sistema de autenticaci√≥n no disponible');
                    return;
                }
                
                console.log('[DEBUG]  AN√ÅLISIS DE REFERENCIAS A CONFIGURACION EN EL C√ìDIGO\n');
                
                // Importar Firestore
                const { getFirestore, doc, getDoc } = 
                    await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                const db = getFirestore(window.authManager.app);
                
                console.log('[DATA]  === AN√ÅLISIS DE REFERENCIAS DE CONFIGURACI√ìN ===\n');
                
                // 1. Obtener configuraci√≥n actual de system_settings
                console.log('[CONFIG]  1. Obteniendo configuraci√≥n actual de system_settings:');
                const systemSettingsRef = doc(db, 'system_settings', 'main');
                const systemSettingsDoc = await getDoc(systemSettingsRef);
                
                if (!systemSettingsDoc.exists()) {
                    console.log('   ‚ùå system_settings/main no existe');
                    return;
                }
                
                const config = systemSettingsDoc.data();
                console.log('   ‚úÖ system_settings cargado correctamente');
                
                // 2. Analizar referencias hardcodeadas encontradas
                console.log('\nüìã 2. Referencias hardcodeadas encontradas en index.html:');
                console.log('   üîç SERIES DE FACTURAS:');
                console.log('      ‚Ä¢ Hardcoded: "EXP", "ALQ", "PROF", "OF"');
                console.log('      ‚Ä¢ Configurado:', JSON.stringify(config.invoice?.series || ['No encontrado']));
                
                console.log('\n   üîç CATEGOR√çAS DE PRODUCTOS:');
                console.log('      ‚Ä¢ Configurado:', JSON.stringify(config.products?.categories || ['No encontrado']));
                
                console.log('\n   üîç PROVEEDORES:');
                console.log('      ‚Ä¢ Configurado:', JSON.stringify(config.products?.suppliers || ['No encontrado']));
                
                console.log('\n   üîç FUENTES DE LEADS:');
                console.log('      ‚Ä¢ Configurado:', JSON.stringify(config.sales?.sources || ['No encontrado']));
                
                console.log('\n   üîç ETAPAS DEL EMBUDO:');
                console.log('      ‚Ä¢ Configurado:', JSON.stringify(config.sales?.funnelStages || ['No encontrado']));
                
                console.log('\n   üîç PRIORIDADES:');
                console.log('      ‚Ä¢ Configurado:', JSON.stringify(config.sales?.priorities || ['No encontrado']));
                
                // 3. Generar recomendaciones de refactoring
                console.log('\nüõ†Ô∏è 3. RECOMENDACIONES DE REFACTORING:');
                console.log('   ===============================================\n');
                
                console.log('   üìù A. REEMPLAZAR SERIES HARDCODEADAS:');
                console.log('      L√≠neas afectadas en index.html:');
                console.log("      ‚Ä¢ L√≠nea 618, 632: series: 'EXP' ‚Üí Obtener de config.invoice.series[0]");
                console.log("      ‚Ä¢ L√≠nea 643, 671, 693: offerSeries: 'OF' ‚Üí Obtener de config.invoice.offerSeries");
                console.log("      ‚Ä¢ L√≠nea 909: dataToSave.invoiceSeries || 'EXP' ‚Üí || config.invoice.series[0]");
                console.log("      ‚Ä¢ L√≠nea 989, 1023: series = 'OF' ‚Üí config.invoice.offerSeries");
                
                console.log('\n   üìù B. FUNCI√ìN DIN√ÅMICA PARA CARGAR CONFIGURACI√ìN:');
                console.log('      ‚úÖ Crear funci√≥n: async getConfigValue(section, key, defaultValue)');
                console.log('      ‚úÖ Cargar configuraci√≥n una vez al inicio de la app');
                console.log('      ‚úÖ Cache local para evitar m√∫ltiples consultas Firebase');
                
                console.log('\n   üìù C. ACTUALIZACIONES ESPEC√çFICAS NECESARIAS:');
                console.log('      1. Funci√≥n getNextInvoiceNumber: Usar series din√°micas');
                console.log('      2. Funci√≥n getNextOfferNumber: Usar series din√°micas');
                console.log('      3. Formularios de productos: Usar categories y suppliers din√°micos');
                console.log('      4. Formularios de leads/ventas: Usar sources, funnelStages, priorities din√°micos');
                
                // 4. Verificar contador global
                console.log('\\nüî¢ 4. CONTADOR GLOBAL DE FACTURAS:');
                console.log('   ‚Ä¢ Estado actual:', config.invoice?.globalCounter || 'No configurado');
                console.log('   ‚Ä¢ Pr√≥ximo n√∫mero:', (config.invoice?.globalCounter || 0) + 1);
                
                // 5. Mostrar configuraciones actuales
                console.log('\\nüìä 5. RESUMEN DE CONFIGURACIONES DISPONIBLES:');
                console.log('   ===========================================');
                
                if (config.products) {
                    console.log('   üì¶ PRODUCTOS:', Object.keys(config.products).length, 'configuraciones');
                    Object.keys(config.products).forEach(key => {
                        const value = config.products[key];
                        if (Array.isArray(value)) {
                            console.log('      ‚Ä¢', key + ':', value.length, 'elementos [' + value.slice(0,3).join(', ') + (value.length > 3 ? '...' : '') + ']');
                        } else {
                            console.log('      ‚Ä¢', key + ':', value);
                        }
                    });
                }
                
                if (config.sales) {
                    console.log('   üíº VENTAS:', Object.keys(config.sales).length, 'configuraciones');
                    Object.keys(config.sales).forEach(key => {
                        const value = config.sales[key];
                        if (Array.isArray(value)) {
                            console.log('      ‚Ä¢', key + ':', value.length, 'elementos [' + value.slice(0,3).join(', ') + (value.length > 3 ? '...' : '') + ']');
                        } else {
                            console.log('      ‚Ä¢', key + ':', value);
                        }
                    });
                }
                
                if (config.invoice) {
                    console.log('   üßæ FACTURACI√ìN:', Object.keys(config.invoice).length, 'configuraciones');
                    Object.keys(config.invoice).forEach(key => {
                        const value = config.invoice[key];
                        if (Array.isArray(value)) {
                            console.log('      ‚Ä¢', key + ':', value.length, 'elementos [' + value.join(', ') + ']');
                        } else if (typeof value === 'object') {
                            console.log('      ‚Ä¢', key + ':', Object.keys(value).length, 'sub-configuraciones');
                        } else {
                            console.log('      ‚Ä¢', key + ':', value);
                        }
                    });
                }
                
                console.log('\\n‚úÖ === AN√ÅLISIS COMPLETADO ===');
                console.log('[PROCESS]  Siguiente paso: Implementar las funciones din√°micas en index.html');
                console.log('[CONFIG]  Usar las recomendaciones anteriores para refactorizar el c√≥digo\\n');
                
            } catch (error) {
                console.error('[ERROR]  Error analizando referencias:', error);
            }
        }
        */
        
        
        // Se llama a la funci√≥n de inicializaci√≥n despu√©s de que la ventana completa se haya cargado.
        window.onload = initAuthAndApp;
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
        // === GOOGLE LOGIN CON MEJORES PR√ÅCTICAS ===
        
        // Funci√≥n para manejar login con Google - Versi√≥n Mejorada
        async function handleGoogleLogin() {
            try {
                showAuthStatus('Iniciando sesi√≥n con Google...', 'info');
                console.log('[INFO] Iniciando login con Google (mejores pr√°cticas)...');
                
                const user = await window.authManager.loginWithGoogle();
                
                console.log('[OK] Usuario logueado con Google exitosamente:', user.email);
                console.log('üë§ UID:', user.uid);
                console.log('üìß Email verificado:', user.emailVerified);
                console.log('üë§ Display Name:', user.displayName);
                console.log('üñºÔ∏è Photo URL:', user.photoURL);
                
                showAuthStatus('[OK] Sesi√≥n iniciada con Google, cargando aplicaci√≥n...', 'success');
                
                // Esperar un momento y luego cargar la aplicaci√≥n
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                console.error('[ERROR] Error en login con Google:', error);
                console.error('üîç C√≥digo de error:', error.code);
                console.error('üìù Mensaje:', error.message);
                
                // Manejar errores espec√≠ficos de Google Auth
                let friendlyMessage = 'Error al iniciar sesi√≥n con Google';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    friendlyMessage = 'Popup bloqueado. Permite ventanas emergentes para este sitio';
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = 'Error de conexi√≥n. Verifica tu internet';
                } else if (error.code === 'auth/too-many-requests') {
                    friendlyMessage = 'Demasiados intentos. Int√©ntalo m√°s tarde';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = 'Ya existe una cuenta con este email usando otro m√©todo de login';
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMessage = 'Credenciales inv√°lidas. Int√©ntalo de nuevo';
                }
                
                showAuthStatus('[ERROR] ' + friendlyMessage, 'error');
            }
        }
    </script>
</body>
</html>
